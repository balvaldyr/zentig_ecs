<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>worldbuilder.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! A comptime only class for constructing World types</span></span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L4"><span class="tok-kw">const</span> ztg = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;init.zig&quot;</span>);</span>
<span class="line" id="L5"><span class="tok-kw">const</span> world = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;world.zig&quot;</span>);</span>
<span class="line" id="L6"></span>
<span class="line" id="L7"><span class="tok-kw">const</span> TypeMap = ztg.meta.TypeMap;</span>
<span class="line" id="L8"><span class="tok-kw">const</span> TypeBuilder = ztg.meta.TypeBuilder;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> World = world.World;</span>
<span class="line" id="L10"></span>
<span class="line" id="L11"><span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L12"></span>
<span class="line" id="L13"><span class="tok-kw">const</span> StageLabel = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L14">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L15">    before: TypeBuilder = .{ .is_tuple = <span class="tok-null">true</span> },</span>
<span class="line" id="L16">    during: TypeBuilder = .{ .is_tuple = <span class="tok-null">true</span> },</span>
<span class="line" id="L17">    after: TypeBuilder = .{ .is_tuple = <span class="tok-null">true</span> },</span>
<span class="line" id="L18">};</span>
<span class="line" id="L19"></span>
<span class="line" id="L20"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> StageDef = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L21">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L22">    labels: ztg.meta.ComptimeList(StageLabel),</span>
<span class="line" id="L23">};</span>
<span class="line" id="L24"></span>
<span class="line" id="L25"><span class="tok-kw">const</span> default_stages = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L26">    <span class="tok-comment">// zig fmt: off</span>
</span>
<span class="line" id="L27">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> init        = <span class="tok-number">0</span>;</span>
<span class="line" id="L28">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> load        = <span class="tok-number">1</span>;</span>
<span class="line" id="L29">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> pre_update  = <span class="tok-number">2</span>;</span>
<span class="line" id="L30">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> update      = <span class="tok-number">3</span>;</span>
<span class="line" id="L31">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> post_update = <span class="tok-number">4</span>;</span>
<span class="line" id="L32">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> draw        = <span class="tok-number">5</span>;</span>
<span class="line" id="L33">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> deinit      = <span class="tok-number">6</span>;</span>
<span class="line" id="L34">    <span class="tok-comment">// zig fmt: on</span>
</span>
<span class="line" id="L35">};</span>
<span class="line" id="L36"></span>
<span class="line" id="L37">warnings: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-str">&quot;&quot;</span>,</span>
<span class="line" id="L38"></span>
<span class="line" id="L39">max_entities: <span class="tok-type">usize</span> = <span class="tok-number">100_000</span>,</span>
<span class="line" id="L40">stage_defs: ztg.meta.ComptimeList(StageDef) = .{},</span>
<span class="line" id="L41"></span>
<span class="line" id="L42">comp_types: TypeMap = .{},</span>
<span class="line" id="L43">event_types: TypeMap = .{},</span>
<span class="line" id="L44">included: TypeMap = .{},</span>
<span class="line" id="L45"></span>
<span class="line" id="L46">resources: TypeBuilder = .{},</span>
<span class="line" id="L47">added_resources: TypeMap = .{},</span>
<span class="line" id="L48"></span>
<span class="line" id="L49"><span class="tok-comment">// TODO: implement</span>
</span>
<span class="line" id="L50">optimize: OptimizeMode = .low_alloc,</span>
<span class="line" id="L51"></span>
<span class="line" id="L52">on_crash_fn: OnCrashFn = defaultCrash,</span>
<span class="line" id="L53">on_ent_overflow: OnEntOverflow = .crash,</span>
<span class="line" id="L54"></span>
<span class="line" id="L55"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OnCrashFn = <span class="tok-kw">fn</span> (ztg.Commands, ztg.CrashReason) <span class="tok-type">anyerror</span>!<span class="tok-type">void</span>;</span>
<span class="line" id="L56"></span>
<span class="line" id="L57"><span class="tok-comment">// TODO: implement</span>
</span>
<span class="line" id="L58"><span class="tok-kw">const</span> OptimizeMode = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L59">    <span class="tok-comment">/// (DEFAULT) Pre-allocates everything with a known max. Reduces the number of allocations per frame greatly, but can use a lot of memory with large components</span></span>
<span class="line" id="L60">    low_alloc,</span>
<span class="line" id="L61">    <span class="tok-comment">/// Pre-allocates everything except component data</span></span>
<span class="line" id="L62">    low_component_mem,</span>
<span class="line" id="L63">    <span class="tok-comment">/// Only allocates when necessary</span></span>
<span class="line" id="L64">    low_mem,</span>
<span class="line" id="L65">};</span>
<span class="line" id="L66"></span>
<span class="line" id="L67"><span class="tok-kw">const</span> OnEntOverflow = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L68">    <span class="tok-comment">/// Invokes OnCrashFn with the CrashReason of .hit_ent_limit</span></span>
<span class="line" id="L69">    crash,</span>
<span class="line" id="L70">    <span class="tok-comment">/// Takes the last entity spawned, strips it of its components, and returns it</span></span>
<span class="line" id="L71">    overwrite_last,</span>
<span class="line" id="L72">    <span class="tok-comment">/// Takes the first entity spawned, strips it of its components, and returns it</span></span>
<span class="line" id="L73">    overwrite_first,</span>
<span class="line" id="L74">};</span>
<span class="line" id="L75"></span>
<span class="line" id="L76"><span class="tok-comment">/// Passes `includes` to `self.include(...)`</span></span>
<span class="line" id="L77"><span class="tok-comment">/// Also adds `Allocator` and `Random` resources</span></span>
<span class="line" id="L78"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(<span class="tok-kw">comptime</span> includes: []<span class="tok-kw">const</span> <span class="tok-type">type</span>) Self {</span>
<span class="line" id="L79">    <span class="tok-kw">var</span> self = Self{};</span>
<span class="line" id="L80"></span>
<span class="line" id="L81">    <span class="tok-kw">for</span> (<span class="tok-builtin">@typeInfo</span>(default_stages).Struct.decls) |decl| {</span>
<span class="line" id="L82">        self.stage_defs.append(.{</span>
<span class="line" id="L83">            .name = decl.name,</span>
<span class="line" id="L84">            .labels = ztg.meta.ComptimeList(StageLabel).fromSlice(&amp;.{.{ .name = <span class="tok-str">&quot;body&quot;</span> }}),</span>
<span class="line" id="L85">        });</span>
<span class="line" id="L86">    }</span>
<span class="line" id="L87"></span>
<span class="line" id="L88">    self.addResource(std.mem.Allocator, <span class="tok-null">undefined</span>);</span>
<span class="line" id="L89">    self.addResource(ztg.FrameAlloc, <span class="tok-null">undefined</span>);</span>
<span class="line" id="L90">    self.addResource(std.rand.Random, <span class="tok-null">undefined</span>);</span>
<span class="line" id="L91">    self.include(includes);</span>
<span class="line" id="L92"></span>
<span class="line" id="L93">    <span class="tok-kw">return</span> self;</span>
<span class="line" id="L94">}</span>
<span class="line" id="L95"></span>
<span class="line" id="L96"><span class="tok-comment">/// Calls `include(comptime wb: *WorldBuilder) (!)void` on all structs passed into the `includes` slice.</span></span>
<span class="line" id="L97"><span class="tok-comment">/// `.init(...)` passes it's arguments to this function.</span></span>
<span class="line" id="L98"><span class="tok-comment">///</span></span>
<span class="line" id="L99"><span class="tok-comment">/// You can include a struct more than once without errors/warnings, it's effects will only be applied once.</span></span>
<span class="line" id="L100"><span class="tok-comment">///</span></span>
<span class="line" id="L101"><span class="tok-comment">/// Example:</span></span>
<span class="line" id="L102"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L103"><span class="tok-comment">/// wb.include(&amp;.{ @import(&quot;player.zig&quot;) });</span></span>
<span class="line" id="L104"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L105"><span class="tok-comment">///</span></span>
<span class="line" id="L106"><span class="tok-comment">/// `player.zig:`</span></span>
<span class="line" id="L107"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L108"><span class="tok-comment">/// pub fn include(comptime wb: *WorldBuilder) void {</span></span>
<span class="line" id="L109"><span class="tok-comment">///     wb.addComponents(&amp;.{ Player });</span></span>
<span class="line" id="L110"><span class="tok-comment">/// }</span></span>
<span class="line" id="L111"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L112"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">include</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> includes: []<span class="tok-kw">const</span> <span class="tok-type">type</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L113">    <span class="tok-kw">for</span> (includes) |TI| {</span>
<span class="line" id="L114">        <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.meta.trait.hasFn(<span class="tok-str">&quot;include&quot;</span>)(TI)) {</span>
<span class="line" id="L115">            <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> self.included.has(TI)) <span class="tok-kw">continue</span>; <span class="tok-comment">// silent fail</span>
</span>
<span class="line" id="L116"></span>
<span class="line" id="L117">            <span class="tok-kw">const</span> ti = <span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(TI.include));</span>
<span class="line" id="L118"></span>
<span class="line" id="L119">            <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> !(ti.Fn.params.len == <span class="tok-number">1</span> <span class="tok-kw">and</span> ti.Fn.params[<span class="tok-number">0</span>].<span class="tok-type">type</span>.? == *Self)) {</span>
<span class="line" id="L120">                <span class="tok-builtin">@compileError</span>(<span class="tok-builtin">@typeName</span>(TI) ++ <span class="tok-str">&quot;'s include function's signature must be fn(*WorldBuilder) (!)void&quot;</span>);</span>
<span class="line" id="L121">            }</span>
<span class="line" id="L122"></span>
<span class="line" id="L123">            <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> ztg.meta.canReturnError(<span class="tok-builtin">@TypeOf</span>(TI.include))) {</span>
<span class="line" id="L124">                TI.include(self) <span class="tok-kw">catch</span> |err| <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Cound not build world, error in include. Error: &quot;</span> ++ err);</span>
<span class="line" id="L125">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L126">                TI.include(self);</span>
<span class="line" id="L127">            }</span>
<span class="line" id="L128">            self.included.append(TI);</span>
<span class="line" id="L129">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L130">            <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Struct &quot;</span> ++ <span class="tok-builtin">@typeName</span>(TI) ++ <span class="tok-str">&quot; does not have an fn include, it should not be passed to include.&quot;</span>);</span>
<span class="line" id="L131">        }</span>
<span class="line" id="L132">    }</span>
<span class="line" id="L133">}</span>
<span class="line" id="L134"></span>
<span class="line" id="L135"><span class="tok-comment">/// Creates a new stage that can be ran and have events added to it</span></span>
<span class="line" id="L136"><span class="tok-comment">///</span></span>
<span class="line" id="L137"><span class="tok-comment">/// Example:</span></span>
<span class="line" id="L138"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L139"><span class="tok-comment">/// wb.addStage(.my_custom_stage);</span></span>
<span class="line" id="L140"><span class="tok-comment">/// wb.addSystemsToStage(.my_custom_stage, .{mySystem});</span></span>
<span class="line" id="L141"><span class="tok-comment">///</span></span>
<span class="line" id="L142"><span class="tok-comment">/// // @TypeOf(world) == wb.Build();</span></span>
<span class="line" id="L143"><span class="tok-comment">/// world.runStage(.my_custom_stage); // Prints &quot;Hello.&quot;</span></span>
<span class="line" id="L144"><span class="tok-comment">///</span></span>
<span class="line" id="L145"><span class="tok-comment">/// fn mySystem() void {</span></span>
<span class="line" id="L146"><span class="tok-comment">///   std.debug.print(&quot;Hello.\n&quot;, .{});</span></span>
<span class="line" id="L147"><span class="tok-comment">/// }</span></span>
<span class="line" id="L148"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L149"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addStage</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> stage_name: ztg.meta.EnumLiteral) <span class="tok-type">void</span> {</span>
<span class="line" id="L150">    <span class="tok-kw">for</span> (self.stage_defs.items) |sdef| {</span>
<span class="line" id="L151">        <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, sdef.name, <span class="tok-builtin">@tagName</span>(stage_name))) {</span>
<span class="line" id="L152">            self.warn(<span class="tok-str">&quot;Tried to add stage `&quot;</span> ++ sdef.name ++ <span class="tok-str">&quot;` to world more than once.&quot;</span>);</span>
<span class="line" id="L153">            <span class="tok-kw">return</span>;</span>
<span class="line" id="L154">        }</span>
<span class="line" id="L155">    }</span>
<span class="line" id="L156"></span>
<span class="line" id="L157">    self.stage_defs.append(.{</span>
<span class="line" id="L158">        .name = <span class="tok-builtin">@tagName</span>(stage_name),</span>
<span class="line" id="L159">        .labels = ztg.meta.ComptimeList(StageLabel).fromSlice(&amp;.{.{ .name = <span class="tok-str">&quot;body&quot;</span> }}),</span>
<span class="line" id="L160">    });</span>
<span class="line" id="L161">}</span>
<span class="line" id="L162"></span>
<span class="line" id="L163"><span class="tok-kw">fn</span> <span class="tok-fn">stageIndexFromName</span>(<span class="tok-kw">comptime</span> self: Self, <span class="tok-kw">comptime</span> stage_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">usize</span> {</span>
<span class="line" id="L164">    <span class="tok-comment">// if stage is part of DEFAULT_STAGES, we already know the index</span>
</span>
<span class="line" id="L165">    <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(default_stages, stage_name)) <span class="tok-kw">return</span> <span class="tok-builtin">@field</span>(default_stages, stage_name);</span>
<span class="line" id="L166"></span>
<span class="line" id="L167">    <span class="tok-kw">for</span> (self.stage_defs.items, <span class="tok-number">0</span>..) |sdef, i| {</span>
<span class="line" id="L168">        <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, sdef.name, stage_name)) {</span>
<span class="line" id="L169">            <span class="tok-kw">return</span> i;</span>
<span class="line" id="L170">        }</span>
<span class="line" id="L171">    }</span>
<span class="line" id="L172"></span>
<span class="line" id="L173">    <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Stage &quot;</span> ++ stage_name ++ <span class="tok-str">&quot; is not in world. Consider adding it with WorldBuilder.addStage&quot;</span>);</span>
<span class="line" id="L174">}</span>
<span class="line" id="L175"></span>
<span class="line" id="L176"><span class="tok-kw">fn</span> <span class="tok-fn">labelIndexFromName</span>(<span class="tok-kw">comptime</span> stage: StageDef, <span class="tok-kw">comptime</span> label_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">usize</span> {</span>
<span class="line" id="L177">    <span class="tok-kw">for</span> (stage.labels.items, <span class="tok-number">0</span>..) |label, i| {</span>
<span class="line" id="L178">        <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, label.name, label_name)) <span class="tok-kw">return</span> i;</span>
<span class="line" id="L179">    }</span>
<span class="line" id="L180">    <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Cannot find label &quot;</span> ++ label_name ++ <span class="tok-str">&quot; within stage. Consider adding it with WorldBuilder.addLabel&quot;</span>);</span>
<span class="line" id="L181">}</span>
<span class="line" id="L182"></span>
<span class="line" id="L183"><span class="tok-comment">/// Adds a new label named `label_name` to the system named `stage_name`.</span></span>
<span class="line" id="L184"><span class="tok-comment">/// This label can then be used to order your systems.</span></span>
<span class="line" id="L185"><span class="tok-comment">///</span></span>
<span class="line" id="L186"><span class="tok-comment">/// Each stage has a default label of `.body` which all systems are added</span></span>
<span class="line" id="L187"><span class="tok-comment">/// to by default.</span></span>
<span class="line" id="L188"><span class="tok-comment">///</span></span>
<span class="line" id="L189"><span class="tok-comment">/// Example:</span></span>
<span class="line" id="L190"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L191"><span class="tok-comment">/// wb.addLabel(.update, .my_early_label, .{ .before = .body });</span></span>
<span class="line" id="L192"><span class="tok-comment">/// wb.addLabel(.update, .my_label, .default); // default appends it to the end of the label list</span></span>
<span class="line" id="L193"><span class="tok-comment">///</span></span>
<span class="line" id="L194"><span class="tok-comment">/// wb.addSystemsToStage(.update, ztg.after(.my_label, mySystem));</span></span>
<span class="line" id="L195"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L196"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addLabel</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> stage_name: ztg.meta.EnumLiteral, <span class="tok-kw">comptime</span> label_name: ztg.meta.EnumLiteral, <span class="tok-kw">comptime</span> order: <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L197">    before: ztg.meta.EnumLiteral,</span>
<span class="line" id="L198">    after: ztg.meta.EnumLiteral,</span>
<span class="line" id="L199">    default,</span>
<span class="line" id="L200">}) <span class="tok-type">void</span> {</span>
<span class="line" id="L201">    <span class="tok-kw">const</span> stage_index = self.stageIndexFromName(<span class="tok-builtin">@tagName</span>(stage_name));</span>
<span class="line" id="L202">    <span class="tok-kw">var</span> stage = self.stage_defs.items[stage_index];</span>
<span class="line" id="L203"></span>
<span class="line" id="L204">    <span class="tok-kw">const</span> index = <span class="tok-kw">switch</span> (order) {</span>
<span class="line" id="L205">        .before =&gt; |label| labelIndexFromName(stage, <span class="tok-builtin">@tagName</span>(label)),</span>
<span class="line" id="L206">        .after =&gt; |label| labelIndexFromName(stage, <span class="tok-builtin">@tagName</span>(label)) + <span class="tok-number">1</span>,</span>
<span class="line" id="L207">        .default =&gt; stage.labels.items.len,</span>
<span class="line" id="L208">    };</span>
<span class="line" id="L209"></span>
<span class="line" id="L210">    stage.labels.insert(index, .{</span>
<span class="line" id="L211">        .name = <span class="tok-builtin">@tagName</span>(label_name),</span>
<span class="line" id="L212">    });</span>
<span class="line" id="L213">    self.stage_defs.replace(stage_index, stage);</span>
<span class="line" id="L214">}</span>
<span class="line" id="L215"></span>
<span class="line" id="L216"><span class="tok-comment">/// After you add a component, you can then query for it in your systems:</span></span>
<span class="line" id="L217"><span class="tok-comment">///</span></span>
<span class="line" id="L218"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L219"><span class="tok-comment">/// const Player = struct { score: usize };</span></span>
<span class="line" id="L220"><span class="tok-comment">///</span></span>
<span class="line" id="L221"><span class="tok-comment">/// // ...</span></span>
<span class="line" id="L222"><span class="tok-comment">///</span></span>
<span class="line" id="L223"><span class="tok-comment">/// wb.addComponents(&amp;.{ Player });</span></span>
<span class="line" id="L224"><span class="tok-comment">///</span></span>
<span class="line" id="L225"><span class="tok-comment">/// // ...</span></span>
<span class="line" id="L226"><span class="tok-comment">///</span></span>
<span class="line" id="L227"><span class="tok-comment">/// pub fn mySystem(q: Query(.{ Player })) void {</span></span>
<span class="line" id="L228"><span class="tok-comment">///     for (q.items(0)) |pl| {</span></span>
<span class="line" id="L229"><span class="tok-comment">///         std.debug.print(&quot;My score is {}\n&quot;, .{ pl.score });</span></span>
<span class="line" id="L230"><span class="tok-comment">///     }</span></span>
<span class="line" id="L231"><span class="tok-comment">/// }</span></span>
<span class="line" id="L232"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L233"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addComponents</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> comps: []<span class="tok-kw">const</span> <span class="tok-type">type</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L234">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (comps) |T| {</span>
<span class="line" id="L235">        <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> self.comp_types.has(T)) <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Attempted to add type `&quot;</span> ++ <span class="tok-builtin">@typeName</span>(T) ++ <span class="tok-str">&quot;` to worldbuilder more than once.&quot;</span>);</span>
<span class="line" id="L236">    }</span>
<span class="line" id="L237">    self.comp_types.appendSlice(comps);</span>
<span class="line" id="L238">}</span>
<span class="line" id="L239"></span>
<span class="line" id="L240"><span class="tok-comment">/// Resources are unique struct instances that you can request within your systems:</span></span>
<span class="line" id="L241"><span class="tok-comment">///</span></span>
<span class="line" id="L242"><span class="tok-comment">/// Example:</span></span>
<span class="line" id="L243"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L244"><span class="tok-comment">/// const Timer = struct { current: usize };</span></span>
<span class="line" id="L245"><span class="tok-comment">///</span></span>
<span class="line" id="L246"><span class="tok-comment">/// wb.addResource(Timer, .{ .current = 0 });</span></span>
<span class="line" id="L247"><span class="tok-comment">///</span></span>
<span class="line" id="L248"><span class="tok-comment">/// pub fn mySystem(timer: Timer) void {</span></span>
<span class="line" id="L249"><span class="tok-comment">///     std.debug.print(&quot;{}\n&quot;, .{ timer.current });</span></span>
<span class="line" id="L250"><span class="tok-comment">/// }</span></span>
<span class="line" id="L251"><span class="tok-comment">///</span></span>
<span class="line" id="L252"><span class="tok-comment">/// pub fn updateTimer(timer: *Timer) void {</span></span>
<span class="line" id="L253"><span class="tok-comment">///     timer.current += 1;</span></span>
<span class="line" id="L254"><span class="tok-comment">/// }</span></span>
<span class="line" id="L255"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L256"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addResource</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> default_value: T) <span class="tok-type">void</span> {</span>
<span class="line" id="L257">    <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> T == ztg.Commands) <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;`Commands` cannot be a resource type.&quot;</span>);</span>
<span class="line" id="L258">    <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.meta.trait.isContainer(T) <span class="tok-kw">and</span> (<span class="tok-builtin">@hasDecl</span>(T, <span class="tok-str">&quot;IsQueryType&quot;</span>) <span class="tok-kw">or</span> <span class="tok-builtin">@hasDecl</span>(T, <span class="tok-str">&quot;EventSendType&quot;</span>) <span class="tok-kw">or</span> <span class="tok-builtin">@hasDecl</span>(T, <span class="tok-str">&quot;EventRecvType&quot;</span>))) <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Queries and Events cannot be resources.&quot;</span>);</span>
<span class="line" id="L259"></span>
<span class="line" id="L260">    <span class="tok-kw">if</span> (self.added_resources.has(T)) {</span>
<span class="line" id="L261">        self.warn(<span class="tok-str">&quot;Tried to add resource type `&quot;</span> ++ <span class="tok-builtin">@typeName</span>(T) ++ <span class="tok-str">&quot;` to world more than once.&quot;</span>);</span>
<span class="line" id="L262">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L263">    }</span>
<span class="line" id="L264"></span>
<span class="line" id="L265">    self.added_resources.append(T);</span>
<span class="line" id="L266">    <span class="tok-kw">const</span> idx = self.added_resources.indexOf(T).?;</span>
<span class="line" id="L267">    self.resources.addField(std.fmt.comptimePrint(<span class="tok-str">&quot;{}&quot;</span>, .{idx}), T, &amp;default_value);</span>
<span class="line" id="L268">}</span>
<span class="line" id="L269"></span>
<span class="line" id="L270"><span class="tok-comment">/// Registers an event that has a payload of type `T`</span></span>
<span class="line" id="L271"><span class="tok-comment">///</span></span>
<span class="line" id="L272"><span class="tok-comment">/// Example:</span></span>
<span class="line" id="L273"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L274"><span class="tok-comment">/// const Score = struct { total: usize };</span></span>
<span class="line" id="L275"><span class="tok-comment">/// const PointsGained = struct { amount: usize };</span></span>
<span class="line" id="L276"><span class="tok-comment">///</span></span>
<span class="line" id="L277"><span class="tok-comment">/// wb.addEvent(PointsGained);</span></span>
<span class="line" id="L278"><span class="tok-comment">///</span></span>
<span class="line" id="L279"><span class="tok-comment">/// pub fn playerUpdate(q: Query(.{ Player, Transform, Box }), points_event: EventSender(PointsGained)) void {</span></span>
<span class="line" id="L280"><span class="tok-comment">///   for (q.items(0), q.items(1), q.items(2)) |pl, tr, box| {</span></span>
<span class="line" id="L281"><span class="tok-comment">///     if (pl.isTouchingCoin(tr, box)) points_event.send(.{ .amount = 50 });</span></span>
<span class="line" id="L282"><span class="tok-comment">///   }</span></span>
<span class="line" id="L283"><span class="tok-comment">/// }</span></span>
<span class="line" id="L284"><span class="tok-comment">///</span></span>
<span class="line" id="L285"><span class="tok-comment">/// pub fn scoreUpdate(score: *Score, points_event: EventReceiver(PointsGained)) void {</span></span>
<span class="line" id="L286"><span class="tok-comment">///   for (points_event.items) |pe| score.total += pe.amount;</span></span>
<span class="line" id="L287"><span class="tok-comment">/// }</span></span>
<span class="line" id="L288"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L289"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addEvent</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L290">    <span class="tok-kw">if</span> (self.event_types.has(T)) {</span>
<span class="line" id="L291">        self.warn(<span class="tok-str">&quot;Tried to add event type `&quot;</span> ++ <span class="tok-builtin">@typeName</span>(T) ++ <span class="tok-str">&quot;` to world more than once.&quot;</span>);</span>
<span class="line" id="L292">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L293">    }</span>
<span class="line" id="L294"></span>
<span class="line" id="L295">    self.event_types.append(T);</span>
<span class="line" id="L296">}</span>
<span class="line" id="L297"></span>
<span class="line" id="L298"><span class="tok-comment">/// Adds the system to the specified stage</span></span>
<span class="line" id="L299"><span class="tok-comment">///</span></span>
<span class="line" id="L300"><span class="tok-comment">/// Example:</span></span>
<span class="line" id="L301"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L302"><span class="tok-comment">/// wb.addSystemsToStage(.draw, drawPlayer);</span></span>
<span class="line" id="L303"><span class="tok-comment">/// // or for multiple</span></span>
<span class="line" id="L304"><span class="tok-comment">/// wb.addSystemsToStage(.draw, .{ drawPlayer, drawEnemy });</span></span>
<span class="line" id="L305"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L306"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addSystemsToStage</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> stage_tag: <span class="tok-builtin">@TypeOf</span>(.enum_literal), systems: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L307">    self.addSystemsToStageByName(<span class="tok-builtin">@tagName</span>(stage_tag), systems);</span>
<span class="line" id="L308">}</span>
<span class="line" id="L309"></span>
<span class="line" id="L310"><span class="tok-comment">/// Same as `addSystemsToStage` but with a string instead of an enum literal</span></span>
<span class="line" id="L311"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addSystemsToStageByName</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> stage_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, _systems: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L312">    <span class="tok-kw">const</span> systems = <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> !std.meta.trait.isTuple(<span class="tok-builtin">@TypeOf</span>(_systems))) .{_systems} <span class="tok-kw">else</span> _systems;</span>
<span class="line" id="L313">    <span class="tok-kw">const</span> stage_index = <span class="tok-kw">comptime</span> self.stageIndexFromName(stage_name);</span>
<span class="line" id="L314"></span>
<span class="line" id="L315">    <span class="tok-kw">for</span> (systems) |sys| {</span>
<span class="line" id="L316">        <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(sys))) {</span>
<span class="line" id="L317">            .Fn =&gt; self.appendToStageLabel(stage_index, <span class="tok-str">&quot;body&quot;</span>, .during, sys),</span>
<span class="line" id="L318">            .Struct =&gt; {</span>
<span class="line" id="L319">                <span class="tok-kw">if</span> (!<span class="tok-builtin">@hasField</span>(<span class="tok-builtin">@TypeOf</span>(sys), <span class="tok-str">&quot;label&quot;</span>)) <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Passed unsupported struct type to addSystems, the only supported structs come from ztg.before(), ztg.during(), and ztg.after().&quot;</span>);</span>
<span class="line" id="L320">                self.appendToStageLabel(stage_index, <span class="tok-builtin">@tagName</span>(sys.label), sys.offset, sys.f);</span>
<span class="line" id="L321">            },</span>
<span class="line" id="L322">            <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;addSystems expected a tuple of supported types, a member of that tuple was of type `&quot;</span> ++ <span class="tok-builtin">@typeName</span>(<span class="tok-builtin">@TypeOf</span>(sys)) ++ <span class="tok-str">&quot;` which is not supported.&quot;</span>),</span>
<span class="line" id="L323">        }</span>
<span class="line" id="L324">    }</span>
<span class="line" id="L325">}</span>
<span class="line" id="L326"></span>
<span class="line" id="L327"><span class="tok-kw">fn</span> <span class="tok-fn">appendToStageLabel</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> stage_index: <span class="tok-type">usize</span>, <span class="tok-kw">comptime</span> label_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, <span class="tok-kw">comptime</span> offset: ztg.SystemOrder, sys: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L328">    <span class="tok-kw">var</span> stage = self.stage_defs.items[stage_index];</span>
<span class="line" id="L329"></span>
<span class="line" id="L330">    <span class="tok-kw">const</span> label_index = labelIndexFromName(stage, label_name);</span>
<span class="line" id="L331">    <span class="tok-kw">var</span> label = stage.labels.items[label_index];</span>
<span class="line" id="L332"></span>
<span class="line" id="L333">    <span class="tok-kw">switch</span> (offset) {</span>
<span class="line" id="L334">        .before =&gt; label.before.appendTupleFieldExtra(<span class="tok-builtin">@TypeOf</span>(sys), sys, <span class="tok-null">true</span>, <span class="tok-number">0</span>),</span>
<span class="line" id="L335">        .during =&gt; label.during.appendTupleFieldExtra(<span class="tok-builtin">@TypeOf</span>(sys), sys, <span class="tok-null">true</span>, <span class="tok-number">0</span>),</span>
<span class="line" id="L336">        .after =&gt; label.after.appendTupleFieldExtra(<span class="tok-builtin">@TypeOf</span>(sys), sys, <span class="tok-null">true</span>, <span class="tok-number">0</span>),</span>
<span class="line" id="L337">    }</span>
<span class="line" id="L338"></span>
<span class="line" id="L339">    stage.labels.replace(label_index, label);</span>
<span class="line" id="L340">    self.stage_defs.replace(stage_index, stage);</span>
<span class="line" id="L341">}</span>
<span class="line" id="L342"></span>
<span class="line" id="L343"><span class="tok-comment">/// Useful for adding systems to multiple stages.</span></span>
<span class="line" id="L344"><span class="tok-comment">///</span></span>
<span class="line" id="L345"><span class="tok-comment">/// Example:</span></span>
<span class="line" id="L346"><span class="tok-comment">/// ```zig</span></span>
<span class="line" id="L347"><span class="tok-comment">/// wb.addSystems(.{</span></span>
<span class="line" id="L348"><span class="tok-comment">///   .load = .{myLoadSystem},</span></span>
<span class="line" id="L349"><span class="tok-comment">///   .update = .{myUpdateSystem},</span></span>
<span class="line" id="L350"><span class="tok-comment">///   .draw = .{myDrawSystem}</span></span>
<span class="line" id="L351"><span class="tok-comment">/// });</span></span>
<span class="line" id="L352"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L353"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addSystems</span>(<span class="tok-kw">comptime</span> self: *Self, system_lists: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L354">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (std.meta.fields(<span class="tok-builtin">@TypeOf</span>(system_lists))) |list_field| {</span>
<span class="line" id="L355">        <span class="tok-kw">if</span> (!self.hasStageName(list_field.name)) <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;Cannot add systems to stage &quot;</span> ++ list_field.name ++ <span class="tok-str">&quot; as it does not exist.&quot;</span>);</span>
<span class="line" id="L356">        <span class="tok-kw">const</span> list = <span class="tok-builtin">@field</span>(system_lists, list_field.name);</span>
<span class="line" id="L357">        self.addSystemsToStageByName(list_field.name, list);</span>
<span class="line" id="L358">    }</span>
<span class="line" id="L359">}</span>
<span class="line" id="L360"></span>
<span class="line" id="L361"><span class="tok-comment">/// Checks whether a stage with the name `stage_name` has been added</span></span>
<span class="line" id="L362"><span class="tok-comment">/// to the worldbuilder.</span></span>
<span class="line" id="L363"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">hasStageName</span>(<span class="tok-kw">comptime</span> self: *<span class="tok-kw">const</span> Self, <span class="tok-kw">comptime</span> stage_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L364">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (self.stage_defs.items) |sdef| {</span>
<span class="line" id="L365">        <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, sdef.name, stage_name)) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L366">    }</span>
<span class="line" id="L367">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L368">}</span>
<span class="line" id="L369"></span>
<span class="line" id="L370"><span class="tok-comment">/// Shorthand for `addSystemsToStage(.load, ...)`</span></span>
<span class="line" id="L371"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addLoadSystems</span>(<span class="tok-kw">comptime</span> self: *Self, systems: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L372">    addSystemsToStage(self, .load, systems);</span>
<span class="line" id="L373">}</span>
<span class="line" id="L374"></span>
<span class="line" id="L375"><span class="tok-comment">/// Shorthand for `addSystemsToStage(.update, ...)`</span></span>
<span class="line" id="L376"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addUpdateSystems</span>(<span class="tok-kw">comptime</span> self: *Self, systems: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L377">    addSystemsToStage(self, .update, systems);</span>
<span class="line" id="L378">}</span>
<span class="line" id="L379"></span>
<span class="line" id="L380"><span class="tok-comment">/// Shorthand for `addSystemsToStage(.draw, ...)`</span></span>
<span class="line" id="L381"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addDrawSystems</span>(<span class="tok-kw">comptime</span> self: *Self, systems: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L382">    addSystemsToStage(self, .draw, systems);</span>
<span class="line" id="L383">}</span>
<span class="line" id="L384"></span>
<span class="line" id="L385"><span class="tok-kw">fn</span> <span class="tok-fn">defaultCrash</span>(com: ztg.Commands, r: ztg.CrashReason) <span class="tok-type">anyerror</span>!<span class="tok-type">void</span> {</span>
<span class="line" id="L386">    _ = com;</span>
<span class="line" id="L387">    ztg.log.err(<span class="tok-str">&quot;Crashed due to: {}\n&quot;</span>, .{r});</span>
<span class="line" id="L388">}</span>
<span class="line" id="L389"></span>
<span class="line" id="L390"><span class="tok-comment">/// Returns the final World type</span></span>
<span class="line" id="L391"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Build</span>(<span class="tok-kw">comptime</span> self: Self) <span class="tok-type">type</span> {</span>
<span class="line" id="L392">    <span class="tok-kw">return</span> World(self);</span>
<span class="line" id="L393">}</span>
<span class="line" id="L394"></span>
<span class="line" id="L395"><span class="tok-kw">fn</span> <span class="tok-fn">warn</span>(<span class="tok-kw">comptime</span> self: *Self, <span class="tok-kw">comptime</span> message: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L396">    self.warnings = self.warnings ++ message ++ <span class="tok-str">&quot;\n&quot;</span>;</span>
<span class="line" id="L397">}</span>
<span class="line" id="L398"></span>
<span class="line" id="L399"><span class="tok-kw">fn</span> <span class="tok-fn">TestWorld</span>(<span class="tok-kw">comptime</span> namespace: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L400">    <span class="tok-kw">return</span> Self.init(&amp;.{namespace}).Build();</span>
<span class="line" id="L401">}</span>
<span class="line" id="L402"></span>
<span class="line" id="L403"><span class="tok-kw">fn</span> <span class="tok-fn">testWorld</span>(<span class="tok-kw">comptime</span> namespace: <span class="tok-type">type</span>) !*TestWorld(namespace) {</span>
<span class="line" id="L404">    <span class="tok-kw">return</span> TestWorld(namespace).init(std.testing.allocator);</span>
<span class="line" id="L405">}</span>
<span class="line" id="L406"></span>
<span class="line" id="L407"><span class="tok-kw">test</span> Self {</span>
<span class="line" id="L408">    <span class="tok-kw">var</span> w = <span class="tok-kw">try</span> testWorld(ztg.base);</span>
<span class="line" id="L409">    <span class="tok-kw">defer</span> w.deinit();</span>
<span class="line" id="L410">}</span>
<span class="line" id="L411"></span>
<span class="line" id="L412"><span class="tok-kw">test</span> addComponents {</span>
<span class="line" id="L413">    <span class="tok-kw">var</span> w = <span class="tok-kw">try</span> testWorld(<span class="tok-kw">struct</span> {</span>
<span class="line" id="L414">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">include</span>(<span class="tok-kw">comptime</span> wb: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L415">            wb.addComponents(&amp;.{ MyComponent, MyEmpty, MyEnum, MyUnion });</span>
<span class="line" id="L416">        }</span>
<span class="line" id="L417"></span>
<span class="line" id="L418">        <span class="tok-kw">const</span> MyComponent = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L419">            value: <span class="tok-type">i32</span>,</span>
<span class="line" id="L420">        };</span>
<span class="line" id="L421"></span>
<span class="line" id="L422">        <span class="tok-kw">const</span> MyEmpty = <span class="tok-kw">struct</span> {};</span>
<span class="line" id="L423"></span>
<span class="line" id="L424">        <span class="tok-kw">const</span> MyEnum = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L425">            a,</span>
<span class="line" id="L426">            b,</span>
<span class="line" id="L427">        };</span>
<span class="line" id="L428"></span>
<span class="line" id="L429">        <span class="tok-kw">const</span> MyUnion = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L430">            a: <span class="tok-type">i32</span>,</span>
<span class="line" id="L431">            b: <span class="tok-type">bool</span>,</span>
<span class="line" id="L432">        };</span>
<span class="line" id="L433">    });</span>
<span class="line" id="L434">    <span class="tok-kw">defer</span> w.deinit();</span>
<span class="line" id="L435">}</span>
<span class="line" id="L436"></span>
<span class="line" id="L437"><span class="tok-kw">test</span> addStage {</span>
<span class="line" id="L438">    <span class="tok-kw">const</span> namespace = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L439">        <span class="tok-kw">var</span> stage_was_run: <span class="tok-type">bool</span> = <span class="tok-null">false</span>;</span>
<span class="line" id="L440"></span>
<span class="line" id="L441">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">include</span>(<span class="tok-kw">comptime</span> wb: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L442">            wb.addStage(.my_stage);</span>
<span class="line" id="L443">            wb.addSystemsToStage(.my_stage, mySystem);</span>
<span class="line" id="L444">            <span class="tok-kw">try</span> std.testing.expect(wb.hasStageName(<span class="tok-str">&quot;my_stage&quot;</span>));</span>
<span class="line" id="L445">        }</span>
<span class="line" id="L446"></span>
<span class="line" id="L447">        <span class="tok-kw">fn</span> <span class="tok-fn">mySystem</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L448">            stage_was_run = <span class="tok-null">true</span>;</span>
<span class="line" id="L449">        }</span>
<span class="line" id="L450">    };</span>
<span class="line" id="L451"></span>
<span class="line" id="L452">    <span class="tok-kw">var</span> w = <span class="tok-kw">try</span> testWorld(namespace);</span>
<span class="line" id="L453">    <span class="tok-kw">defer</span> w.deinit();</span>
<span class="line" id="L454"></span>
<span class="line" id="L455">    <span class="tok-kw">try</span> w.runStage(.my_stage);</span>
<span class="line" id="L456">    <span class="tok-kw">try</span> std.testing.expect(namespace.stage_was_run);</span>
<span class="line" id="L457">}</span>
<span class="line" id="L458"></span>
<span class="line" id="L459"><span class="tok-kw">test</span> <span class="tok-str">&quot;adding systems&quot;</span> {</span>
<span class="line" id="L460">    <span class="tok-kw">const</span> namespace = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L461">        <span class="tok-kw">var</span> stages_were_run: [<span class="tok-number">6</span>]<span class="tok-type">bool</span> = .{<span class="tok-null">false</span>} ** <span class="tok-number">6</span>;</span>
<span class="line" id="L462"></span>
<span class="line" id="L463">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">include</span>(<span class="tok-kw">comptime</span> wb: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L464">            wb.addSystemsToStage(.load, sys0);</span>
<span class="line" id="L465">            wb.addSystemsToStageByName(<span class="tok-str">&quot;load&quot;</span>, sys1);</span>
<span class="line" id="L466">            wb.addSystems(.{ .load = sys2 });</span>
<span class="line" id="L467">            wb.addLoadSystems(load);</span>
<span class="line" id="L468">            wb.addUpdateSystems(update);</span>
<span class="line" id="L469">            wb.addDrawSystems(draw);</span>
<span class="line" id="L470">        }</span>
<span class="line" id="L471"></span>
<span class="line" id="L472">        <span class="tok-kw">fn</span> <span class="tok-fn">sys0</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L473">            stages_were_run[<span class="tok-number">0</span>] = <span class="tok-null">true</span>;</span>
<span class="line" id="L474">        }</span>
<span class="line" id="L475"></span>
<span class="line" id="L476">        <span class="tok-kw">fn</span> <span class="tok-fn">sys1</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L477">            stages_were_run[<span class="tok-number">1</span>] = <span class="tok-null">true</span>;</span>
<span class="line" id="L478">        }</span>
<span class="line" id="L479"></span>
<span class="line" id="L480">        <span class="tok-kw">fn</span> <span class="tok-fn">sys2</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L481">            stages_were_run[<span class="tok-number">2</span>] = <span class="tok-null">true</span>;</span>
<span class="line" id="L482">        }</span>
<span class="line" id="L483"></span>
<span class="line" id="L484">        <span class="tok-kw">fn</span> <span class="tok-fn">load</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L485">            stages_were_run[<span class="tok-number">3</span>] = <span class="tok-null">true</span>;</span>
<span class="line" id="L486">        }</span>
<span class="line" id="L487"></span>
<span class="line" id="L488">        <span class="tok-kw">fn</span> <span class="tok-fn">update</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L489">            stages_were_run[<span class="tok-number">4</span>] = <span class="tok-null">true</span>;</span>
<span class="line" id="L490">        }</span>
<span class="line" id="L491"></span>
<span class="line" id="L492">        <span class="tok-kw">fn</span> <span class="tok-fn">draw</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L493">            stages_were_run[<span class="tok-number">5</span>] = <span class="tok-null">true</span>;</span>
<span class="line" id="L494">        }</span>
<span class="line" id="L495">    };</span>
<span class="line" id="L496"></span>
<span class="line" id="L497">    <span class="tok-kw">var</span> w = <span class="tok-kw">try</span> testWorld(namespace);</span>
<span class="line" id="L498">    <span class="tok-kw">defer</span> w.deinit();</span>
<span class="line" id="L499"></span>
<span class="line" id="L500">    <span class="tok-kw">try</span> w.runStage(.load);</span>
<span class="line" id="L501">    <span class="tok-kw">try</span> w.runUpdateStages();</span>
<span class="line" id="L502">    <span class="tok-kw">try</span> w.runStage(.draw);</span>
<span class="line" id="L503"></span>
<span class="line" id="L504">    <span class="tok-kw">try</span> std.testing.expect(namespace.stages_were_run[<span class="tok-number">0</span>]);</span>
<span class="line" id="L505">    <span class="tok-kw">try</span> std.testing.expect(namespace.stages_were_run[<span class="tok-number">1</span>]);</span>
<span class="line" id="L506">    <span class="tok-kw">try</span> std.testing.expect(namespace.stages_were_run[<span class="tok-number">2</span>]);</span>
<span class="line" id="L507">    <span class="tok-kw">try</span> std.testing.expect(namespace.stages_were_run[<span class="tok-number">3</span>]);</span>
<span class="line" id="L508">    <span class="tok-kw">try</span> std.testing.expect(namespace.stages_were_run[<span class="tok-number">4</span>]);</span>
<span class="line" id="L509">    <span class="tok-kw">try</span> std.testing.expect(namespace.stages_were_run[<span class="tok-number">5</span>]);</span>
<span class="line" id="L510">}</span>
<span class="line" id="L511"></span>
<span class="line" id="L512"><span class="tok-kw">test</span> addLabel {</span>
<span class="line" id="L513">    <span class="tok-kw">const</span> namespace = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L514">        <span class="tok-kw">var</span> counter: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L515"></span>
<span class="line" id="L516">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">include</span>(<span class="tok-kw">comptime</span> wb: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L517">            wb.addLabel(.load, .my_label, .{ .before = .body });</span>
<span class="line" id="L518">            wb.addSystems(.{</span>
<span class="line" id="L519">                .load = .{</span>
<span class="line" id="L520">                    load_body_during,</span>
<span class="line" id="L521">                    ztg.before(.my_label, load_my_label_before),</span>
<span class="line" id="L522">                    ztg.during(.my_label, load_my_label_during),</span>
<span class="line" id="L523">                    ztg.after(.my_label, load_my_label_after),</span>
<span class="line" id="L524">                },</span>
<span class="line" id="L525">            });</span>
<span class="line" id="L526">        }</span>
<span class="line" id="L527"></span>
<span class="line" id="L528">        <span class="tok-kw">fn</span> <span class="tok-fn">load_my_label_before</span>() !<span class="tok-type">void</span> {</span>
<span class="line" id="L529">            <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">0</span>), counter);</span>
<span class="line" id="L530">            counter += <span class="tok-number">1</span>;</span>
<span class="line" id="L531">        }</span>
<span class="line" id="L532"></span>
<span class="line" id="L533">        <span class="tok-kw">fn</span> <span class="tok-fn">load_my_label_during</span>() !<span class="tok-type">void</span> {</span>
<span class="line" id="L534">            <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">1</span>), counter);</span>
<span class="line" id="L535">            counter += <span class="tok-number">1</span>;</span>
<span class="line" id="L536">        }</span>
<span class="line" id="L537"></span>
<span class="line" id="L538">        <span class="tok-kw">fn</span> <span class="tok-fn">load_my_label_after</span>() !<span class="tok-type">void</span> {</span>
<span class="line" id="L539">            <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">2</span>), counter);</span>
<span class="line" id="L540">            counter += <span class="tok-number">1</span>;</span>
<span class="line" id="L541">        }</span>
<span class="line" id="L542"></span>
<span class="line" id="L543">        <span class="tok-kw">fn</span> <span class="tok-fn">load_body_during</span>() !<span class="tok-type">void</span> {</span>
<span class="line" id="L544">            <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">3</span>), counter);</span>
<span class="line" id="L545">            counter += <span class="tok-number">1</span>;</span>
<span class="line" id="L546">        }</span>
<span class="line" id="L547">    };</span>
<span class="line" id="L548"></span>
<span class="line" id="L549">    <span class="tok-kw">var</span> w = <span class="tok-kw">try</span> testWorld(namespace);</span>
<span class="line" id="L550">    <span class="tok-kw">defer</span> w.deinit();</span>
<span class="line" id="L551"></span>
<span class="line" id="L552">    <span class="tok-kw">try</span> w.runStage(.load);</span>
<span class="line" id="L553">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">4</span>), namespace.counter);</span>
<span class="line" id="L554">}</span>
<span class="line" id="L555"></span>
<span class="line" id="L556"><span class="tok-kw">test</span> addResource {</span>
<span class="line" id="L557">    <span class="tok-kw">const</span> MyResource = <span class="tok-kw">struct</span> { data: <span class="tok-type">i32</span> = <span class="tok-number">0</span> };</span>
<span class="line" id="L558"></span>
<span class="line" id="L559">    <span class="tok-kw">var</span> w = <span class="tok-kw">try</span> testWorld(<span class="tok-kw">struct</span> {</span>
<span class="line" id="L560">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">include</span>(<span class="tok-kw">comptime</span> wb: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L561">            wb.addResource(MyResource, .{ .data = <span class="tok-number">10</span> });</span>
<span class="line" id="L562">        }</span>
<span class="line" id="L563">    });</span>
<span class="line" id="L564">    <span class="tok-kw">defer</span> w.deinit();</span>
<span class="line" id="L565"></span>
<span class="line" id="L566">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">10</span>), w.getRes(MyResource).data);</span>
<span class="line" id="L567">}</span>
<span class="line" id="L568"></span>
<span class="line" id="L569"><span class="tok-kw">test</span> addEvent {</span>
<span class="line" id="L570">    <span class="tok-kw">const</span> MyEvent = <span class="tok-kw">struct</span> { data: <span class="tok-type">i32</span> };</span>
<span class="line" id="L571">    <span class="tok-kw">const</span> namespace = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L572">        <span class="tok-kw">var</span> system_was_run = <span class="tok-null">false</span>;</span>
<span class="line" id="L573"></span>
<span class="line" id="L574">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">include</span>(<span class="tok-kw">comptime</span> wb: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L575">            wb.addEvent(MyEvent);</span>
<span class="line" id="L576">            wb.addSystems(.{</span>
<span class="line" id="L577">                .load = .{ sendEvent, ztg.after(.body, recvEvent) },</span>
<span class="line" id="L578">            });</span>
<span class="line" id="L579">        }</span>
<span class="line" id="L580"></span>
<span class="line" id="L581">        <span class="tok-kw">fn</span> <span class="tok-fn">sendEvent</span>(send: ztg.EventSender(MyEvent)) !<span class="tok-type">void</span> {</span>
<span class="line" id="L582">            <span class="tok-kw">try</span> send.send(.{ .data = <span class="tok-number">20</span> });</span>
<span class="line" id="L583">        }</span>
<span class="line" id="L584"></span>
<span class="line" id="L585">        <span class="tok-kw">fn</span> <span class="tok-fn">recvEvent</span>(recv: ztg.EventReceiver(MyEvent)) !<span class="tok-type">void</span> {</span>
<span class="line" id="L586">            <span class="tok-kw">for</span> (recv.items) |it| <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">20</span>), it.data);</span>
<span class="line" id="L587">            system_was_run = <span class="tok-null">true</span>;</span>
<span class="line" id="L588">        }</span>
<span class="line" id="L589">    };</span>
<span class="line" id="L590"></span>
<span class="line" id="L591">    <span class="tok-kw">var</span> w = <span class="tok-kw">try</span> testWorld(namespace);</span>
<span class="line" id="L592">    <span class="tok-kw">defer</span> w.deinit();</span>
<span class="line" id="L593"></span>
<span class="line" id="L594">    <span class="tok-kw">try</span> w.runStage(.load);</span>
<span class="line" id="L595">    <span class="tok-kw">try</span> std.testing.expect(namespace.system_was_run);</span>
<span class="line" id="L596">}</span>
<span class="line" id="L597"></span>
</code></pre></body>
</html>