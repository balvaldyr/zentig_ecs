<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>zmath.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">// ==============================================================================</span>
</span>
<span class="line" id="L2"><span class="tok-comment">//</span>
</span>
<span class="line" id="L3"><span class="tok-comment">// SIMD math library for game developers</span>
</span>
<span class="line" id="L4"><span class="tok-comment">// https://github.com/michal-z/zig-gamedev/tree/main/libs/zmath</span>
</span>
<span class="line" id="L5"><span class="tok-comment">//</span>
</span>
<span class="line" id="L6"><span class="tok-comment">// Should work on all OSes supported by Zig. Works on x86_64 and ARM.</span>
</span>
<span class="line" id="L7"><span class="tok-comment">// Provides ~140 optimized routines and ~70 extensive tests.</span>
</span>
<span class="line" id="L8"><span class="tok-comment">// Can be used with any graphics API.</span>
</span>
<span class="line" id="L9"><span class="tok-comment">//</span>
</span>
<span class="line" id="L10"><span class="tok-comment">// zmath uses row-major matrices, row vectors (each row vector is stored in a SIMD register).</span>
</span>
<span class="line" id="L11"><span class="tok-comment">// Handedness is determined by which function version is used (Rh vs. Lh),</span>
</span>
<span class="line" id="L12"><span class="tok-comment">// otherwise the function works with either left-handed or right-handed view coordinates.</span>
</span>
<span class="line" id="L13"><span class="tok-comment">//</span>
</span>
<span class="line" id="L14"><span class="tok-comment">// const va = f32x4(1.0, 2.0, 3.0, 1.0);</span>
</span>
<span class="line" id="L15"><span class="tok-comment">// const vb = f32x4(-1.0, 1.0, -1.0, 1.0);</span>
</span>
<span class="line" id="L16"><span class="tok-comment">// const v0 = va + vb - f32x4(0.0, 1.0, 0.0, 1.0) * f32x4s(3.0);</span>
</span>
<span class="line" id="L17"><span class="tok-comment">// const v1 = cross3(va, vb) + f32x4(1.0, 1.0, 1.0, 1.0);</span>
</span>
<span class="line" id="L18"><span class="tok-comment">// const v2 = va + dot3(va, vb) / v1; // dotN() returns scalar replicated on all vector components</span>
</span>
<span class="line" id="L19"><span class="tok-comment">//</span>
</span>
<span class="line" id="L20"><span class="tok-comment">// const m = rotationX(math.pi * 0.25);</span>
</span>
<span class="line" id="L21"><span class="tok-comment">// const v = f32x4(...);</span>
</span>
<span class="line" id="L22"><span class="tok-comment">// const v0 = mul(v, m); // 'v' treated as a row vector</span>
</span>
<span class="line" id="L23"><span class="tok-comment">// const v1 = mul(m, v); // 'v' treated as a column vector</span>
</span>
<span class="line" id="L24"><span class="tok-comment">// const f = m[row][column];</span>
</span>
<span class="line" id="L25"><span class="tok-comment">//</span>
</span>
<span class="line" id="L26"><span class="tok-comment">// const b = va &lt; vb;</span>
</span>
<span class="line" id="L27"><span class="tok-comment">// if (all(b, 0)) { ... } // '0' means check all vector components; if all are 'true'</span>
</span>
<span class="line" id="L28"><span class="tok-comment">// if (all(b, 3)) { ... } // '3' means check first three vector components; if all first three are 'true'</span>
</span>
<span class="line" id="L29"><span class="tok-comment">// if (any(b, 0)) { ... } // '0' means check all vector components; if any is 'true'</span>
</span>
<span class="line" id="L30"><span class="tok-comment">// if (any(b, 3)) { ... } // '3' means check first three vector components; if any from first three is 'true'</span>
</span>
<span class="line" id="L31"><span class="tok-comment">//</span>
</span>
<span class="line" id="L32"><span class="tok-comment">// var v4 = load(mem[0..], F32x4, 0);</span>
</span>
<span class="line" id="L33"><span class="tok-comment">// var v8 = load(mem[100..], F32x8, 0);</span>
</span>
<span class="line" id="L34"><span class="tok-comment">// var v16 = load(mem[200..], F32x16, 0);</span>
</span>
<span class="line" id="L35"><span class="tok-comment">//</span>
</span>
<span class="line" id="L36"><span class="tok-comment">// var camera_position = [3]f32{ 1.0, 2.0, 3.0 };</span>
</span>
<span class="line" id="L37"><span class="tok-comment">// var cam_pos = loadArr3(camera_position);</span>
</span>
<span class="line" id="L38"><span class="tok-comment">// ...</span>
</span>
<span class="line" id="L39"><span class="tok-comment">// storeArr3(&amp;camera_position, cam_pos);</span>
</span>
<span class="line" id="L40"><span class="tok-comment">//</span>
</span>
<span class="line" id="L41"><span class="tok-comment">// v4 = sin(v4); // SIMDx4</span>
</span>
<span class="line" id="L42"><span class="tok-comment">// v8 = cos(v8); // .x86_64 -&gt; 2 x SIMDx4, .x86_64+avx+fma -&gt; SIMDx8</span>
</span>
<span class="line" id="L43"><span class="tok-comment">// v16 = atan(v16); // .x86_64 -&gt; 4 x SIMDx4, .x86_64+avx+fma -&gt; 2 x SIMDx8, .x86_64+avx512f -&gt; SIMDx16</span>
</span>
<span class="line" id="L44"><span class="tok-comment">//</span>
</span>
<span class="line" id="L45"><span class="tok-comment">// store(mem[0..], v4, 0);</span>
</span>
<span class="line" id="L46"><span class="tok-comment">// store(mem[100..], v8, 0);</span>
</span>
<span class="line" id="L47"><span class="tok-comment">// store(mem[200..], v16, 0);</span>
</span>
<span class="line" id="L48"><span class="tok-comment">//</span>
</span>
<span class="line" id="L49"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L50"><span class="tok-comment">// 1. Initialization functions</span>
</span>
<span class="line" id="L51"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L52"><span class="tok-comment">//</span>
</span>
<span class="line" id="L53"><span class="tok-comment">// f32x4(e0: f32, e1: f32, e2: f32, e3: f32) F32x4</span>
</span>
<span class="line" id="L54"><span class="tok-comment">// f32x8(e0: f32, e1: f32, e2: f32, e3: f32, e4: f32, e5: f32, e6: f32, e7: f32) F32x8</span>
</span>
<span class="line" id="L55"><span class="tok-comment">// f32x16(e0: f32, e1: f32, e2: f32, e3: f32, e4: f32, e5: f32, e6: f32, e7: f32,</span>
</span>
<span class="line" id="L56"><span class="tok-comment">//        e8: f32, e9: f32, ea: f32, eb: f32, ec: f32, ed: f32, ee: f32, ef: f32) F32x16</span>
</span>
<span class="line" id="L57"><span class="tok-comment">//</span>
</span>
<span class="line" id="L58"><span class="tok-comment">// f32x4s(e0: f32) F32x4</span>
</span>
<span class="line" id="L59"><span class="tok-comment">// f32x8s(e0: f32) F32x8</span>
</span>
<span class="line" id="L60"><span class="tok-comment">// f32x16s(e0: f32) F32x16</span>
</span>
<span class="line" id="L61"><span class="tok-comment">//</span>
</span>
<span class="line" id="L62"><span class="tok-comment">// boolx4(e0: bool, e1: bool, e2: bool, e3: bool) Boolx4</span>
</span>
<span class="line" id="L63"><span class="tok-comment">// boolx8(e0: bool, e1: bool, e2: bool, e3: bool, e4: bool, e5: bool, e6: bool, e7: bool) Boolx8</span>
</span>
<span class="line" id="L64"><span class="tok-comment">// boolx16(e0: bool, e1: bool, e2: bool, e3: bool, e4: bool, e5: bool, e6: bool, e7: bool,</span>
</span>
<span class="line" id="L65"><span class="tok-comment">//         e8: bool, e9: bool, ea: bool, eb: bool, ec: bool, ed: bool, ee: bool, ef: bool) Boolx16</span>
</span>
<span class="line" id="L66"><span class="tok-comment">//</span>
</span>
<span class="line" id="L67"><span class="tok-comment">// load(mem: []const f32, comptime T: type, comptime len: u32) T</span>
</span>
<span class="line" id="L68"><span class="tok-comment">// store(mem: []f32, v: anytype, comptime len: u32) void</span>
</span>
<span class="line" id="L69"><span class="tok-comment">//</span>
</span>
<span class="line" id="L70"><span class="tok-comment">// loadArr2(arr: [2]f32) F32x4</span>
</span>
<span class="line" id="L71"><span class="tok-comment">// loadArr2zw(arr: [2]f32, z: f32, w: f32) F32x4</span>
</span>
<span class="line" id="L72"><span class="tok-comment">// loadArr3(arr: [3]f32) F32x4</span>
</span>
<span class="line" id="L73"><span class="tok-comment">// loadArr3w(arr: [3]f32, w: f32) F32x4</span>
</span>
<span class="line" id="L74"><span class="tok-comment">// loadArr4(arr: [4]f32) F32x4</span>
</span>
<span class="line" id="L75"><span class="tok-comment">//</span>
</span>
<span class="line" id="L76"><span class="tok-comment">// storeArr2(arr: *[2]f32, v: F32x4) void</span>
</span>
<span class="line" id="L77"><span class="tok-comment">// storeArr3(arr: *[3]f32, v: F32x4) void</span>
</span>
<span class="line" id="L78"><span class="tok-comment">// storeArr4(arr: *[4]f32, v: F32x4) void</span>
</span>
<span class="line" id="L79"><span class="tok-comment">//</span>
</span>
<span class="line" id="L80"><span class="tok-comment">// arr3Ptr(ptr: anytype) *const [3]f32</span>
</span>
<span class="line" id="L81"><span class="tok-comment">// arrNPtr(ptr: anytype) [*]const f32</span>
</span>
<span class="line" id="L82"><span class="tok-comment">//</span>
</span>
<span class="line" id="L83"><span class="tok-comment">// splat(comptime T: type, value: f32) T</span>
</span>
<span class="line" id="L84"><span class="tok-comment">// splatInt(comptime T: type, value: u32) T</span>
</span>
<span class="line" id="L85"><span class="tok-comment">//</span>
</span>
<span class="line" id="L86"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L87"><span class="tok-comment">// 2. Functions that work on all vector components (F32xN = F32x4 or F32x8 or F32x16)</span>
</span>
<span class="line" id="L88"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L89"><span class="tok-comment">//</span>
</span>
<span class="line" id="L90"><span class="tok-comment">// all(vb: anytype, comptime len: u32) bool</span>
</span>
<span class="line" id="L91"><span class="tok-comment">// any(vb: anytype, comptime len: u32) bool</span>
</span>
<span class="line" id="L92"><span class="tok-comment">//</span>
</span>
<span class="line" id="L93"><span class="tok-comment">// isNearEqual(v0: F32xN, v1: F32xN, epsilon: F32xN) BoolxN</span>
</span>
<span class="line" id="L94"><span class="tok-comment">// isNan(v: F32xN) BoolxN</span>
</span>
<span class="line" id="L95"><span class="tok-comment">// isInf(v: F32xN) BoolxN</span>
</span>
<span class="line" id="L96"><span class="tok-comment">// isInBounds(v: F32xN, bounds: F32xN) BoolxN</span>
</span>
<span class="line" id="L97"><span class="tok-comment">//</span>
</span>
<span class="line" id="L98"><span class="tok-comment">// andInt(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L99"><span class="tok-comment">// andNotInt(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L100"><span class="tok-comment">// orInt(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L101"><span class="tok-comment">// norInt(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L102"><span class="tok-comment">// xorInt(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L103"><span class="tok-comment">//</span>
</span>
<span class="line" id="L104"><span class="tok-comment">// minFast(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L105"><span class="tok-comment">// maxFast(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L106"><span class="tok-comment">// min(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L107"><span class="tok-comment">// max(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L108"><span class="tok-comment">// round(v: F32xN) F32xN</span>
</span>
<span class="line" id="L109"><span class="tok-comment">// floor(v: F32xN) F32xN</span>
</span>
<span class="line" id="L110"><span class="tok-comment">// trunc(v: F32xN) F32xN</span>
</span>
<span class="line" id="L111"><span class="tok-comment">// ceil(v: F32xN) F32xN</span>
</span>
<span class="line" id="L112"><span class="tok-comment">// clamp(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L113"><span class="tok-comment">// clampFast(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L114"><span class="tok-comment">// saturate(v: F32xN) F32xN</span>
</span>
<span class="line" id="L115"><span class="tok-comment">// saturateFast(v: F32xN) F32xN</span>
</span>
<span class="line" id="L116"><span class="tok-comment">// lerp(v0: F32xN, v1: F32xN, t: f32) F32xN</span>
</span>
<span class="line" id="L117"><span class="tok-comment">// lerpV(v0: F32xN, v1: F32xN, t: F32xN) F32xN</span>
</span>
<span class="line" id="L118"><span class="tok-comment">// lerpInverse(v0: F32xN, v1: F32xN, t: f32) F32xN</span>
</span>
<span class="line" id="L119"><span class="tok-comment">// lerpInverseV(v0: F32xN, v1: F32xN, t: F32xN) F32xN</span>
</span>
<span class="line" id="L120"><span class="tok-comment">// mapLinear(v: F32xN, min1: f32, max1: f32, min2: f32, max2: f32) F32xN</span>
</span>
<span class="line" id="L121"><span class="tok-comment">// mapLinearV(v: F32xN, min1: F32xN, max1: F32xN, min2: F32xN, max2: F32xN) F32xN</span>
</span>
<span class="line" id="L122"><span class="tok-comment">// sqrt(v: F32xN) F32xN</span>
</span>
<span class="line" id="L123"><span class="tok-comment">// abs(v: F32xN) F32xN</span>
</span>
<span class="line" id="L124"><span class="tok-comment">// mod(v0: F32xN, v1: F32xN) F32xN</span>
</span>
<span class="line" id="L125"><span class="tok-comment">// modAngle(v: F32xN) F32xN</span>
</span>
<span class="line" id="L126"><span class="tok-comment">// mulAdd(v0: F32xN, v1: F32xN, v2: F32xN) F32xN</span>
</span>
<span class="line" id="L127"><span class="tok-comment">// select(mask: BoolxN, v0: F32xN, v1: F32xN)</span>
</span>
<span class="line" id="L128"><span class="tok-comment">// sin(v: F32xN) F32xN</span>
</span>
<span class="line" id="L129"><span class="tok-comment">// cos(v: F32xN) F32xN</span>
</span>
<span class="line" id="L130"><span class="tok-comment">// sincos(v: F32xN) [2]F32xN</span>
</span>
<span class="line" id="L131"><span class="tok-comment">// asin(v: F32xN) F32xN</span>
</span>
<span class="line" id="L132"><span class="tok-comment">// acos(v: F32xN) F32xN</span>
</span>
<span class="line" id="L133"><span class="tok-comment">// atan(v: F32xN) F32xN</span>
</span>
<span class="line" id="L134"><span class="tok-comment">// atan2(vy: F32xN, vx: F32xN) F32xN</span>
</span>
<span class="line" id="L135"><span class="tok-comment">// cmulSoa(re0: F32xN, im0: F32xN, re1: F32xN, im1: F32xN) [2]F32xN</span>
</span>
<span class="line" id="L136"><span class="tok-comment">//</span>
</span>
<span class="line" id="L137"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L138"><span class="tok-comment">// 3. 2D, 3D, 4D vector functions</span>
</span>
<span class="line" id="L139"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L140"><span class="tok-comment">//</span>
</span>
<span class="line" id="L141"><span class="tok-comment">// swizzle(v: Vec, c, c, c, c) Vec (comptime c = .x | .y | .z | .w)</span>
</span>
<span class="line" id="L142"><span class="tok-comment">// dot2(v0: Vec, v1: Vec) F32x4</span>
</span>
<span class="line" id="L143"><span class="tok-comment">// dot3(v0: Vec, v1: Vec) F32x4</span>
</span>
<span class="line" id="L144"><span class="tok-comment">// dot4(v0: Vec, v1: Vec) F32x4</span>
</span>
<span class="line" id="L145"><span class="tok-comment">// cross3(v0: Vec, v1: Vec) Vec</span>
</span>
<span class="line" id="L146"><span class="tok-comment">// lengthSq2(v: Vec) F32x4</span>
</span>
<span class="line" id="L147"><span class="tok-comment">// lengthSq3(v: Vec) F32x4</span>
</span>
<span class="line" id="L148"><span class="tok-comment">// lengthSq4(v: Vec) F32x4</span>
</span>
<span class="line" id="L149"><span class="tok-comment">// length2(v: Vec) F32x4</span>
</span>
<span class="line" id="L150"><span class="tok-comment">// length3(v: Vec) F32x4</span>
</span>
<span class="line" id="L151"><span class="tok-comment">// length4(v: Vec) F32x4</span>
</span>
<span class="line" id="L152"><span class="tok-comment">// normalize2(v: Vec) Vec</span>
</span>
<span class="line" id="L153"><span class="tok-comment">// normalize3(v: Vec) Vec</span>
</span>
<span class="line" id="L154"><span class="tok-comment">// normalize4(v: Vec) Vec</span>
</span>
<span class="line" id="L155"><span class="tok-comment">//</span>
</span>
<span class="line" id="L156"><span class="tok-comment">// vecToArr2(v: Vec) [2]f32</span>
</span>
<span class="line" id="L157"><span class="tok-comment">// vecToArr3(v: Vec) [3]f32</span>
</span>
<span class="line" id="L158"><span class="tok-comment">// vecToArr4(v: Vec) [4]f32</span>
</span>
<span class="line" id="L159"><span class="tok-comment">//</span>
</span>
<span class="line" id="L160"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L161"><span class="tok-comment">// 4. Matrix functions</span>
</span>
<span class="line" id="L162"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L163"><span class="tok-comment">//</span>
</span>
<span class="line" id="L164"><span class="tok-comment">// identity() Mat</span>
</span>
<span class="line" id="L165"><span class="tok-comment">// mul(m0: Mat, m1: Mat) Mat</span>
</span>
<span class="line" id="L166"><span class="tok-comment">// mul(s: f32, m: Mat) Mat</span>
</span>
<span class="line" id="L167"><span class="tok-comment">// mul(m: Mat, s: f32) Mat</span>
</span>
<span class="line" id="L168"><span class="tok-comment">// mul(v: Vec, m: Mat) Vec</span>
</span>
<span class="line" id="L169"><span class="tok-comment">// mul(m: Mat, v: Vec) Vec</span>
</span>
<span class="line" id="L170"><span class="tok-comment">// transpose(m: Mat) Mat</span>
</span>
<span class="line" id="L171"><span class="tok-comment">// rotationX(angle: f32) Mat</span>
</span>
<span class="line" id="L172"><span class="tok-comment">// rotationY(angle: f32) Mat</span>
</span>
<span class="line" id="L173"><span class="tok-comment">// rotationZ(angle: f32) Mat</span>
</span>
<span class="line" id="L174"><span class="tok-comment">// translation(x: f32, y: f32, z: f32) Mat</span>
</span>
<span class="line" id="L175"><span class="tok-comment">// translationV(v: Vec) Mat</span>
</span>
<span class="line" id="L176"><span class="tok-comment">// scaling(x: f32, y: f32, z: f32) Mat</span>
</span>
<span class="line" id="L177"><span class="tok-comment">// scalingV(v: Vec) Mat</span>
</span>
<span class="line" id="L178"><span class="tok-comment">// lookToLh(eyepos: Vec, eyedir: Vec, updir: Vec) Mat</span>
</span>
<span class="line" id="L179"><span class="tok-comment">// lookAtLh(eyepos: Vec, focuspos: Vec, updir: Vec) Mat</span>
</span>
<span class="line" id="L180"><span class="tok-comment">// lookToRh(eyepos: Vec, eyedir: Vec, updir: Vec) Mat</span>
</span>
<span class="line" id="L181"><span class="tok-comment">// lookAtRh(eyepos: Vec, focuspos: Vec, updir: Vec) Mat</span>
</span>
<span class="line" id="L182"><span class="tok-comment">// perspectiveFovLh(fovy: f32, aspect: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L183"><span class="tok-comment">// perspectiveFovRh(fovy: f32, aspect: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L184"><span class="tok-comment">// perspectiveFovLhGl(fovy: f32, aspect: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L185"><span class="tok-comment">// perspectiveFovRhGl(fovy: f32, aspect: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L186"><span class="tok-comment">// orthographicLh(w: f32, h: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L187"><span class="tok-comment">// orthographicRh(w: f32, h: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L188"><span class="tok-comment">// orthographicLhGl(w: f32, h: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L189"><span class="tok-comment">// orthographicRhGl(w: f32, h: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L190"><span class="tok-comment">// orthographicOffCenterLh(left: f32, right: f32, top: f32, bottom: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L191"><span class="tok-comment">// orthographicOffCenterRh(left: f32, right: f32, top: f32, bottom: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L192"><span class="tok-comment">// orthographicOffCenterLhGl(left: f32, right: f32, top: f32, bottom: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L193"><span class="tok-comment">// orthographicOffCenterRhGl(left: f32, right: f32, top: f32, bottom: f32, near: f32, far: f32) Mat</span>
</span>
<span class="line" id="L194"><span class="tok-comment">// determinant(m: Mat) F32x4</span>
</span>
<span class="line" id="L195"><span class="tok-comment">// inverse(m: Mat) Mat</span>
</span>
<span class="line" id="L196"><span class="tok-comment">// inverseDet(m: Mat, det: ?*F32x4) Mat</span>
</span>
<span class="line" id="L197"><span class="tok-comment">// matToQuat(m: Mat) Quat</span>
</span>
<span class="line" id="L198"><span class="tok-comment">// matFromAxisAngle(axis: Vec, angle: f32) Mat</span>
</span>
<span class="line" id="L199"><span class="tok-comment">// matFromNormAxisAngle(axis: Vec, angle: f32) Mat</span>
</span>
<span class="line" id="L200"><span class="tok-comment">// matFromQuat(quat: Quat) Mat</span>
</span>
<span class="line" id="L201"><span class="tok-comment">// matFromRollPitchYaw(pitch: f32, yaw: f32, roll: f32) Mat</span>
</span>
<span class="line" id="L202"><span class="tok-comment">// matFromRollPitchYawV(angles: Vec) Mat</span>
</span>
<span class="line" id="L203"><span class="tok-comment">//</span>
</span>
<span class="line" id="L204"><span class="tok-comment">// loadMat(mem: []const f32) Mat</span>
</span>
<span class="line" id="L205"><span class="tok-comment">// loadMat43(mem: []const f32) Mat</span>
</span>
<span class="line" id="L206"><span class="tok-comment">// loadMat34(mem: []const f32) Mat</span>
</span>
<span class="line" id="L207"><span class="tok-comment">// storeMat(mem: []f32, m: Mat) void</span>
</span>
<span class="line" id="L208"><span class="tok-comment">// storeMat43(mem: []f32, m: Mat) void</span>
</span>
<span class="line" id="L209"><span class="tok-comment">// storeMat34(mem: []f32, m: Mat) void</span>
</span>
<span class="line" id="L210"><span class="tok-comment">//</span>
</span>
<span class="line" id="L211"><span class="tok-comment">// matToArr(m: Mat) [16]f32</span>
</span>
<span class="line" id="L212"><span class="tok-comment">// matToArr43(m: Mat) [12]f32</span>
</span>
<span class="line" id="L213"><span class="tok-comment">// matToArr34(m: Mat) [12]f32</span>
</span>
<span class="line" id="L214"><span class="tok-comment">//</span>
</span>
<span class="line" id="L215"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L216"><span class="tok-comment">// 5. Quaternion functions</span>
</span>
<span class="line" id="L217"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L218"><span class="tok-comment">//</span>
</span>
<span class="line" id="L219"><span class="tok-comment">// qmul(q0: Quat, q1: Quat) Quat</span>
</span>
<span class="line" id="L220"><span class="tok-comment">// qidentity() Quat</span>
</span>
<span class="line" id="L221"><span class="tok-comment">// conjugate(quat: Quat) Quat</span>
</span>
<span class="line" id="L222"><span class="tok-comment">// inverse(q: Quat) Quat</span>
</span>
<span class="line" id="L223"><span class="tok-comment">// rotate(q: Quat, v: Vec) Vec</span>
</span>
<span class="line" id="L224"><span class="tok-comment">// slerp(q0: Quat, q1: Quat, t: f32) Quat</span>
</span>
<span class="line" id="L225"><span class="tok-comment">// slerpV(q0: Quat, q1: Quat, t: F32x4) Quat</span>
</span>
<span class="line" id="L226"><span class="tok-comment">// quatToMat(quat: Quat) Mat</span>
</span>
<span class="line" id="L227"><span class="tok-comment">// quatToAxisAngle(quat: Quat, axis: *Vec, angle: *f32) void</span>
</span>
<span class="line" id="L228"><span class="tok-comment">// quatFromMat(m: Mat) Quat</span>
</span>
<span class="line" id="L229"><span class="tok-comment">// quatFromAxisAngle(axis: Vec, angle: f32) Quat</span>
</span>
<span class="line" id="L230"><span class="tok-comment">// quatFromNormAxisAngle(axis: Vec, angle: f32) Quat</span>
</span>
<span class="line" id="L231"><span class="tok-comment">// quatFromRollPitchYaw(pitch: f32, yaw: f32, roll: f32) Quat</span>
</span>
<span class="line" id="L232"><span class="tok-comment">// quatFromRollPitchYawV(angles: Vec) Quat</span>
</span>
<span class="line" id="L233"><span class="tok-comment">//</span>
</span>
<span class="line" id="L234"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L235"><span class="tok-comment">// 6. Color functions</span>
</span>
<span class="line" id="L236"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L237"><span class="tok-comment">//</span>
</span>
<span class="line" id="L238"><span class="tok-comment">// adjustSaturation(color: F32x4, saturation: f32) F32x4</span>
</span>
<span class="line" id="L239"><span class="tok-comment">// adjustContrast(color: F32x4, contrast: f32) F32x4</span>
</span>
<span class="line" id="L240"><span class="tok-comment">// rgbToHsl(rgb: F32x4) F32x4</span>
</span>
<span class="line" id="L241"><span class="tok-comment">// hslToRgb(hsl: F32x4) F32x4</span>
</span>
<span class="line" id="L242"><span class="tok-comment">// rgbToHsv(rgb: F32x4) F32x4</span>
</span>
<span class="line" id="L243"><span class="tok-comment">// hsvToRgb(hsv: F32x4) F32x4</span>
</span>
<span class="line" id="L244"><span class="tok-comment">// rgbToSrgb(rgb: F32x4) F32x4</span>
</span>
<span class="line" id="L245"><span class="tok-comment">// srgbToRgb(srgb: F32x4) F32x4</span>
</span>
<span class="line" id="L246"><span class="tok-comment">//</span>
</span>
<span class="line" id="L247"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L248"><span class="tok-comment">// X. Misc functions</span>
</span>
<span class="line" id="L249"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L250"><span class="tok-comment">//</span>
</span>
<span class="line" id="L251"><span class="tok-comment">// linePointDistance(linept0: Vec, linept1: Vec, pt: Vec) F32x4</span>
</span>
<span class="line" id="L252"><span class="tok-comment">// sin(v: f32) f32</span>
</span>
<span class="line" id="L253"><span class="tok-comment">// cos(v: f32) f32</span>
</span>
<span class="line" id="L254"><span class="tok-comment">// sincos(v: f32) [2]f32</span>
</span>
<span class="line" id="L255"><span class="tok-comment">// asin(v: f32) f32</span>
</span>
<span class="line" id="L256"><span class="tok-comment">// acos(v: f32) f32</span>
</span>
<span class="line" id="L257"><span class="tok-comment">//</span>
</span>
<span class="line" id="L258"><span class="tok-comment">// fftInitUnityTable(unitytable: []F32x4) void</span>
</span>
<span class="line" id="L259"><span class="tok-comment">// fft(re: []F32x4, im: []F32x4, unitytable: []const F32x4) void</span>
</span>
<span class="line" id="L260"><span class="tok-comment">// ifft(re: []F32x4, im: []const F32x4, unitytable: []const F32x4) void</span>
</span>
<span class="line" id="L261"><span class="tok-comment">//</span>
</span>
<span class="line" id="L262"><span class="tok-comment">// ==============================================================================</span>
</span>
<span class="line" id="L263"></span>
<span class="line" id="L264"><span class="tok-comment">// Fundamental types</span>
</span>
<span class="line" id="L265"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F32x4 = <span class="tok-builtin">@Vector</span>(<span class="tok-number">4</span>, <span class="tok-type">f32</span>);</span>
<span class="line" id="L266"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F32x8 = <span class="tok-builtin">@Vector</span>(<span class="tok-number">8</span>, <span class="tok-type">f32</span>);</span>
<span class="line" id="L267"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F32x16 = <span class="tok-builtin">@Vector</span>(<span class="tok-number">16</span>, <span class="tok-type">f32</span>);</span>
<span class="line" id="L268"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Boolx4 = <span class="tok-builtin">@Vector</span>(<span class="tok-number">4</span>, <span class="tok-type">bool</span>);</span>
<span class="line" id="L269"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Boolx8 = <span class="tok-builtin">@Vector</span>(<span class="tok-number">8</span>, <span class="tok-type">bool</span>);</span>
<span class="line" id="L270"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Boolx16 = <span class="tok-builtin">@Vector</span>(<span class="tok-number">16</span>, <span class="tok-type">bool</span>);</span>
<span class="line" id="L271"></span>
<span class="line" id="L272"><span class="tok-comment">// &quot;Higher-level&quot; aliases</span>
</span>
<span class="line" id="L273"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Vec = F32x4;</span>
<span class="line" id="L274"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Mat = [<span class="tok-number">4</span>]F32x4;</span>
<span class="line" id="L275"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Quat = F32x4;</span>
<span class="line" id="L276"></span>
<span class="line" id="L277"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L278"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L279"><span class="tok-kw">const</span> math = std.math;</span>
<span class="line" id="L280"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L281"><span class="tok-kw">const</span> expect = std.testing.expect;</span>
<span class="line" id="L282"></span>
<span class="line" id="L283"><span class="tok-kw">const</span> cpu_arch = builtin.cpu.arch;</span>
<span class="line" id="L284"><span class="tok-kw">const</span> has_avx = <span class="tok-kw">if</span> (cpu_arch == .x86_64) std.Target.x86.featureSetHas(builtin.cpu.features, .avx) <span class="tok-kw">else</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L285"><span class="tok-kw">const</span> has_avx512f = <span class="tok-kw">if</span> (cpu_arch == .x86_64) std.Target.x86.featureSetHas(builtin.cpu.features, .avx512f) <span class="tok-kw">else</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L286"><span class="tok-kw">const</span> has_fma = <span class="tok-kw">if</span> (cpu_arch == .x86_64) std.Target.x86.featureSetHas(builtin.cpu.features, .fma) <span class="tok-kw">else</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L287"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L288"><span class="tok-comment">//</span>
</span>
<span class="line" id="L289"><span class="tok-comment">// 1. Initialization functions</span>
</span>
<span class="line" id="L290"><span class="tok-comment">//</span>
</span>
<span class="line" id="L291"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L292"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">f32x4</span>(e0: <span class="tok-type">f32</span>, e1: <span class="tok-type">f32</span>, e2: <span class="tok-type">f32</span>, e3: <span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L293">    <span class="tok-kw">return</span> .{ e0, e1, e2, e3 };</span>
<span class="line" id="L294">}</span>
<span class="line" id="L295"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">f32x8</span>(e0: <span class="tok-type">f32</span>, e1: <span class="tok-type">f32</span>, e2: <span class="tok-type">f32</span>, e3: <span class="tok-type">f32</span>, e4: <span class="tok-type">f32</span>, e5: <span class="tok-type">f32</span>, e6: <span class="tok-type">f32</span>, e7: <span class="tok-type">f32</span>) F32x8 {</span>
<span class="line" id="L296">    <span class="tok-kw">return</span> .{ e0, e1, e2, e3, e4, e5, e6, e7 };</span>
<span class="line" id="L297">}</span>
<span class="line" id="L298"><span class="tok-comment">// zig fmt: off</span>
</span>
<span class="line" id="L299"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">f32x16</span>(</span>
<span class="line" id="L300">    e0: <span class="tok-type">f32</span>, e1: <span class="tok-type">f32</span>, e2: <span class="tok-type">f32</span>, e3: <span class="tok-type">f32</span>, e4: <span class="tok-type">f32</span>, e5: <span class="tok-type">f32</span>, e6: <span class="tok-type">f32</span>, e7: <span class="tok-type">f32</span>,</span>
<span class="line" id="L301">    e8: <span class="tok-type">f32</span>, e9: <span class="tok-type">f32</span>, ea: <span class="tok-type">f32</span>, eb: <span class="tok-type">f32</span>, ec: <span class="tok-type">f32</span>, ed: <span class="tok-type">f32</span>, ee: <span class="tok-type">f32</span>, ef: <span class="tok-type">f32</span>) F32x16 {</span>
<span class="line" id="L302">    <span class="tok-kw">return</span> .{ e0, e1, e2, e3, e4, e5, e6, e7, e8, e9, ea, eb, ec, ed, ee, ef };</span>
<span class="line" id="L303">}</span>
<span class="line" id="L304"><span class="tok-comment">// zig fmt: on</span>
</span>
<span class="line" id="L305"></span>
<span class="line" id="L306"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">f32x4s</span>(e0: <span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L307">    <span class="tok-kw">return</span> splat(F32x4, e0);</span>
<span class="line" id="L308">}</span>
<span class="line" id="L309"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">f32x8s</span>(e0: <span class="tok-type">f32</span>) F32x8 {</span>
<span class="line" id="L310">    <span class="tok-kw">return</span> splat(F32x8, e0);</span>
<span class="line" id="L311">}</span>
<span class="line" id="L312"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">f32x16s</span>(e0: <span class="tok-type">f32</span>) F32x16 {</span>
<span class="line" id="L313">    <span class="tok-kw">return</span> splat(F32x16, e0);</span>
<span class="line" id="L314">}</span>
<span class="line" id="L315"></span>
<span class="line" id="L316"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">boolx4</span>(e0: <span class="tok-type">bool</span>, e1: <span class="tok-type">bool</span>, e2: <span class="tok-type">bool</span>, e3: <span class="tok-type">bool</span>) Boolx4 {</span>
<span class="line" id="L317">    <span class="tok-kw">return</span> .{ e0, e1, e2, e3 };</span>
<span class="line" id="L318">}</span>
<span class="line" id="L319"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">boolx8</span>(e0: <span class="tok-type">bool</span>, e1: <span class="tok-type">bool</span>, e2: <span class="tok-type">bool</span>, e3: <span class="tok-type">bool</span>, e4: <span class="tok-type">bool</span>, e5: <span class="tok-type">bool</span>, e6: <span class="tok-type">bool</span>, e7: <span class="tok-type">bool</span>) Boolx8 {</span>
<span class="line" id="L320">    <span class="tok-kw">return</span> .{ e0, e1, e2, e3, e4, e5, e6, e7 };</span>
<span class="line" id="L321">}</span>
<span class="line" id="L322"><span class="tok-comment">// zig fmt: off</span>
</span>
<span class="line" id="L323"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">boolx16</span>(</span>
<span class="line" id="L324">    e0: <span class="tok-type">bool</span>, e1: <span class="tok-type">bool</span>, e2: <span class="tok-type">bool</span>, e3: <span class="tok-type">bool</span>, e4: <span class="tok-type">bool</span>, e5: <span class="tok-type">bool</span>, e6: <span class="tok-type">bool</span>, e7: <span class="tok-type">bool</span>,</span>
<span class="line" id="L325">    e8: <span class="tok-type">bool</span>, e9: <span class="tok-type">bool</span>, ea: <span class="tok-type">bool</span>, eb: <span class="tok-type">bool</span>, ec: <span class="tok-type">bool</span>, ed: <span class="tok-type">bool</span>, ee: <span class="tok-type">bool</span>, ef: <span class="tok-type">bool</span>) Boolx16 {</span>
<span class="line" id="L326">    <span class="tok-kw">return</span> .{ e0, e1, e2, e3, e4, e5, e6, e7, e8, e9, ea, eb, ec, ed, ee, ef };</span>
<span class="line" id="L327">}</span>
<span class="line" id="L328"><span class="tok-comment">// zig fmt: on</span>
</span>
<span class="line" id="L329"></span>
<span class="line" id="L330"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">veclen</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">comptime_int</span> {</span>
<span class="line" id="L331">    <span class="tok-kw">return</span> <span class="tok-builtin">@typeInfo</span>(T).Vector.len;</span>
<span class="line" id="L332">}</span>
<span class="line" id="L333"></span>
<span class="line" id="L334"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">splat</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, value: <span class="tok-type">f32</span>) T {</span>
<span class="line" id="L335">    <span class="tok-kw">return</span> <span class="tok-builtin">@splat</span>(value);</span>
<span class="line" id="L336">}</span>
<span class="line" id="L337"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">splatInt</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, value: <span class="tok-type">u32</span>) T {</span>
<span class="line" id="L338">    <span class="tok-kw">return</span> <span class="tok-builtin">@splat</span>(<span class="tok-builtin">@bitCast</span>(value));</span>
<span class="line" id="L339">}</span>
<span class="line" id="L340"></span>
<span class="line" id="L341"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">load</span>(mem: []<span class="tok-kw">const</span> <span class="tok-type">f32</span>, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> len: <span class="tok-type">u32</span>) T {</span>
<span class="line" id="L342">    <span class="tok-kw">var</span> v = splat(T, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L343">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> loop_len = <span class="tok-kw">if</span> (len == <span class="tok-number">0</span>) veclen(T) <span class="tok-kw">else</span> len;</span>
<span class="line" id="L344">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L345">    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; loop_len) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L346">        v[i] = mem[i];</span>
<span class="line" id="L347">    }</span>
<span class="line" id="L348">    <span class="tok-kw">return</span> v;</span>
<span class="line" id="L349">}</span>
<span class="line" id="L350"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.load&quot;</span> {</span>
<span class="line" id="L351">    <span class="tok-kw">const</span> a = [<span class="tok-number">7</span>]<span class="tok-type">f32</span>{ <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span> };</span>
<span class="line" id="L352">    <span class="tok-kw">var</span> ptr = &amp;a;</span>
<span class="line" id="L353">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L354">    <span class="tok-kw">const</span> v0 = load(a[i..], F32x4, <span class="tok-number">2</span>);</span>
<span class="line" id="L355">    <span class="tok-kw">try</span> expect(approxEqAbs(v0, F32x4{ <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span> }, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L356">    i += <span class="tok-number">2</span>;</span>
<span class="line" id="L357">    <span class="tok-kw">const</span> v1 = load(a[i .. i + <span class="tok-number">2</span>], F32x4, <span class="tok-number">2</span>);</span>
<span class="line" id="L358">    <span class="tok-kw">try</span> expect(approxEqAbs(v1, F32x4{ <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span> }, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L359">    <span class="tok-kw">const</span> v2 = load(a[<span class="tok-number">5</span>..<span class="tok-number">7</span>], F32x4, <span class="tok-number">2</span>);</span>
<span class="line" id="L360">    <span class="tok-kw">try</span> expect(approxEqAbs(v2, F32x4{ <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span> }, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L361">    <span class="tok-kw">const</span> v3 = load(ptr[<span class="tok-number">1</span>..], F32x4, <span class="tok-number">2</span>);</span>
<span class="line" id="L362">    <span class="tok-kw">try</span> expect(approxEqAbs(v3, F32x4{ <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span> }, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L363">    i += <span class="tok-number">1</span>;</span>
<span class="line" id="L364">    <span class="tok-kw">const</span> v4 = load(ptr[i .. i + <span class="tok-number">2</span>], F32x4, <span class="tok-number">2</span>);</span>
<span class="line" id="L365">    <span class="tok-kw">try</span> expect(approxEqAbs(v4, F32x4{ <span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span> }, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L366">}</span>
<span class="line" id="L367"></span>
<span class="line" id="L368"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">store</span>(mem: []<span class="tok-type">f32</span>, v: <span class="tok-kw">anytype</span>, <span class="tok-kw">comptime</span> len: <span class="tok-type">u32</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L369">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L370">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> loop_len = <span class="tok-kw">if</span> (len == <span class="tok-number">0</span>) veclen(T) <span class="tok-kw">else</span> len;</span>
<span class="line" id="L371">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L372">    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; loop_len) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L373">        mem[i] = v[i];</span>
<span class="line" id="L374">    }</span>
<span class="line" id="L375">}</span>
<span class="line" id="L376"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.store&quot;</span> {</span>
<span class="line" id="L377">    <span class="tok-kw">var</span> a = [<span class="tok-number">7</span>]<span class="tok-type">f32</span>{ <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span> };</span>
<span class="line" id="L378">    <span class="tok-kw">const</span> v = load(a[<span class="tok-number">1</span>..], F32x4, <span class="tok-number">3</span>);</span>
<span class="line" id="L379">    store(a[<span class="tok-number">2</span>..], v, <span class="tok-number">4</span>);</span>
<span class="line" id="L380">    <span class="tok-kw">try</span> expect(a[<span class="tok-number">0</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L381">    <span class="tok-kw">try</span> expect(a[<span class="tok-number">1</span>] == <span class="tok-number">2.0</span>);</span>
<span class="line" id="L382">    <span class="tok-kw">try</span> expect(a[<span class="tok-number">2</span>] == <span class="tok-number">2.0</span>);</span>
<span class="line" id="L383">    <span class="tok-kw">try</span> expect(a[<span class="tok-number">3</span>] == <span class="tok-number">3.0</span>);</span>
<span class="line" id="L384">    <span class="tok-kw">try</span> expect(a[<span class="tok-number">4</span>] == <span class="tok-number">4.0</span>);</span>
<span class="line" id="L385">    <span class="tok-kw">try</span> expect(a[<span class="tok-number">5</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L386">}</span>
<span class="line" id="L387"></span>
<span class="line" id="L388"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadArr2</span>(arr: [<span class="tok-number">2</span>]<span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L389">    <span class="tok-kw">return</span> f32x4(arr[<span class="tok-number">0</span>], arr[<span class="tok-number">1</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L390">}</span>
<span class="line" id="L391"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadArr2zw</span>(arr: [<span class="tok-number">2</span>]<span class="tok-type">f32</span>, z: <span class="tok-type">f32</span>, w: <span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L392">    <span class="tok-kw">return</span> f32x4(arr[<span class="tok-number">0</span>], arr[<span class="tok-number">1</span>], z, w);</span>
<span class="line" id="L393">}</span>
<span class="line" id="L394"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadArr3</span>(arr: [<span class="tok-number">3</span>]<span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L395">    <span class="tok-kw">return</span> f32x4(arr[<span class="tok-number">0</span>], arr[<span class="tok-number">1</span>], arr[<span class="tok-number">2</span>], <span class="tok-number">0.0</span>);</span>
<span class="line" id="L396">}</span>
<span class="line" id="L397"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadArr3w</span>(arr: [<span class="tok-number">3</span>]<span class="tok-type">f32</span>, w: <span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L398">    <span class="tok-kw">return</span> f32x4(arr[<span class="tok-number">0</span>], arr[<span class="tok-number">1</span>], arr[<span class="tok-number">2</span>], w);</span>
<span class="line" id="L399">}</span>
<span class="line" id="L400"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadArr4</span>(arr: [<span class="tok-number">4</span>]<span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L401">    <span class="tok-kw">return</span> f32x4(arr[<span class="tok-number">0</span>], arr[<span class="tok-number">1</span>], arr[<span class="tok-number">2</span>], arr[<span class="tok-number">3</span>]);</span>
<span class="line" id="L402">}</span>
<span class="line" id="L403"></span>
<span class="line" id="L404"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">storeArr2</span>(arr: *[<span class="tok-number">2</span>]<span class="tok-type">f32</span>, v: F32x4) <span class="tok-type">void</span> {</span>
<span class="line" id="L405">    arr.* = .{ v[<span class="tok-number">0</span>], v[<span class="tok-number">1</span>] };</span>
<span class="line" id="L406">}</span>
<span class="line" id="L407"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">storeArr3</span>(arr: *[<span class="tok-number">3</span>]<span class="tok-type">f32</span>, v: F32x4) <span class="tok-type">void</span> {</span>
<span class="line" id="L408">    arr.* = .{ v[<span class="tok-number">0</span>], v[<span class="tok-number">1</span>], v[<span class="tok-number">2</span>] };</span>
<span class="line" id="L409">}</span>
<span class="line" id="L410"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">storeArr4</span>(arr: *[<span class="tok-number">4</span>]<span class="tok-type">f32</span>, v: F32x4) <span class="tok-type">void</span> {</span>
<span class="line" id="L411">    arr.* = .{ v[<span class="tok-number">0</span>], v[<span class="tok-number">1</span>], v[<span class="tok-number">2</span>], v[<span class="tok-number">3</span>] };</span>
<span class="line" id="L412">}</span>
<span class="line" id="L413"></span>
<span class="line" id="L414"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">arr3Ptr</span>(ptr: <span class="tok-kw">anytype</span>) *<span class="tok-kw">const</span> [<span class="tok-number">3</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L415">    <span class="tok-kw">comptime</span> assert(<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(ptr)) == .Pointer);</span>
<span class="line" id="L416">    <span class="tok-kw">const</span> T = std.meta.Child(<span class="tok-builtin">@TypeOf</span>(ptr));</span>
<span class="line" id="L417">    <span class="tok-kw">comptime</span> assert(T == F32x4);</span>
<span class="line" id="L418">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(*<span class="tok-kw">const</span> [<span class="tok-number">3</span>]<span class="tok-type">f32</span>, <span class="tok-builtin">@ptrCast</span>(ptr));</span>
<span class="line" id="L419">}</span>
<span class="line" id="L420"></span>
<span class="line" id="L421"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">arrNPtr</span>(ptr: <span class="tok-kw">anytype</span>) [*]<span class="tok-kw">const</span> <span class="tok-type">f32</span> {</span>
<span class="line" id="L422">    <span class="tok-kw">comptime</span> assert(<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(ptr)) == .Pointer);</span>
<span class="line" id="L423">    <span class="tok-kw">const</span> T = std.meta.Child(<span class="tok-builtin">@TypeOf</span>(ptr));</span>
<span class="line" id="L424">    <span class="tok-kw">comptime</span> assert(T == Mat <span class="tok-kw">or</span> T == F32x4 <span class="tok-kw">or</span> T == F32x8 <span class="tok-kw">or</span> T == F32x16);</span>
<span class="line" id="L425">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>([*]<span class="tok-kw">const</span> <span class="tok-type">f32</span>, <span class="tok-builtin">@ptrCast</span>(ptr));</span>
<span class="line" id="L426">}</span>
<span class="line" id="L427"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.arrNPtr&quot;</span> {</span>
<span class="line" id="L428">    {</span>
<span class="line" id="L429">        <span class="tok-kw">const</span> mat = identity();</span>
<span class="line" id="L430">        <span class="tok-kw">const</span> f32ptr = arrNPtr(&amp;mat);</span>
<span class="line" id="L431">        <span class="tok-kw">try</span> expect(f32ptr[<span class="tok-number">0</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L432">        <span class="tok-kw">try</span> expect(f32ptr[<span class="tok-number">5</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L433">        <span class="tok-kw">try</span> expect(f32ptr[<span class="tok-number">10</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L434">        <span class="tok-kw">try</span> expect(f32ptr[<span class="tok-number">15</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L435">    }</span>
<span class="line" id="L436">    {</span>
<span class="line" id="L437">        <span class="tok-kw">const</span> v8 = f32x8s(<span class="tok-number">1.0</span>);</span>
<span class="line" id="L438">        <span class="tok-kw">const</span> f32ptr = arrNPtr(&amp;v8);</span>
<span class="line" id="L439">        <span class="tok-kw">try</span> expect(f32ptr[<span class="tok-number">1</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L440">        <span class="tok-kw">try</span> expect(f32ptr[<span class="tok-number">7</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L441">    }</span>
<span class="line" id="L442">}</span>
<span class="line" id="L443"></span>
<span class="line" id="L444"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.loadArr&quot;</span> {</span>
<span class="line" id="L445">    {</span>
<span class="line" id="L446">        <span class="tok-kw">const</span> camera_position = [<span class="tok-number">3</span>]<span class="tok-type">f32</span>{ <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span> };</span>
<span class="line" id="L447">        <span class="tok-kw">const</span> simd_reg = loadArr3(camera_position);</span>
<span class="line" id="L448">        <span class="tok-kw">try</span> expect(approxEqAbs(simd_reg, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L449">    }</span>
<span class="line" id="L450">    {</span>
<span class="line" id="L451">        <span class="tok-kw">const</span> camera_position = [<span class="tok-number">3</span>]<span class="tok-type">f32</span>{ <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span> };</span>
<span class="line" id="L452">        <span class="tok-kw">const</span> simd_reg = loadArr3w(camera_position, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L453">        <span class="tok-kw">try</span> expect(approxEqAbs(simd_reg, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L454">    }</span>
<span class="line" id="L455">}</span>
<span class="line" id="L456"></span>
<span class="line" id="L457"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">vecToArr2</span>(v: Vec) [<span class="tok-number">2</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L458">    <span class="tok-kw">return</span> .{ v[<span class="tok-number">0</span>], v[<span class="tok-number">1</span>] };</span>
<span class="line" id="L459">}</span>
<span class="line" id="L460"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">vecToArr3</span>(v: Vec) [<span class="tok-number">3</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L461">    <span class="tok-kw">return</span> .{ v[<span class="tok-number">0</span>], v[<span class="tok-number">1</span>], v[<span class="tok-number">2</span>] };</span>
<span class="line" id="L462">}</span>
<span class="line" id="L463"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">vecToArr4</span>(v: Vec) [<span class="tok-number">4</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L464">    <span class="tok-kw">return</span> .{ v[<span class="tok-number">0</span>], v[<span class="tok-number">1</span>], v[<span class="tok-number">2</span>], v[<span class="tok-number">3</span>] };</span>
<span class="line" id="L465">}</span>
<span class="line" id="L466"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L467"><span class="tok-comment">//</span>
</span>
<span class="line" id="L468"><span class="tok-comment">// 2. Functions that work on all vector components (F32xN = F32x4 or F32x8 or F32x16)</span>
</span>
<span class="line" id="L469"><span class="tok-comment">//</span>
</span>
<span class="line" id="L470"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L471"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">all</span>(vb: <span class="tok-kw">anytype</span>, <span class="tok-kw">comptime</span> len: <span class="tok-type">u32</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L472">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(vb);</span>
<span class="line" id="L473">    <span class="tok-kw">if</span> (len &gt; veclen(T)) {</span>
<span class="line" id="L474">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.all(): 'len' is greater than vector len of type &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T));</span>
<span class="line" id="L475">    }</span>
<span class="line" id="L476">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> loop_len = <span class="tok-kw">if</span> (len == <span class="tok-number">0</span>) veclen(T) <span class="tok-kw">else</span> len;</span>
<span class="line" id="L477">    <span class="tok-kw">const</span> ab: [veclen(T)]<span class="tok-type">bool</span> = vb;</span>
<span class="line" id="L478">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L479">    <span class="tok-kw">var</span> result = <span class="tok-null">true</span>;</span>
<span class="line" id="L480">    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; loop_len) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L481">        result = result <span class="tok-kw">and</span> ab[i];</span>
<span class="line" id="L482">    }</span>
<span class="line" id="L483">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L484">}</span>
<span class="line" id="L485"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.all&quot;</span> {</span>
<span class="line" id="L486">    <span class="tok-kw">try</span> expect(all(boolx8(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), <span class="tok-number">5</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L487">    <span class="tok-kw">try</span> expect(all(boolx8(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), <span class="tok-number">6</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L488">    <span class="tok-kw">try</span> expect(all(boolx8(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), <span class="tok-number">4</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L489">    <span class="tok-kw">try</span> expect(all(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), <span class="tok-number">3</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L490">    <span class="tok-kw">try</span> expect(all(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), <span class="tok-number">1</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L491">    <span class="tok-kw">try</span> expect(all(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), <span class="tok-number">1</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L492">    <span class="tok-kw">try</span> expect(all(boolx4(<span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), <span class="tok-number">1</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L493">    <span class="tok-kw">try</span> expect(all(boolx8(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), <span class="tok-number">0</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L494">    <span class="tok-kw">try</span> expect(all(boolx4(<span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), <span class="tok-number">0</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L495">    <span class="tok-kw">try</span> expect(all(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L496">}</span>
<span class="line" id="L497"></span>
<span class="line" id="L498"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">any</span>(vb: <span class="tok-kw">anytype</span>, <span class="tok-kw">comptime</span> len: <span class="tok-type">u32</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L499">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(vb);</span>
<span class="line" id="L500">    <span class="tok-kw">if</span> (len &gt; veclen(T)) {</span>
<span class="line" id="L501">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.any(): 'len' is greater than vector len of type &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T));</span>
<span class="line" id="L502">    }</span>
<span class="line" id="L503">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> loop_len = <span class="tok-kw">if</span> (len == <span class="tok-number">0</span>) veclen(T) <span class="tok-kw">else</span> len;</span>
<span class="line" id="L504">    <span class="tok-kw">const</span> ab: [veclen(T)]<span class="tok-type">bool</span> = vb;</span>
<span class="line" id="L505">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L506">    <span class="tok-kw">var</span> result = <span class="tok-null">false</span>;</span>
<span class="line" id="L507">    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; loop_len) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L508">        result = result <span class="tok-kw">or</span> ab[i];</span>
<span class="line" id="L509">    }</span>
<span class="line" id="L510">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L511">}</span>
<span class="line" id="L512"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.any&quot;</span> {</span>
<span class="line" id="L513">    <span class="tok-kw">try</span> expect(any(boolx8(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L514">    <span class="tok-kw">try</span> expect(any(boolx8(<span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), <span class="tok-number">3</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L515">    <span class="tok-kw">try</span> expect(any(boolx8(<span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), <span class="tok-number">4</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L516">}</span>
<span class="line" id="L517"></span>
<span class="line" id="L518"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">isNearEqual</span>(</span>
<span class="line" id="L519">    v0: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L520">    v1: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L521">    epsilon: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L522">) <span class="tok-builtin">@Vector</span>(veclen(<span class="tok-builtin">@TypeOf</span>(v0)), <span class="tok-type">bool</span>) {</span>
<span class="line" id="L523">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1, epsilon);</span>
<span class="line" id="L524">    <span class="tok-kw">const</span> delta = v0 - v1;</span>
<span class="line" id="L525">    <span class="tok-kw">const</span> temp = maxFast(delta, splat(T, <span class="tok-number">0.0</span>) - delta);</span>
<span class="line" id="L526">    <span class="tok-kw">return</span> temp &lt;= epsilon;</span>
<span class="line" id="L527">}</span>
<span class="line" id="L528"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.isNearEqual&quot;</span> {</span>
<span class="line" id="L529">    <span class="tok-kw">if</span> (builtin.target.os.tag == .macos <span class="tok-kw">and</span> builtin.zig_backend != .stage1) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SkipZigTest;</span>
<span class="line" id="L530">    {</span>
<span class="line" id="L531">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, -<span class="tok-number">3.0</span>, <span class="tok-number">4.001</span>);</span>
<span class="line" id="L532">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.1</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>);</span>
<span class="line" id="L533">        <span class="tok-kw">const</span> b = isNearEqual(v0, v1, splat(F32x4, <span class="tok-number">0.01</span>));</span>
<span class="line" id="L534">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b == boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>)));</span>
<span class="line" id="L535">    }</span>
<span class="line" id="L536">    {</span>
<span class="line" id="L537">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, -<span class="tok-number">3.0</span>, <span class="tok-number">4.001</span>, <span class="tok-number">1.001</span>, <span class="tok-number">2.3</span>, -<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L538">        <span class="tok-kw">const</span> v1 = f32x8(<span class="tok-number">1.0</span>, <span class="tok-number">2.1</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, -<span class="tok-number">1.001</span>, <span class="tok-number">2.1</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L539">        <span class="tok-kw">const</span> b = isNearEqual(v0, v1, splat(F32x8, <span class="tok-number">0.01</span>));</span>
<span class="line" id="L540">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b == boolx8(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>)));</span>
<span class="line" id="L541">    }</span>
<span class="line" id="L542">    <span class="tok-kw">try</span> expect(all(isNearEqual(</span>
<span class="line" id="L543">        splat(F32x4, math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L544">        splat(F32x4, math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L545">        splat(F32x4, <span class="tok-number">0.0001</span>),</span>
<span class="line" id="L546">    ), <span class="tok-number">0</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L547">    <span class="tok-kw">try</span> expect(all(isNearEqual(</span>
<span class="line" id="L548">        splat(F32x4, -math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L549">        splat(F32x4, math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L550">        splat(F32x4, <span class="tok-number">0.0001</span>),</span>
<span class="line" id="L551">    ), <span class="tok-number">0</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L552">    <span class="tok-kw">try</span> expect(all(isNearEqual(</span>
<span class="line" id="L553">        splat(F32x4, -math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L554">        splat(F32x4, -math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L555">        splat(F32x4, <span class="tok-number">0.0001</span>),</span>
<span class="line" id="L556">    ), <span class="tok-number">0</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L557">    <span class="tok-kw">try</span> expect(all(isNearEqual(</span>
<span class="line" id="L558">        splat(F32x4, -math.nan_f32),</span>
<span class="line" id="L559">        splat(F32x4, math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L560">        splat(F32x4, <span class="tok-number">0.0001</span>),</span>
<span class="line" id="L561">    ), <span class="tok-number">0</span>) == <span class="tok-null">false</span>);</span>
<span class="line" id="L562">}</span>
<span class="line" id="L563"></span>
<span class="line" id="L564"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">isNan</span>(</span>
<span class="line" id="L565">    v: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L566">) <span class="tok-builtin">@Vector</span>(veclen(<span class="tok-builtin">@TypeOf</span>(v)), <span class="tok-type">bool</span>) {</span>
<span class="line" id="L567">    <span class="tok-kw">return</span> v != v;</span>
<span class="line" id="L568">}</span>
<span class="line" id="L569"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.isNan&quot;</span> {</span>
<span class="line" id="L570">    {</span>
<span class="line" id="L571">        <span class="tok-kw">const</span> v0 = f32x4(math.inf(<span class="tok-type">f32</span>), math.nan_f32, math.nan_f32, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L572">        <span class="tok-kw">const</span> b = isNan(v0);</span>
<span class="line" id="L573">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b == boolx4(<span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>)));</span>
<span class="line" id="L574">    }</span>
<span class="line" id="L575">    {</span>
<span class="line" id="L576">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0</span>, math.nan_f32, <span class="tok-number">0</span>, <span class="tok-number">0</span>, math.inf(<span class="tok-type">f32</span>), math.nan_f32, math.qnan_f32, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L577">        <span class="tok-kw">const</span> b = isNan(v0);</span>
<span class="line" id="L578">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b == boolx8(<span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>)));</span>
<span class="line" id="L579">    }</span>
<span class="line" id="L580">}</span>
<span class="line" id="L581"></span>
<span class="line" id="L582"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">isInf</span>(</span>
<span class="line" id="L583">    v: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L584">) <span class="tok-builtin">@Vector</span>(veclen(<span class="tok-builtin">@TypeOf</span>(v)), <span class="tok-type">bool</span>) {</span>
<span class="line" id="L585">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L586">    <span class="tok-kw">return</span> abs(v) == splat(T, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L587">}</span>
<span class="line" id="L588"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.isInf&quot;</span> {</span>
<span class="line" id="L589">    {</span>
<span class="line" id="L590">        <span class="tok-kw">const</span> v0 = f32x4(math.inf(<span class="tok-type">f32</span>), math.nan_f32, math.qnan_f32, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L591">        <span class="tok-kw">const</span> b = isInf(v0);</span>
<span class="line" id="L592">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b == boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>)));</span>
<span class="line" id="L593">    }</span>
<span class="line" id="L594">    {</span>
<span class="line" id="L595">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0</span>, math.inf(<span class="tok-type">f32</span>), <span class="tok-number">0</span>, <span class="tok-number">0</span>, math.inf(<span class="tok-type">f32</span>), math.nan_f32, math.qnan_f32, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L596">        <span class="tok-kw">const</span> b = isInf(v0);</span>
<span class="line" id="L597">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b == boolx8(<span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>)));</span>
<span class="line" id="L598">    }</span>
<span class="line" id="L599">}</span>
<span class="line" id="L600"></span>
<span class="line" id="L601"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">isInBounds</span>(</span>
<span class="line" id="L602">    v: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L603">    bounds: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L604">) <span class="tok-builtin">@Vector</span>(veclen(<span class="tok-builtin">@TypeOf</span>(v)), <span class="tok-type">bool</span>) {</span>
<span class="line" id="L605">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v, bounds);</span>
<span class="line" id="L606">    <span class="tok-kw">const</span> Tu = <span class="tok-builtin">@Vector</span>(veclen(T), <span class="tok-type">u1</span>);</span>
<span class="line" id="L607">    <span class="tok-kw">const</span> Tr = <span class="tok-builtin">@Vector</span>(veclen(T), <span class="tok-type">bool</span>);</span>
<span class="line" id="L608"></span>
<span class="line" id="L609">    <span class="tok-comment">// 2 x cmpleps, xorps, load, andps</span>
</span>
<span class="line" id="L610">    <span class="tok-kw">const</span> b0 = v &lt;= bounds;</span>
<span class="line" id="L611">    <span class="tok-kw">const</span> b1 = (bounds * splat(T, -<span class="tok-number">1.0</span>)) &lt;= v;</span>
<span class="line" id="L612">    <span class="tok-kw">const</span> b0u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(b0));</span>
<span class="line" id="L613">    <span class="tok-kw">const</span> b1u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(b1));</span>
<span class="line" id="L614">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(Tr, <span class="tok-builtin">@bitCast</span>(b0u &amp; b1u));</span>
<span class="line" id="L615">}</span>
<span class="line" id="L616"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.isInBounds&quot;</span> {</span>
<span class="line" id="L617">    {</span>
<span class="line" id="L618">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">0.5</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.9</span>);</span>
<span class="line" id="L619">        <span class="tok-kw">const</span> v1 = f32x4(-<span class="tok-number">1.6</span>, -<span class="tok-number">2.001</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.9</span>);</span>
<span class="line" id="L620">        <span class="tok-kw">const</span> bounds = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>);</span>
<span class="line" id="L621">        <span class="tok-kw">const</span> b0 = isInBounds(v0, bounds);</span>
<span class="line" id="L622">        <span class="tok-kw">const</span> b1 = isInBounds(v1, bounds);</span>
<span class="line" id="L623">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b0 == boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>)));</span>
<span class="line" id="L624">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b1 == boolx4(<span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>)));</span>
<span class="line" id="L625">    }</span>
<span class="line" id="L626">    {</span>
<span class="line" id="L627">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.9</span>);</span>
<span class="line" id="L628">        <span class="tok-kw">const</span> bounds = f32x8(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, math.inf(<span class="tok-type">f32</span>), <span class="tok-number">1.0</span>, math.nan_f32, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>);</span>
<span class="line" id="L629">        <span class="tok-kw">const</span> b0 = isInBounds(v0, bounds);</span>
<span class="line" id="L630">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@reduce</span>(.And, b0 == boolx8(<span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>)));</span>
<span class="line" id="L631">    }</span>
<span class="line" id="L632">}</span>
<span class="line" id="L633"></span>
<span class="line" id="L634"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">andInt</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L635">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1);</span>
<span class="line" id="L636">    <span class="tok-kw">const</span> Tu = <span class="tok-builtin">@Vector</span>(veclen(T), <span class="tok-type">u32</span>);</span>
<span class="line" id="L637">    <span class="tok-kw">const</span> v0u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v0));</span>
<span class="line" id="L638">    <span class="tok-kw">const</span> v1u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v1));</span>
<span class="line" id="L639">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(T, <span class="tok-builtin">@bitCast</span>(v0u &amp; v1u)); <span class="tok-comment">// andps</span>
</span>
<span class="line" id="L640">}</span>
<span class="line" id="L641"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.andInt&quot;</span> {</span>
<span class="line" id="L642">    {</span>
<span class="line" id="L643">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))));</span>
<span class="line" id="L644">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L645">        <span class="tok-kw">const</span> v = andInt(v0, v1);</span>
<span class="line" id="L646">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L647">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">0.0</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L648">    }</span>
<span class="line" id="L649">    {</span>
<span class="line" id="L650">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))));</span>
<span class="line" id="L651">        <span class="tok-kw">const</span> v1 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L652">        <span class="tok-kw">const</span> v = andInt(v0, v1);</span>
<span class="line" id="L653">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">7</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L654">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">0.0</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L655">    }</span>
<span class="line" id="L656">}</span>
<span class="line" id="L657"></span>
<span class="line" id="L658"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">andNotInt</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L659">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1);</span>
<span class="line" id="L660">    <span class="tok-kw">const</span> Tu = <span class="tok-builtin">@Vector</span>(veclen(T), <span class="tok-type">u32</span>);</span>
<span class="line" id="L661">    <span class="tok-kw">const</span> v0u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v0));</span>
<span class="line" id="L662">    <span class="tok-kw">const</span> v1u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v1));</span>
<span class="line" id="L663">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(T, <span class="tok-builtin">@bitCast</span>(~v0u &amp; v1u)); <span class="tok-comment">// andnps</span>
</span>
<span class="line" id="L664">}</span>
<span class="line" id="L665"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.andNotInt&quot;</span> {</span>
<span class="line" id="L666">    {</span>
<span class="line" id="L667">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>);</span>
<span class="line" id="L668">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))));</span>
<span class="line" id="L669">        <span class="tok-kw">const</span> v = andNotInt(v1, v0);</span>
<span class="line" id="L670">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L671">    }</span>
<span class="line" id="L672">    {</span>
<span class="line" id="L673">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>);</span>
<span class="line" id="L674">        <span class="tok-kw">const</span> v1 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))));</span>
<span class="line" id="L675">        <span class="tok-kw">const</span> v = andNotInt(v1, v0);</span>
<span class="line" id="L676">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L677">    }</span>
<span class="line" id="L678">}</span>
<span class="line" id="L679"></span>
<span class="line" id="L680"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">orInt</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L681">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1);</span>
<span class="line" id="L682">    <span class="tok-kw">const</span> Tu = <span class="tok-builtin">@Vector</span>(veclen(T), <span class="tok-type">u32</span>);</span>
<span class="line" id="L683">    <span class="tok-kw">const</span> v0u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v0));</span>
<span class="line" id="L684">    <span class="tok-kw">const</span> v1u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v1));</span>
<span class="line" id="L685">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(T, <span class="tok-builtin">@bitCast</span>(v0u | v1u)); <span class="tok-comment">// orps</span>
</span>
<span class="line" id="L686">}</span>
<span class="line" id="L687"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.orInt&quot;</span> {</span>
<span class="line" id="L688">    {</span>
<span class="line" id="L689">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L690">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>);</span>
<span class="line" id="L691">        <span class="tok-kw">const</span> v = orInt(v0, v1);</span>
<span class="line" id="L692">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">0</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L693">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@bitCast</span>(v[<span class="tok-number">1</span>])) == ~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L694">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">2</span>] == <span class="tok-number">3.0</span>);</span>
<span class="line" id="L695">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == <span class="tok-number">4.0</span>);</span>
<span class="line" id="L696">    }</span>
<span class="line" id="L697">    {</span>
<span class="line" id="L698">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L699">        <span class="tok-kw">const</span> v1 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>);</span>
<span class="line" id="L700">        <span class="tok-kw">const</span> v = orInt(v0, v1);</span>
<span class="line" id="L701">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">4</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L702">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@bitCast</span>(v[<span class="tok-number">5</span>])) == ~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L703">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">6</span>] == <span class="tok-number">3.0</span>);</span>
<span class="line" id="L704">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">7</span>] == <span class="tok-number">4.0</span>);</span>
<span class="line" id="L705">    }</span>
<span class="line" id="L706">}</span>
<span class="line" id="L707"></span>
<span class="line" id="L708"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">norInt</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L709">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1);</span>
<span class="line" id="L710">    <span class="tok-kw">const</span> Tu = <span class="tok-builtin">@Vector</span>(veclen(T), <span class="tok-type">u32</span>);</span>
<span class="line" id="L711">    <span class="tok-kw">const</span> v0u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v0));</span>
<span class="line" id="L712">    <span class="tok-kw">const</span> v1u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v1));</span>
<span class="line" id="L713">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(T, <span class="tok-builtin">@bitCast</span>(~(v0u | v1u))); <span class="tok-comment">// por, pcmpeqd, pxor</span>
</span>
<span class="line" id="L714">}</span>
<span class="line" id="L715"></span>
<span class="line" id="L716"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">xorInt</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L717">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1);</span>
<span class="line" id="L718">    <span class="tok-kw">const</span> Tu = <span class="tok-builtin">@Vector</span>(veclen(T), <span class="tok-type">u32</span>);</span>
<span class="line" id="L719">    <span class="tok-kw">const</span> v0u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v0));</span>
<span class="line" id="L720">    <span class="tok-kw">const</span> v1u = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(v1));</span>
<span class="line" id="L721">    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(T, <span class="tok-builtin">@bitCast</span>(v0u ^ v1u)); <span class="tok-comment">// xorps</span>
</span>
<span class="line" id="L722">}</span>
<span class="line" id="L723"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.xorInt&quot;</span> {</span>
<span class="line" id="L724">    {</span>
<span class="line" id="L725">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L726">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L727">        <span class="tok-kw">const</span> v = xorInt(v0, v1);</span>
<span class="line" id="L728">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">0</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L729">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@bitCast</span>(v[<span class="tok-number">1</span>])) == ~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L730">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">2</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L731">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L732">    }</span>
<span class="line" id="L733">    {</span>
<span class="line" id="L734">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L735">        <span class="tok-kw">const</span> v1 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L736">        <span class="tok-kw">const</span> v = xorInt(v0, v1);</span>
<span class="line" id="L737">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">4</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L738">        <span class="tok-kw">try</span> expect(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@bitCast</span>(v[<span class="tok-number">5</span>])) == ~<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L739">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">6</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L740">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">7</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L741">    }</span>
<span class="line" id="L742">}</span>
<span class="line" id="L743"></span>
<span class="line" id="L744"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">minFast</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L745">    <span class="tok-kw">return</span> select(v0 &lt; v1, v0, v1); <span class="tok-comment">// minps</span>
</span>
<span class="line" id="L746">}</span>
<span class="line" id="L747"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.minFast&quot;</span> {</span>
<span class="line" id="L748">    {</span>
<span class="line" id="L749">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L750">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L751">        <span class="tok-kw">const</span> v = minFast(v0, v1);</span>
<span class="line" id="L752">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L753">    }</span>
<span class="line" id="L754">    {</span>
<span class="line" id="L755">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, math.nan_f32, <span class="tok-number">5.0</span>, math.qnan_f32);</span>
<span class="line" id="L756">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L757">        <span class="tok-kw">const</span> v = minFast(v0, v1);</span>
<span class="line" id="L758">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">0</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L759">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">1</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L760">        <span class="tok-kw">try</span> expect(!math.isNan(v[<span class="tok-number">1</span>]));</span>
<span class="line" id="L761">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">2</span>] == <span class="tok-number">4.0</span>);</span>
<span class="line" id="L762">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L763">        <span class="tok-kw">try</span> expect(!math.isNan(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L764">    }</span>
<span class="line" id="L765">}</span>
<span class="line" id="L766"></span>
<span class="line" id="L767"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">maxFast</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L768">    <span class="tok-kw">return</span> select(v0 &gt; v1, v0, v1); <span class="tok-comment">// maxps</span>
</span>
<span class="line" id="L769">}</span>
<span class="line" id="L770"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.maxFast&quot;</span> {</span>
<span class="line" id="L771">    {</span>
<span class="line" id="L772">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L773">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L774">        <span class="tok-kw">const</span> v = maxFast(v0, v1);</span>
<span class="line" id="L775">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L776">    }</span>
<span class="line" id="L777">    {</span>
<span class="line" id="L778">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, math.nan_f32, <span class="tok-number">5.0</span>, math.qnan_f32);</span>
<span class="line" id="L779">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L780">        <span class="tok-kw">const</span> v = maxFast(v0, v1);</span>
<span class="line" id="L781">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">0</span>] == <span class="tok-number">2.0</span>);</span>
<span class="line" id="L782">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">1</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L783">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">2</span>] == <span class="tok-number">5.0</span>);</span>
<span class="line" id="L784">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L785">        <span class="tok-kw">try</span> expect(!math.isNan(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L786">    }</span>
<span class="line" id="L787">}</span>
<span class="line" id="L788"></span>
<span class="line" id="L789"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">min</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L790">    <span class="tok-comment">// This will handle inf &amp; nan</span>
</span>
<span class="line" id="L791">    <span class="tok-kw">return</span> <span class="tok-builtin">@min</span>(v0, v1); <span class="tok-comment">// minps, cmpunordps, andps, andnps, orps</span>
</span>
<span class="line" id="L792">}</span>
<span class="line" id="L793"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.min&quot;</span> {</span>
<span class="line" id="L794">    <span class="tok-kw">if</span> (builtin.target.os.tag == .macos) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SkipZigTest;</span>
<span class="line" id="L795">    {</span>
<span class="line" id="L796">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L797">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L798">        <span class="tok-kw">const</span> v = min(v0, v1);</span>
<span class="line" id="L799">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L800">    }</span>
<span class="line" id="L801">    {</span>
<span class="line" id="L802">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L803">        <span class="tok-kw">const</span> v1 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L804">        <span class="tok-kw">const</span> v = min(v0, v1);</span>
<span class="line" id="L805">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x8(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L806">    }</span>
<span class="line" id="L807">    {</span>
<span class="line" id="L808">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, math.nan_f32, <span class="tok-number">5.0</span>, math.qnan_f32);</span>
<span class="line" id="L809">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L810">        <span class="tok-kw">const</span> v = min(v0, v1);</span>
<span class="line" id="L811">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">0</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L812">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">1</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L813">        <span class="tok-kw">try</span> expect(!math.isNan(v[<span class="tok-number">1</span>]));</span>
<span class="line" id="L814">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">2</span>] == <span class="tok-number">4.0</span>);</span>
<span class="line" id="L815">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L816">        <span class="tok-kw">try</span> expect(!math.isNan(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L817">    }</span>
<span class="line" id="L818">    {</span>
<span class="line" id="L819">        <span class="tok-kw">const</span> v0 = f32x4(-math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), math.qnan_f32);</span>
<span class="line" id="L820">        <span class="tok-kw">const</span> v1 = f32x4(math.qnan_f32, -math.inf(<span class="tok-type">f32</span>), math.qnan_f32, math.nan_f32);</span>
<span class="line" id="L821">        <span class="tok-kw">const</span> v = min(v0, v1);</span>
<span class="line" id="L822">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">0</span>] == -math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L823">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">1</span>] == -math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L824">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">2</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L825">        <span class="tok-kw">try</span> expect(!math.isNan(v[<span class="tok-number">2</span>]));</span>
<span class="line" id="L826">        <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L827">        <span class="tok-kw">try</span> expect(!math.isInf(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L828">    }</span>
<span class="line" id="L829">}</span>
<span class="line" id="L830"></span>
<span class="line" id="L831"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">max</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L832">    <span class="tok-comment">// This will handle inf &amp; nan</span>
</span>
<span class="line" id="L833">    <span class="tok-kw">return</span> <span class="tok-builtin">@max</span>(v0, v1); <span class="tok-comment">// maxps, cmpunordps, andps, andnps, orps</span>
</span>
<span class="line" id="L834">}</span>
<span class="line" id="L835"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.max&quot;</span> {</span>
<span class="line" id="L836">    <span class="tok-kw">if</span> (builtin.target.os.tag == .macos) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SkipZigTest;</span>
<span class="line" id="L837">    {</span>
<span class="line" id="L838">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L839">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L840">        <span class="tok-kw">const</span> v = max(v0, v1);</span>
<span class="line" id="L841">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L842">    }</span>
<span class="line" id="L843">    {</span>
<span class="line" id="L844">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">7.0</span>);</span>
<span class="line" id="L845">        <span class="tok-kw">const</span> v1 = f32x8(<span class="tok-number">0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L846">        <span class="tok-kw">const</span> v = max(v0, v1);</span>
<span class="line" id="L847">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x8(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L848">    }</span>
<span class="line" id="L849">    {</span>
<span class="line" id="L850">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, math.nan_f32, <span class="tok-number">5.0</span>, math.qnan_f32);</span>
<span class="line" id="L851">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L852">        <span class="tok-kw">const</span> v = max(v0, v1);</span>
<span class="line" id="L853">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">0</span>] == <span class="tok-number">2.0</span>);</span>
<span class="line" id="L854">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">1</span>] == <span class="tok-number">1.0</span>);</span>
<span class="line" id="L855">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">2</span>] == <span class="tok-number">5.0</span>);</span>
<span class="line" id="L856">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L857">        <span class="tok-kw">try</span> expect(!math.isNan(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L858">    }</span>
<span class="line" id="L859">    {</span>
<span class="line" id="L860">        <span class="tok-kw">const</span> v0 = f32x4(-math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), math.qnan_f32);</span>
<span class="line" id="L861">        <span class="tok-kw">const</span> v1 = f32x4(math.qnan_f32, -math.inf(<span class="tok-type">f32</span>), math.qnan_f32, math.nan_f32);</span>
<span class="line" id="L862">        <span class="tok-kw">const</span> v = max(v0, v1);</span>
<span class="line" id="L863">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">0</span>] == -math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L864">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">1</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L865">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">2</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L866">        <span class="tok-kw">try</span> expect(!math.isNan(v[<span class="tok-number">2</span>]));</span>
<span class="line" id="L867">        <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L868">        <span class="tok-kw">try</span> expect(!math.isInf(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L869">    }</span>
<span class="line" id="L870">}</span>
<span class="line" id="L871"></span>
<span class="line" id="L872"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">round</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L873">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L874">    <span class="tok-kw">if</span> (cpu_arch == .x86_64 <span class="tok-kw">and</span> has_avx) {</span>
<span class="line" id="L875">        <span class="tok-kw">if</span> (T == F32x4) {</span>
<span class="line" id="L876">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $0, %%xmm0, %%xmm0&quot;</span></span>
<span class="line" id="L877">                : [ret] <span class="tok-str">&quot;={xmm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L878">                : [v] <span class="tok-str">&quot;{xmm0}&quot;</span> (v),</span>
<span class="line" id="L879">            );</span>
<span class="line" id="L880">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x8) {</span>
<span class="line" id="L881">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $0, %%ymm0, %%ymm0&quot;</span></span>
<span class="line" id="L882">                : [ret] <span class="tok-str">&quot;={ymm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L883">                : [v] <span class="tok-str">&quot;{ymm0}&quot;</span> (v),</span>
<span class="line" id="L884">            );</span>
<span class="line" id="L885">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x16 <span class="tok-kw">and</span> has_avx512f) {</span>
<span class="line" id="L886">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vrndscaleps $0, %%zmm0, %%zmm0&quot;</span></span>
<span class="line" id="L887">                : [ret] <span class="tok-str">&quot;={zmm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L888">                : [v] <span class="tok-str">&quot;{zmm0}&quot;</span> (v),</span>
<span class="line" id="L889">            );</span>
<span class="line" id="L890">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x16 <span class="tok-kw">and</span> !has_avx512f) {</span>
<span class="line" id="L891">            <span class="tok-kw">const</span> arr: [<span class="tok-number">16</span>]<span class="tok-type">f32</span> = v;</span>
<span class="line" id="L892">            <span class="tok-kw">var</span> ymm0 = <span class="tok-builtin">@as</span>(F32x8, arr[<span class="tok-number">0</span>..<span class="tok-number">8</span>].*);</span>
<span class="line" id="L893">            <span class="tok-kw">var</span> ymm1 = <span class="tok-builtin">@as</span>(F32x8, arr[<span class="tok-number">8</span>..<span class="tok-number">16</span>].*);</span>
<span class="line" id="L894">            ymm0 = <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $0, %%ymm0, %%ymm0&quot;</span></span>
<span class="line" id="L895">                : [ret] <span class="tok-str">&quot;={ymm0}&quot;</span> (-&gt; F32x8),</span>
<span class="line" id="L896">                : [v] <span class="tok-str">&quot;{ymm0}&quot;</span> (ymm0),</span>
<span class="line" id="L897">            );</span>
<span class="line" id="L898">            ymm1 = <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $0, %%ymm1, %%ymm1&quot;</span></span>
<span class="line" id="L899">                : [ret] <span class="tok-str">&quot;={ymm1}&quot;</span> (-&gt; F32x8),</span>
<span class="line" id="L900">                : [v] <span class="tok-str">&quot;{ymm1}&quot;</span> (ymm1),</span>
<span class="line" id="L901">            );</span>
<span class="line" id="L902">            <span class="tok-kw">return</span> <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, ymm0, ymm1, [<span class="tok-number">16</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span>, <span class="tok-number">6</span>, <span class="tok-number">7</span>, -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">3</span>, -<span class="tok-number">4</span>, -<span class="tok-number">5</span>, -<span class="tok-number">6</span>, -<span class="tok-number">7</span>, -<span class="tok-number">8</span> });</span>
<span class="line" id="L903">        }</span>
<span class="line" id="L904">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L905">        <span class="tok-kw">const</span> sign = andInt(v, splatNegativeZero(T));</span>
<span class="line" id="L906">        <span class="tok-kw">const</span> magic = orInt(splatNoFraction(T), sign);</span>
<span class="line" id="L907">        <span class="tok-kw">var</span> r1 = v + magic;</span>
<span class="line" id="L908">        r1 = r1 - magic;</span>
<span class="line" id="L909">        <span class="tok-kw">const</span> r2 = abs(v);</span>
<span class="line" id="L910">        <span class="tok-kw">const</span> mask = r2 &lt;= splatNoFraction(T);</span>
<span class="line" id="L911">        <span class="tok-kw">return</span> select(mask, r1, v);</span>
<span class="line" id="L912">    }</span>
<span class="line" id="L913">}</span>
<span class="line" id="L914"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.round&quot;</span> {</span>
<span class="line" id="L915">    {</span>
<span class="line" id="L916">        <span class="tok-kw">try</span> expect(all(round(splat(F32x4, math.inf(<span class="tok-type">f32</span>))) == splat(F32x4, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0</span>));</span>
<span class="line" id="L917">        <span class="tok-kw">try</span> expect(all(round(splat(F32x4, -math.inf(<span class="tok-type">f32</span>))) == splat(F32x4, -math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0</span>));</span>
<span class="line" id="L918">        <span class="tok-kw">try</span> expect(all(isNan(round(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L919">        <span class="tok-kw">try</span> expect(all(isNan(round(splat(F32x4, -math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L920">        <span class="tok-kw">try</span> expect(all(isNan(round(splat(F32x4, math.qnan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L921">        <span class="tok-kw">try</span> expect(all(isNan(round(splat(F32x4, -math.qnan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L922">    }</span>
<span class="line" id="L923">    {</span>
<span class="line" id="L924">        <span class="tok-kw">var</span> v = round(f32x16(<span class="tok-number">1.1</span>, -<span class="tok-number">1.1</span>, -<span class="tok-number">1.5</span>, <span class="tok-number">1.5</span>, <span class="tok-number">2.1</span>, <span class="tok-number">2.8</span>, <span class="tok-number">2.9</span>, <span class="tok-number">4.1</span>, <span class="tok-number">5.8</span>, <span class="tok-number">6.1</span>, <span class="tok-number">7.9</span>, <span class="tok-number">8.9</span>, <span class="tok-number">10.1</span>, <span class="tok-number">11.2</span>, <span class="tok-number">12.7</span>, <span class="tok-number">13.1</span>));</span>
<span class="line" id="L925">        <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L926">            v,</span>
<span class="line" id="L927">            f32x16(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">8.0</span>, <span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">13.0</span>, <span class="tok-number">13.0</span>),</span>
<span class="line" id="L928">            <span class="tok-number">0.0</span>,</span>
<span class="line" id="L929">        ));</span>
<span class="line" id="L930">    }</span>
<span class="line" id="L931">    <span class="tok-kw">var</span> v = round(f32x4(<span class="tok-number">1.1</span>, -<span class="tok-number">1.1</span>, -<span class="tok-number">1.5</span>, <span class="tok-number">1.5</span>));</span>
<span class="line" id="L932">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">2.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L933"></span>
<span class="line" id="L934">    <span class="tok-kw">const</span> v1 = f32x4(-<span class="tok-number">10_000_000.1</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">10_000_001.5</span>, math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L935">    v = round(v1);</span>
<span class="line" id="L936">    <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L937">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">10_000_000.1</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">10_000_001.5</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L938"></span>
<span class="line" id="L939">    <span class="tok-kw">const</span> v2 = f32x4(-math.qnan_f32, math.qnan_f32, math.nan_f32, -math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L940">    v = round(v2);</span>
<span class="line" id="L941">    <span class="tok-kw">try</span> expect(math.isNan(v2[<span class="tok-number">0</span>]));</span>
<span class="line" id="L942">    <span class="tok-kw">try</span> expect(math.isNan(v2[<span class="tok-number">1</span>]));</span>
<span class="line" id="L943">    <span class="tok-kw">try</span> expect(math.isNan(v2[<span class="tok-number">2</span>]));</span>
<span class="line" id="L944">    <span class="tok-kw">try</span> expect(v2[<span class="tok-number">3</span>] == -math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L945"></span>
<span class="line" id="L946">    <span class="tok-kw">const</span> v3 = f32x4(<span class="tok-number">1001.5</span>, -<span class="tok-number">201.499</span>, -<span class="tok-number">10000.99</span>, -<span class="tok-number">101.5</span>);</span>
<span class="line" id="L947">    v = round(v3);</span>
<span class="line" id="L948">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1002.0</span>, -<span class="tok-number">201.0</span>, -<span class="tok-number">10001.0</span>, -<span class="tok-number">102.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L949"></span>
<span class="line" id="L950">    <span class="tok-kw">const</span> v4 = f32x4(-<span class="tok-number">1_388_609.9</span>, <span class="tok-number">1_388_609.5</span>, <span class="tok-number">1_388_109.01</span>, <span class="tok-number">2_388_609.5</span>);</span>
<span class="line" id="L951">    v = round(v4);</span>
<span class="line" id="L952">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">1_388_610.0</span>, <span class="tok-number">1_388_610.0</span>, <span class="tok-number">1_388_109.0</span>, <span class="tok-number">2_388_610.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L953"></span>
<span class="line" id="L954">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">100.0</span>;</span>
<span class="line" id="L955">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L956">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">100</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L957">        <span class="tok-kw">const</span> vr = round(splat(F32x4, f));</span>
<span class="line" id="L958">        <span class="tok-kw">const</span> fr = <span class="tok-builtin">@round</span>(splat(F32x4, f));</span>
<span class="line" id="L959">        <span class="tok-kw">const</span> vr8 = round(splat(F32x8, f));</span>
<span class="line" id="L960">        <span class="tok-kw">const</span> fr8 = <span class="tok-builtin">@round</span>(splat(F32x8, f));</span>
<span class="line" id="L961">        <span class="tok-kw">const</span> vr16 = round(splat(F32x16, f));</span>
<span class="line" id="L962">        <span class="tok-kw">const</span> fr16 = <span class="tok-builtin">@round</span>(splat(F32x16, f));</span>
<span class="line" id="L963">        <span class="tok-kw">try</span> expect(approxEqAbs(vr, fr, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L964">        <span class="tok-kw">try</span> expect(approxEqAbs(vr8, fr8, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L965">        <span class="tok-kw">try</span> expect(approxEqAbs(vr16, fr16, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L966">        f += <span class="tok-number">0.12345</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L967">    }</span>
<span class="line" id="L968">}</span>
<span class="line" id="L969"></span>
<span class="line" id="L970"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">trunc</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L971">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L972">    <span class="tok-kw">if</span> (cpu_arch == .x86_64 <span class="tok-kw">and</span> has_avx) {</span>
<span class="line" id="L973">        <span class="tok-kw">if</span> (T == F32x4) {</span>
<span class="line" id="L974">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $3, %%xmm0, %%xmm0&quot;</span></span>
<span class="line" id="L975">                : [ret] <span class="tok-str">&quot;={xmm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L976">                : [v] <span class="tok-str">&quot;{xmm0}&quot;</span> (v),</span>
<span class="line" id="L977">            );</span>
<span class="line" id="L978">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x8) {</span>
<span class="line" id="L979">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $3, %%ymm0, %%ymm0&quot;</span></span>
<span class="line" id="L980">                : [ret] <span class="tok-str">&quot;={ymm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L981">                : [v] <span class="tok-str">&quot;{ymm0}&quot;</span> (v),</span>
<span class="line" id="L982">            );</span>
<span class="line" id="L983">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x16 <span class="tok-kw">and</span> has_avx512f) {</span>
<span class="line" id="L984">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vrndscaleps $3, %%zmm0, %%zmm0&quot;</span></span>
<span class="line" id="L985">                : [ret] <span class="tok-str">&quot;={zmm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L986">                : [v] <span class="tok-str">&quot;{zmm0}&quot;</span> (v),</span>
<span class="line" id="L987">            );</span>
<span class="line" id="L988">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x16 <span class="tok-kw">and</span> !has_avx512f) {</span>
<span class="line" id="L989">            <span class="tok-kw">const</span> arr: [<span class="tok-number">16</span>]<span class="tok-type">f32</span> = v;</span>
<span class="line" id="L990">            <span class="tok-kw">var</span> ymm0 = <span class="tok-builtin">@as</span>(F32x8, arr[<span class="tok-number">0</span>..<span class="tok-number">8</span>].*);</span>
<span class="line" id="L991">            <span class="tok-kw">var</span> ymm1 = <span class="tok-builtin">@as</span>(F32x8, arr[<span class="tok-number">8</span>..<span class="tok-number">16</span>].*);</span>
<span class="line" id="L992">            ymm0 = <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $3, %%ymm0, %%ymm0&quot;</span></span>
<span class="line" id="L993">                : [ret] <span class="tok-str">&quot;={ymm0}&quot;</span> (-&gt; F32x8),</span>
<span class="line" id="L994">                : [v] <span class="tok-str">&quot;{ymm0}&quot;</span> (ymm0),</span>
<span class="line" id="L995">            );</span>
<span class="line" id="L996">            ymm1 = <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $3, %%ymm1, %%ymm1&quot;</span></span>
<span class="line" id="L997">                : [ret] <span class="tok-str">&quot;={ymm1}&quot;</span> (-&gt; F32x8),</span>
<span class="line" id="L998">                : [v] <span class="tok-str">&quot;{ymm1}&quot;</span> (ymm1),</span>
<span class="line" id="L999">            );</span>
<span class="line" id="L1000">            <span class="tok-kw">return</span> <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, ymm0, ymm1, [<span class="tok-number">16</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span>, <span class="tok-number">6</span>, <span class="tok-number">7</span>, -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">3</span>, -<span class="tok-number">4</span>, -<span class="tok-number">5</span>, -<span class="tok-number">6</span>, -<span class="tok-number">7</span>, -<span class="tok-number">8</span> });</span>
<span class="line" id="L1001">        }</span>
<span class="line" id="L1002">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1003">        <span class="tok-kw">const</span> mask = abs(v) &lt; splatNoFraction(T);</span>
<span class="line" id="L1004">        <span class="tok-kw">const</span> result = floatToIntAndBack(v);</span>
<span class="line" id="L1005">        <span class="tok-kw">return</span> select(mask, result, v);</span>
<span class="line" id="L1006">    }</span>
<span class="line" id="L1007">}</span>
<span class="line" id="L1008"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.trunc&quot;</span> {</span>
<span class="line" id="L1009">    {</span>
<span class="line" id="L1010">        <span class="tok-kw">try</span> expect(all(trunc(splat(F32x4, math.inf(<span class="tok-type">f32</span>))) == splat(F32x4, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0</span>));</span>
<span class="line" id="L1011">        <span class="tok-kw">try</span> expect(all(trunc(splat(F32x4, -math.inf(<span class="tok-type">f32</span>))) == splat(F32x4, -math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0</span>));</span>
<span class="line" id="L1012">        <span class="tok-kw">try</span> expect(all(isNan(trunc(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1013">        <span class="tok-kw">try</span> expect(all(isNan(trunc(splat(F32x4, -math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1014">        <span class="tok-kw">try</span> expect(all(isNan(trunc(splat(F32x4, math.qnan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1015">        <span class="tok-kw">try</span> expect(all(isNan(trunc(splat(F32x4, -math.qnan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1016">    }</span>
<span class="line" id="L1017">    {</span>
<span class="line" id="L1018">        <span class="tok-kw">var</span> v = trunc(f32x16(<span class="tok-number">1.1</span>, -<span class="tok-number">1.1</span>, -<span class="tok-number">1.5</span>, <span class="tok-number">1.5</span>, <span class="tok-number">2.1</span>, <span class="tok-number">2.8</span>, <span class="tok-number">2.9</span>, <span class="tok-number">4.1</span>, <span class="tok-number">5.8</span>, <span class="tok-number">6.1</span>, <span class="tok-number">7.9</span>, <span class="tok-number">8.9</span>, <span class="tok-number">10.1</span>, <span class="tok-number">11.2</span>, <span class="tok-number">12.7</span>, <span class="tok-number">13.1</span>));</span>
<span class="line" id="L1019">        <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1020">            v,</span>
<span class="line" id="L1021">            f32x16(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>, <span class="tok-number">13.0</span>),</span>
<span class="line" id="L1022">            <span class="tok-number">0.0</span>,</span>
<span class="line" id="L1023">        ));</span>
<span class="line" id="L1024">    }</span>
<span class="line" id="L1025">    <span class="tok-kw">var</span> v = trunc(f32x4(<span class="tok-number">1.1</span>, -<span class="tok-number">1.1</span>, -<span class="tok-number">1.5</span>, <span class="tok-number">1.5</span>));</span>
<span class="line" id="L1026">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1027"></span>
<span class="line" id="L1028">    v = trunc(f32x4(-<span class="tok-number">10_000_002.1</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">10_000_001.5</span>, math.inf(<span class="tok-type">f32</span>)));</span>
<span class="line" id="L1029">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">10_000_002.1</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">10_000_001.5</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1030"></span>
<span class="line" id="L1031">    v = trunc(f32x4(-math.qnan_f32, math.qnan_f32, math.nan_f32, -math.inf(<span class="tok-type">f32</span>)));</span>
<span class="line" id="L1032">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">0</span>]));</span>
<span class="line" id="L1033">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">1</span>]));</span>
<span class="line" id="L1034">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">2</span>]));</span>
<span class="line" id="L1035">    <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == -math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L1036"></span>
<span class="line" id="L1037">    v = trunc(f32x4(<span class="tok-number">1000.5001</span>, -<span class="tok-number">201.499</span>, -<span class="tok-number">10000.99</span>, <span class="tok-number">100.750001</span>));</span>
<span class="line" id="L1038">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1000.0</span>, -<span class="tok-number">201.0</span>, -<span class="tok-number">10000.0</span>, <span class="tok-number">100.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1039"></span>
<span class="line" id="L1040">    v = trunc(f32x4(-<span class="tok-number">7_388_609.5</span>, <span class="tok-number">7_388_609.1</span>, <span class="tok-number">8_388_109.5</span>, -<span class="tok-number">8_388_509.5</span>));</span>
<span class="line" id="L1041">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">7_388_609.0</span>, <span class="tok-number">7_388_609.0</span>, <span class="tok-number">8_388_109.0</span>, -<span class="tok-number">8_388_509.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1042"></span>
<span class="line" id="L1043">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">100.0</span>;</span>
<span class="line" id="L1044">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1045">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">100</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1046">        <span class="tok-kw">const</span> vr = trunc(splat(F32x4, f));</span>
<span class="line" id="L1047">        <span class="tok-kw">const</span> fr = <span class="tok-builtin">@trunc</span>(splat(F32x4, f));</span>
<span class="line" id="L1048">        <span class="tok-kw">const</span> vr8 = trunc(splat(F32x8, f));</span>
<span class="line" id="L1049">        <span class="tok-kw">const</span> fr8 = <span class="tok-builtin">@trunc</span>(splat(F32x8, f));</span>
<span class="line" id="L1050">        <span class="tok-kw">const</span> vr16 = trunc(splat(F32x16, f));</span>
<span class="line" id="L1051">        <span class="tok-kw">const</span> fr16 = <span class="tok-builtin">@trunc</span>(splat(F32x16, f));</span>
<span class="line" id="L1052">        <span class="tok-kw">try</span> expect(approxEqAbs(vr, fr, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1053">        <span class="tok-kw">try</span> expect(approxEqAbs(vr8, fr8, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1054">        <span class="tok-kw">try</span> expect(approxEqAbs(vr16, fr16, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1055">        f += <span class="tok-number">0.12345</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L1056">    }</span>
<span class="line" id="L1057">}</span>
<span class="line" id="L1058"></span>
<span class="line" id="L1059"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">floor</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1060">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1061">    <span class="tok-kw">if</span> (cpu_arch == .x86_64 <span class="tok-kw">and</span> has_avx) {</span>
<span class="line" id="L1062">        <span class="tok-kw">if</span> (T == F32x4) {</span>
<span class="line" id="L1063">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $1, %%xmm0, %%xmm0&quot;</span></span>
<span class="line" id="L1064">                : [ret] <span class="tok-str">&quot;={xmm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L1065">                : [v] <span class="tok-str">&quot;{xmm0}&quot;</span> (v),</span>
<span class="line" id="L1066">            );</span>
<span class="line" id="L1067">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x8) {</span>
<span class="line" id="L1068">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $1, %%ymm0, %%ymm0&quot;</span></span>
<span class="line" id="L1069">                : [ret] <span class="tok-str">&quot;={ymm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L1070">                : [v] <span class="tok-str">&quot;{ymm0}&quot;</span> (v),</span>
<span class="line" id="L1071">            );</span>
<span class="line" id="L1072">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x16 <span class="tok-kw">and</span> has_avx512f) {</span>
<span class="line" id="L1073">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vrndscaleps $1, %%zmm0, %%zmm0&quot;</span></span>
<span class="line" id="L1074">                : [ret] <span class="tok-str">&quot;={zmm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L1075">                : [v] <span class="tok-str">&quot;{zmm0}&quot;</span> (v),</span>
<span class="line" id="L1076">            );</span>
<span class="line" id="L1077">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x16 <span class="tok-kw">and</span> !has_avx512f) {</span>
<span class="line" id="L1078">            <span class="tok-kw">const</span> arr: [<span class="tok-number">16</span>]<span class="tok-type">f32</span> = v;</span>
<span class="line" id="L1079">            <span class="tok-kw">var</span> ymm0 = <span class="tok-builtin">@as</span>(F32x8, arr[<span class="tok-number">0</span>..<span class="tok-number">8</span>].*);</span>
<span class="line" id="L1080">            <span class="tok-kw">var</span> ymm1 = <span class="tok-builtin">@as</span>(F32x8, arr[<span class="tok-number">8</span>..<span class="tok-number">16</span>].*);</span>
<span class="line" id="L1081">            ymm0 = <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $1, %%ymm0, %%ymm0&quot;</span></span>
<span class="line" id="L1082">                : [ret] <span class="tok-str">&quot;={ymm0}&quot;</span> (-&gt; F32x8),</span>
<span class="line" id="L1083">                : [v] <span class="tok-str">&quot;{ymm0}&quot;</span> (ymm0),</span>
<span class="line" id="L1084">            );</span>
<span class="line" id="L1085">            ymm1 = <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $1, %%ymm1, %%ymm1&quot;</span></span>
<span class="line" id="L1086">                : [ret] <span class="tok-str">&quot;={ymm1}&quot;</span> (-&gt; F32x8),</span>
<span class="line" id="L1087">                : [v] <span class="tok-str">&quot;{ymm1}&quot;</span> (ymm1),</span>
<span class="line" id="L1088">            );</span>
<span class="line" id="L1089">            <span class="tok-kw">return</span> <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, ymm0, ymm1, [<span class="tok-number">16</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span>, <span class="tok-number">6</span>, <span class="tok-number">7</span>, -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">3</span>, -<span class="tok-number">4</span>, -<span class="tok-number">5</span>, -<span class="tok-number">6</span>, -<span class="tok-number">7</span>, -<span class="tok-number">8</span> });</span>
<span class="line" id="L1090">        }</span>
<span class="line" id="L1091">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1092">        <span class="tok-kw">const</span> mask = abs(v) &lt; splatNoFraction(T);</span>
<span class="line" id="L1093">        <span class="tok-kw">var</span> result = floatToIntAndBack(v);</span>
<span class="line" id="L1094">        <span class="tok-kw">const</span> larger_mask = result &gt; v;</span>
<span class="line" id="L1095">        <span class="tok-kw">const</span> larger = select(larger_mask, splat(T, -<span class="tok-number">1.0</span>), splat(T, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1096">        result = result + larger;</span>
<span class="line" id="L1097">        <span class="tok-kw">return</span> select(mask, result, v);</span>
<span class="line" id="L1098">    }</span>
<span class="line" id="L1099">}</span>
<span class="line" id="L1100"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.floor&quot;</span> {</span>
<span class="line" id="L1101">    {</span>
<span class="line" id="L1102">        <span class="tok-kw">try</span> expect(all(floor(splat(F32x4, math.inf(<span class="tok-type">f32</span>))) == splat(F32x4, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0</span>));</span>
<span class="line" id="L1103">        <span class="tok-kw">try</span> expect(all(floor(splat(F32x4, -math.inf(<span class="tok-type">f32</span>))) == splat(F32x4, -math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0</span>));</span>
<span class="line" id="L1104">        <span class="tok-kw">try</span> expect(all(isNan(floor(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1105">        <span class="tok-kw">try</span> expect(all(isNan(floor(splat(F32x4, -math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1106">        <span class="tok-kw">try</span> expect(all(isNan(floor(splat(F32x4, math.qnan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1107">        <span class="tok-kw">try</span> expect(all(isNan(floor(splat(F32x4, -math.qnan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1108">    }</span>
<span class="line" id="L1109">    {</span>
<span class="line" id="L1110">        <span class="tok-kw">var</span> v = floor(f32x16(<span class="tok-number">1.1</span>, -<span class="tok-number">1.1</span>, -<span class="tok-number">1.5</span>, <span class="tok-number">1.5</span>, <span class="tok-number">2.1</span>, <span class="tok-number">2.8</span>, <span class="tok-number">2.9</span>, <span class="tok-number">4.1</span>, <span class="tok-number">5.8</span>, <span class="tok-number">6.1</span>, <span class="tok-number">7.9</span>, <span class="tok-number">8.9</span>, <span class="tok-number">10.1</span>, <span class="tok-number">11.2</span>, <span class="tok-number">12.7</span>, <span class="tok-number">13.1</span>));</span>
<span class="line" id="L1111">        <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1112">            v,</span>
<span class="line" id="L1113">            f32x16(<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>, <span class="tok-number">13.0</span>),</span>
<span class="line" id="L1114">            <span class="tok-number">0.0</span>,</span>
<span class="line" id="L1115">        ));</span>
<span class="line" id="L1116">    }</span>
<span class="line" id="L1117">    <span class="tok-kw">var</span> v = floor(f32x4(<span class="tok-number">1.5</span>, -<span class="tok-number">1.5</span>, -<span class="tok-number">1.7</span>, -<span class="tok-number">2.1</span>));</span>
<span class="line" id="L1118">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">3.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1119"></span>
<span class="line" id="L1120">    v = floor(f32x4(-<span class="tok-number">10_000_002.1</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">10_000_001.5</span>, math.inf(<span class="tok-type">f32</span>)));</span>
<span class="line" id="L1121">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">10_000_002.1</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">10_000_001.5</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1122"></span>
<span class="line" id="L1123">    v = floor(f32x4(-math.qnan_f32, math.qnan_f32, math.nan_f32, -math.inf(<span class="tok-type">f32</span>)));</span>
<span class="line" id="L1124">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">0</span>]));</span>
<span class="line" id="L1125">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">1</span>]));</span>
<span class="line" id="L1126">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">2</span>]));</span>
<span class="line" id="L1127">    <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == -math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L1128"></span>
<span class="line" id="L1129">    v = floor(f32x4(<span class="tok-number">1000.5001</span>, -<span class="tok-number">201.499</span>, -<span class="tok-number">10000.99</span>, <span class="tok-number">100.75001</span>));</span>
<span class="line" id="L1130">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1000.0</span>, -<span class="tok-number">202.0</span>, -<span class="tok-number">10001.0</span>, <span class="tok-number">100.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1131"></span>
<span class="line" id="L1132">    v = floor(f32x4(-<span class="tok-number">7_388_609.5</span>, <span class="tok-number">7_388_609.1</span>, <span class="tok-number">8_388_109.5</span>, -<span class="tok-number">8_388_509.5</span>));</span>
<span class="line" id="L1133">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">7_388_610.0</span>, <span class="tok-number">7_388_609.0</span>, <span class="tok-number">8_388_109.0</span>, -<span class="tok-number">8_388_510.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1134"></span>
<span class="line" id="L1135">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">100.0</span>;</span>
<span class="line" id="L1136">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1137">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">100</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1138">        <span class="tok-kw">const</span> vr = floor(splat(F32x4, f));</span>
<span class="line" id="L1139">        <span class="tok-kw">const</span> fr = <span class="tok-builtin">@floor</span>(splat(F32x4, f));</span>
<span class="line" id="L1140">        <span class="tok-kw">const</span> vr8 = floor(splat(F32x8, f));</span>
<span class="line" id="L1141">        <span class="tok-kw">const</span> fr8 = <span class="tok-builtin">@floor</span>(splat(F32x8, f));</span>
<span class="line" id="L1142">        <span class="tok-kw">const</span> vr16 = floor(splat(F32x16, f));</span>
<span class="line" id="L1143">        <span class="tok-kw">const</span> fr16 = <span class="tok-builtin">@floor</span>(splat(F32x16, f));</span>
<span class="line" id="L1144">        <span class="tok-kw">try</span> expect(approxEqAbs(vr, fr, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1145">        <span class="tok-kw">try</span> expect(approxEqAbs(vr8, fr8, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1146">        <span class="tok-kw">try</span> expect(approxEqAbs(vr16, fr16, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1147">        f += <span class="tok-number">0.12345</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L1148">    }</span>
<span class="line" id="L1149">}</span>
<span class="line" id="L1150"></span>
<span class="line" id="L1151"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ceil</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1152">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1153">    <span class="tok-kw">if</span> (cpu_arch == .x86_64 <span class="tok-kw">and</span> has_avx) {</span>
<span class="line" id="L1154">        <span class="tok-kw">if</span> (T == F32x4) {</span>
<span class="line" id="L1155">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $2, %%xmm0, %%xmm0&quot;</span></span>
<span class="line" id="L1156">                : [ret] <span class="tok-str">&quot;={xmm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L1157">                : [v] <span class="tok-str">&quot;{xmm0}&quot;</span> (v),</span>
<span class="line" id="L1158">            );</span>
<span class="line" id="L1159">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x8) {</span>
<span class="line" id="L1160">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $2, %%ymm0, %%ymm0&quot;</span></span>
<span class="line" id="L1161">                : [ret] <span class="tok-str">&quot;={ymm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L1162">                : [v] <span class="tok-str">&quot;{ymm0}&quot;</span> (v),</span>
<span class="line" id="L1163">            );</span>
<span class="line" id="L1164">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x16 <span class="tok-kw">and</span> has_avx512f) {</span>
<span class="line" id="L1165">            <span class="tok-kw">return</span> <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vrndscaleps $2, %%zmm0, %%zmm0&quot;</span></span>
<span class="line" id="L1166">                : [ret] <span class="tok-str">&quot;={zmm0}&quot;</span> (-&gt; T),</span>
<span class="line" id="L1167">                : [v] <span class="tok-str">&quot;{zmm0}&quot;</span> (v),</span>
<span class="line" id="L1168">            );</span>
<span class="line" id="L1169">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == F32x16 <span class="tok-kw">and</span> !has_avx512f) {</span>
<span class="line" id="L1170">            <span class="tok-kw">const</span> arr: [<span class="tok-number">16</span>]<span class="tok-type">f32</span> = v;</span>
<span class="line" id="L1171">            <span class="tok-kw">var</span> ymm0 = <span class="tok-builtin">@as</span>(F32x8, arr[<span class="tok-number">0</span>..<span class="tok-number">8</span>].*);</span>
<span class="line" id="L1172">            <span class="tok-kw">var</span> ymm1 = <span class="tok-builtin">@as</span>(F32x8, arr[<span class="tok-number">8</span>..<span class="tok-number">16</span>].*);</span>
<span class="line" id="L1173">            ymm0 = <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $2, %%ymm0, %%ymm0&quot;</span></span>
<span class="line" id="L1174">                : [ret] <span class="tok-str">&quot;={ymm0}&quot;</span> (-&gt; F32x8),</span>
<span class="line" id="L1175">                : [v] <span class="tok-str">&quot;{ymm0}&quot;</span> (ymm0),</span>
<span class="line" id="L1176">            );</span>
<span class="line" id="L1177">            ymm1 = <span class="tok-kw">asm</span> (<span class="tok-str">&quot;vroundps $2, %%ymm1, %%ymm1&quot;</span></span>
<span class="line" id="L1178">                : [ret] <span class="tok-str">&quot;={ymm1}&quot;</span> (-&gt; F32x8),</span>
<span class="line" id="L1179">                : [v] <span class="tok-str">&quot;{ymm1}&quot;</span> (ymm1),</span>
<span class="line" id="L1180">            );</span>
<span class="line" id="L1181">            <span class="tok-kw">return</span> <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, ymm0, ymm1, [<span class="tok-number">16</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span>, <span class="tok-number">6</span>, <span class="tok-number">7</span>, -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">3</span>, -<span class="tok-number">4</span>, -<span class="tok-number">5</span>, -<span class="tok-number">6</span>, -<span class="tok-number">7</span>, -<span class="tok-number">8</span> });</span>
<span class="line" id="L1182">        }</span>
<span class="line" id="L1183">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1184">        <span class="tok-kw">const</span> mask = abs(v) &lt; splatNoFraction(T);</span>
<span class="line" id="L1185">        <span class="tok-kw">var</span> result = floatToIntAndBack(v);</span>
<span class="line" id="L1186">        <span class="tok-kw">const</span> smaller_mask = result &lt; v;</span>
<span class="line" id="L1187">        <span class="tok-kw">const</span> smaller = select(smaller_mask, splat(T, -<span class="tok-number">1.0</span>), splat(T, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1188">        result = result - smaller;</span>
<span class="line" id="L1189">        <span class="tok-kw">return</span> select(mask, result, v);</span>
<span class="line" id="L1190">    }</span>
<span class="line" id="L1191">}</span>
<span class="line" id="L1192"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.ceil&quot;</span> {</span>
<span class="line" id="L1193">    {</span>
<span class="line" id="L1194">        <span class="tok-kw">try</span> expect(all(ceil(splat(F32x4, math.inf(<span class="tok-type">f32</span>))) == splat(F32x4, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0</span>));</span>
<span class="line" id="L1195">        <span class="tok-kw">try</span> expect(all(ceil(splat(F32x4, -math.inf(<span class="tok-type">f32</span>))) == splat(F32x4, -math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0</span>));</span>
<span class="line" id="L1196">        <span class="tok-kw">try</span> expect(all(isNan(ceil(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1197">        <span class="tok-kw">try</span> expect(all(isNan(ceil(splat(F32x4, -math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1198">        <span class="tok-kw">try</span> expect(all(isNan(ceil(splat(F32x4, math.qnan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1199">        <span class="tok-kw">try</span> expect(all(isNan(ceil(splat(F32x4, -math.qnan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1200">    }</span>
<span class="line" id="L1201">    {</span>
<span class="line" id="L1202">        <span class="tok-kw">var</span> v = ceil(f32x16(<span class="tok-number">1.1</span>, -<span class="tok-number">1.1</span>, -<span class="tok-number">1.5</span>, <span class="tok-number">1.5</span>, <span class="tok-number">2.1</span>, <span class="tok-number">2.8</span>, <span class="tok-number">2.9</span>, <span class="tok-number">4.1</span>, <span class="tok-number">5.8</span>, <span class="tok-number">6.1</span>, <span class="tok-number">7.9</span>, <span class="tok-number">8.9</span>, <span class="tok-number">10.1</span>, <span class="tok-number">11.2</span>, <span class="tok-number">12.7</span>, <span class="tok-number">13.1</span>));</span>
<span class="line" id="L1203">        <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1204">            v,</span>
<span class="line" id="L1205">            f32x16(<span class="tok-number">2.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>, <span class="tok-number">9.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>, <span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>),</span>
<span class="line" id="L1206">            <span class="tok-number">0.0</span>,</span>
<span class="line" id="L1207">        ));</span>
<span class="line" id="L1208">    }</span>
<span class="line" id="L1209">    <span class="tok-kw">var</span> v = ceil(f32x4(<span class="tok-number">1.5</span>, -<span class="tok-number">1.5</span>, -<span class="tok-number">1.7</span>, -<span class="tok-number">2.1</span>));</span>
<span class="line" id="L1210">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">2.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1211"></span>
<span class="line" id="L1212">    v = ceil(f32x4(-<span class="tok-number">10_000_002.1</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">10_000_001.5</span>, math.inf(<span class="tok-type">f32</span>)));</span>
<span class="line" id="L1213">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">10_000_002.1</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">10_000_001.5</span>, math.inf(<span class="tok-type">f32</span>)), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1214"></span>
<span class="line" id="L1215">    v = ceil(f32x4(-math.qnan_f32, math.qnan_f32, math.nan_f32, -math.inf(<span class="tok-type">f32</span>)));</span>
<span class="line" id="L1216">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">0</span>]));</span>
<span class="line" id="L1217">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">1</span>]));</span>
<span class="line" id="L1218">    <span class="tok-kw">try</span> expect(math.isNan(v[<span class="tok-number">2</span>]));</span>
<span class="line" id="L1219">    <span class="tok-kw">try</span> expect(v[<span class="tok-number">3</span>] == -math.inf(<span class="tok-type">f32</span>));</span>
<span class="line" id="L1220"></span>
<span class="line" id="L1221">    v = ceil(f32x4(<span class="tok-number">1000.5001</span>, -<span class="tok-number">201.499</span>, -<span class="tok-number">10000.99</span>, <span class="tok-number">100.75001</span>));</span>
<span class="line" id="L1222">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1001.0</span>, -<span class="tok-number">201.0</span>, -<span class="tok-number">10000.0</span>, <span class="tok-number">101.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1223"></span>
<span class="line" id="L1224">    v = ceil(f32x4(-<span class="tok-number">1_388_609.5</span>, <span class="tok-number">1_388_609.1</span>, <span class="tok-number">1_388_109.9</span>, -<span class="tok-number">1_388_509.9</span>));</span>
<span class="line" id="L1225">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">1_388_609.0</span>, <span class="tok-number">1_388_610.0</span>, <span class="tok-number">1_388_110.0</span>, -<span class="tok-number">1_388_509.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1226"></span>
<span class="line" id="L1227">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">100.0</span>;</span>
<span class="line" id="L1228">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1229">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">100</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1230">        <span class="tok-kw">const</span> vr = ceil(splat(F32x4, f));</span>
<span class="line" id="L1231">        <span class="tok-kw">const</span> fr = <span class="tok-builtin">@ceil</span>(splat(F32x4, f));</span>
<span class="line" id="L1232">        <span class="tok-kw">const</span> vr8 = ceil(splat(F32x8, f));</span>
<span class="line" id="L1233">        <span class="tok-kw">const</span> fr8 = <span class="tok-builtin">@ceil</span>(splat(F32x8, f));</span>
<span class="line" id="L1234">        <span class="tok-kw">const</span> vr16 = ceil(splat(F32x16, f));</span>
<span class="line" id="L1235">        <span class="tok-kw">const</span> fr16 = <span class="tok-builtin">@ceil</span>(splat(F32x16, f));</span>
<span class="line" id="L1236">        <span class="tok-kw">try</span> expect(approxEqAbs(vr, fr, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1237">        <span class="tok-kw">try</span> expect(approxEqAbs(vr8, fr8, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1238">        <span class="tok-kw">try</span> expect(approxEqAbs(vr16, fr16, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1239">        f += <span class="tok-number">0.12345</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L1240">    }</span>
<span class="line" id="L1241">}</span>
<span class="line" id="L1242"></span>
<span class="line" id="L1243"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">clamp</span>(v: <span class="tok-kw">anytype</span>, vmin: <span class="tok-kw">anytype</span>, vmax: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v, vmin, vmax) {</span>
<span class="line" id="L1244">    <span class="tok-kw">var</span> result = max(vmin, v);</span>
<span class="line" id="L1245">    result = min(vmax, result);</span>
<span class="line" id="L1246">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L1247">}</span>
<span class="line" id="L1248"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.clamp&quot;</span> {</span>
<span class="line" id="L1249">    <span class="tok-kw">if</span> (builtin.target.os.tag == .macos) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SkipZigTest;</span>
<span class="line" id="L1250">    {</span>
<span class="line" id="L1251">        <span class="tok-kw">const</span> v0 = f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.1</span>, -<span class="tok-number">0.3</span>);</span>
<span class="line" id="L1252">        <span class="tok-kw">const</span> v = clamp(v0, splat(F32x4, -<span class="tok-number">0.5</span>), splat(F32x4, <span class="tok-number">0.5</span>));</span>
<span class="line" id="L1253">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">0.5</span>, <span class="tok-number">0.2</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">0.3</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1254">    }</span>
<span class="line" id="L1255">    {</span>
<span class="line" id="L1256">        <span class="tok-kw">const</span> v0 = f32x8(-<span class="tok-number">2.0</span>, <span class="tok-number">0.25</span>, -<span class="tok-number">0.25</span>, <span class="tok-number">100.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.1</span>, -<span class="tok-number">0.3</span>);</span>
<span class="line" id="L1257">        <span class="tok-kw">const</span> v = clamp(v0, splat(F32x8, -<span class="tok-number">0.5</span>), splat(F32x8, <span class="tok-number">0.5</span>));</span>
<span class="line" id="L1258">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x8(-<span class="tok-number">0.5</span>, <span class="tok-number">0.25</span>, -<span class="tok-number">0.25</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">0.5</span>, <span class="tok-number">0.2</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">0.3</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1259">    }</span>
<span class="line" id="L1260">    {</span>
<span class="line" id="L1261">        <span class="tok-kw">const</span> v0 = f32x4(-math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), math.nan_f32, math.qnan_f32);</span>
<span class="line" id="L1262">        <span class="tok-kw">const</span> v = clamp(v0, f32x4(-<span class="tok-number">100.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">100.0</span>, <span class="tok-number">0.0</span>), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">100.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">100.0</span>));</span>
<span class="line" id="L1263">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">100.0</span>, <span class="tok-number">100.0</span>, -<span class="tok-number">100.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1264">    }</span>
<span class="line" id="L1265">    {</span>
<span class="line" id="L1266">        <span class="tok-kw">const</span> v0 = f32x4(math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), -math.nan_f32, -math.qnan_f32);</span>
<span class="line" id="L1267">        <span class="tok-kw">const</span> v = clamp(v0, splat(F32x4, -<span class="tok-number">1.0</span>), splat(F32x4, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L1268">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1269">    }</span>
<span class="line" id="L1270">}</span>
<span class="line" id="L1271"></span>
<span class="line" id="L1272"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">clampFast</span>(v: <span class="tok-kw">anytype</span>, vmin: <span class="tok-kw">anytype</span>, vmax: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v, vmin, vmax) {</span>
<span class="line" id="L1273">    <span class="tok-kw">var</span> result = maxFast(vmin, v);</span>
<span class="line" id="L1274">    result = minFast(vmax, result);</span>
<span class="line" id="L1275">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L1276">}</span>
<span class="line" id="L1277"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.clampFast&quot;</span> {</span>
<span class="line" id="L1278">    {</span>
<span class="line" id="L1279">        <span class="tok-kw">const</span> v0 = f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.1</span>, -<span class="tok-number">0.3</span>);</span>
<span class="line" id="L1280">        <span class="tok-kw">const</span> v = clampFast(v0, splat(F32x4, -<span class="tok-number">0.5</span>), splat(F32x4, <span class="tok-number">0.5</span>));</span>
<span class="line" id="L1281">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">0.5</span>, <span class="tok-number">0.2</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">0.3</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1282">    }</span>
<span class="line" id="L1283">}</span>
<span class="line" id="L1284"></span>
<span class="line" id="L1285"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">saturate</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1286">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1287">    <span class="tok-kw">var</span> result = max(v, splat(T, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1288">    result = min(result, splat(T, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L1289">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L1290">}</span>
<span class="line" id="L1291"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.saturate&quot;</span> {</span>
<span class="line" id="L1292">    <span class="tok-kw">if</span> (builtin.target.os.tag == .macos) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SkipZigTest;</span>
<span class="line" id="L1293">    {</span>
<span class="line" id="L1294">        <span class="tok-kw">const</span> v0 = f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.1</span>, -<span class="tok-number">0.3</span>);</span>
<span class="line" id="L1295">        <span class="tok-kw">const</span> v = saturate(v0);</span>
<span class="line" id="L1296">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1297">    }</span>
<span class="line" id="L1298">    {</span>
<span class="line" id="L1299">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2.0</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.1</span>, -<span class="tok-number">0.3</span>);</span>
<span class="line" id="L1300">        <span class="tok-kw">const</span> v = saturate(v0);</span>
<span class="line" id="L1301">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x8(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1302">    }</span>
<span class="line" id="L1303">    {</span>
<span class="line" id="L1304">        <span class="tok-kw">const</span> v0 = f32x4(-math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), math.nan_f32, math.qnan_f32);</span>
<span class="line" id="L1305">        <span class="tok-kw">const</span> v = saturate(v0);</span>
<span class="line" id="L1306">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1307">    }</span>
<span class="line" id="L1308">    {</span>
<span class="line" id="L1309">        <span class="tok-kw">const</span> v0 = f32x4(math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), -math.nan_f32, -math.qnan_f32);</span>
<span class="line" id="L1310">        <span class="tok-kw">const</span> v = saturate(v0);</span>
<span class="line" id="L1311">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1312">    }</span>
<span class="line" id="L1313">}</span>
<span class="line" id="L1314"></span>
<span class="line" id="L1315"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">saturateFast</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1316">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1317">    <span class="tok-kw">var</span> result = maxFast(v, splat(T, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L1318">    result = minFast(result, splat(T, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L1319">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L1320">}</span>
<span class="line" id="L1321"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.saturateFast&quot;</span> {</span>
<span class="line" id="L1322">    {</span>
<span class="line" id="L1323">        <span class="tok-kw">const</span> v0 = f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.1</span>, -<span class="tok-number">0.3</span>);</span>
<span class="line" id="L1324">        <span class="tok-kw">const</span> v = saturateFast(v0);</span>
<span class="line" id="L1325">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1326">    }</span>
<span class="line" id="L1327">    {</span>
<span class="line" id="L1328">        <span class="tok-kw">const</span> v0 = f32x8(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2.0</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.1</span>, -<span class="tok-number">0.3</span>);</span>
<span class="line" id="L1329">        <span class="tok-kw">const</span> v = saturateFast(v0);</span>
<span class="line" id="L1330">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x8(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1331">    }</span>
<span class="line" id="L1332">    {</span>
<span class="line" id="L1333">        <span class="tok-kw">const</span> v0 = f32x4(-math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), math.nan_f32, math.qnan_f32);</span>
<span class="line" id="L1334">        <span class="tok-kw">const</span> v = saturateFast(v0);</span>
<span class="line" id="L1335">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1336">    }</span>
<span class="line" id="L1337">    {</span>
<span class="line" id="L1338">        <span class="tok-kw">const</span> v0 = f32x4(math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), -math.nan_f32, -math.qnan_f32);</span>
<span class="line" id="L1339">        <span class="tok-kw">const</span> v = saturateFast(v0);</span>
<span class="line" id="L1340">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1341">    }</span>
<span class="line" id="L1342">}</span>
<span class="line" id="L1343"></span>
<span class="line" id="L1344"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">sqrt</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1345">    <span class="tok-kw">return</span> <span class="tok-builtin">@sqrt</span>(v); <span class="tok-comment">// sqrtps</span>
</span>
<span class="line" id="L1346">}</span>
<span class="line" id="L1347"></span>
<span class="line" id="L1348"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">abs</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1349">    <span class="tok-kw">return</span> <span class="tok-builtin">@fabs</span>(v); <span class="tok-comment">// load, andps</span>
</span>
<span class="line" id="L1350">}</span>
<span class="line" id="L1351"></span>
<span class="line" id="L1352"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">select</span>(mask: <span class="tok-kw">anytype</span>, v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L1353">    <span class="tok-kw">return</span> <span class="tok-builtin">@select</span>(<span class="tok-type">f32</span>, mask, v0, v1);</span>
<span class="line" id="L1354">}</span>
<span class="line" id="L1355"></span>
<span class="line" id="L1356"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lerp</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>, t: <span class="tok-type">f32</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L1357">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1);</span>
<span class="line" id="L1358">    <span class="tok-kw">return</span> v0 + (v1 - v0) * splat(T, t); <span class="tok-comment">// subps, shufps, addps, mulps</span>
</span>
<span class="line" id="L1359">}</span>
<span class="line" id="L1360"></span>
<span class="line" id="L1361"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lerpV</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>, t: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1, t) {</span>
<span class="line" id="L1362">    <span class="tok-kw">return</span> v0 + (v1 - v0) * t; <span class="tok-comment">// subps, addps, mulps</span>
</span>
<span class="line" id="L1363">}</span>
<span class="line" id="L1364"></span>
<span class="line" id="L1365"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lerpInverse</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>, t: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L1366">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1);</span>
<span class="line" id="L1367">    <span class="tok-kw">return</span> (splat(T, t) - v0) / (v1 - v0);</span>
<span class="line" id="L1368">}</span>
<span class="line" id="L1369"></span>
<span class="line" id="L1370"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lerpInverseV</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>, t: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1, t) {</span>
<span class="line" id="L1371">    <span class="tok-kw">return</span> (t - v0) / (v1 - v0);</span>
<span class="line" id="L1372">}</span>
<span class="line" id="L1373"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.lerpInverse&quot;</span> {</span>
<span class="line" id="L1374">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, lerpInverseV(<span class="tok-number">10.0</span>, <span class="tok-number">100.0</span>, <span class="tok-number">10.0</span>), <span class="tok-number">0</span>, <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1375">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, lerpInverseV(<span class="tok-number">10.0</span>, <span class="tok-number">100.0</span>, <span class="tok-number">100.0</span>), <span class="tok-number">1</span>, <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1376">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, lerpInverseV(<span class="tok-number">10.0</span>, <span class="tok-number">100.0</span>, <span class="tok-number">55.0</span>), <span class="tok-number">0.5</span>, <span class="tok-number">0.05</span>));</span>
<span class="line" id="L1377">    <span class="tok-kw">try</span> expect(approxEqAbs(lerpInverse(f32x4(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">10</span>, <span class="tok-number">10</span>), f32x4(<span class="tok-number">100</span>, <span class="tok-number">200</span>, <span class="tok-number">100</span>, <span class="tok-number">100</span>), <span class="tok-number">10.0</span>), f32x4(<span class="tok-number">0.1</span>, <span class="tok-number">0.05</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1378">}</span>
<span class="line" id="L1379"></span>
<span class="line" id="L1380"><span class="tok-comment">// Frame rate independent lerp (or &quot;damp&quot;), for approaching things over time.</span>
</span>
<span class="line" id="L1381"><span class="tok-comment">// Reference: https://www.gamedeveloper.com/programming/improved-lerp-smoothing-</span>
</span>
<span class="line" id="L1382"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lerpOverTime</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>, rate: <span class="tok-kw">anytype</span>, dt: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L1383">    <span class="tok-kw">const</span> t = std.math.exp2(-rate * dt);</span>
<span class="line" id="L1384">    <span class="tok-kw">return</span> lerp(v0, v1, t);</span>
<span class="line" id="L1385">}</span>
<span class="line" id="L1386"></span>
<span class="line" id="L1387"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lerpVOverTime</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>, rate: <span class="tok-kw">anytype</span>, dt: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1, rate, dt) {</span>
<span class="line" id="L1388">    <span class="tok-kw">const</span> t = std.math.exp2(-rate * dt);</span>
<span class="line" id="L1389">    <span class="tok-kw">return</span> lerpV(v0, v1, t);</span>
<span class="line" id="L1390">}</span>
<span class="line" id="L1391"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.lerpOverTime&quot;</span> {</span>
<span class="line" id="L1392">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, lerpVOverTime(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.5</span>, <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1393">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, lerpVOverTime(<span class="tok-number">0.5</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.75</span>, <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1394">    <span class="tok-kw">try</span> expect(approxEqAbs(lerpOverTime(f32x4(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">10</span>, <span class="tok-number">10</span>), f32x4(<span class="tok-number">100</span>, <span class="tok-number">200</span>, <span class="tok-number">100</span>, <span class="tok-number">100</span>), <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), f32x4(<span class="tok-number">50</span>, <span class="tok-number">100</span>, <span class="tok-number">55</span>, <span class="tok-number">55</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1395">}</span>
<span class="line" id="L1396"></span>
<span class="line" id="L1397"><span class="tok-comment">/// To transform a vector of values from one range to another.</span></span>
<span class="line" id="L1398"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">mapLinear</span>(v: <span class="tok-kw">anytype</span>, min1: <span class="tok-kw">anytype</span>, max1: <span class="tok-kw">anytype</span>, min2: <span class="tok-kw">anytype</span>, max2: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1399">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1400">    <span class="tok-kw">const</span> min1V = splat(T, min1);</span>
<span class="line" id="L1401">    <span class="tok-kw">const</span> max1V = splat(T, max1);</span>
<span class="line" id="L1402">    <span class="tok-kw">const</span> min2V = splat(T, min2);</span>
<span class="line" id="L1403">    <span class="tok-kw">const</span> max2V = splat(T, max2);</span>
<span class="line" id="L1404">    <span class="tok-kw">const</span> dV = max1V - min1V;</span>
<span class="line" id="L1405">    <span class="tok-kw">return</span> min2V + (v - min1V) * (max2V - min2V) / dV;</span>
<span class="line" id="L1406">}</span>
<span class="line" id="L1407"></span>
<span class="line" id="L1408"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">mapLinearV</span>(v: <span class="tok-kw">anytype</span>, min1: <span class="tok-kw">anytype</span>, max1: <span class="tok-kw">anytype</span>, min2: <span class="tok-kw">anytype</span>, max2: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v, min1, max1, min2, max2) {</span>
<span class="line" id="L1409">    <span class="tok-kw">const</span> d = max1 - min1;</span>
<span class="line" id="L1410">    <span class="tok-kw">return</span> min2 + (v - min1) * (max2 - min2) / d;</span>
<span class="line" id="L1411">}</span>
<span class="line" id="L1412"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.mapLinear&quot;</span> {</span>
<span class="line" id="L1413">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, mapLinearV(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1.2</span>, <span class="tok-number">10</span>, <span class="tok-number">100</span>), <span class="tok-number">10</span>, <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1414">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, mapLinearV(<span class="tok-number">1.2</span>, <span class="tok-number">0</span>, <span class="tok-number">1.2</span>, <span class="tok-number">10</span>, <span class="tok-number">100</span>), <span class="tok-number">100</span>, <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1415">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, mapLinearV(<span class="tok-number">0.6</span>, <span class="tok-number">0</span>, <span class="tok-number">1.2</span>, <span class="tok-number">10</span>, <span class="tok-number">100</span>), <span class="tok-number">55</span>, <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1416">    <span class="tok-kw">try</span> expect(approxEqAbs(mapLinearV(splat(F32x4, <span class="tok-number">0</span>), splat(F32x4, <span class="tok-number">0</span>), splat(F32x4, <span class="tok-number">1.2</span>), splat(F32x4, <span class="tok-number">10</span>), splat(F32x4, <span class="tok-number">100</span>)), splat(F32x4, <span class="tok-number">10</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1417">    <span class="tok-kw">try</span> expect(approxEqAbs(mapLinear(f32x4(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0.6</span>, <span class="tok-number">1.2</span>), <span class="tok-number">0</span>, <span class="tok-number">1.2</span>, <span class="tok-number">10</span>, <span class="tok-number">100</span>), f32x4(<span class="tok-number">10</span>, <span class="tok-number">10</span>, <span class="tok-number">55</span>, <span class="tok-number">100</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1418">}</span>
<span class="line" id="L1419"></span>
<span class="line" id="L1420"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F32x4Component = <span class="tok-kw">enum</span> { x, y, z, w };</span>
<span class="line" id="L1421"></span>
<span class="line" id="L1422"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">swizzle</span>(</span>
<span class="line" id="L1423">    v: F32x4,</span>
<span class="line" id="L1424">    <span class="tok-kw">comptime</span> x: F32x4Component,</span>
<span class="line" id="L1425">    <span class="tok-kw">comptime</span> y: F32x4Component,</span>
<span class="line" id="L1426">    <span class="tok-kw">comptime</span> z: F32x4Component,</span>
<span class="line" id="L1427">    <span class="tok-kw">comptime</span> w: F32x4Component,</span>
<span class="line" id="L1428">) F32x4 {</span>
<span class="line" id="L1429">    <span class="tok-kw">return</span> <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v, <span class="tok-null">undefined</span>, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-builtin">@intFromEnum</span>(x), <span class="tok-builtin">@intFromEnum</span>(y), <span class="tok-builtin">@intFromEnum</span>(z), <span class="tok-builtin">@intFromEnum</span>(w) });</span>
<span class="line" id="L1430">}</span>
<span class="line" id="L1431"></span>
<span class="line" id="L1432"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">mod</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1) {</span>
<span class="line" id="L1433">    <span class="tok-comment">// vdivps, vroundps, vmulps, vsubps</span>
</span>
<span class="line" id="L1434">    <span class="tok-kw">return</span> v0 - v1 * trunc(v0 / v1);</span>
<span class="line" id="L1435">}</span>
<span class="line" id="L1436"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.mod&quot;</span> {</span>
<span class="line" id="L1437">    <span class="tok-kw">if</span> (builtin.target.os.tag == .macos <span class="tok-kw">and</span> builtin.zig_backend != .stage1) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SkipZigTest;</span>
<span class="line" id="L1438">    <span class="tok-kw">try</span> expect(approxEqAbs(mod(splat(F32x4, <span class="tok-number">3.1</span>), splat(F32x4, <span class="tok-number">1.7</span>)), splat(F32x4, <span class="tok-number">1.4</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1439">    <span class="tok-kw">try</span> expect(approxEqAbs(mod(splat(F32x4, -<span class="tok-number">3.0</span>), splat(F32x4, <span class="tok-number">2.0</span>)), splat(F32x4, -<span class="tok-number">1.0</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1440">    <span class="tok-kw">try</span> expect(approxEqAbs(mod(splat(F32x4, -<span class="tok-number">3.0</span>), splat(F32x4, -<span class="tok-number">2.0</span>)), splat(F32x4, -<span class="tok-number">1.0</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1441">    <span class="tok-kw">try</span> expect(approxEqAbs(mod(splat(F32x4, <span class="tok-number">3.0</span>), splat(F32x4, -<span class="tok-number">2.0</span>)), splat(F32x4, <span class="tok-number">1.0</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1442">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, math.inf(<span class="tok-type">f32</span>)), splat(F32x4, <span class="tok-number">1.0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1443">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, -math.inf(<span class="tok-type">f32</span>)), splat(F32x4, <span class="tok-number">123.456</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1444">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, math.nan_f32), splat(F32x4, <span class="tok-number">123.456</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1445">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, math.qnan_f32), splat(F32x4, <span class="tok-number">123.456</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1446">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, -math.qnan_f32), splat(F32x4, <span class="tok-number">123.456</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1447">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, <span class="tok-number">123.456</span>), splat(F32x4, math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1448">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, <span class="tok-number">123.456</span>), splat(F32x4, -math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1449">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, math.inf(<span class="tok-type">f32</span>)), splat(F32x4, math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1450">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, <span class="tok-number">123.456</span>), splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1451">    <span class="tok-kw">try</span> expect(all(isNan(mod(splat(F32x4, math.inf(<span class="tok-type">f32</span>)), splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>));</span>
<span class="line" id="L1452">}</span>
<span class="line" id="L1453"></span>
<span class="line" id="L1454"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">modAngle</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1455">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1456">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (T) {</span>
<span class="line" id="L1457">        <span class="tok-type">f32</span> =&gt; modAngle32(v),</span>
<span class="line" id="L1458">        F32x4, F32x8, F32x16 =&gt; modAngle32xN(v),</span>
<span class="line" id="L1459">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.modAngle() not implemented for &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T)),</span>
<span class="line" id="L1460">    };</span>
<span class="line" id="L1461">}</span>
<span class="line" id="L1462"></span>
<span class="line" id="L1463"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">modAngle32xN</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1464">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1465">    <span class="tok-kw">return</span> v - splat(T, math.tau) * round(v * splat(T, <span class="tok-number">1.0</span> / math.tau)); <span class="tok-comment">// 2 x vmulps, 2 x load, vroundps, vaddps</span>
</span>
<span class="line" id="L1466">}</span>
<span class="line" id="L1467"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.modAngle&quot;</span> {</span>
<span class="line" id="L1468">    <span class="tok-kw">try</span> expect(approxEqAbs(modAngle(splat(F32x4, math.tau)), splat(F32x4, <span class="tok-number">0.0</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1469">    <span class="tok-kw">try</span> expect(approxEqAbs(modAngle(splat(F32x4, <span class="tok-number">0.0</span>)), splat(F32x4, <span class="tok-number">0.0</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1470">    <span class="tok-kw">try</span> expect(approxEqAbs(modAngle(splat(F32x4, math.pi)), splat(F32x4, math.pi), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1471">    <span class="tok-kw">try</span> expect(approxEqAbs(modAngle(splat(F32x4, <span class="tok-number">11</span> * math.pi)), splat(F32x4, math.pi), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1472">    <span class="tok-kw">try</span> expect(approxEqAbs(modAngle(splat(F32x4, <span class="tok-number">3.5</span> * math.pi)), splat(F32x4, -<span class="tok-number">0.5</span> * math.pi), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1473">    <span class="tok-kw">try</span> expect(approxEqAbs(modAngle(splat(F32x4, <span class="tok-number">2.5</span> * math.pi)), splat(F32x4, <span class="tok-number">0.5</span> * math.pi), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L1474">}</span>
<span class="line" id="L1475"></span>
<span class="line" id="L1476"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">mulAdd</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>, v2: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v0, v1, v2) {</span>
<span class="line" id="L1477">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1, v2);</span>
<span class="line" id="L1478">    <span class="tok-kw">if</span> (<span class="tok-builtin">@import</span>(<span class="tok-str">&quot;zmath_options&quot;</span>).enable_cross_platform_determinism) {</span>
<span class="line" id="L1479">        <span class="tok-kw">return</span> v0 * v1 + v2; <span class="tok-comment">// Compiler will generate mul, add sequence (no fma even if the target supports it).</span>
</span>
<span class="line" id="L1480">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1481">        <span class="tok-kw">if</span> (cpu_arch == .x86_64 <span class="tok-kw">and</span> has_avx <span class="tok-kw">and</span> has_fma) {</span>
<span class="line" id="L1482">            <span class="tok-kw">return</span> <span class="tok-builtin">@mulAdd</span>(T, v0, v1, v2);</span>
<span class="line" id="L1483">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1484">            <span class="tok-comment">// NOTE(mziulek): On .x86_64 without HW fma instructions @mulAdd maps to really slow code!</span>
</span>
<span class="line" id="L1485">            <span class="tok-kw">return</span> v0 * v1 + v2;</span>
<span class="line" id="L1486">        }</span>
<span class="line" id="L1487">    }</span>
<span class="line" id="L1488">}</span>
<span class="line" id="L1489"></span>
<span class="line" id="L1490"><span class="tok-kw">fn</span> <span class="tok-fn">sin32xN</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1491">    <span class="tok-comment">// 11-degree minimax approximation</span>
</span>
<span class="line" id="L1492">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1493"></span>
<span class="line" id="L1494">    <span class="tok-kw">var</span> x = modAngle(v);</span>
<span class="line" id="L1495">    <span class="tok-kw">const</span> sign = andInt(x, splatNegativeZero(T));</span>
<span class="line" id="L1496">    <span class="tok-kw">const</span> c = orInt(sign, splat(T, math.pi));</span>
<span class="line" id="L1497">    <span class="tok-kw">const</span> absx = andNotInt(sign, x);</span>
<span class="line" id="L1498">    <span class="tok-kw">const</span> rflx = c - x;</span>
<span class="line" id="L1499">    <span class="tok-kw">const</span> comp = absx &lt;= splat(T, <span class="tok-number">0.5</span> * math.pi);</span>
<span class="line" id="L1500">    x = select(comp, x, rflx);</span>
<span class="line" id="L1501">    <span class="tok-kw">const</span> x2 = x * x;</span>
<span class="line" id="L1502"></span>
<span class="line" id="L1503">    <span class="tok-kw">var</span> result = mulAdd(splat(T, -<span class="tok-number">2.3889859e-08</span>), x2, splat(T, <span class="tok-number">2.7525562e-06</span>));</span>
<span class="line" id="L1504">    result = mulAdd(result, x2, splat(T, -<span class="tok-number">0.00019840874</span>));</span>
<span class="line" id="L1505">    result = mulAdd(result, x2, splat(T, <span class="tok-number">0.0083333310</span>));</span>
<span class="line" id="L1506">    result = mulAdd(result, x2, splat(T, -<span class="tok-number">0.16666667</span>));</span>
<span class="line" id="L1507">    result = mulAdd(result, x2, splat(T, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L1508">    <span class="tok-kw">return</span> x * result;</span>
<span class="line" id="L1509">}</span>
<span class="line" id="L1510"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.sin&quot;</span> {</span>
<span class="line" id="L1511">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L1512"></span>
<span class="line" id="L1513">    <span class="tok-kw">try</span> expect(approxEqAbs(sin(splat(F32x4, <span class="tok-number">0.5</span> * math.pi)), splat(F32x4, <span class="tok-number">1.0</span>), epsilon));</span>
<span class="line" id="L1514">    <span class="tok-kw">try</span> expect(approxEqAbs(sin(splat(F32x4, <span class="tok-number">0.0</span>)), splat(F32x4, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L1515">    <span class="tok-kw">try</span> expect(approxEqAbs(sin(splat(F32x4, -<span class="tok-number">0.0</span>)), splat(F32x4, -<span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L1516">    <span class="tok-kw">try</span> expect(approxEqAbs(sin(splat(F32x4, <span class="tok-number">89.123</span>)), splat(F32x4, <span class="tok-number">0.916166</span>), epsilon));</span>
<span class="line" id="L1517">    <span class="tok-kw">try</span> expect(approxEqAbs(sin(splat(F32x8, <span class="tok-number">89.123</span>)), splat(F32x8, <span class="tok-number">0.916166</span>), epsilon));</span>
<span class="line" id="L1518">    <span class="tok-kw">try</span> expect(approxEqAbs(sin(splat(F32x16, <span class="tok-number">89.123</span>)), splat(F32x16, <span class="tok-number">0.916166</span>), epsilon));</span>
<span class="line" id="L1519">    <span class="tok-kw">try</span> expect(all(isNan(sin(splat(F32x4, math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1520">    <span class="tok-kw">try</span> expect(all(isNan(sin(splat(F32x4, -math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1521">    <span class="tok-kw">try</span> expect(all(isNan(sin(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1522">    <span class="tok-kw">try</span> expect(all(isNan(sin(splat(F32x4, math.qnan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1523"></span>
<span class="line" id="L1524">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">100.0</span>;</span>
<span class="line" id="L1525">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1526">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">100</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1527">        <span class="tok-kw">const</span> vr = sin(splat(F32x4, f));</span>
<span class="line" id="L1528">        <span class="tok-kw">const</span> fr = <span class="tok-builtin">@sin</span>(splat(F32x4, f));</span>
<span class="line" id="L1529">        <span class="tok-kw">const</span> vr8 = sin(splat(F32x8, f));</span>
<span class="line" id="L1530">        <span class="tok-kw">const</span> fr8 = <span class="tok-builtin">@sin</span>(splat(F32x8, f));</span>
<span class="line" id="L1531">        <span class="tok-kw">const</span> vr16 = sin(splat(F32x16, f));</span>
<span class="line" id="L1532">        <span class="tok-kw">const</span> fr16 = <span class="tok-builtin">@sin</span>(splat(F32x16, f));</span>
<span class="line" id="L1533">        <span class="tok-kw">try</span> expect(approxEqAbs(vr, fr, epsilon));</span>
<span class="line" id="L1534">        <span class="tok-kw">try</span> expect(approxEqAbs(vr8, fr8, epsilon));</span>
<span class="line" id="L1535">        <span class="tok-kw">try</span> expect(approxEqAbs(vr16, fr16, epsilon));</span>
<span class="line" id="L1536">        f += <span class="tok-number">0.12345</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L1537">    }</span>
<span class="line" id="L1538">}</span>
<span class="line" id="L1539"></span>
<span class="line" id="L1540"><span class="tok-kw">fn</span> <span class="tok-fn">cos32xN</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1541">    <span class="tok-comment">// 10-degree minimax approximation</span>
</span>
<span class="line" id="L1542">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1543"></span>
<span class="line" id="L1544">    <span class="tok-kw">var</span> x = modAngle(v);</span>
<span class="line" id="L1545">    <span class="tok-kw">var</span> sign = andInt(x, splatNegativeZero(T));</span>
<span class="line" id="L1546">    <span class="tok-kw">const</span> c = orInt(sign, splat(T, math.pi));</span>
<span class="line" id="L1547">    <span class="tok-kw">const</span> absx = andNotInt(sign, x);</span>
<span class="line" id="L1548">    <span class="tok-kw">const</span> rflx = c - x;</span>
<span class="line" id="L1549">    <span class="tok-kw">const</span> comp = absx &lt;= splat(T, <span class="tok-number">0.5</span> * math.pi);</span>
<span class="line" id="L1550">    x = select(comp, x, rflx);</span>
<span class="line" id="L1551">    sign = select(comp, splat(T, <span class="tok-number">1.0</span>), splat(T, -<span class="tok-number">1.0</span>));</span>
<span class="line" id="L1552">    <span class="tok-kw">const</span> x2 = x * x;</span>
<span class="line" id="L1553"></span>
<span class="line" id="L1554">    <span class="tok-kw">var</span> result = mulAdd(splat(T, -<span class="tok-number">2.6051615e-07</span>), x2, splat(T, <span class="tok-number">2.4760495e-05</span>));</span>
<span class="line" id="L1555">    result = mulAdd(result, x2, splat(T, -<span class="tok-number">0.0013888378</span>));</span>
<span class="line" id="L1556">    result = mulAdd(result, x2, splat(T, <span class="tok-number">0.041666638</span>));</span>
<span class="line" id="L1557">    result = mulAdd(result, x2, splat(T, -<span class="tok-number">0.5</span>));</span>
<span class="line" id="L1558">    result = mulAdd(result, x2, splat(T, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L1559">    <span class="tok-kw">return</span> sign * result;</span>
<span class="line" id="L1560">}</span>
<span class="line" id="L1561"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.cos&quot;</span> {</span>
<span class="line" id="L1562">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L1563"></span>
<span class="line" id="L1564">    <span class="tok-kw">try</span> expect(approxEqAbs(cos(splat(F32x4, <span class="tok-number">0.5</span> * math.pi)), splat(F32x4, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L1565">    <span class="tok-kw">try</span> expect(approxEqAbs(cos(splat(F32x4, <span class="tok-number">0.0</span>)), splat(F32x4, <span class="tok-number">1.0</span>), epsilon));</span>
<span class="line" id="L1566">    <span class="tok-kw">try</span> expect(approxEqAbs(cos(splat(F32x4, -<span class="tok-number">0.0</span>)), splat(F32x4, <span class="tok-number">1.0</span>), epsilon));</span>
<span class="line" id="L1567">    <span class="tok-kw">try</span> expect(all(isNan(cos(splat(F32x4, math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1568">    <span class="tok-kw">try</span> expect(all(isNan(cos(splat(F32x4, -math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1569">    <span class="tok-kw">try</span> expect(all(isNan(cos(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1570">    <span class="tok-kw">try</span> expect(all(isNan(cos(splat(F32x4, math.qnan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1571"></span>
<span class="line" id="L1572">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">100.0</span>;</span>
<span class="line" id="L1573">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1574">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">100</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1575">        <span class="tok-kw">const</span> vr = cos(splat(F32x4, f));</span>
<span class="line" id="L1576">        <span class="tok-kw">const</span> fr = <span class="tok-builtin">@cos</span>(splat(F32x4, f));</span>
<span class="line" id="L1577">        <span class="tok-kw">const</span> vr8 = cos(splat(F32x8, f));</span>
<span class="line" id="L1578">        <span class="tok-kw">const</span> fr8 = <span class="tok-builtin">@cos</span>(splat(F32x8, f));</span>
<span class="line" id="L1579">        <span class="tok-kw">const</span> vr16 = cos(splat(F32x16, f));</span>
<span class="line" id="L1580">        <span class="tok-kw">const</span> fr16 = <span class="tok-builtin">@cos</span>(splat(F32x16, f));</span>
<span class="line" id="L1581">        <span class="tok-kw">try</span> expect(approxEqAbs(vr, fr, epsilon));</span>
<span class="line" id="L1582">        <span class="tok-kw">try</span> expect(approxEqAbs(vr8, fr8, epsilon));</span>
<span class="line" id="L1583">        <span class="tok-kw">try</span> expect(approxEqAbs(vr16, fr16, epsilon));</span>
<span class="line" id="L1584">        f += <span class="tok-number">0.12345</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L1585">    }</span>
<span class="line" id="L1586">}</span>
<span class="line" id="L1587"></span>
<span class="line" id="L1588"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sin</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1589">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1590">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (T) {</span>
<span class="line" id="L1591">        <span class="tok-type">f32</span> =&gt; sin32(v),</span>
<span class="line" id="L1592">        F32x4, F32x8, F32x16 =&gt; sin32xN(v),</span>
<span class="line" id="L1593">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.sin() not implemented for &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T)),</span>
<span class="line" id="L1594">    };</span>
<span class="line" id="L1595">}</span>
<span class="line" id="L1596"></span>
<span class="line" id="L1597"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">cos</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1598">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1599">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (T) {</span>
<span class="line" id="L1600">        <span class="tok-type">f32</span> =&gt; cos32(v),</span>
<span class="line" id="L1601">        F32x4, F32x8, F32x16 =&gt; cos32xN(v),</span>
<span class="line" id="L1602">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.cos() not implemented for &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T)),</span>
<span class="line" id="L1603">    };</span>
<span class="line" id="L1604">}</span>
<span class="line" id="L1605"></span>
<span class="line" id="L1606"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sincos</span>(v: <span class="tok-kw">anytype</span>) [<span class="tok-number">2</span>]<span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1607">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1608">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (T) {</span>
<span class="line" id="L1609">        <span class="tok-type">f32</span> =&gt; sincos32(v),</span>
<span class="line" id="L1610">        F32x4, F32x8, F32x16 =&gt; sincos32xN(v),</span>
<span class="line" id="L1611">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.sincos() not implemented for &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T)),</span>
<span class="line" id="L1612">    };</span>
<span class="line" id="L1613">}</span>
<span class="line" id="L1614"></span>
<span class="line" id="L1615"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">asin</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1616">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1617">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (T) {</span>
<span class="line" id="L1618">        <span class="tok-type">f32</span> =&gt; asin32(v),</span>
<span class="line" id="L1619">        F32x4, F32x8, F32x16 =&gt; asin32xN(v),</span>
<span class="line" id="L1620">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.asin() not implemented for &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T)),</span>
<span class="line" id="L1621">    };</span>
<span class="line" id="L1622">}</span>
<span class="line" id="L1623"></span>
<span class="line" id="L1624"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">acos</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1625">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1626">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (T) {</span>
<span class="line" id="L1627">        <span class="tok-type">f32</span> =&gt; acos32(v),</span>
<span class="line" id="L1628">        F32x4, F32x8, F32x16 =&gt; acos32xN(v),</span>
<span class="line" id="L1629">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.acos() not implemented for &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T)),</span>
<span class="line" id="L1630">    };</span>
<span class="line" id="L1631">}</span>
<span class="line" id="L1632"></span>
<span class="line" id="L1633"><span class="tok-kw">fn</span> <span class="tok-fn">sincos32xN</span>(v: <span class="tok-kw">anytype</span>) [<span class="tok-number">2</span>]<span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1634">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1635"></span>
<span class="line" id="L1636">    <span class="tok-kw">var</span> x = modAngle(v);</span>
<span class="line" id="L1637">    <span class="tok-kw">var</span> sign = andInt(x, splatNegativeZero(T));</span>
<span class="line" id="L1638">    <span class="tok-kw">const</span> c = orInt(sign, splat(T, math.pi));</span>
<span class="line" id="L1639">    <span class="tok-kw">const</span> absx = andNotInt(sign, x);</span>
<span class="line" id="L1640">    <span class="tok-kw">const</span> rflx = c - x;</span>
<span class="line" id="L1641">    <span class="tok-kw">const</span> comp = absx &lt;= splat(T, <span class="tok-number">0.5</span> * math.pi);</span>
<span class="line" id="L1642">    x = select(comp, x, rflx);</span>
<span class="line" id="L1643">    sign = select(comp, splat(T, <span class="tok-number">1.0</span>), splat(T, -<span class="tok-number">1.0</span>));</span>
<span class="line" id="L1644">    <span class="tok-kw">const</span> x2 = x * x;</span>
<span class="line" id="L1645"></span>
<span class="line" id="L1646">    <span class="tok-kw">var</span> sresult = mulAdd(splat(T, -<span class="tok-number">2.3889859e-08</span>), x2, splat(T, <span class="tok-number">2.7525562e-06</span>));</span>
<span class="line" id="L1647">    sresult = mulAdd(sresult, x2, splat(T, -<span class="tok-number">0.00019840874</span>));</span>
<span class="line" id="L1648">    sresult = mulAdd(sresult, x2, splat(T, <span class="tok-number">0.0083333310</span>));</span>
<span class="line" id="L1649">    sresult = mulAdd(sresult, x2, splat(T, -<span class="tok-number">0.16666667</span>));</span>
<span class="line" id="L1650">    sresult = x * mulAdd(sresult, x2, splat(T, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L1651"></span>
<span class="line" id="L1652">    <span class="tok-kw">var</span> cresult = mulAdd(splat(T, -<span class="tok-number">2.6051615e-07</span>), x2, splat(T, <span class="tok-number">2.4760495e-05</span>));</span>
<span class="line" id="L1653">    cresult = mulAdd(cresult, x2, splat(T, -<span class="tok-number">0.0013888378</span>));</span>
<span class="line" id="L1654">    cresult = mulAdd(cresult, x2, splat(T, <span class="tok-number">0.041666638</span>));</span>
<span class="line" id="L1655">    cresult = mulAdd(cresult, x2, splat(T, -<span class="tok-number">0.5</span>));</span>
<span class="line" id="L1656">    cresult = sign * mulAdd(cresult, x2, splat(T, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L1657"></span>
<span class="line" id="L1658">    <span class="tok-kw">return</span> .{ sresult, cresult };</span>
<span class="line" id="L1659">}</span>
<span class="line" id="L1660"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.sincos32xN&quot;</span> {</span>
<span class="line" id="L1661">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L1662"></span>
<span class="line" id="L1663">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">100.0</span>;</span>
<span class="line" id="L1664">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1665">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">100</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1666">        <span class="tok-kw">const</span> sc = sincos(splat(F32x4, f));</span>
<span class="line" id="L1667">        <span class="tok-kw">const</span> sc8 = sincos(splat(F32x8, f));</span>
<span class="line" id="L1668">        <span class="tok-kw">const</span> sc16 = sincos(splat(F32x16, f));</span>
<span class="line" id="L1669">        <span class="tok-kw">const</span> s4 = <span class="tok-builtin">@sin</span>(splat(F32x4, f));</span>
<span class="line" id="L1670">        <span class="tok-kw">const</span> s8 = <span class="tok-builtin">@sin</span>(splat(F32x8, f));</span>
<span class="line" id="L1671">        <span class="tok-kw">const</span> s16 = <span class="tok-builtin">@sin</span>(splat(F32x16, f));</span>
<span class="line" id="L1672">        <span class="tok-kw">const</span> c4 = <span class="tok-builtin">@cos</span>(splat(F32x4, f));</span>
<span class="line" id="L1673">        <span class="tok-kw">const</span> c8 = <span class="tok-builtin">@cos</span>(splat(F32x8, f));</span>
<span class="line" id="L1674">        <span class="tok-kw">const</span> c16 = <span class="tok-builtin">@cos</span>(splat(F32x16, f));</span>
<span class="line" id="L1675">        <span class="tok-kw">try</span> expect(approxEqAbs(sc[<span class="tok-number">0</span>], s4, epsilon));</span>
<span class="line" id="L1676">        <span class="tok-kw">try</span> expect(approxEqAbs(sc8[<span class="tok-number">0</span>], s8, epsilon));</span>
<span class="line" id="L1677">        <span class="tok-kw">try</span> expect(approxEqAbs(sc16[<span class="tok-number">0</span>], s16, epsilon));</span>
<span class="line" id="L1678">        <span class="tok-kw">try</span> expect(approxEqAbs(sc[<span class="tok-number">1</span>], c4, epsilon));</span>
<span class="line" id="L1679">        <span class="tok-kw">try</span> expect(approxEqAbs(sc8[<span class="tok-number">1</span>], c8, epsilon));</span>
<span class="line" id="L1680">        <span class="tok-kw">try</span> expect(approxEqAbs(sc16[<span class="tok-number">1</span>], c16, epsilon));</span>
<span class="line" id="L1681">        f += <span class="tok-number">0.12345</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L1682">    }</span>
<span class="line" id="L1683">}</span>
<span class="line" id="L1684"></span>
<span class="line" id="L1685"><span class="tok-kw">fn</span> <span class="tok-fn">asin32xN</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1686">    <span class="tok-comment">// 7-degree minimax approximation</span>
</span>
<span class="line" id="L1687">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1688"></span>
<span class="line" id="L1689">    <span class="tok-kw">const</span> x = abs(v);</span>
<span class="line" id="L1690">    <span class="tok-kw">const</span> root = sqrt(maxFast(splat(T, <span class="tok-number">0.0</span>), splat(T, <span class="tok-number">1.0</span>) - x));</span>
<span class="line" id="L1691"></span>
<span class="line" id="L1692">    <span class="tok-kw">var</span> t0 = mulAdd(splat(T, -<span class="tok-number">0.0012624911</span>), x, splat(T, <span class="tok-number">0.0066700901</span>));</span>
<span class="line" id="L1693">    t0 = mulAdd(t0, x, splat(T, -<span class="tok-number">0.0170881256</span>));</span>
<span class="line" id="L1694">    t0 = mulAdd(t0, x, splat(T, <span class="tok-number">0.0308918810</span>));</span>
<span class="line" id="L1695">    t0 = mulAdd(t0, x, splat(T, -<span class="tok-number">0.0501743046</span>));</span>
<span class="line" id="L1696">    t0 = mulAdd(t0, x, splat(T, <span class="tok-number">0.0889789874</span>));</span>
<span class="line" id="L1697">    t0 = mulAdd(t0, x, splat(T, -<span class="tok-number">0.2145988016</span>));</span>
<span class="line" id="L1698">    t0 = root * mulAdd(t0, x, splat(T, <span class="tok-number">1.5707963050</span>));</span>
<span class="line" id="L1699"></span>
<span class="line" id="L1700">    <span class="tok-kw">const</span> t1 = splat(T, math.pi) - t0;</span>
<span class="line" id="L1701">    <span class="tok-kw">return</span> splat(T, <span class="tok-number">0.5</span> * math.pi) - select(v &gt;= splat(T, <span class="tok-number">0.0</span>), t0, t1);</span>
<span class="line" id="L1702">}</span>
<span class="line" id="L1703"></span>
<span class="line" id="L1704"><span class="tok-kw">fn</span> <span class="tok-fn">acos32xN</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1705">    <span class="tok-comment">// 7-degree minimax approximation</span>
</span>
<span class="line" id="L1706">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1707"></span>
<span class="line" id="L1708">    <span class="tok-kw">const</span> x = abs(v);</span>
<span class="line" id="L1709">    <span class="tok-kw">const</span> root = sqrt(maxFast(splat(T, <span class="tok-number">0.0</span>), splat(T, <span class="tok-number">1.0</span>) - x));</span>
<span class="line" id="L1710"></span>
<span class="line" id="L1711">    <span class="tok-kw">var</span> t0 = mulAdd(splat(T, -<span class="tok-number">0.0012624911</span>), x, splat(T, <span class="tok-number">0.0066700901</span>));</span>
<span class="line" id="L1712">    t0 = mulAdd(t0, x, splat(T, -<span class="tok-number">0.0170881256</span>));</span>
<span class="line" id="L1713">    t0 = mulAdd(t0, x, splat(T, <span class="tok-number">0.0308918810</span>));</span>
<span class="line" id="L1714">    t0 = mulAdd(t0, x, splat(T, -<span class="tok-number">0.0501743046</span>));</span>
<span class="line" id="L1715">    t0 = mulAdd(t0, x, splat(T, <span class="tok-number">0.0889789874</span>));</span>
<span class="line" id="L1716">    t0 = mulAdd(t0, x, splat(T, -<span class="tok-number">0.2145988016</span>));</span>
<span class="line" id="L1717">    t0 = root * mulAdd(t0, x, splat(T, <span class="tok-number">1.5707963050</span>));</span>
<span class="line" id="L1718"></span>
<span class="line" id="L1719">    <span class="tok-kw">const</span> t1 = splat(T, math.pi) - t0;</span>
<span class="line" id="L1720">    <span class="tok-kw">return</span> select(v &gt;= splat(T, <span class="tok-number">0.0</span>), t0, t1);</span>
<span class="line" id="L1721">}</span>
<span class="line" id="L1722"></span>
<span class="line" id="L1723"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">atan</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L1724">    <span class="tok-comment">// 17-degree minimax approximation</span>
</span>
<span class="line" id="L1725">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L1726"></span>
<span class="line" id="L1727">    <span class="tok-kw">const</span> vabs = abs(v);</span>
<span class="line" id="L1728">    <span class="tok-kw">const</span> vinv = splat(T, <span class="tok-number">1.0</span>) / v;</span>
<span class="line" id="L1729">    <span class="tok-kw">var</span> sign = select(v &gt; splat(T, <span class="tok-number">1.0</span>), splat(T, <span class="tok-number">1.0</span>), splat(T, -<span class="tok-number">1.0</span>));</span>
<span class="line" id="L1730">    <span class="tok-kw">const</span> comp = vabs &lt;= splat(T, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1731">    sign = select(comp, splat(T, <span class="tok-number">0.0</span>), sign);</span>
<span class="line" id="L1732">    <span class="tok-kw">const</span> x = select(comp, v, vinv);</span>
<span class="line" id="L1733">    <span class="tok-kw">const</span> x2 = x * x;</span>
<span class="line" id="L1734"></span>
<span class="line" id="L1735">    <span class="tok-kw">var</span> result = mulAdd(splat(T, <span class="tok-number">0.0028662257</span>), x2, splat(T, -<span class="tok-number">0.0161657367</span>));</span>
<span class="line" id="L1736">    result = mulAdd(result, x2, splat(T, <span class="tok-number">0.0429096138</span>));</span>
<span class="line" id="L1737">    result = mulAdd(result, x2, splat(T, -<span class="tok-number">0.0752896400</span>));</span>
<span class="line" id="L1738">    result = mulAdd(result, x2, splat(T, <span class="tok-number">0.1065626393</span>));</span>
<span class="line" id="L1739">    result = mulAdd(result, x2, splat(T, -<span class="tok-number">0.1420889944</span>));</span>
<span class="line" id="L1740">    result = mulAdd(result, x2, splat(T, <span class="tok-number">0.1999355085</span>));</span>
<span class="line" id="L1741">    result = mulAdd(result, x2, splat(T, -<span class="tok-number">0.3333314528</span>));</span>
<span class="line" id="L1742">    result = x * mulAdd(result, x2, splat(T, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L1743"></span>
<span class="line" id="L1744">    <span class="tok-kw">const</span> result1 = sign * splat(T, <span class="tok-number">0.5</span> * math.pi) - result;</span>
<span class="line" id="L1745">    <span class="tok-kw">return</span> select(sign == splat(T, <span class="tok-number">0.0</span>), result, result1);</span>
<span class="line" id="L1746">}</span>
<span class="line" id="L1747"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.atan&quot;</span> {</span>
<span class="line" id="L1748">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L1749">    {</span>
<span class="line" id="L1750">        <span class="tok-kw">const</span> v = f32x4(<span class="tok-number">0.25</span>, <span class="tok-number">0.5</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.25</span>);</span>
<span class="line" id="L1751">        <span class="tok-kw">const</span> e = f32x4(math.atan(v[<span class="tok-number">0</span>]), math.atan(v[<span class="tok-number">1</span>]), math.atan(v[<span class="tok-number">2</span>]), math.atan(v[<span class="tok-number">3</span>]));</span>
<span class="line" id="L1752">        <span class="tok-kw">try</span> expect(approxEqAbs(e, atan(v), epsilon));</span>
<span class="line" id="L1753">    }</span>
<span class="line" id="L1754">    {</span>
<span class="line" id="L1755">        <span class="tok-kw">const</span> v = f32x8(-<span class="tok-number">0.25</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.25</span>, <span class="tok-number">100.0</span>, -<span class="tok-number">200.0</span>, <span class="tok-number">300.0</span>, <span class="tok-number">400.0</span>);</span>
<span class="line" id="L1756">        <span class="tok-comment">// zig fmt: off</span>
</span>
<span class="line" id="L1757">        <span class="tok-kw">const</span> e = f32x8(</span>
<span class="line" id="L1758">            math.atan(v[<span class="tok-number">0</span>]), math.atan(v[<span class="tok-number">1</span>]), math.atan(v[<span class="tok-number">2</span>]), math.atan(v[<span class="tok-number">3</span>]),</span>
<span class="line" id="L1759">            math.atan(v[<span class="tok-number">4</span>]), math.atan(v[<span class="tok-number">5</span>]), math.atan(v[<span class="tok-number">6</span>]), math.atan(v[<span class="tok-number">7</span>]),</span>
<span class="line" id="L1760">        );</span>
<span class="line" id="L1761">        <span class="tok-comment">// zig fmt: on</span>
</span>
<span class="line" id="L1762">        <span class="tok-kw">try</span> expect(approxEqAbs(e, atan(v), epsilon));</span>
<span class="line" id="L1763">    }</span>
<span class="line" id="L1764">    {</span>
<span class="line" id="L1765">        <span class="tok-comment">// zig fmt: off</span>
</span>
<span class="line" id="L1766">        <span class="tok-kw">const</span> v = f32x16(</span>
<span class="line" id="L1767">            -<span class="tok-number">0.25</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.1</span>, -<span class="tok-number">0.2</span>, <span class="tok-number">30.0</span>, <span class="tok-number">400.0</span>,</span>
<span class="line" id="L1768">            -<span class="tok-number">0.25</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">0.0</span>, -<span class="tok-number">0.05</span>, -<span class="tok-number">0.125</span>, <span class="tok-number">0.0625</span>, <span class="tok-number">4000.0</span></span>
<span class="line" id="L1769">        );</span>
<span class="line" id="L1770">        <span class="tok-kw">const</span> e = f32x16(</span>
<span class="line" id="L1771">            math.atan(v[<span class="tok-number">0</span>]), math.atan(v[<span class="tok-number">1</span>]), math.atan(v[<span class="tok-number">2</span>]), math.atan(v[<span class="tok-number">3</span>]),</span>
<span class="line" id="L1772">            math.atan(v[<span class="tok-number">4</span>]), math.atan(v[<span class="tok-number">5</span>]), math.atan(v[<span class="tok-number">6</span>]), math.atan(v[<span class="tok-number">7</span>]),</span>
<span class="line" id="L1773">            math.atan(v[<span class="tok-number">8</span>]), math.atan(v[<span class="tok-number">9</span>]), math.atan(v[<span class="tok-number">10</span>]), math.atan(v[<span class="tok-number">11</span>]),</span>
<span class="line" id="L1774">            math.atan(v[<span class="tok-number">12</span>]), math.atan(v[<span class="tok-number">13</span>]), math.atan(v[<span class="tok-number">14</span>]), math.atan(v[<span class="tok-number">15</span>]),</span>
<span class="line" id="L1775">        );</span>
<span class="line" id="L1776">        <span class="tok-comment">// zig fmt: on</span>
</span>
<span class="line" id="L1777">        <span class="tok-kw">try</span> expect(approxEqAbs(e, atan(v), epsilon));</span>
<span class="line" id="L1778">    }</span>
<span class="line" id="L1779">    {</span>
<span class="line" id="L1780">        <span class="tok-kw">try</span> expect(approxEqAbs(atan(splat(F32x4, math.inf(<span class="tok-type">f32</span>))), splat(F32x4, <span class="tok-number">0.5</span> * math.pi), epsilon));</span>
<span class="line" id="L1781">        <span class="tok-kw">try</span> expect(approxEqAbs(atan(splat(F32x4, -math.inf(<span class="tok-type">f32</span>))), splat(F32x4, -<span class="tok-number">0.5</span> * math.pi), epsilon));</span>
<span class="line" id="L1782">        <span class="tok-kw">try</span> expect(all(isNan(atan(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1783">        <span class="tok-kw">try</span> expect(all(isNan(atan(splat(F32x4, -math.nan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1784">    }</span>
<span class="line" id="L1785">}</span>
<span class="line" id="L1786"></span>
<span class="line" id="L1787"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">atan2</span>(vy: <span class="tok-kw">anytype</span>, vx: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(vx, vy) {</span>
<span class="line" id="L1788">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(vx, vy);</span>
<span class="line" id="L1789">    <span class="tok-kw">const</span> Tu = <span class="tok-builtin">@Vector</span>(veclen(T), <span class="tok-type">u32</span>);</span>
<span class="line" id="L1790"></span>
<span class="line" id="L1791">    <span class="tok-kw">const</span> vx_is_positive =</span>
<span class="line" id="L1792">        (<span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(vx)) &amp; <span class="tok-builtin">@as</span>(veclen(T), <span class="tok-builtin">@splat</span>(<span class="tok-number">0x8000_0000</span>))) == <span class="tok-builtin">@as</span>(veclen(T), <span class="tok-builtin">@splat</span>(<span class="tok-number">0</span>));</span>
<span class="line" id="L1793"></span>
<span class="line" id="L1794">    <span class="tok-kw">const</span> vy_sign = andInt(vy, splatNegativeZero(T));</span>
<span class="line" id="L1795">    <span class="tok-kw">const</span> c0_25pi = orInt(vy_sign, splat(T, <span class="tok-number">0.25</span> * math.pi));</span>
<span class="line" id="L1796">    <span class="tok-kw">const</span> c0_50pi = orInt(vy_sign, splat(T, <span class="tok-number">0.50</span> * math.pi));</span>
<span class="line" id="L1797">    <span class="tok-kw">const</span> c0_75pi = orInt(vy_sign, splat(T, <span class="tok-number">0.75</span> * math.pi));</span>
<span class="line" id="L1798">    <span class="tok-kw">const</span> c1_00pi = orInt(vy_sign, splat(T, <span class="tok-number">1.00</span> * math.pi));</span>
<span class="line" id="L1799"></span>
<span class="line" id="L1800">    <span class="tok-kw">var</span> r1 = select(vx_is_positive, vy_sign, c1_00pi);</span>
<span class="line" id="L1801">    <span class="tok-kw">var</span> r2 = select(vx == splat(T, <span class="tok-number">0.0</span>), c0_50pi, splatInt(T, <span class="tok-number">0xffff_ffff</span>));</span>
<span class="line" id="L1802">    <span class="tok-kw">const</span> r3 = select(vy == splat(T, <span class="tok-number">0.0</span>), r1, r2);</span>
<span class="line" id="L1803">    <span class="tok-kw">const</span> r4 = select(vx_is_positive, c0_25pi, c0_75pi);</span>
<span class="line" id="L1804">    <span class="tok-kw">const</span> r5 = select(isInf(vx), r4, c0_50pi);</span>
<span class="line" id="L1805">    <span class="tok-kw">const</span> result = select(isInf(vy), r5, r3);</span>
<span class="line" id="L1806">    <span class="tok-kw">const</span> result_valid = <span class="tok-builtin">@as</span>(Tu, <span class="tok-builtin">@bitCast</span>(result)) == <span class="tok-builtin">@as</span>(veclen(T), <span class="tok-builtin">@splat</span>(<span class="tok-number">0xffff_ffff</span>));</span>
<span class="line" id="L1807"></span>
<span class="line" id="L1808">    <span class="tok-kw">const</span> v = vy / vx;</span>
<span class="line" id="L1809">    <span class="tok-kw">const</span> r0 = atan(v);</span>
<span class="line" id="L1810"></span>
<span class="line" id="L1811">    r1 = select(vx_is_positive, splatNegativeZero(T), c1_00pi);</span>
<span class="line" id="L1812">    r2 = r0 + r1;</span>
<span class="line" id="L1813"></span>
<span class="line" id="L1814">    <span class="tok-kw">return</span> select(result_valid, r2, result);</span>
<span class="line" id="L1815">}</span>
<span class="line" id="L1816"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.atan2&quot;</span> {</span>
<span class="line" id="L1817">    <span class="tok-comment">// From DirectXMath XMVectorATan2():</span>
</span>
<span class="line" id="L1818">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L1819">    <span class="tok-comment">// Return the inverse tangent of Y / X in the range of -Pi to Pi with the following exceptions:</span>
</span>
<span class="line" id="L1820"></span>
<span class="line" id="L1821">    <span class="tok-comment">//     Y == 0 and X is Negative         -&gt; Pi with the sign of Y</span>
</span>
<span class="line" id="L1822">    <span class="tok-comment">//     y == 0 and x is positive         -&gt; 0 with the sign of y</span>
</span>
<span class="line" id="L1823">    <span class="tok-comment">//     Y != 0 and X == 0                -&gt; Pi / 2 with the sign of Y</span>
</span>
<span class="line" id="L1824">    <span class="tok-comment">//     Y != 0 and X is Negative         -&gt; atan(y/x) + (PI with the sign of Y)</span>
</span>
<span class="line" id="L1825">    <span class="tok-comment">//     X == -Infinity and Finite Y      -&gt; Pi with the sign of Y</span>
</span>
<span class="line" id="L1826">    <span class="tok-comment">//     X == +Infinity and Finite Y      -&gt; 0 with the sign of Y</span>
</span>
<span class="line" id="L1827">    <span class="tok-comment">//     Y == Infinity and X is Finite    -&gt; Pi / 2 with the sign of Y</span>
</span>
<span class="line" id="L1828">    <span class="tok-comment">//     Y == Infinity and X == -Infinity -&gt; 3Pi / 4 with the sign of Y</span>
</span>
<span class="line" id="L1829">    <span class="tok-comment">//     Y == Infinity and X == +Infinity -&gt; Pi / 4 with the sign of Y</span>
</span>
<span class="line" id="L1830"></span>
<span class="line" id="L1831">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L1832">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, <span class="tok-number">0.0</span>), splat(F32x4, -<span class="tok-number">1.0</span>)), splat(F32x4, math.pi), epsilon));</span>
<span class="line" id="L1833">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, -<span class="tok-number">0.0</span>), splat(F32x4, -<span class="tok-number">1.0</span>)), splat(F32x4, -math.pi), epsilon));</span>
<span class="line" id="L1834">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, <span class="tok-number">1.0</span>), splat(F32x4, <span class="tok-number">0.0</span>)), splat(F32x4, <span class="tok-number">0.5</span> * math.pi), epsilon));</span>
<span class="line" id="L1835">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, -<span class="tok-number">1.0</span>), splat(F32x4, <span class="tok-number">0.0</span>)), splat(F32x4, -<span class="tok-number">0.5</span> * math.pi), epsilon));</span>
<span class="line" id="L1836">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1837">        atan2(splat(F32x4, <span class="tok-number">1.0</span>), splat(F32x4, -<span class="tok-number">1.0</span>)),</span>
<span class="line" id="L1838">        splat(F32x4, math.atan(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">1.0</span>)) + math.pi),</span>
<span class="line" id="L1839">        epsilon,</span>
<span class="line" id="L1840">    ));</span>
<span class="line" id="L1841">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1842">        atan2(splat(F32x4, -<span class="tok-number">10.0</span>), splat(F32x4, -<span class="tok-number">2.0</span>)),</span>
<span class="line" id="L1843">        splat(F32x4, math.atan(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">5.0</span>)) - math.pi),</span>
<span class="line" id="L1844">        epsilon,</span>
<span class="line" id="L1845">    ));</span>
<span class="line" id="L1846">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, <span class="tok-number">1.0</span>), splat(F32x4, -math.inf(<span class="tok-type">f32</span>))), splat(F32x4, math.pi), epsilon));</span>
<span class="line" id="L1847">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, -<span class="tok-number">1.0</span>), splat(F32x4, -math.inf(<span class="tok-type">f32</span>))), splat(F32x4, -math.pi), epsilon));</span>
<span class="line" id="L1848">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, <span class="tok-number">1.0</span>), splat(F32x4, math.inf(<span class="tok-type">f32</span>))), splat(F32x4, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L1849">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, -<span class="tok-number">1.0</span>), splat(F32x4, math.inf(<span class="tok-type">f32</span>))), splat(F32x4, -<span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L1850">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1851">        atan2(splat(F32x4, math.inf(<span class="tok-type">f32</span>)), splat(F32x4, <span class="tok-number">2.0</span>)),</span>
<span class="line" id="L1852">        splat(F32x4, <span class="tok-number">0.5</span> * math.pi),</span>
<span class="line" id="L1853">        epsilon,</span>
<span class="line" id="L1854">    ));</span>
<span class="line" id="L1855">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1856">        atan2(splat(F32x4, -math.inf(<span class="tok-type">f32</span>)), splat(F32x4, <span class="tok-number">2.0</span>)),</span>
<span class="line" id="L1857">        splat(F32x4, -<span class="tok-number">0.5</span> * math.pi),</span>
<span class="line" id="L1858">        epsilon,</span>
<span class="line" id="L1859">    ));</span>
<span class="line" id="L1860">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1861">        atan2(splat(F32x4, math.inf(<span class="tok-type">f32</span>)), splat(F32x4, -math.inf(<span class="tok-type">f32</span>))),</span>
<span class="line" id="L1862">        splat(F32x4, <span class="tok-number">0.75</span> * math.pi),</span>
<span class="line" id="L1863">        epsilon,</span>
<span class="line" id="L1864">    ));</span>
<span class="line" id="L1865">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1866">        atan2(splat(F32x4, -math.inf(<span class="tok-type">f32</span>)), splat(F32x4, -math.inf(<span class="tok-type">f32</span>))),</span>
<span class="line" id="L1867">        splat(F32x4, -<span class="tok-number">0.75</span> * math.pi),</span>
<span class="line" id="L1868">        epsilon,</span>
<span class="line" id="L1869">    ));</span>
<span class="line" id="L1870">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1871">        atan2(splat(F32x4, math.inf(<span class="tok-type">f32</span>)), splat(F32x4, math.inf(<span class="tok-type">f32</span>))),</span>
<span class="line" id="L1872">        splat(F32x4, <span class="tok-number">0.25</span> * math.pi),</span>
<span class="line" id="L1873">        epsilon,</span>
<span class="line" id="L1874">    ));</span>
<span class="line" id="L1875">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1876">        atan2(splat(F32x4, -math.inf(<span class="tok-type">f32</span>)), splat(F32x4, math.inf(<span class="tok-type">f32</span>))),</span>
<span class="line" id="L1877">        splat(F32x4, -<span class="tok-number">0.25</span> * math.pi),</span>
<span class="line" id="L1878">        epsilon,</span>
<span class="line" id="L1879">    ));</span>
<span class="line" id="L1880">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L1881">        atan2(</span>
<span class="line" id="L1882">            f32x8(<span class="tok-number">0.0</span>, -math.inf(<span class="tok-type">f32</span>), -<span class="tok-number">0.0</span>, <span class="tok-number">2.0</span>, math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), <span class="tok-number">1.0</span>, -math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L1883">            f32x8(-<span class="tok-number">2.0</span>, math.inf(<span class="tok-type">f32</span>), <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">10.0</span>, -math.inf(<span class="tok-type">f32</span>), <span class="tok-number">1.0</span>, -math.inf(<span class="tok-type">f32</span>)),</span>
<span class="line" id="L1884">        ),</span>
<span class="line" id="L1885">        f32x8(</span>
<span class="line" id="L1886">            math.pi,</span>
<span class="line" id="L1887">            -<span class="tok-number">0.25</span> * math.pi,</span>
<span class="line" id="L1888">            -<span class="tok-number">0.0</span>,</span>
<span class="line" id="L1889">            <span class="tok-number">0.5</span> * math.pi,</span>
<span class="line" id="L1890">            <span class="tok-number">0.5</span> * math.pi,</span>
<span class="line" id="L1891">            <span class="tok-number">0.75</span> * math.pi,</span>
<span class="line" id="L1892">            math.atan(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">1.0</span>)),</span>
<span class="line" id="L1893">            -<span class="tok-number">0.75</span> * math.pi,</span>
<span class="line" id="L1894">        ),</span>
<span class="line" id="L1895">        epsilon,</span>
<span class="line" id="L1896">    ));</span>
<span class="line" id="L1897">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, <span class="tok-number">0.0</span>), splat(F32x4, <span class="tok-number">0.0</span>)), splat(F32x4, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L1898">    <span class="tok-kw">try</span> expect(approxEqAbs(atan2(splat(F32x4, -<span class="tok-number">0.0</span>), splat(F32x4, <span class="tok-number">0.0</span>)), splat(F32x4, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L1899">    <span class="tok-kw">try</span> expect(all(isNan(atan2(splat(F32x4, <span class="tok-number">1.0</span>), splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1900">    <span class="tok-kw">try</span> expect(all(isNan(atan2(splat(F32x4, -<span class="tok-number">1.0</span>), splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1901">    <span class="tok-kw">try</span> expect(all(isNan(atan2(splat(F32x4, math.nan_f32), splat(F32x4, -<span class="tok-number">1.0</span>))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1902">    <span class="tok-kw">try</span> expect(all(isNan(atan2(splat(F32x4, -math.nan_f32), splat(F32x4, <span class="tok-number">1.0</span>))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L1903">}</span>
<span class="line" id="L1904"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L1905"><span class="tok-comment">//</span>
</span>
<span class="line" id="L1906"><span class="tok-comment">// 3. 2D, 3D, 4D vector functions</span>
</span>
<span class="line" id="L1907"><span class="tok-comment">//</span>
</span>
<span class="line" id="L1908"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L1909"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">dot2</span>(v0: Vec, v1: Vec) F32x4 {</span>
<span class="line" id="L1910">    <span class="tok-kw">var</span> xmm0 = v0 * v1; <span class="tok-comment">// | x0*x1 | y0*y1 | -- | -- |</span>
</span>
<span class="line" id="L1911">    <span class="tok-kw">var</span> xmm1 = swizzle(xmm0, .y, .x, .x, .x); <span class="tok-comment">// | y0*y1 | -- | -- | -- |</span>
</span>
<span class="line" id="L1912">    xmm0 = f32x4(xmm0[<span class="tok-number">0</span>] + xmm1[<span class="tok-number">0</span>], xmm0[<span class="tok-number">1</span>], xmm0[<span class="tok-number">2</span>], xmm0[<span class="tok-number">3</span>]); <span class="tok-comment">// | x0*x1 + y0*y1 | -- | -- | -- |</span>
</span>
<span class="line" id="L1913">    <span class="tok-kw">return</span> swizzle(xmm0, .x, .x, .x, .x);</span>
<span class="line" id="L1914">}</span>
<span class="line" id="L1915"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.dot2&quot;</span> {</span>
<span class="line" id="L1916">    <span class="tok-kw">const</span> v0 = f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">300.0</span>, -<span class="tok-number">2.0</span>);</span>
<span class="line" id="L1917">    <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">600.0</span>, <span class="tok-number">2.0</span>);</span>
<span class="line" id="L1918">    <span class="tok-kw">var</span> v = dot2(v0, v1);</span>
<span class="line" id="L1919">    <span class="tok-kw">try</span> expect(approxEqAbs(v, splat(F32x4, <span class="tok-number">6.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1920">}</span>
<span class="line" id="L1921"></span>
<span class="line" id="L1922"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">dot3</span>(v0: Vec, v1: Vec) F32x4 {</span>
<span class="line" id="L1923">    <span class="tok-kw">const</span> dot = v0 * v1;</span>
<span class="line" id="L1924">    <span class="tok-kw">return</span> f32x4s(dot[<span class="tok-number">0</span>] + dot[<span class="tok-number">1</span>] + dot[<span class="tok-number">2</span>]);</span>
<span class="line" id="L1925">}</span>
<span class="line" id="L1926"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.dot3&quot;</span> {</span>
<span class="line" id="L1927">    <span class="tok-kw">const</span> v0 = f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1928">    <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1929">    <span class="tok-kw">var</span> v = dot3(v0, v1);</span>
<span class="line" id="L1930">    <span class="tok-kw">try</span> expect(approxEqAbs(v, splat(F32x4, <span class="tok-number">24.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1931">}</span>
<span class="line" id="L1932"></span>
<span class="line" id="L1933"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">dot4</span>(v0: Vec, v1: Vec) F32x4 {</span>
<span class="line" id="L1934">    <span class="tok-kw">var</span> xmm0 = v0 * v1; <span class="tok-comment">// | x0*x1 | y0*y1 | z0*z1 | w0*w1 |</span>
</span>
<span class="line" id="L1935">    <span class="tok-kw">var</span> xmm1 = swizzle(xmm0, .y, .x, .w, .x); <span class="tok-comment">// | y0*y1 | -- | w0*w1 | -- |</span>
</span>
<span class="line" id="L1936">    xmm1 = xmm0 + xmm1; <span class="tok-comment">// | x0*x1 + y0*y1 | -- | z0*z1 + w0*w1 | -- |</span>
</span>
<span class="line" id="L1937">    xmm0 = swizzle(xmm1, .z, .x, .x, .x); <span class="tok-comment">// | z0*z1 + w0*w1 | -- | -- | -- |</span>
</span>
<span class="line" id="L1938">    xmm0 = f32x4(xmm0[<span class="tok-number">0</span>] + xmm1[<span class="tok-number">0</span>], xmm0[<span class="tok-number">1</span>], xmm0[<span class="tok-number">2</span>], xmm0[<span class="tok-number">2</span>]); <span class="tok-comment">// addss</span>
</span>
<span class="line" id="L1939">    <span class="tok-kw">return</span> swizzle(xmm0, .x, .x, .x, .x);</span>
<span class="line" id="L1940">}</span>
<span class="line" id="L1941"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.dot4&quot;</span> {</span>
<span class="line" id="L1942">    <span class="tok-kw">const</span> v0 = f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, -<span class="tok-number">2.0</span>);</span>
<span class="line" id="L1943">    <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">2.0</span>);</span>
<span class="line" id="L1944">    <span class="tok-kw">var</span> v = dot4(v0, v1);</span>
<span class="line" id="L1945">    <span class="tok-kw">try</span> expect(approxEqAbs(v, splat(F32x4, <span class="tok-number">20.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1946">}</span>
<span class="line" id="L1947"></span>
<span class="line" id="L1948"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">cross3</span>(v0: Vec, v1: Vec) Vec {</span>
<span class="line" id="L1949">    <span class="tok-kw">var</span> xmm0 = swizzle(v0, .y, .z, .x, .w);</span>
<span class="line" id="L1950">    <span class="tok-kw">var</span> xmm1 = swizzle(v1, .z, .x, .y, .w);</span>
<span class="line" id="L1951">    <span class="tok-kw">var</span> result = xmm0 * xmm1;</span>
<span class="line" id="L1952">    xmm0 = swizzle(xmm0, .y, .z, .x, .w);</span>
<span class="line" id="L1953">    xmm1 = swizzle(xmm1, .z, .x, .y, .w);</span>
<span class="line" id="L1954">    result = result - xmm0 * xmm1;</span>
<span class="line" id="L1955">    <span class="tok-kw">return</span> andInt(result, f32x4_mask3);</span>
<span class="line" id="L1956">}</span>
<span class="line" id="L1957"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.cross3&quot;</span> {</span>
<span class="line" id="L1958">    {</span>
<span class="line" id="L1959">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1960">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1961">        <span class="tok-kw">var</span> v = cross3(v0, v1);</span>
<span class="line" id="L1962">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1963">    }</span>
<span class="line" id="L1964">    {</span>
<span class="line" id="L1965">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1966">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">0.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1967">        <span class="tok-kw">var</span> v = cross3(v0, v1);</span>
<span class="line" id="L1968">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1969">    }</span>
<span class="line" id="L1970">    {</span>
<span class="line" id="L1971">        <span class="tok-kw">const</span> v0 = f32x4(-<span class="tok-number">3.0</span>, <span class="tok-number">0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1972">        <span class="tok-kw">const</span> v1 = f32x4(<span class="tok-number">5.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L1973">        <span class="tok-kw">var</span> v = cross3(v0, v1);</span>
<span class="line" id="L1974">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(-<span class="tok-number">2.0</span>, -<span class="tok-number">4.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L1975">    }</span>
<span class="line" id="L1976">}</span>
<span class="line" id="L1977"></span>
<span class="line" id="L1978"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lengthSq2</span>(v: Vec) F32x4 {</span>
<span class="line" id="L1979">    <span class="tok-kw">return</span> dot2(v, v);</span>
<span class="line" id="L1980">}</span>
<span class="line" id="L1981"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lengthSq3</span>(v: Vec) F32x4 {</span>
<span class="line" id="L1982">    <span class="tok-kw">return</span> dot3(v, v);</span>
<span class="line" id="L1983">}</span>
<span class="line" id="L1984"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">lengthSq4</span>(v: Vec) F32x4 {</span>
<span class="line" id="L1985">    <span class="tok-kw">return</span> dot4(v, v);</span>
<span class="line" id="L1986">}</span>
<span class="line" id="L1987"></span>
<span class="line" id="L1988"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">length2</span>(v: Vec) F32x4 {</span>
<span class="line" id="L1989">    <span class="tok-kw">return</span> sqrt(dot2(v, v));</span>
<span class="line" id="L1990">}</span>
<span class="line" id="L1991"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">length3</span>(v: Vec) F32x4 {</span>
<span class="line" id="L1992">    <span class="tok-kw">return</span> sqrt(dot3(v, v));</span>
<span class="line" id="L1993">}</span>
<span class="line" id="L1994"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">length4</span>(v: Vec) F32x4 {</span>
<span class="line" id="L1995">    <span class="tok-kw">return</span> sqrt(dot4(v, v));</span>
<span class="line" id="L1996">}</span>
<span class="line" id="L1997"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.length3&quot;</span> {</span>
<span class="line" id="L1998">    <span class="tok-kw">if</span> (builtin.target.os.tag == .macos <span class="tok-kw">and</span> builtin.zig_backend != .stage1) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SkipZigTest;</span>
<span class="line" id="L1999">    {</span>
<span class="line" id="L2000">        <span class="tok-kw">const</span> v = length3(f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1000.0</span>));</span>
<span class="line" id="L2001">        <span class="tok-kw">try</span> expect(approxEqAbs(v, splat(F32x4, math.sqrt(<span class="tok-number">14.0</span>)), <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2002">    }</span>
<span class="line" id="L2003">    {</span>
<span class="line" id="L2004">        <span class="tok-kw">const</span> v = length3(f32x4(<span class="tok-number">1.0</span>, math.nan_f32, math.nan_f32, <span class="tok-number">1000.0</span>));</span>
<span class="line" id="L2005">        <span class="tok-kw">try</span> expect(all(isNan(v), <span class="tok-number">0</span>));</span>
<span class="line" id="L2006">    }</span>
<span class="line" id="L2007">    {</span>
<span class="line" id="L2008">        <span class="tok-kw">const</span> v = length3(f32x4(<span class="tok-number">1.0</span>, math.inf(<span class="tok-type">f32</span>), <span class="tok-number">3.0</span>, <span class="tok-number">1000.0</span>));</span>
<span class="line" id="L2009">        <span class="tok-kw">try</span> expect(all(isInf(v), <span class="tok-number">0</span>));</span>
<span class="line" id="L2010">    }</span>
<span class="line" id="L2011">    {</span>
<span class="line" id="L2012">        <span class="tok-kw">const</span> v = length3(f32x4(<span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, math.nan_f32));</span>
<span class="line" id="L2013">        <span class="tok-kw">try</span> expect(approxEqAbs(v, splat(F32x4, math.sqrt(<span class="tok-number">14.0</span>)), <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2014">    }</span>
<span class="line" id="L2015">}</span>
<span class="line" id="L2016"></span>
<span class="line" id="L2017"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">normalize2</span>(v: Vec) Vec {</span>
<span class="line" id="L2018">    <span class="tok-kw">return</span> v * splat(F32x4, <span class="tok-number">1.0</span>) / sqrt(dot2(v, v));</span>
<span class="line" id="L2019">}</span>
<span class="line" id="L2020"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">normalize3</span>(v: Vec) Vec {</span>
<span class="line" id="L2021">    <span class="tok-kw">return</span> v * splat(F32x4, <span class="tok-number">1.0</span>) / sqrt(dot3(v, v));</span>
<span class="line" id="L2022">}</span>
<span class="line" id="L2023"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">normalize4</span>(v: Vec) Vec {</span>
<span class="line" id="L2024">    <span class="tok-kw">return</span> v * splat(F32x4, <span class="tok-number">1.0</span>) / sqrt(dot4(v, v));</span>
<span class="line" id="L2025">}</span>
<span class="line" id="L2026"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.normalize3&quot;</span> {</span>
<span class="line" id="L2027">    {</span>
<span class="line" id="L2028">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1000.0</span>);</span>
<span class="line" id="L2029">        <span class="tok-kw">var</span> v = normalize3(v0);</span>
<span class="line" id="L2030">        <span class="tok-kw">try</span> expect(approxEqAbs(v, v0 * splat(F32x4, <span class="tok-number">1.0</span> / math.sqrt(<span class="tok-number">14.0</span>)), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L2031">    }</span>
<span class="line" id="L2032">    {</span>
<span class="line" id="L2033">        <span class="tok-kw">try</span> expect(any(isNan(normalize3(f32x4(<span class="tok-number">1.0</span>, math.inf(<span class="tok-type">f32</span>), <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L2034">        <span class="tok-kw">try</span> expect(any(isNan(normalize3(f32x4(-math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L2035">        <span class="tok-kw">try</span> expect(any(isNan(normalize3(f32x4(-math.nan_f32, math.qnan_f32, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L2036">        <span class="tok-kw">try</span> expect(any(isNan(normalize3(f32x4(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L2037">    }</span>
<span class="line" id="L2038">}</span>
<span class="line" id="L2039"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.normalize4&quot;</span> {</span>
<span class="line" id="L2040">    {</span>
<span class="line" id="L2041">        <span class="tok-kw">const</span> v0 = f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">10.0</span>);</span>
<span class="line" id="L2042">        <span class="tok-kw">var</span> v = normalize4(v0);</span>
<span class="line" id="L2043">        <span class="tok-kw">try</span> expect(approxEqAbs(v, v0 * splat(F32x4, <span class="tok-number">1.0</span> / math.sqrt(<span class="tok-number">114.0</span>)), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L2044">    }</span>
<span class="line" id="L2045">    {</span>
<span class="line" id="L2046">        <span class="tok-kw">try</span> expect(any(isNan(normalize4(f32x4(<span class="tok-number">1.0</span>, math.inf(<span class="tok-type">f32</span>), <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L2047">        <span class="tok-kw">try</span> expect(any(isNan(normalize4(f32x4(-math.inf(<span class="tok-type">f32</span>), math.inf(<span class="tok-type">f32</span>), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L2048">        <span class="tok-kw">try</span> expect(any(isNan(normalize4(f32x4(-math.nan_f32, math.qnan_f32, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L2049">        <span class="tok-kw">try</span> expect(any(isNan(normalize4(f32x4(<span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>))), <span class="tok-number">0</span>));</span>
<span class="line" id="L2050">    }</span>
<span class="line" id="L2051">}</span>
<span class="line" id="L2052"></span>
<span class="line" id="L2053"><span class="tok-kw">fn</span> <span class="tok-fn">vecMulMat</span>(v: Vec, m: Mat) Vec {</span>
<span class="line" id="L2054">    <span class="tok-kw">var</span> vx = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v, <span class="tok-null">undefined</span>, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> });</span>
<span class="line" id="L2055">    <span class="tok-kw">var</span> vy = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v, <span class="tok-null">undefined</span>, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">1</span>, <span class="tok-number">1</span>, <span class="tok-number">1</span> });</span>
<span class="line" id="L2056">    <span class="tok-kw">var</span> vz = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v, <span class="tok-null">undefined</span>, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">2</span>, <span class="tok-number">2</span>, <span class="tok-number">2</span> });</span>
<span class="line" id="L2057">    <span class="tok-kw">var</span> vw = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v, <span class="tok-null">undefined</span>, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">3</span>, <span class="tok-number">3</span>, <span class="tok-number">3</span>, <span class="tok-number">3</span> });</span>
<span class="line" id="L2058">    <span class="tok-kw">return</span> vx * m[<span class="tok-number">0</span>] + vy * m[<span class="tok-number">1</span>] + vz * m[<span class="tok-number">2</span>] + vw * m[<span class="tok-number">3</span>];</span>
<span class="line" id="L2059">}</span>
<span class="line" id="L2060"><span class="tok-kw">fn</span> <span class="tok-fn">matMulVec</span>(m: Mat, v: Vec) Vec {</span>
<span class="line" id="L2061">    <span class="tok-kw">return</span> .{ dot4(m[<span class="tok-number">0</span>], v)[<span class="tok-number">0</span>], dot4(m[<span class="tok-number">1</span>], v)[<span class="tok-number">0</span>], dot4(m[<span class="tok-number">2</span>], v)[<span class="tok-number">0</span>], dot4(m[<span class="tok-number">3</span>], v)[<span class="tok-number">0</span>] };</span>
<span class="line" id="L2062">}</span>
<span class="line" id="L2063"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.vecMulMat&quot;</span> {</span>
<span class="line" id="L2064">    <span class="tok-kw">const</span> m = Mat{</span>
<span class="line" id="L2065">        f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2066">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2067">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2068">        f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2069">    };</span>
<span class="line" id="L2070">    <span class="tok-kw">const</span> vm = mul(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>), m);</span>
<span class="line" id="L2071">    <span class="tok-kw">const</span> mv = mul(m, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L2072">    <span class="tok-kw">const</span> v = mul(transpose(m), f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L2073">    <span class="tok-kw">try</span> expect(approxEqAbs(vm, f32x4(<span class="tok-number">3.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2074">    <span class="tok-kw">try</span> expect(approxEqAbs(mv, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">21.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2075">    <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">3.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2076">}</span>
<span class="line" id="L2077"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L2078"><span class="tok-comment">//</span>
</span>
<span class="line" id="L2079"><span class="tok-comment">// 4. Matrix functions</span>
</span>
<span class="line" id="L2080"><span class="tok-comment">//</span>
</span>
<span class="line" id="L2081"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L2082"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">identity</span>() Mat {</span>
<span class="line" id="L2083">    <span class="tok-kw">const</span> static = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2084">        <span class="tok-kw">const</span> identity = Mat{</span>
<span class="line" id="L2085">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2086">            f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2087">            f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2088">            f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2089">        };</span>
<span class="line" id="L2090">    };</span>
<span class="line" id="L2091">    <span class="tok-kw">return</span> static.identity;</span>
<span class="line" id="L2092">}</span>
<span class="line" id="L2093"></span>
<span class="line" id="L2094"><span class="tok-kw">fn</span> <span class="tok-fn">mulRetType</span>(<span class="tok-kw">comptime</span> Ta: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> Tb: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L2095">    <span class="tok-kw">if</span> (Ta == Mat <span class="tok-kw">and</span> Tb == Mat) {</span>
<span class="line" id="L2096">        <span class="tok-kw">return</span> Mat;</span>
<span class="line" id="L2097">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> ((Ta == <span class="tok-type">f32</span> <span class="tok-kw">and</span> Tb == Mat) <span class="tok-kw">or</span> (Ta == Mat <span class="tok-kw">and</span> Tb == <span class="tok-type">f32</span>)) {</span>
<span class="line" id="L2098">        <span class="tok-kw">return</span> Mat;</span>
<span class="line" id="L2099">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> ((Ta == Vec <span class="tok-kw">and</span> Tb == Mat) <span class="tok-kw">or</span> (Ta == Mat <span class="tok-kw">and</span> Tb == Vec)) {</span>
<span class="line" id="L2100">        <span class="tok-kw">return</span> Vec;</span>
<span class="line" id="L2101">    }</span>
<span class="line" id="L2102">    <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.mul() not implemented for types: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Ta) ++ <span class="tok-builtin">@typeName</span>(Tb));</span>
<span class="line" id="L2103">}</span>
<span class="line" id="L2104"></span>
<span class="line" id="L2105"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mul</span>(a: <span class="tok-kw">anytype</span>, b: <span class="tok-kw">anytype</span>) mulRetType(<span class="tok-builtin">@TypeOf</span>(a), <span class="tok-builtin">@TypeOf</span>(b)) {</span>
<span class="line" id="L2106">    <span class="tok-kw">const</span> Ta = <span class="tok-builtin">@TypeOf</span>(a);</span>
<span class="line" id="L2107">    <span class="tok-kw">const</span> Tb = <span class="tok-builtin">@TypeOf</span>(b);</span>
<span class="line" id="L2108">    <span class="tok-kw">if</span> (Ta == Mat <span class="tok-kw">and</span> Tb == Mat) {</span>
<span class="line" id="L2109">        <span class="tok-kw">return</span> mulMat(a, b);</span>
<span class="line" id="L2110">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (Ta == <span class="tok-type">f32</span> <span class="tok-kw">and</span> Tb == Mat) {</span>
<span class="line" id="L2111">        <span class="tok-kw">const</span> va = splat(F32x4, a);</span>
<span class="line" id="L2112">        <span class="tok-kw">return</span> Mat{ va * b[<span class="tok-number">0</span>], va * b[<span class="tok-number">1</span>], va * b[<span class="tok-number">2</span>], va * b[<span class="tok-number">3</span>] };</span>
<span class="line" id="L2113">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (Ta == Mat <span class="tok-kw">and</span> Tb == <span class="tok-type">f32</span>) {</span>
<span class="line" id="L2114">        <span class="tok-kw">const</span> vb = splat(F32x4, b);</span>
<span class="line" id="L2115">        <span class="tok-kw">return</span> Mat{ a[<span class="tok-number">0</span>] * vb, a[<span class="tok-number">1</span>] * vb, a[<span class="tok-number">2</span>] * vb, a[<span class="tok-number">3</span>] * vb };</span>
<span class="line" id="L2116">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (Ta == Vec <span class="tok-kw">and</span> Tb == Mat) {</span>
<span class="line" id="L2117">        <span class="tok-kw">return</span> vecMulMat(a, b);</span>
<span class="line" id="L2118">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (Ta == Mat <span class="tok-kw">and</span> Tb == Vec) {</span>
<span class="line" id="L2119">        <span class="tok-kw">return</span> matMulVec(a, b);</span>
<span class="line" id="L2120">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2121">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.mul() not implemented for types: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Ta) ++ <span class="tok-str">&quot;, &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Tb));</span>
<span class="line" id="L2122">    }</span>
<span class="line" id="L2123">}</span>
<span class="line" id="L2124"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.mul&quot;</span> {</span>
<span class="line" id="L2125">    {</span>
<span class="line" id="L2126">        <span class="tok-kw">const</span> m = Mat{</span>
<span class="line" id="L2127">            f32x4(<span class="tok-number">0.1</span>, <span class="tok-number">0.2</span>, <span class="tok-number">0.3</span>, <span class="tok-number">0.4</span>),</span>
<span class="line" id="L2128">            f32x4(<span class="tok-number">0.5</span>, <span class="tok-number">0.6</span>, <span class="tok-number">0.7</span>, <span class="tok-number">0.8</span>),</span>
<span class="line" id="L2129">            f32x4(<span class="tok-number">0.9</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.1</span>, <span class="tok-number">1.2</span>),</span>
<span class="line" id="L2130">            f32x4(<span class="tok-number">1.3</span>, <span class="tok-number">1.4</span>, <span class="tok-number">1.5</span>, <span class="tok-number">1.6</span>),</span>
<span class="line" id="L2131">        };</span>
<span class="line" id="L2132">        <span class="tok-kw">const</span> ms = mul(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">2.0</span>), m);</span>
<span class="line" id="L2133">        <span class="tok-kw">try</span> expect(approxEqAbs(ms[<span class="tok-number">0</span>], f32x4(<span class="tok-number">0.2</span>, <span class="tok-number">0.4</span>, <span class="tok-number">0.6</span>, <span class="tok-number">0.8</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2134">        <span class="tok-kw">try</span> expect(approxEqAbs(ms[<span class="tok-number">1</span>], f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.2</span>, <span class="tok-number">1.4</span>, <span class="tok-number">1.6</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2135">        <span class="tok-kw">try</span> expect(approxEqAbs(ms[<span class="tok-number">2</span>], f32x4(<span class="tok-number">1.8</span>, <span class="tok-number">2.0</span>, <span class="tok-number">2.2</span>, <span class="tok-number">2.4</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2136">        <span class="tok-kw">try</span> expect(approxEqAbs(ms[<span class="tok-number">3</span>], f32x4(<span class="tok-number">2.6</span>, <span class="tok-number">2.8</span>, <span class="tok-number">3.0</span>, <span class="tok-number">3.2</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2137">    }</span>
<span class="line" id="L2138">}</span>
<span class="line" id="L2139"></span>
<span class="line" id="L2140"><span class="tok-kw">fn</span> <span class="tok-fn">mulMat</span>(m0: Mat, m1: Mat) Mat {</span>
<span class="line" id="L2141">    <span class="tok-kw">var</span> result: Mat = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2142">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> row: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L2143">    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (row &lt; <span class="tok-number">4</span>) : (row += <span class="tok-number">1</span>) {</span>
<span class="line" id="L2144">        <span class="tok-kw">const</span> vx = swizzle(m0[row], .x, .x, .x, .x);</span>
<span class="line" id="L2145">        <span class="tok-kw">const</span> vy = swizzle(m0[row], .y, .y, .y, .y);</span>
<span class="line" id="L2146">        <span class="tok-kw">const</span> vz = swizzle(m0[row], .z, .z, .z, .z);</span>
<span class="line" id="L2147">        <span class="tok-kw">const</span> vw = swizzle(m0[row], .w, .w, .w, .w);</span>
<span class="line" id="L2148">        result[row] = mulAdd(vx, m1[<span class="tok-number">0</span>], vz * m1[<span class="tok-number">2</span>]) + mulAdd(vy, m1[<span class="tok-number">1</span>], vw * m1[<span class="tok-number">3</span>]);</span>
<span class="line" id="L2149">    }</span>
<span class="line" id="L2150">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L2151">}</span>
<span class="line" id="L2152"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.matrix.mul&quot;</span> {</span>
<span class="line" id="L2153">    <span class="tok-kw">const</span> a = Mat{</span>
<span class="line" id="L2154">        f32x4(<span class="tok-number">0.1</span>, <span class="tok-number">0.2</span>, <span class="tok-number">0.3</span>, <span class="tok-number">0.4</span>),</span>
<span class="line" id="L2155">        f32x4(<span class="tok-number">0.5</span>, <span class="tok-number">0.6</span>, <span class="tok-number">0.7</span>, <span class="tok-number">0.8</span>),</span>
<span class="line" id="L2156">        f32x4(<span class="tok-number">0.9</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.1</span>, <span class="tok-number">1.2</span>),</span>
<span class="line" id="L2157">        f32x4(<span class="tok-number">1.3</span>, <span class="tok-number">1.4</span>, <span class="tok-number">1.5</span>, <span class="tok-number">1.6</span>),</span>
<span class="line" id="L2158">    };</span>
<span class="line" id="L2159">    <span class="tok-kw">const</span> b = Mat{</span>
<span class="line" id="L2160">        f32x4(<span class="tok-number">1.7</span>, <span class="tok-number">1.8</span>, <span class="tok-number">1.9</span>, <span class="tok-number">2.0</span>),</span>
<span class="line" id="L2161">        f32x4(<span class="tok-number">2.1</span>, <span class="tok-number">2.2</span>, <span class="tok-number">2.3</span>, <span class="tok-number">2.4</span>),</span>
<span class="line" id="L2162">        f32x4(<span class="tok-number">2.5</span>, <span class="tok-number">2.6</span>, <span class="tok-number">2.7</span>, <span class="tok-number">2.8</span>),</span>
<span class="line" id="L2163">        f32x4(<span class="tok-number">2.9</span>, <span class="tok-number">3.0</span>, <span class="tok-number">3.1</span>, <span class="tok-number">3.2</span>),</span>
<span class="line" id="L2164">    };</span>
<span class="line" id="L2165">    <span class="tok-kw">const</span> c = mul(a, b);</span>
<span class="line" id="L2166">    <span class="tok-kw">try</span> expect(approxEqAbs(c[<span class="tok-number">0</span>], f32x4(<span class="tok-number">2.5</span>, <span class="tok-number">2.6</span>, <span class="tok-number">2.7</span>, <span class="tok-number">2.8</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2167">    <span class="tok-kw">try</span> expect(approxEqAbs(c[<span class="tok-number">1</span>], f32x4(<span class="tok-number">6.18</span>, <span class="tok-number">6.44</span>, <span class="tok-number">6.7</span>, <span class="tok-number">6.96</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2168">    <span class="tok-kw">try</span> expect(approxEqAbs(c[<span class="tok-number">2</span>], f32x4(<span class="tok-number">9.86</span>, <span class="tok-number">10.28</span>, <span class="tok-number">10.7</span>, <span class="tok-number">11.12</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2169">    <span class="tok-kw">try</span> expect(approxEqAbs(c[<span class="tok-number">3</span>], f32x4(<span class="tok-number">13.54</span>, <span class="tok-number">14.12</span>, <span class="tok-number">14.7</span>, <span class="tok-number">15.28</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2170">}</span>
<span class="line" id="L2171"></span>
<span class="line" id="L2172"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">transpose</span>(m: Mat) Mat {</span>
<span class="line" id="L2173">    <span class="tok-kw">const</span> temp1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, m[<span class="tok-number">0</span>], m[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2174">    <span class="tok-kw">const</span> temp3 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, m[<span class="tok-number">0</span>], m[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2175">    <span class="tok-kw">const</span> temp2 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, m[<span class="tok-number">2</span>], m[<span class="tok-number">3</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2176">    <span class="tok-kw">const</span> temp4 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, m[<span class="tok-number">2</span>], m[<span class="tok-number">3</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2177">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2178">        <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, temp1, temp2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) }),</span>
<span class="line" id="L2179">        <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, temp1, temp2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) }),</span>
<span class="line" id="L2180">        <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, temp3, temp4, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) }),</span>
<span class="line" id="L2181">        <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, temp3, temp4, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) }),</span>
<span class="line" id="L2182">    };</span>
<span class="line" id="L2183">}</span>
<span class="line" id="L2184"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.matrix.transpose&quot;</span> {</span>
<span class="line" id="L2185">    <span class="tok-kw">const</span> m = Mat{</span>
<span class="line" id="L2186">        f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),</span>
<span class="line" id="L2187">        f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L2188">        f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),</span>
<span class="line" id="L2189">        f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L2190">    };</span>
<span class="line" id="L2191">    <span class="tok-kw">const</span> mt = transpose(m);</span>
<span class="line" id="L2192">    <span class="tok-kw">try</span> expect(approxEqAbs(mt[<span class="tok-number">0</span>], f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">5.0</span>, <span class="tok-number">9.0</span>, <span class="tok-number">13.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2193">    <span class="tok-kw">try</span> expect(approxEqAbs(mt[<span class="tok-number">1</span>], f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">14.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2194">    <span class="tok-kw">try</span> expect(approxEqAbs(mt[<span class="tok-number">2</span>], f32x4(<span class="tok-number">3.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">15.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2195">    <span class="tok-kw">try</span> expect(approxEqAbs(mt[<span class="tok-number">3</span>], f32x4(<span class="tok-number">4.0</span>, <span class="tok-number">8.0</span>, <span class="tok-number">12.0</span>, <span class="tok-number">16.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2196">}</span>
<span class="line" id="L2197"></span>
<span class="line" id="L2198"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rotationX</span>(angle: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2199">    <span class="tok-kw">const</span> sc = sincos(angle);</span>
<span class="line" id="L2200">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2201">        f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2202">        f32x4(<span class="tok-number">0.0</span>, sc[<span class="tok-number">1</span>], sc[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2203">        f32x4(<span class="tok-number">0.0</span>, -sc[<span class="tok-number">0</span>], sc[<span class="tok-number">1</span>], <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2204">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2205">    };</span>
<span class="line" id="L2206">}</span>
<span class="line" id="L2207"></span>
<span class="line" id="L2208"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rotationY</span>(angle: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2209">    <span class="tok-kw">const</span> sc = sincos(angle);</span>
<span class="line" id="L2210">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2211">        f32x4(sc[<span class="tok-number">1</span>], <span class="tok-number">0.0</span>, -sc[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2212">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2213">        f32x4(sc[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>, sc[<span class="tok-number">1</span>], <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2214">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2215">    };</span>
<span class="line" id="L2216">}</span>
<span class="line" id="L2217"></span>
<span class="line" id="L2218"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rotationZ</span>(angle: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2219">    <span class="tok-kw">const</span> sc = sincos(angle);</span>
<span class="line" id="L2220">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2221">        f32x4(sc[<span class="tok-number">1</span>], sc[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2222">        f32x4(-sc[<span class="tok-number">0</span>], sc[<span class="tok-number">1</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2223">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2224">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2225">    };</span>
<span class="line" id="L2226">}</span>
<span class="line" id="L2227"></span>
<span class="line" id="L2228"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">translation</span>(x: <span class="tok-type">f32</span>, y: <span class="tok-type">f32</span>, z: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2229">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2230">        f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2231">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2232">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2233">        f32x4(x, y, z, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2234">    };</span>
<span class="line" id="L2235">}</span>
<span class="line" id="L2236"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">translationV</span>(v: Vec) Mat {</span>
<span class="line" id="L2237">    <span class="tok-kw">return</span> translation(v[<span class="tok-number">0</span>], v[<span class="tok-number">1</span>], v[<span class="tok-number">2</span>]);</span>
<span class="line" id="L2238">}</span>
<span class="line" id="L2239"></span>
<span class="line" id="L2240"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">scaling</span>(x: <span class="tok-type">f32</span>, y: <span class="tok-type">f32</span>, z: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2241">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2242">        f32x4(x, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2243">        f32x4(<span class="tok-number">0.0</span>, y, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2244">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, z, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2245">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2246">    };</span>
<span class="line" id="L2247">}</span>
<span class="line" id="L2248"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">scalingV</span>(v: Vec) Mat {</span>
<span class="line" id="L2249">    <span class="tok-kw">return</span> scaling(v[<span class="tok-number">0</span>], v[<span class="tok-number">1</span>], v[<span class="tok-number">2</span>]);</span>
<span class="line" id="L2250">}</span>
<span class="line" id="L2251"></span>
<span class="line" id="L2252"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lookToLh</span>(eyepos: Vec, eyedir: Vec, updir: Vec) Mat {</span>
<span class="line" id="L2253">    <span class="tok-kw">const</span> az = normalize3(eyedir);</span>
<span class="line" id="L2254">    <span class="tok-kw">const</span> ax = normalize3(cross3(updir, az));</span>
<span class="line" id="L2255">    <span class="tok-kw">const</span> ay = normalize3(cross3(az, ax));</span>
<span class="line" id="L2256">    <span class="tok-kw">return</span> transpose(.{</span>
<span class="line" id="L2257">        f32x4(ax[<span class="tok-number">0</span>], ax[<span class="tok-number">1</span>], ax[<span class="tok-number">2</span>], -dot3(ax, eyepos)[<span class="tok-number">0</span>]),</span>
<span class="line" id="L2258">        f32x4(ay[<span class="tok-number">0</span>], ay[<span class="tok-number">1</span>], ay[<span class="tok-number">2</span>], -dot3(ay, eyepos)[<span class="tok-number">0</span>]),</span>
<span class="line" id="L2259">        f32x4(az[<span class="tok-number">0</span>], az[<span class="tok-number">1</span>], az[<span class="tok-number">2</span>], -dot3(az, eyepos)[<span class="tok-number">0</span>]),</span>
<span class="line" id="L2260">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2261">    });</span>
<span class="line" id="L2262">}</span>
<span class="line" id="L2263"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lookToRh</span>(eyepos: Vec, eyedir: Vec, updir: Vec) Mat {</span>
<span class="line" id="L2264">    <span class="tok-kw">return</span> lookToLh(eyepos, -eyedir, updir);</span>
<span class="line" id="L2265">}</span>
<span class="line" id="L2266"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lookAtLh</span>(eyepos: Vec, focuspos: Vec, updir: Vec) Mat {</span>
<span class="line" id="L2267">    <span class="tok-kw">return</span> lookToLh(eyepos, focuspos - eyepos, updir);</span>
<span class="line" id="L2268">}</span>
<span class="line" id="L2269"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lookAtRh</span>(eyepos: Vec, focuspos: Vec, updir: Vec) Mat {</span>
<span class="line" id="L2270">    <span class="tok-kw">return</span> lookToLh(eyepos, eyepos - focuspos, updir);</span>
<span class="line" id="L2271">}</span>
<span class="line" id="L2272"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.matrix.lookToLh&quot;</span> {</span>
<span class="line" id="L2273">    <span class="tok-kw">const</span> m = lookToLh(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L2274">    <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">0</span>], f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2275">    <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">1</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2276">    <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">2</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2277">    <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">3</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2278">}</span>
<span class="line" id="L2279"></span>
<span class="line" id="L2280"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">perspectiveFovLh</span>(fovy: <span class="tok-type">f32</span>, aspect: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2281">    <span class="tok-kw">const</span> scfov = sincos(<span class="tok-number">0.5</span> * fovy);</span>
<span class="line" id="L2282"></span>
<span class="line" id="L2283">    assert(near &gt; <span class="tok-number">0.0</span> <span class="tok-kw">and</span> far &gt; <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2284">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, scfov[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2285">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2286">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, aspect, <span class="tok-number">0.0</span>, <span class="tok-number">0.01</span>));</span>
<span class="line" id="L2287"></span>
<span class="line" id="L2288">    <span class="tok-kw">const</span> h = scfov[<span class="tok-number">1</span>] / scfov[<span class="tok-number">0</span>];</span>
<span class="line" id="L2289">    <span class="tok-kw">const</span> w = h / aspect;</span>
<span class="line" id="L2290">    <span class="tok-kw">const</span> r = far / (far - near);</span>
<span class="line" id="L2291">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2292">        f32x4(w, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2293">        f32x4(<span class="tok-number">0.0</span>, h, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2294">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, r, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2295">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, -r * near, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2296">    };</span>
<span class="line" id="L2297">}</span>
<span class="line" id="L2298"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">perspectiveFovRh</span>(fovy: <span class="tok-type">f32</span>, aspect: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2299">    <span class="tok-kw">const</span> scfov = sincos(<span class="tok-number">0.5</span> * fovy);</span>
<span class="line" id="L2300"></span>
<span class="line" id="L2301">    assert(near &gt; <span class="tok-number">0.0</span> <span class="tok-kw">and</span> far &gt; <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2302">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, scfov[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2303">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2304">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, aspect, <span class="tok-number">0.0</span>, <span class="tok-number">0.01</span>));</span>
<span class="line" id="L2305"></span>
<span class="line" id="L2306">    <span class="tok-kw">const</span> h = scfov[<span class="tok-number">1</span>] / scfov[<span class="tok-number">0</span>];</span>
<span class="line" id="L2307">    <span class="tok-kw">const</span> w = h / aspect;</span>
<span class="line" id="L2308">    <span class="tok-kw">const</span> r = far / (near - far);</span>
<span class="line" id="L2309">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2310">        f32x4(w, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2311">        f32x4(<span class="tok-number">0.0</span>, h, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2312">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, r, -<span class="tok-number">1.0</span>),</span>
<span class="line" id="L2313">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, r * near, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2314">    };</span>
<span class="line" id="L2315">}</span>
<span class="line" id="L2316"></span>
<span class="line" id="L2317"><span class="tok-comment">// Produces Z values in [-1.0, 1.0] range (OpenGL defaults)</span>
</span>
<span class="line" id="L2318"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">perspectiveFovLhGl</span>(fovy: <span class="tok-type">f32</span>, aspect: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2319">    <span class="tok-kw">const</span> scfov = sincos(<span class="tok-number">0.5</span> * fovy);</span>
<span class="line" id="L2320"></span>
<span class="line" id="L2321">    assert(near &gt; <span class="tok-number">0.0</span> <span class="tok-kw">and</span> far &gt; <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2322">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, scfov[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2323">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2324">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, aspect, <span class="tok-number">0.0</span>, <span class="tok-number">0.01</span>));</span>
<span class="line" id="L2325"></span>
<span class="line" id="L2326">    <span class="tok-kw">const</span> h = scfov[<span class="tok-number">1</span>] / scfov[<span class="tok-number">0</span>];</span>
<span class="line" id="L2327">    <span class="tok-kw">const</span> w = h / aspect;</span>
<span class="line" id="L2328">    <span class="tok-kw">const</span> r = far - near;</span>
<span class="line" id="L2329">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2330">        f32x4(w, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2331">        f32x4(<span class="tok-number">0.0</span>, h, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2332">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, (near + far) / r, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2333">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2.0</span> * near * far / -r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2334">    };</span>
<span class="line" id="L2335">}</span>
<span class="line" id="L2336"></span>
<span class="line" id="L2337"><span class="tok-comment">// Produces Z values in [-1.0, 1.0] range (OpenGL defaults)</span>
</span>
<span class="line" id="L2338"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">perspectiveFovRhGl</span>(fovy: <span class="tok-type">f32</span>, aspect: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2339">    <span class="tok-kw">const</span> scfov = sincos(<span class="tok-number">0.5</span> * fovy);</span>
<span class="line" id="L2340"></span>
<span class="line" id="L2341">    assert(near &gt; <span class="tok-number">0.0</span> <span class="tok-kw">and</span> far &gt; <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2342">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, scfov[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2343">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2344">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, aspect, <span class="tok-number">0.0</span>, <span class="tok-number">0.01</span>));</span>
<span class="line" id="L2345"></span>
<span class="line" id="L2346">    <span class="tok-kw">const</span> h = scfov[<span class="tok-number">1</span>] / scfov[<span class="tok-number">0</span>];</span>
<span class="line" id="L2347">    <span class="tok-kw">const</span> w = h / aspect;</span>
<span class="line" id="L2348">    <span class="tok-kw">const</span> r = near - far;</span>
<span class="line" id="L2349">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2350">        f32x4(w, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2351">        f32x4(<span class="tok-number">0.0</span>, h, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2352">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, (near + far) / r, -<span class="tok-number">1.0</span>),</span>
<span class="line" id="L2353">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2.0</span> * near * far / r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2354">    };</span>
<span class="line" id="L2355">}</span>
<span class="line" id="L2356"></span>
<span class="line" id="L2357"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">orthographicLh</span>(w: <span class="tok-type">f32</span>, h: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2358">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, w, <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2359">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, h, <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2360">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2361"></span>
<span class="line" id="L2362">    <span class="tok-kw">const</span> r = <span class="tok-number">1</span> / (far - near);</span>
<span class="line" id="L2363">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2364">        f32x4(<span class="tok-number">2</span> / w, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2365">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2</span> / h, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2366">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2367">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, -r * near, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2368">    };</span>
<span class="line" id="L2369">}</span>
<span class="line" id="L2370"></span>
<span class="line" id="L2371"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">orthographicRh</span>(w: <span class="tok-type">f32</span>, h: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2372">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, w, <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2373">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, h, <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2374">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2375"></span>
<span class="line" id="L2376">    <span class="tok-kw">const</span> r = <span class="tok-number">1</span> / (near - far);</span>
<span class="line" id="L2377">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2378">        f32x4(<span class="tok-number">2</span> / w, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2379">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2</span> / h, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2380">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2381">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, r * near, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2382">    };</span>
<span class="line" id="L2383">}</span>
<span class="line" id="L2384"></span>
<span class="line" id="L2385"><span class="tok-comment">// Produces Z values in [-1.0, 1.0] range (OpenGL defaults)</span>
</span>
<span class="line" id="L2386"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">orthographicLhGl</span>(w: <span class="tok-type">f32</span>, h: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2387">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, w, <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2388">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, h, <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2389">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2390"></span>
<span class="line" id="L2391">    <span class="tok-kw">const</span> r = far - near;</span>
<span class="line" id="L2392">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2393">        f32x4(<span class="tok-number">2</span> / w, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2394">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2</span> / h, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2395">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2</span> / r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2396">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, (near + far) / -r, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2397">    };</span>
<span class="line" id="L2398">}</span>
<span class="line" id="L2399"></span>
<span class="line" id="L2400"><span class="tok-comment">// Produces Z values in [-1.0, 1.0] range (OpenGL defaults)</span>
</span>
<span class="line" id="L2401"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">orthographicRhGl</span>(w: <span class="tok-type">f32</span>, h: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2402">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, w, <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2403">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, h, <span class="tok-number">0.0</span>, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2404">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2405"></span>
<span class="line" id="L2406">    <span class="tok-kw">const</span> r = near - far;</span>
<span class="line" id="L2407">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2408">        f32x4(<span class="tok-number">2</span> / w, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2409">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2</span> / h, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2410">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2</span> / r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2411">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, (near + far) / r, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2412">    };</span>
<span class="line" id="L2413">}</span>
<span class="line" id="L2414"></span>
<span class="line" id="L2415"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">orthographicOffCenterLh</span>(left: <span class="tok-type">f32</span>, right: <span class="tok-type">f32</span>, top: <span class="tok-type">f32</span>, bottom: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2416">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2417"></span>
<span class="line" id="L2418">    <span class="tok-kw">const</span> r = <span class="tok-number">1</span> / (far - near);</span>
<span class="line" id="L2419">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2420">        f32x4(<span class="tok-number">2</span> / (right - left), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2421">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2</span> / (top - bottom), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2422">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2423">        f32x4(-(right + left) / (right - left), -(top + bottom) / (top - bottom), -r * near, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2424">    };</span>
<span class="line" id="L2425">}</span>
<span class="line" id="L2426"></span>
<span class="line" id="L2427"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">orthographicOffCenterRh</span>(left: <span class="tok-type">f32</span>, right: <span class="tok-type">f32</span>, top: <span class="tok-type">f32</span>, bottom: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2428">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2429"></span>
<span class="line" id="L2430">    <span class="tok-kw">const</span> r = <span class="tok-number">1</span> / (near - far);</span>
<span class="line" id="L2431">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2432">        f32x4(<span class="tok-number">2</span> / (right - left), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2433">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2</span> / (top - bottom), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2434">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2435">        f32x4(-(right + left) / (right - left), -(top + bottom) / (top - bottom), r * near, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2436">    };</span>
<span class="line" id="L2437">}</span>
<span class="line" id="L2438"></span>
<span class="line" id="L2439"><span class="tok-comment">// Produces Z values in [-1.0, 1.0] range (OpenGL defaults)</span>
</span>
<span class="line" id="L2440"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">orthographicOffCenterLhGl</span>(left: <span class="tok-type">f32</span>, right: <span class="tok-type">f32</span>, top: <span class="tok-type">f32</span>, bottom: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2441">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2442"></span>
<span class="line" id="L2443">    <span class="tok-kw">const</span> r = far - near;</span>
<span class="line" id="L2444">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2445">        f32x4(<span class="tok-number">2</span> / (right - left), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2446">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2</span> / (top - bottom), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2447">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2</span> / r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2448">        f32x4(-(right + left) / (right - left), -(top + bottom) / (top - bottom), (near + far) / -r, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2449">    };</span>
<span class="line" id="L2450">}</span>
<span class="line" id="L2451"></span>
<span class="line" id="L2452"><span class="tok-comment">// Produces Z values in [-1.0, 1.0] range (OpenGL defaults)</span>
</span>
<span class="line" id="L2453"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">orthographicOffCenterRhGl</span>(left: <span class="tok-type">f32</span>, right: <span class="tok-type">f32</span>, top: <span class="tok-type">f32</span>, bottom: <span class="tok-type">f32</span>, near: <span class="tok-type">f32</span>, far: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2454">    assert(!math.approxEqAbs(<span class="tok-type">f32</span>, far, near, <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2455"></span>
<span class="line" id="L2456">    <span class="tok-kw">const</span> r = near - far;</span>
<span class="line" id="L2457">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2458">        f32x4(<span class="tok-number">2</span> / (right - left), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2459">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2</span> / (top - bottom), <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2460">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">2</span> / r, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2461">        f32x4(-(right + left) / (right - left), -(top + bottom) / (top - bottom), (near + far) / r, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2462">    };</span>
<span class="line" id="L2463">}</span>
<span class="line" id="L2464"></span>
<span class="line" id="L2465"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">determinant</span>(m: Mat) F32x4 {</span>
<span class="line" id="L2466">    <span class="tok-kw">var</span> v0 = swizzle(m[<span class="tok-number">2</span>], .y, .x, .x, .x);</span>
<span class="line" id="L2467">    <span class="tok-kw">var</span> v1 = swizzle(m[<span class="tok-number">3</span>], .z, .z, .y, .y);</span>
<span class="line" id="L2468">    <span class="tok-kw">var</span> v2 = swizzle(m[<span class="tok-number">2</span>], .y, .x, .x, .x);</span>
<span class="line" id="L2469">    <span class="tok-kw">var</span> v3 = swizzle(m[<span class="tok-number">3</span>], .w, .w, .w, .z);</span>
<span class="line" id="L2470">    <span class="tok-kw">var</span> v4 = swizzle(m[<span class="tok-number">2</span>], .z, .z, .y, .y);</span>
<span class="line" id="L2471">    <span class="tok-kw">var</span> v5 = swizzle(m[<span class="tok-number">3</span>], .w, .w, .w, .z);</span>
<span class="line" id="L2472"></span>
<span class="line" id="L2473">    <span class="tok-kw">var</span> p0 = v0 * v1;</span>
<span class="line" id="L2474">    <span class="tok-kw">var</span> p1 = v2 * v3;</span>
<span class="line" id="L2475">    <span class="tok-kw">var</span> p2 = v4 * v5;</span>
<span class="line" id="L2476"></span>
<span class="line" id="L2477">    v0 = swizzle(m[<span class="tok-number">2</span>], .z, .z, .y, .y);</span>
<span class="line" id="L2478">    v1 = swizzle(m[<span class="tok-number">3</span>], .y, .x, .x, .x);</span>
<span class="line" id="L2479">    v2 = swizzle(m[<span class="tok-number">2</span>], .w, .w, .w, .z);</span>
<span class="line" id="L2480">    v3 = swizzle(m[<span class="tok-number">3</span>], .y, .x, .x, .x);</span>
<span class="line" id="L2481">    v4 = swizzle(m[<span class="tok-number">2</span>], .w, .w, .w, .z);</span>
<span class="line" id="L2482">    v5 = swizzle(m[<span class="tok-number">3</span>], .z, .z, .y, .y);</span>
<span class="line" id="L2483"></span>
<span class="line" id="L2484">    p0 = mulAdd(-v0, v1, p0);</span>
<span class="line" id="L2485">    p1 = mulAdd(-v2, v3, p1);</span>
<span class="line" id="L2486">    p2 = mulAdd(-v4, v5, p2);</span>
<span class="line" id="L2487"></span>
<span class="line" id="L2488">    v0 = swizzle(m[<span class="tok-number">1</span>], .w, .w, .w, .z);</span>
<span class="line" id="L2489">    v1 = swizzle(m[<span class="tok-number">1</span>], .z, .z, .y, .y);</span>
<span class="line" id="L2490">    v2 = swizzle(m[<span class="tok-number">1</span>], .y, .x, .x, .x);</span>
<span class="line" id="L2491"></span>
<span class="line" id="L2492">    <span class="tok-kw">var</span> s = m[<span class="tok-number">0</span>] * f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>);</span>
<span class="line" id="L2493">    <span class="tok-kw">var</span> r = v0 * p0;</span>
<span class="line" id="L2494">    r = mulAdd(-v1, p1, r);</span>
<span class="line" id="L2495">    r = mulAdd(v2, p2, r);</span>
<span class="line" id="L2496">    <span class="tok-kw">return</span> dot4(s, r);</span>
<span class="line" id="L2497">}</span>
<span class="line" id="L2498"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.matrix.determinant&quot;</span> {</span>
<span class="line" id="L2499">    <span class="tok-kw">const</span> m = Mat{</span>
<span class="line" id="L2500">        f32x4(<span class="tok-number">10.0</span>, -<span class="tok-number">9.0</span>, -<span class="tok-number">12.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2501">        f32x4(<span class="tok-number">7.0</span>, -<span class="tok-number">12.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2502">        f32x4(-<span class="tok-number">10.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2503">        f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),</span>
<span class="line" id="L2504">    };</span>
<span class="line" id="L2505">    <span class="tok-kw">try</span> expect(approxEqAbs(determinant(m), splat(F32x4, <span class="tok-number">2939.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2506">}</span>
<span class="line" id="L2507"></span>
<span class="line" id="L2508"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">inverse</span>(a: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(a) {</span>
<span class="line" id="L2509">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(a);</span>
<span class="line" id="L2510">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (T) {</span>
<span class="line" id="L2511">        Mat =&gt; inverseMat(a),</span>
<span class="line" id="L2512">        Quat =&gt; inverseQuat(a),</span>
<span class="line" id="L2513">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;zmath.inverse() not implemented for &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T)),</span>
<span class="line" id="L2514">    };</span>
<span class="line" id="L2515">}</span>
<span class="line" id="L2516"></span>
<span class="line" id="L2517"><span class="tok-kw">fn</span> <span class="tok-fn">inverseMat</span>(m: Mat) Mat {</span>
<span class="line" id="L2518">    <span class="tok-kw">return</span> inverseDet(m, <span class="tok-null">null</span>);</span>
<span class="line" id="L2519">}</span>
<span class="line" id="L2520"></span>
<span class="line" id="L2521"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">inverseDet</span>(m: Mat, out_det: ?*F32x4) Mat {</span>
<span class="line" id="L2522">    <span class="tok-kw">const</span> mt = transpose(m);</span>
<span class="line" id="L2523">    <span class="tok-kw">var</span> v0: [<span class="tok-number">4</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2524">    <span class="tok-kw">var</span> v1: [<span class="tok-number">4</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2525"></span>
<span class="line" id="L2526">    v0[<span class="tok-number">0</span>] = swizzle(mt[<span class="tok-number">2</span>], .x, .x, .y, .y);</span>
<span class="line" id="L2527">    v1[<span class="tok-number">0</span>] = swizzle(mt[<span class="tok-number">3</span>], .z, .w, .z, .w);</span>
<span class="line" id="L2528">    v0[<span class="tok-number">1</span>] = swizzle(mt[<span class="tok-number">0</span>], .x, .x, .y, .y);</span>
<span class="line" id="L2529">    v1[<span class="tok-number">1</span>] = swizzle(mt[<span class="tok-number">1</span>], .z, .w, .z, .w);</span>
<span class="line" id="L2530">    v0[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, mt[<span class="tok-number">2</span>], mt[<span class="tok-number">0</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L2531">    v1[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, mt[<span class="tok-number">3</span>], mt[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2532"></span>
<span class="line" id="L2533">    <span class="tok-kw">var</span> d0 = v0[<span class="tok-number">0</span>] * v1[<span class="tok-number">0</span>];</span>
<span class="line" id="L2534">    <span class="tok-kw">var</span> d1 = v0[<span class="tok-number">1</span>] * v1[<span class="tok-number">1</span>];</span>
<span class="line" id="L2535">    <span class="tok-kw">var</span> d2 = v0[<span class="tok-number">2</span>] * v1[<span class="tok-number">2</span>];</span>
<span class="line" id="L2536"></span>
<span class="line" id="L2537">    v0[<span class="tok-number">0</span>] = swizzle(mt[<span class="tok-number">2</span>], .z, .w, .z, .w);</span>
<span class="line" id="L2538">    v1[<span class="tok-number">0</span>] = swizzle(mt[<span class="tok-number">3</span>], .x, .x, .y, .y);</span>
<span class="line" id="L2539">    v0[<span class="tok-number">1</span>] = swizzle(mt[<span class="tok-number">0</span>], .z, .w, .z, .w);</span>
<span class="line" id="L2540">    v1[<span class="tok-number">1</span>] = swizzle(mt[<span class="tok-number">1</span>], .x, .x, .y, .y);</span>
<span class="line" id="L2541">    v0[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, mt[<span class="tok-number">2</span>], mt[<span class="tok-number">0</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2542">    v1[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, mt[<span class="tok-number">3</span>], mt[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L2543"></span>
<span class="line" id="L2544">    d0 = mulAdd(-v0[<span class="tok-number">0</span>], v1[<span class="tok-number">0</span>], d0);</span>
<span class="line" id="L2545">    d1 = mulAdd(-v0[<span class="tok-number">1</span>], v1[<span class="tok-number">1</span>], d1);</span>
<span class="line" id="L2546">    d2 = mulAdd(-v0[<span class="tok-number">2</span>], v1[<span class="tok-number">2</span>], d2);</span>
<span class="line" id="L2547"></span>
<span class="line" id="L2548">    v0[<span class="tok-number">0</span>] = swizzle(mt[<span class="tok-number">1</span>], .y, .z, .x, .y);</span>
<span class="line" id="L2549">    v1[<span class="tok-number">0</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d0, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), <span class="tok-number">1</span>, <span class="tok-number">3</span>, <span class="tok-number">0</span> });</span>
<span class="line" id="L2550">    v0[<span class="tok-number">1</span>] = swizzle(mt[<span class="tok-number">0</span>], .z, .x, .y, .x);</span>
<span class="line" id="L2551">    v1[<span class="tok-number">1</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d0, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), <span class="tok-number">1</span>, <span class="tok-number">2</span> });</span>
<span class="line" id="L2552">    v0[<span class="tok-number">2</span>] = swizzle(mt[<span class="tok-number">3</span>], .y, .z, .x, .y);</span>
<span class="line" id="L2553">    v1[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d1, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>), <span class="tok-number">1</span>, <span class="tok-number">3</span>, <span class="tok-number">0</span> });</span>
<span class="line" id="L2554">    v0[<span class="tok-number">3</span>] = swizzle(mt[<span class="tok-number">2</span>], .z, .x, .y, .x);</span>
<span class="line" id="L2555">    v1[<span class="tok-number">3</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d1, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>), <span class="tok-number">1</span>, <span class="tok-number">2</span> });</span>
<span class="line" id="L2556"></span>
<span class="line" id="L2557">    <span class="tok-kw">var</span> c0 = v0[<span class="tok-number">0</span>] * v1[<span class="tok-number">0</span>];</span>
<span class="line" id="L2558">    <span class="tok-kw">var</span> c2 = v0[<span class="tok-number">1</span>] * v1[<span class="tok-number">1</span>];</span>
<span class="line" id="L2559">    <span class="tok-kw">var</span> c4 = v0[<span class="tok-number">2</span>] * v1[<span class="tok-number">2</span>];</span>
<span class="line" id="L2560">    <span class="tok-kw">var</span> c6 = v0[<span class="tok-number">3</span>] * v1[<span class="tok-number">3</span>];</span>
<span class="line" id="L2561"></span>
<span class="line" id="L2562">    v0[<span class="tok-number">0</span>] = swizzle(mt[<span class="tok-number">1</span>], .z, .w, .y, .z);</span>
<span class="line" id="L2563">    v1[<span class="tok-number">0</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d0, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">3</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>) });</span>
<span class="line" id="L2564">    v0[<span class="tok-number">1</span>] = swizzle(mt[<span class="tok-number">0</span>], .w, .z, .w, .y);</span>
<span class="line" id="L2565">    v1[<span class="tok-number">1</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d0, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), <span class="tok-number">0</span> });</span>
<span class="line" id="L2566">    v0[<span class="tok-number">2</span>] = swizzle(mt[<span class="tok-number">3</span>], .z, .w, .y, .z);</span>
<span class="line" id="L2567">    v1[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d1, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">3</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L2568">    v0[<span class="tok-number">3</span>] = swizzle(mt[<span class="tok-number">2</span>], .w, .z, .w, .y);</span>
<span class="line" id="L2569">    v1[<span class="tok-number">3</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d1, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), <span class="tok-number">0</span> });</span>
<span class="line" id="L2570"></span>
<span class="line" id="L2571">    c0 = mulAdd(-v0[<span class="tok-number">0</span>], v1[<span class="tok-number">0</span>], c0);</span>
<span class="line" id="L2572">    c2 = mulAdd(-v0[<span class="tok-number">1</span>], v1[<span class="tok-number">1</span>], c2);</span>
<span class="line" id="L2573">    c4 = mulAdd(-v0[<span class="tok-number">2</span>], v1[<span class="tok-number">2</span>], c4);</span>
<span class="line" id="L2574">    c6 = mulAdd(-v0[<span class="tok-number">3</span>], v1[<span class="tok-number">3</span>], c6);</span>
<span class="line" id="L2575"></span>
<span class="line" id="L2576">    v0[<span class="tok-number">0</span>] = swizzle(mt[<span class="tok-number">1</span>], .w, .x, .w, .x);</span>
<span class="line" id="L2577">    v1[<span class="tok-number">0</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d0, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), <span class="tok-number">2</span> });</span>
<span class="line" id="L2578">    v0[<span class="tok-number">1</span>] = swizzle(mt[<span class="tok-number">0</span>], .y, .w, .x, .z);</span>
<span class="line" id="L2579">    v1[<span class="tok-number">1</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d0, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), <span class="tok-number">0</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>) });</span>
<span class="line" id="L2580">    v0[<span class="tok-number">2</span>] = swizzle(mt[<span class="tok-number">3</span>], .w, .x, .w, .x);</span>
<span class="line" id="L2581">    v1[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d1, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), <span class="tok-number">2</span> });</span>
<span class="line" id="L2582">    v0[<span class="tok-number">3</span>] = swizzle(mt[<span class="tok-number">2</span>], .y, .w, .x, .z);</span>
<span class="line" id="L2583">    v1[<span class="tok-number">3</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, d1, d2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>), <span class="tok-number">0</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L2584"></span>
<span class="line" id="L2585">    <span class="tok-kw">const</span> c1 = mulAdd(-v0[<span class="tok-number">0</span>], v1[<span class="tok-number">0</span>], c0);</span>
<span class="line" id="L2586">    <span class="tok-kw">const</span> c3 = mulAdd(v0[<span class="tok-number">1</span>], v1[<span class="tok-number">1</span>], c2);</span>
<span class="line" id="L2587">    <span class="tok-kw">const</span> c5 = mulAdd(-v0[<span class="tok-number">2</span>], v1[<span class="tok-number">2</span>], c4);</span>
<span class="line" id="L2588">    <span class="tok-kw">const</span> c7 = mulAdd(v0[<span class="tok-number">3</span>], v1[<span class="tok-number">3</span>], c6);</span>
<span class="line" id="L2589"></span>
<span class="line" id="L2590">    c0 = mulAdd(v0[<span class="tok-number">0</span>], v1[<span class="tok-number">0</span>], c0);</span>
<span class="line" id="L2591">    c2 = mulAdd(-v0[<span class="tok-number">1</span>], v1[<span class="tok-number">1</span>], c2);</span>
<span class="line" id="L2592">    c4 = mulAdd(v0[<span class="tok-number">2</span>], v1[<span class="tok-number">2</span>], c4);</span>
<span class="line" id="L2593">    c6 = mulAdd(-v0[<span class="tok-number">3</span>], v1[<span class="tok-number">3</span>], c6);</span>
<span class="line" id="L2594"></span>
<span class="line" id="L2595">    <span class="tok-kw">var</span> mr = Mat{</span>
<span class="line" id="L2596">        f32x4(c0[<span class="tok-number">0</span>], c1[<span class="tok-number">1</span>], c0[<span class="tok-number">2</span>], c1[<span class="tok-number">3</span>]),</span>
<span class="line" id="L2597">        f32x4(c2[<span class="tok-number">0</span>], c3[<span class="tok-number">1</span>], c2[<span class="tok-number">2</span>], c3[<span class="tok-number">3</span>]),</span>
<span class="line" id="L2598">        f32x4(c4[<span class="tok-number">0</span>], c5[<span class="tok-number">1</span>], c4[<span class="tok-number">2</span>], c5[<span class="tok-number">3</span>]),</span>
<span class="line" id="L2599">        f32x4(c6[<span class="tok-number">0</span>], c7[<span class="tok-number">1</span>], c6[<span class="tok-number">2</span>], c7[<span class="tok-number">3</span>]),</span>
<span class="line" id="L2600">    };</span>
<span class="line" id="L2601"></span>
<span class="line" id="L2602">    <span class="tok-kw">const</span> det = dot4(mr[<span class="tok-number">0</span>], mt[<span class="tok-number">0</span>]);</span>
<span class="line" id="L2603">    <span class="tok-kw">if</span> (out_det != <span class="tok-null">null</span>) {</span>
<span class="line" id="L2604">        out_det.?.* = det;</span>
<span class="line" id="L2605">    }</span>
<span class="line" id="L2606"></span>
<span class="line" id="L2607">    <span class="tok-kw">if</span> (math.approxEqAbs(<span class="tok-type">f32</span>, det[<span class="tok-number">0</span>], <span class="tok-number">0.0</span>, math.floatEps(<span class="tok-type">f32</span>))) {</span>
<span class="line" id="L2608">        <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2609">            f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2610">            f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2611">            f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2612">            f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2613">        };</span>
<span class="line" id="L2614">    }</span>
<span class="line" id="L2615"></span>
<span class="line" id="L2616">    <span class="tok-kw">const</span> scale = splat(F32x4, <span class="tok-number">1.0</span>) / det;</span>
<span class="line" id="L2617">    mr[<span class="tok-number">0</span>] *= scale;</span>
<span class="line" id="L2618">    mr[<span class="tok-number">1</span>] *= scale;</span>
<span class="line" id="L2619">    mr[<span class="tok-number">2</span>] *= scale;</span>
<span class="line" id="L2620">    mr[<span class="tok-number">3</span>] *= scale;</span>
<span class="line" id="L2621">    <span class="tok-kw">return</span> mr;</span>
<span class="line" id="L2622">}</span>
<span class="line" id="L2623"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.matrix.inverse&quot;</span> {</span>
<span class="line" id="L2624">    <span class="tok-kw">const</span> m = Mat{</span>
<span class="line" id="L2625">        f32x4(<span class="tok-number">10.0</span>, -<span class="tok-number">9.0</span>, -<span class="tok-number">12.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2626">        f32x4(<span class="tok-number">7.0</span>, -<span class="tok-number">12.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2627">        f32x4(-<span class="tok-number">10.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2628">        f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),</span>
<span class="line" id="L2629">    };</span>
<span class="line" id="L2630">    <span class="tok-kw">var</span> det: F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2631">    <span class="tok-kw">const</span> mi = inverseDet(m, &amp;det);</span>
<span class="line" id="L2632">    <span class="tok-kw">try</span> expect(approxEqAbs(det, splat(F32x4, <span class="tok-number">2939.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2633"></span>
<span class="line" id="L2634">    <span class="tok-kw">try</span> expect(approxEqAbs(mi[<span class="tok-number">0</span>], f32x4(-<span class="tok-number">0.170806</span>, -<span class="tok-number">0.13576</span>, -<span class="tok-number">0.349439</span>, <span class="tok-number">0.164001</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2635">    <span class="tok-kw">try</span> expect(approxEqAbs(mi[<span class="tok-number">1</span>], f32x4(-<span class="tok-number">0.163661</span>, -<span class="tok-number">0.14801</span>, -<span class="tok-number">0.253147</span>, <span class="tok-number">0.141204</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2636">    <span class="tok-kw">try</span> expect(approxEqAbs(mi[<span class="tok-number">2</span>], f32x4(-<span class="tok-number">0.0871045</span>, <span class="tok-number">0.00646478</span>, -<span class="tok-number">0.0785982</span>, <span class="tok-number">0.0398095</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2637">    <span class="tok-kw">try</span> expect(approxEqAbs(mi[<span class="tok-number">3</span>], f32x4(<span class="tok-number">0.18986</span>, <span class="tok-number">0.103096</span>, <span class="tok-number">0.272882</span>, <span class="tok-number">0.10854</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2638">}</span>
<span class="line" id="L2639"></span>
<span class="line" id="L2640"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">matFromNormAxisAngle</span>(axis: Vec, angle: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2641">    <span class="tok-kw">const</span> sincos_angle = sincos(angle);</span>
<span class="line" id="L2642"></span>
<span class="line" id="L2643">    <span class="tok-kw">const</span> c2 = splat(F32x4, <span class="tok-number">1.0</span> - sincos_angle[<span class="tok-number">1</span>]);</span>
<span class="line" id="L2644">    <span class="tok-kw">const</span> c1 = splat(F32x4, sincos_angle[<span class="tok-number">1</span>]);</span>
<span class="line" id="L2645">    <span class="tok-kw">const</span> c0 = splat(F32x4, sincos_angle[<span class="tok-number">0</span>]);</span>
<span class="line" id="L2646"></span>
<span class="line" id="L2647">    <span class="tok-kw">const</span> n0 = swizzle(axis, .y, .z, .x, .w);</span>
<span class="line" id="L2648">    <span class="tok-kw">const</span> n1 = swizzle(axis, .z, .x, .y, .w);</span>
<span class="line" id="L2649"></span>
<span class="line" id="L2650">    <span class="tok-kw">var</span> v0 = c2 * n0 * n1;</span>
<span class="line" id="L2651">    <span class="tok-kw">const</span> r0 = c2 * axis * axis + c1;</span>
<span class="line" id="L2652">    <span class="tok-kw">const</span> r1 = c0 * axis + v0;</span>
<span class="line" id="L2653">    <span class="tok-kw">var</span> r2 = v0 - c0 * axis;</span>
<span class="line" id="L2654"></span>
<span class="line" id="L2655">    v0 = andInt(r0, f32x4_mask3);</span>
<span class="line" id="L2656"></span>
<span class="line" id="L2657">    <span class="tok-kw">var</span> v1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r1, r2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L2658">    v1 = swizzle(v1, .y, .z, .w, .x);</span>
<span class="line" id="L2659"></span>
<span class="line" id="L2660">    <span class="tok-kw">var</span> v2 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r1, r2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>) });</span>
<span class="line" id="L2661">    v2 = swizzle(v2, .x, .z, .x, .z);</span>
<span class="line" id="L2662"></span>
<span class="line" id="L2663">    r2 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v0, v1, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2664">    r2 = swizzle(r2, .x, .z, .w, .y);</span>
<span class="line" id="L2665"></span>
<span class="line" id="L2666">    <span class="tok-kw">var</span> m: Mat = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2667">    m[<span class="tok-number">0</span>] = r2;</span>
<span class="line" id="L2668"></span>
<span class="line" id="L2669">    r2 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v0, v1, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2670">    r2 = swizzle(r2, .z, .x, .w, .y);</span>
<span class="line" id="L2671">    m[<span class="tok-number">1</span>] = r2;</span>
<span class="line" id="L2672"></span>
<span class="line" id="L2673">    v2 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v2, v0, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2674">    m[<span class="tok-number">2</span>] = v2;</span>
<span class="line" id="L2675">    m[<span class="tok-number">3</span>] = f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L2676">    <span class="tok-kw">return</span> m;</span>
<span class="line" id="L2677">}</span>
<span class="line" id="L2678"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">matFromAxisAngle</span>(axis: Vec, angle: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2679">    assert(!all(axis == splat(F32x4, <span class="tok-number">0.0</span>), <span class="tok-number">3</span>));</span>
<span class="line" id="L2680">    assert(!all(isInf(axis), <span class="tok-number">3</span>));</span>
<span class="line" id="L2681">    <span class="tok-kw">const</span> normal = normalize3(axis);</span>
<span class="line" id="L2682">    <span class="tok-kw">return</span> matFromNormAxisAngle(normal, angle);</span>
<span class="line" id="L2683">}</span>
<span class="line" id="L2684"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.matrix.matFromAxisAngle&quot;</span> {</span>
<span class="line" id="L2685">    {</span>
<span class="line" id="L2686">        <span class="tok-kw">const</span> m0 = matFromAxisAngle(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), math.pi * <span class="tok-number">0.25</span>);</span>
<span class="line" id="L2687">        <span class="tok-kw">const</span> m1 = rotationX(math.pi * <span class="tok-number">0.25</span>);</span>
<span class="line" id="L2688">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">0</span>], m1[<span class="tok-number">0</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2689">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">1</span>], m1[<span class="tok-number">1</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2690">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">2</span>], m1[<span class="tok-number">2</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2691">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">3</span>], m1[<span class="tok-number">3</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2692">    }</span>
<span class="line" id="L2693">    {</span>
<span class="line" id="L2694">        <span class="tok-kw">const</span> m0 = matFromAxisAngle(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), math.pi * <span class="tok-number">0.125</span>);</span>
<span class="line" id="L2695">        <span class="tok-kw">const</span> m1 = rotationY(math.pi * <span class="tok-number">0.125</span>);</span>
<span class="line" id="L2696">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">0</span>], m1[<span class="tok-number">0</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2697">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">1</span>], m1[<span class="tok-number">1</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2698">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">2</span>], m1[<span class="tok-number">2</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2699">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">3</span>], m1[<span class="tok-number">3</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2700">    }</span>
<span class="line" id="L2701">    {</span>
<span class="line" id="L2702">        <span class="tok-kw">const</span> m0 = matFromAxisAngle(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), math.pi * <span class="tok-number">0.333</span>);</span>
<span class="line" id="L2703">        <span class="tok-kw">const</span> m1 = rotationZ(math.pi * <span class="tok-number">0.333</span>);</span>
<span class="line" id="L2704">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">0</span>], m1[<span class="tok-number">0</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2705">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">1</span>], m1[<span class="tok-number">1</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2706">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">2</span>], m1[<span class="tok-number">2</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2707">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">3</span>], m1[<span class="tok-number">3</span>], <span class="tok-number">0.001</span>));</span>
<span class="line" id="L2708">    }</span>
<span class="line" id="L2709">}</span>
<span class="line" id="L2710"></span>
<span class="line" id="L2711"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">matFromQuat</span>(quat: Quat) Mat {</span>
<span class="line" id="L2712">    <span class="tok-kw">var</span> q0 = quat + quat;</span>
<span class="line" id="L2713">    <span class="tok-kw">var</span> q1 = quat * q0;</span>
<span class="line" id="L2714"></span>
<span class="line" id="L2715">    <span class="tok-kw">var</span> v0 = swizzle(q1, .y, .x, .x, .w);</span>
<span class="line" id="L2716">    v0 = andInt(v0, f32x4_mask3);</span>
<span class="line" id="L2717"></span>
<span class="line" id="L2718">    <span class="tok-kw">var</span> v1 = swizzle(q1, .z, .z, .y, .w);</span>
<span class="line" id="L2719">    v1 = andInt(v1, f32x4_mask3);</span>
<span class="line" id="L2720"></span>
<span class="line" id="L2721">    <span class="tok-kw">var</span> r0 = (f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>) - v0) - v1;</span>
<span class="line" id="L2722"></span>
<span class="line" id="L2723">    v0 = swizzle(quat, .x, .x, .y, .w);</span>
<span class="line" id="L2724">    v1 = swizzle(q0, .z, .y, .z, .w);</span>
<span class="line" id="L2725">    v0 = v0 * v1;</span>
<span class="line" id="L2726"></span>
<span class="line" id="L2727">    v1 = swizzle(quat, .w, .w, .w, .w);</span>
<span class="line" id="L2728">    <span class="tok-kw">var</span> v2 = swizzle(q0, .y, .z, .x, .w);</span>
<span class="line" id="L2729">    v1 = v1 * v2;</span>
<span class="line" id="L2730"></span>
<span class="line" id="L2731">    <span class="tok-kw">var</span> r1 = v0 + v1;</span>
<span class="line" id="L2732">    <span class="tok-kw">var</span> r2 = v0 - v1;</span>
<span class="line" id="L2733"></span>
<span class="line" id="L2734">    v0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r1, r2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2735">    v0 = swizzle(v0, .x, .z, .w, .y);</span>
<span class="line" id="L2736">    v1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r1, r2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">0</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L2737">    v1 = swizzle(v1, .x, .z, .x, .z);</span>
<span class="line" id="L2738"></span>
<span class="line" id="L2739">    q1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r0, v0, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2740">    q1 = swizzle(q1, .x, .z, .w, .y);</span>
<span class="line" id="L2741"></span>
<span class="line" id="L2742">    <span class="tok-kw">var</span> m: Mat = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2743">    m[<span class="tok-number">0</span>] = q1;</span>
<span class="line" id="L2744"></span>
<span class="line" id="L2745">    q1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r0, v0, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2746">    q1 = swizzle(q1, .z, .x, .w, .y);</span>
<span class="line" id="L2747">    m[<span class="tok-number">1</span>] = q1;</span>
<span class="line" id="L2748"></span>
<span class="line" id="L2749">    q1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, v1, r0, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2750">    m[<span class="tok-number">2</span>] = q1;</span>
<span class="line" id="L2751">    m[<span class="tok-number">3</span>] = f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L2752">    <span class="tok-kw">return</span> m;</span>
<span class="line" id="L2753">}</span>
<span class="line" id="L2754"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.matrix.matFromQuat&quot;</span> {</span>
<span class="line" id="L2755">    {</span>
<span class="line" id="L2756">        <span class="tok-kw">const</span> m = matFromQuat(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L2757">        <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">0</span>], f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2758">        <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">1</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2759">        <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">2</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2760">        <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">3</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2761">    }</span>
<span class="line" id="L2762">}</span>
<span class="line" id="L2763"></span>
<span class="line" id="L2764"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">matFromRollPitchYaw</span>(pitch: <span class="tok-type">f32</span>, yaw: <span class="tok-type">f32</span>, roll: <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2765">    <span class="tok-kw">return</span> matFromRollPitchYawV(f32x4(pitch, yaw, roll, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L2766">}</span>
<span class="line" id="L2767"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">matFromRollPitchYawV</span>(angles: Vec) Mat {</span>
<span class="line" id="L2768">    <span class="tok-kw">return</span> matFromQuat(quatFromRollPitchYawV(angles));</span>
<span class="line" id="L2769">}</span>
<span class="line" id="L2770"></span>
<span class="line" id="L2771"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">matToQuat</span>(m: Mat) Quat {</span>
<span class="line" id="L2772">    <span class="tok-kw">return</span> quatFromMat(m);</span>
<span class="line" id="L2773">}</span>
<span class="line" id="L2774"></span>
<span class="line" id="L2775"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadMat</span>(mem: []<span class="tok-kw">const</span> <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2776">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2777">        load(mem[<span class="tok-number">0</span>..<span class="tok-number">4</span>], F32x4, <span class="tok-number">0</span>),</span>
<span class="line" id="L2778">        load(mem[<span class="tok-number">4</span>..<span class="tok-number">8</span>], F32x4, <span class="tok-number">0</span>),</span>
<span class="line" id="L2779">        load(mem[<span class="tok-number">8</span>..<span class="tok-number">12</span>], F32x4, <span class="tok-number">0</span>),</span>
<span class="line" id="L2780">        load(mem[<span class="tok-number">12</span>..<span class="tok-number">16</span>], F32x4, <span class="tok-number">0</span>),</span>
<span class="line" id="L2781">    };</span>
<span class="line" id="L2782">}</span>
<span class="line" id="L2783"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.loadMat&quot;</span> {</span>
<span class="line" id="L2784">    <span class="tok-kw">const</span> a = [<span class="tok-number">18</span>]<span class="tok-type">f32</span>{</span>
<span class="line" id="L2785">        <span class="tok-number">1.0</span>,  <span class="tok-number">2.0</span>,  <span class="tok-number">3.0</span>,  <span class="tok-number">4.0</span>,</span>
<span class="line" id="L2786">        <span class="tok-number">5.0</span>,  <span class="tok-number">6.0</span>,  <span class="tok-number">7.0</span>,  <span class="tok-number">8.0</span>,</span>
<span class="line" id="L2787">        <span class="tok-number">9.0</span>,  <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>,</span>
<span class="line" id="L2788">        <span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>,</span>
<span class="line" id="L2789">        <span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>,</span>
<span class="line" id="L2790">    };</span>
<span class="line" id="L2791">    <span class="tok-kw">const</span> m = loadMat(a[<span class="tok-number">1</span>..]);</span>
<span class="line" id="L2792">    <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">0</span>], f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">5.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L2793">    <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">1</span>], f32x4(<span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>, <span class="tok-number">9.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L2794">    <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">2</span>], f32x4(<span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>, <span class="tok-number">13.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L2795">    <span class="tok-kw">try</span> expect(approxEqAbs(m[<span class="tok-number">3</span>], f32x4(<span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>, <span class="tok-number">17.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L2796">}</span>
<span class="line" id="L2797"></span>
<span class="line" id="L2798"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">storeMat</span>(mem: []<span class="tok-type">f32</span>, m: Mat) <span class="tok-type">void</span> {</span>
<span class="line" id="L2799">    store(mem[<span class="tok-number">0</span>..<span class="tok-number">4</span>], m[<span class="tok-number">0</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L2800">    store(mem[<span class="tok-number">4</span>..<span class="tok-number">8</span>], m[<span class="tok-number">1</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L2801">    store(mem[<span class="tok-number">8</span>..<span class="tok-number">12</span>], m[<span class="tok-number">2</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L2802">    store(mem[<span class="tok-number">12</span>..<span class="tok-number">16</span>], m[<span class="tok-number">3</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L2803">}</span>
<span class="line" id="L2804"></span>
<span class="line" id="L2805"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadMat43</span>(mem: []<span class="tok-kw">const</span> <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2806">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2807">        f32x4(mem[<span class="tok-number">0</span>], mem[<span class="tok-number">1</span>], mem[<span class="tok-number">2</span>], <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2808">        f32x4(mem[<span class="tok-number">3</span>], mem[<span class="tok-number">4</span>], mem[<span class="tok-number">5</span>], <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2809">        f32x4(mem[<span class="tok-number">6</span>], mem[<span class="tok-number">7</span>], mem[<span class="tok-number">8</span>], <span class="tok-number">0.0</span>),</span>
<span class="line" id="L2810">        f32x4(mem[<span class="tok-number">9</span>], mem[<span class="tok-number">10</span>], mem[<span class="tok-number">11</span>], <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2811">    };</span>
<span class="line" id="L2812">}</span>
<span class="line" id="L2813"></span>
<span class="line" id="L2814"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">storeMat43</span>(mem: []<span class="tok-type">f32</span>, m: Mat) <span class="tok-type">void</span> {</span>
<span class="line" id="L2815">    store(mem[<span class="tok-number">0</span>..<span class="tok-number">3</span>], m[<span class="tok-number">0</span>], <span class="tok-number">3</span>);</span>
<span class="line" id="L2816">    store(mem[<span class="tok-number">3</span>..<span class="tok-number">6</span>], m[<span class="tok-number">1</span>], <span class="tok-number">3</span>);</span>
<span class="line" id="L2817">    store(mem[<span class="tok-number">6</span>..<span class="tok-number">9</span>], m[<span class="tok-number">2</span>], <span class="tok-number">3</span>);</span>
<span class="line" id="L2818">    store(mem[<span class="tok-number">9</span>..<span class="tok-number">12</span>], m[<span class="tok-number">3</span>], <span class="tok-number">3</span>);</span>
<span class="line" id="L2819">}</span>
<span class="line" id="L2820"></span>
<span class="line" id="L2821"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">loadMat34</span>(mem: []<span class="tok-kw">const</span> <span class="tok-type">f32</span>) Mat {</span>
<span class="line" id="L2822">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L2823">        load(mem[<span class="tok-number">0</span>..<span class="tok-number">4</span>], F32x4, <span class="tok-number">0</span>),</span>
<span class="line" id="L2824">        load(mem[<span class="tok-number">4</span>..<span class="tok-number">8</span>], F32x4, <span class="tok-number">0</span>),</span>
<span class="line" id="L2825">        load(mem[<span class="tok-number">8</span>..<span class="tok-number">12</span>], F32x4, <span class="tok-number">0</span>),</span>
<span class="line" id="L2826">        f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L2827">    };</span>
<span class="line" id="L2828">}</span>
<span class="line" id="L2829"></span>
<span class="line" id="L2830"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">storeMat34</span>(mem: []<span class="tok-type">f32</span>, m: Mat) <span class="tok-type">void</span> {</span>
<span class="line" id="L2831">    store(mem[<span class="tok-number">0</span>..<span class="tok-number">4</span>], m[<span class="tok-number">0</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L2832">    store(mem[<span class="tok-number">4</span>..<span class="tok-number">8</span>], m[<span class="tok-number">1</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L2833">    store(mem[<span class="tok-number">8</span>..<span class="tok-number">12</span>], m[<span class="tok-number">2</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L2834">}</span>
<span class="line" id="L2835"></span>
<span class="line" id="L2836"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">matToArr</span>(m: Mat) [<span class="tok-number">16</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L2837">    <span class="tok-kw">var</span> array: [<span class="tok-number">16</span>]<span class="tok-type">f32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2838">    storeMat(array[<span class="tok-number">0</span>..], m);</span>
<span class="line" id="L2839">    <span class="tok-kw">return</span> array;</span>
<span class="line" id="L2840">}</span>
<span class="line" id="L2841"></span>
<span class="line" id="L2842"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">matToArr43</span>(m: Mat) [<span class="tok-number">12</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L2843">    <span class="tok-kw">var</span> array: [<span class="tok-number">12</span>]<span class="tok-type">f32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2844">    storeMat43(array[<span class="tok-number">0</span>..], m);</span>
<span class="line" id="L2845">    <span class="tok-kw">return</span> array;</span>
<span class="line" id="L2846">}</span>
<span class="line" id="L2847"></span>
<span class="line" id="L2848"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">matToArr34</span>(m: Mat) [<span class="tok-number">12</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L2849">    <span class="tok-kw">var</span> array: [<span class="tok-number">12</span>]<span class="tok-type">f32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2850">    storeMat34(array[<span class="tok-number">0</span>..], m);</span>
<span class="line" id="L2851">    <span class="tok-kw">return</span> array;</span>
<span class="line" id="L2852">}</span>
<span class="line" id="L2853"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L2854"><span class="tok-comment">//</span>
</span>
<span class="line" id="L2855"><span class="tok-comment">// 5. Quaternion functions</span>
</span>
<span class="line" id="L2856"><span class="tok-comment">//</span>
</span>
<span class="line" id="L2857"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L2858"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">qmul</span>(q0: Quat, q1: Quat) Quat {</span>
<span class="line" id="L2859">    <span class="tok-kw">var</span> result = swizzle(q1, .w, .w, .w, .w);</span>
<span class="line" id="L2860">    <span class="tok-kw">var</span> q1x = swizzle(q1, .x, .x, .x, .x);</span>
<span class="line" id="L2861">    <span class="tok-kw">var</span> q1y = swizzle(q1, .y, .y, .y, .y);</span>
<span class="line" id="L2862">    <span class="tok-kw">var</span> q1z = swizzle(q1, .z, .z, .z, .z);</span>
<span class="line" id="L2863">    result = result * q0;</span>
<span class="line" id="L2864">    <span class="tok-kw">var</span> q0_shuf = swizzle(q0, .w, .z, .y, .x);</span>
<span class="line" id="L2865">    q1x = q1x * q0_shuf;</span>
<span class="line" id="L2866">    q0_shuf = swizzle(q0_shuf, .y, .x, .w, .z);</span>
<span class="line" id="L2867">    result = mulAdd(q1x, f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>), result);</span>
<span class="line" id="L2868">    q1y = q1y * q0_shuf;</span>
<span class="line" id="L2869">    q0_shuf = swizzle(q0_shuf, .w, .z, .y, .x);</span>
<span class="line" id="L2870">    q1y = q1y * f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>);</span>
<span class="line" id="L2871">    q1z = q1z * q0_shuf;</span>
<span class="line" id="L2872">    q1y = mulAdd(q1z, f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>), q1y);</span>
<span class="line" id="L2873">    <span class="tok-kw">return</span> result + q1y;</span>
<span class="line" id="L2874">}</span>
<span class="line" id="L2875"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quaternion.mul&quot;</span> {</span>
<span class="line" id="L2876">    {</span>
<span class="line" id="L2877">        <span class="tok-kw">const</span> q0 = f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L2878">        <span class="tok-kw">const</span> q1 = f32x4(<span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">4.0</span>);</span>
<span class="line" id="L2879">        <span class="tok-kw">try</span> expect(approxEqAbs(qmul(q0, q1), f32x4(<span class="tok-number">16.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">22.0</span>, -<span class="tok-number">12.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2880">    }</span>
<span class="line" id="L2881">}</span>
<span class="line" id="L2882"></span>
<span class="line" id="L2883"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">quatToMat</span>(quat: Quat) Mat {</span>
<span class="line" id="L2884">    <span class="tok-kw">return</span> matFromQuat(quat);</span>
<span class="line" id="L2885">}</span>
<span class="line" id="L2886"></span>
<span class="line" id="L2887"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">quatToAxisAngle</span>(quat: Quat, axis: *Vec, angle: *<span class="tok-type">f32</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L2888">    axis.* = quat;</span>
<span class="line" id="L2889">    angle.* = <span class="tok-number">2.0</span> * acos(quat[<span class="tok-number">3</span>]);</span>
<span class="line" id="L2890">}</span>
<span class="line" id="L2891"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quaternion.quatToAxisAngle&quot;</span> {</span>
<span class="line" id="L2892">    {</span>
<span class="line" id="L2893">        <span class="tok-kw">const</span> q0 = quatFromNormAxisAngle(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.25</span> * math.pi);</span>
<span class="line" id="L2894">        <span class="tok-kw">var</span> axis: Vec = f32x4(<span class="tok-number">4.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L2895">        <span class="tok-kw">var</span> angle: <span class="tok-type">f32</span> = <span class="tok-number">10.0</span>;</span>
<span class="line" id="L2896">        quatToAxisAngle(q0, &amp;axis, &amp;angle);</span>
<span class="line" id="L2897">        <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, axis[<span class="tok-number">0</span>], <span class="tok-builtin">@sin</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">0.25</span>) * math.pi * <span class="tok-number">0.5</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2898">        <span class="tok-kw">try</span> expect(axis[<span class="tok-number">1</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2899">        <span class="tok-kw">try</span> expect(axis[<span class="tok-number">2</span>] == <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2900">        <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, angle, <span class="tok-number">0.25</span> * math.pi, <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2901">    }</span>
<span class="line" id="L2902">}</span>
<span class="line" id="L2903"></span>
<span class="line" id="L2904"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">quatFromMat</span>(m: Mat) Quat {</span>
<span class="line" id="L2905">    <span class="tok-kw">const</span> r0 = m[<span class="tok-number">0</span>];</span>
<span class="line" id="L2906">    <span class="tok-kw">const</span> r1 = m[<span class="tok-number">1</span>];</span>
<span class="line" id="L2907">    <span class="tok-kw">const</span> r2 = m[<span class="tok-number">2</span>];</span>
<span class="line" id="L2908">    <span class="tok-kw">const</span> r00 = swizzle(r0, .x, .x, .x, .x);</span>
<span class="line" id="L2909">    <span class="tok-kw">const</span> r11 = swizzle(r1, .y, .y, .y, .y);</span>
<span class="line" id="L2910">    <span class="tok-kw">const</span> r22 = swizzle(r2, .z, .z, .z, .z);</span>
<span class="line" id="L2911"></span>
<span class="line" id="L2912">    <span class="tok-kw">const</span> x2gey2 = (r11 - r00) &lt;= splat(F32x4, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2913">    <span class="tok-kw">const</span> z2gew2 = (r11 + r00) &lt;= splat(F32x4, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2914">    <span class="tok-kw">const</span> x2py2gez2pw2 = r22 &lt;= splat(F32x4, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L2915"></span>
<span class="line" id="L2916">    <span class="tok-kw">var</span> t0 = mulAdd(r00, f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), splat(F32x4, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L2917">    <span class="tok-kw">var</span> t1 = r11 * f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L2918">    <span class="tok-kw">var</span> t2 = mulAdd(r22, f32x4(-<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), t0);</span>
<span class="line" id="L2919">    <span class="tok-kw">const</span> x2y2z2w2 = t1 + t2;</span>
<span class="line" id="L2920"></span>
<span class="line" id="L2921">    t0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r0, r1, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2922">    t1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r1, r2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">0</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2923">    t1 = swizzle(t1, .x, .z, .w, .y);</span>
<span class="line" id="L2924">    <span class="tok-kw">const</span> xyxzyz = t0 + t1;</span>
<span class="line" id="L2925"></span>
<span class="line" id="L2926">    t0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r2, r1, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">0</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>) });</span>
<span class="line" id="L2927">    t1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, r1, r0, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2928">    t1 = swizzle(t1, .x, .z, .w, .y);</span>
<span class="line" id="L2929">    <span class="tok-kw">const</span> xwywzw = (t0 - t1) * f32x4(-<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L2930"></span>
<span class="line" id="L2931">    t0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, x2y2z2w2, xyxzyz, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>) });</span>
<span class="line" id="L2932">    t1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, x2y2z2w2, xwywzw, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>) });</span>
<span class="line" id="L2933">    t2 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, xyxzyz, xwywzw, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2934"></span>
<span class="line" id="L2935">    <span class="tok-kw">const</span> tensor0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, t0, t2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L2936">    <span class="tok-kw">const</span> tensor1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, t0, t2, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L2937">    <span class="tok-kw">const</span> tensor2 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, t2, t1, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L2938">    <span class="tok-kw">const</span> tensor3 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, t2, t1, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>) });</span>
<span class="line" id="L2939"></span>
<span class="line" id="L2940">    t0 = select(x2gey2, tensor0, tensor1);</span>
<span class="line" id="L2941">    t1 = select(z2gew2, tensor2, tensor3);</span>
<span class="line" id="L2942">    t2 = select(x2py2gez2pw2, t0, t1);</span>
<span class="line" id="L2943"></span>
<span class="line" id="L2944">    <span class="tok-kw">return</span> t2 / length4(t2);</span>
<span class="line" id="L2945">}</span>
<span class="line" id="L2946"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quatFromMat&quot;</span> {</span>
<span class="line" id="L2947">    {</span>
<span class="line" id="L2948">        <span class="tok-kw">const</span> q0 = quatFromAxisAngle(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.25</span> * math.pi);</span>
<span class="line" id="L2949">        <span class="tok-kw">const</span> q1 = quatFromMat(rotationX(<span class="tok-number">0.25</span> * math.pi));</span>
<span class="line" id="L2950">        <span class="tok-kw">try</span> expect(approxEqAbs(q0, q1, <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2951">    }</span>
<span class="line" id="L2952">    {</span>
<span class="line" id="L2953">        <span class="tok-kw">const</span> q0 = quatFromAxisAngle(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.25</span> * math.pi);</span>
<span class="line" id="L2954">        <span class="tok-kw">const</span> q1 = quatFromMat(matFromAxisAngle(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.25</span> * math.pi));</span>
<span class="line" id="L2955">        <span class="tok-kw">try</span> expect(approxEqAbs(q0, q1, <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2956">    }</span>
<span class="line" id="L2957">    {</span>
<span class="line" id="L2958">        <span class="tok-kw">const</span> q0 = quatFromRollPitchYaw(<span class="tok-number">0.1</span> * math.pi, -<span class="tok-number">0.2</span> * math.pi, <span class="tok-number">0.3</span> * math.pi);</span>
<span class="line" id="L2959">        <span class="tok-kw">const</span> q1 = quatFromMat(matFromRollPitchYaw(<span class="tok-number">0.1</span> * math.pi, -<span class="tok-number">0.2</span> * math.pi, <span class="tok-number">0.3</span> * math.pi));</span>
<span class="line" id="L2960">        <span class="tok-kw">try</span> expect(approxEqAbs(q0, q1, <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2961">    }</span>
<span class="line" id="L2962">}</span>
<span class="line" id="L2963"></span>
<span class="line" id="L2964"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">quatFromNormAxisAngle</span>(axis: Vec, angle: <span class="tok-type">f32</span>) Quat {</span>
<span class="line" id="L2965">    <span class="tok-kw">var</span> n = f32x4(axis[<span class="tok-number">0</span>], axis[<span class="tok-number">1</span>], axis[<span class="tok-number">2</span>], <span class="tok-number">1.0</span>);</span>
<span class="line" id="L2966">    <span class="tok-kw">const</span> sc = sincos(<span class="tok-number">0.5</span> * angle);</span>
<span class="line" id="L2967">    <span class="tok-kw">return</span> n * f32x4(sc[<span class="tok-number">0</span>], sc[<span class="tok-number">0</span>], sc[<span class="tok-number">0</span>], sc[<span class="tok-number">1</span>]);</span>
<span class="line" id="L2968">}</span>
<span class="line" id="L2969"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">quatFromAxisAngle</span>(axis: Vec, angle: <span class="tok-type">f32</span>) Quat {</span>
<span class="line" id="L2970">    assert(!all(axis == splat(F32x4, <span class="tok-number">0.0</span>), <span class="tok-number">3</span>));</span>
<span class="line" id="L2971">    assert(!all(isInf(axis), <span class="tok-number">3</span>));</span>
<span class="line" id="L2972">    <span class="tok-kw">const</span> normal = normalize3(axis);</span>
<span class="line" id="L2973">    <span class="tok-kw">return</span> quatFromNormAxisAngle(normal, angle);</span>
<span class="line" id="L2974">}</span>
<span class="line" id="L2975"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quaternion.quatFromNormAxisAngle&quot;</span> {</span>
<span class="line" id="L2976">    {</span>
<span class="line" id="L2977">        <span class="tok-kw">const</span> q0 = quatFromAxisAngle(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.25</span> * math.pi);</span>
<span class="line" id="L2978">        <span class="tok-kw">const</span> q1 = quatFromAxisAngle(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.125</span> * math.pi);</span>
<span class="line" id="L2979">        <span class="tok-kw">const</span> m0 = rotationX(<span class="tok-number">0.25</span> * math.pi);</span>
<span class="line" id="L2980">        <span class="tok-kw">const</span> m1 = rotationY(<span class="tok-number">0.125</span> * math.pi);</span>
<span class="line" id="L2981">        <span class="tok-kw">const</span> mr0 = quatToMat(qmul(q0, q1));</span>
<span class="line" id="L2982">        <span class="tok-kw">const</span> mr1 = mul(m0, m1);</span>
<span class="line" id="L2983">        <span class="tok-kw">try</span> expect(approxEqAbs(mr0[<span class="tok-number">0</span>], mr1[<span class="tok-number">0</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2984">        <span class="tok-kw">try</span> expect(approxEqAbs(mr0[<span class="tok-number">1</span>], mr1[<span class="tok-number">1</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2985">        <span class="tok-kw">try</span> expect(approxEqAbs(mr0[<span class="tok-number">2</span>], mr1[<span class="tok-number">2</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2986">        <span class="tok-kw">try</span> expect(approxEqAbs(mr0[<span class="tok-number">3</span>], mr1[<span class="tok-number">3</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2987">    }</span>
<span class="line" id="L2988">    {</span>
<span class="line" id="L2989">        <span class="tok-kw">const</span> m0 = quatToMat(quatFromAxisAngle(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.25</span> * math.pi));</span>
<span class="line" id="L2990">        <span class="tok-kw">const</span> m1 = matFromAxisAngle(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">0.0</span>), <span class="tok-number">0.25</span> * math.pi);</span>
<span class="line" id="L2991">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">0</span>], m1[<span class="tok-number">0</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2992">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">1</span>], m1[<span class="tok-number">1</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2993">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">2</span>], m1[<span class="tok-number">2</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2994">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">3</span>], m1[<span class="tok-number">3</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L2995">    }</span>
<span class="line" id="L2996">}</span>
<span class="line" id="L2997"></span>
<span class="line" id="L2998"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">qidentity</span>() Quat {</span>
<span class="line" id="L2999">    <span class="tok-kw">return</span> f32x4(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">0.0</span>), <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">0.0</span>), <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">0.0</span>), <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L3000">}</span>
<span class="line" id="L3001"></span>
<span class="line" id="L3002"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">conjugate</span>(quat: Quat) Quat {</span>
<span class="line" id="L3003">    <span class="tok-kw">return</span> quat * f32x4(-<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3004">}</span>
<span class="line" id="L3005"></span>
<span class="line" id="L3006"><span class="tok-kw">fn</span> <span class="tok-fn">inverseQuat</span>(quat: Quat) Quat {</span>
<span class="line" id="L3007">    <span class="tok-kw">const</span> l = lengthSq4(quat);</span>
<span class="line" id="L3008">    <span class="tok-kw">const</span> conj = conjugate(quat);</span>
<span class="line" id="L3009">    <span class="tok-kw">return</span> select(l &lt;= splat(F32x4, math.floatEps(<span class="tok-type">f32</span>)), splat(F32x4, <span class="tok-number">0.0</span>), conj / l);</span>
<span class="line" id="L3010">}</span>
<span class="line" id="L3011"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quaternion.inverseQuat&quot;</span> {</span>
<span class="line" id="L3012">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3013">        inverse(f32x4(<span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>, <span class="tok-number">1.0</span>)),</span>
<span class="line" id="L3014">        f32x4(-<span class="tok-number">1.0</span> / <span class="tok-number">15.0</span>, -<span class="tok-number">1.0</span> / <span class="tok-number">10.0</span>, -<span class="tok-number">2.0</span> / <span class="tok-number">15.0</span>, <span class="tok-number">1.0</span> / <span class="tok-number">30.0</span>),</span>
<span class="line" id="L3015">        <span class="tok-number">0.0001</span>,</span>
<span class="line" id="L3016">    ));</span>
<span class="line" id="L3017">    <span class="tok-kw">try</span> expect(approxEqAbs(inverse(qidentity()), qidentity(), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3018">}</span>
<span class="line" id="L3019"></span>
<span class="line" id="L3020"><span class="tok-comment">// Algorithm from: https://github.com/g-truc/glm/blob/master/glm/detail/type_quat.inl</span>
</span>
<span class="line" id="L3021"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rotate</span>(q: Quat, v: Vec) Vec {</span>
<span class="line" id="L3022">    <span class="tok-kw">const</span> w = splat(F32x4, q[<span class="tok-number">3</span>]);</span>
<span class="line" id="L3023">    <span class="tok-kw">const</span> axis = f32x4(q[<span class="tok-number">0</span>], q[<span class="tok-number">1</span>], q[<span class="tok-number">2</span>], <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3024">    <span class="tok-kw">const</span> uv = cross3(axis, v);</span>
<span class="line" id="L3025">    <span class="tok-kw">return</span> v + ((uv * w) + cross3(axis, uv)) * splat(F32x4, <span class="tok-number">2.0</span>);</span>
<span class="line" id="L3026">}</span>
<span class="line" id="L3027"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quaternion.rotate&quot;</span> {</span>
<span class="line" id="L3028">    <span class="tok-kw">const</span> quat = quatFromRollPitchYaw(<span class="tok-number">0.1</span> * math.pi, <span class="tok-number">0.2</span> * math.pi, <span class="tok-number">0.3</span> * math.pi);</span>
<span class="line" id="L3029">    <span class="tok-kw">const</span> mat = matFromQuat(quat);</span>
<span class="line" id="L3030">    <span class="tok-kw">const</span> forward = f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3031">    <span class="tok-kw">const</span> up = f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3032">    <span class="tok-kw">const</span> right = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3033">    <span class="tok-kw">try</span> expect(approxEqAbs(rotate(quat, forward), mul(forward, mat), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3034">    <span class="tok-kw">try</span> expect(approxEqAbs(rotate(quat, up), mul(up, mat), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3035">    <span class="tok-kw">try</span> expect(approxEqAbs(rotate(quat, right), mul(right, mat), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3036">}</span>
<span class="line" id="L3037"></span>
<span class="line" id="L3038"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">slerp</span>(q0: Quat, q1: Quat, t: <span class="tok-type">f32</span>) Quat {</span>
<span class="line" id="L3039">    <span class="tok-kw">return</span> slerpV(q0, q1, splat(F32x4, t));</span>
<span class="line" id="L3040">}</span>
<span class="line" id="L3041"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">slerpV</span>(q0: Quat, q1: Quat, t: F32x4) Quat {</span>
<span class="line" id="L3042">    <span class="tok-kw">var</span> cos_omega = dot4(q0, q1);</span>
<span class="line" id="L3043">    <span class="tok-kw">const</span> sign = select(cos_omega &lt; splat(F32x4, <span class="tok-number">0.0</span>), splat(F32x4, -<span class="tok-number">1.0</span>), splat(F32x4, <span class="tok-number">1.0</span>));</span>
<span class="line" id="L3044"></span>
<span class="line" id="L3045">    cos_omega = cos_omega * sign;</span>
<span class="line" id="L3046">    <span class="tok-kw">const</span> sin_omega = sqrt(splat(F32x4, <span class="tok-number">1.0</span>) - cos_omega * cos_omega);</span>
<span class="line" id="L3047"></span>
<span class="line" id="L3048">    <span class="tok-kw">const</span> omega = atan2(sin_omega, cos_omega);</span>
<span class="line" id="L3049"></span>
<span class="line" id="L3050">    <span class="tok-kw">var</span> v01 = t;</span>
<span class="line" id="L3051">    v01 = xorInt(andInt(v01, f32x4_mask2), f32x4_sign_mask1);</span>
<span class="line" id="L3052">    v01 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>) + v01;</span>
<span class="line" id="L3053"></span>
<span class="line" id="L3054">    <span class="tok-kw">var</span> s0 = sin(v01 * omega) / sin_omega;</span>
<span class="line" id="L3055">    s0 = select(cos_omega &lt; splat(F32x4, <span class="tok-number">1.0</span> - <span class="tok-number">0.00001</span>), s0, v01);</span>
<span class="line" id="L3056"></span>
<span class="line" id="L3057">    <span class="tok-kw">var</span> s1 = swizzle(s0, .y, .y, .y, .y);</span>
<span class="line" id="L3058">    s0 = swizzle(s0, .x, .x, .x, .x);</span>
<span class="line" id="L3059"></span>
<span class="line" id="L3060">    <span class="tok-kw">return</span> q0 * s0 + sign * q1 * s1;</span>
<span class="line" id="L3061">}</span>
<span class="line" id="L3062"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quaternion.slerp&quot;</span> {</span>
<span class="line" id="L3063">    <span class="tok-kw">const</span> from = f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3064">    <span class="tok-kw">const</span> to = f32x4(<span class="tok-number">0.5</span>, <span class="tok-number">0.5</span>, -<span class="tok-number">0.5</span>, <span class="tok-number">0.5</span>);</span>
<span class="line" id="L3065">    <span class="tok-kw">const</span> result = slerp(from, to, <span class="tok-number">0.5</span>);</span>
<span class="line" id="L3066">    <span class="tok-kw">try</span> expect(approxEqAbs(result, f32x4(<span class="tok-number">0.28867513</span>, <span class="tok-number">0.28867513</span>, -<span class="tok-number">0.28867513</span>, <span class="tok-number">0.86602540</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3067">}</span>
<span class="line" id="L3068"></span>
<span class="line" id="L3069"><span class="tok-comment">// Converts q back to euler angles, assuming a YXZ rotation order.</span>
</span>
<span class="line" id="L3070"><span class="tok-comment">// See: http://www.euclideanspace.com/maths/geometry/rotations/conversions/quaternionToEuler</span>
</span>
<span class="line" id="L3071"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">quatToRollPitchYaw</span>(q: Quat) [<span class="tok-number">3</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L3072">    <span class="tok-kw">var</span> angles: [<span class="tok-number">3</span>]<span class="tok-type">f32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3073"></span>
<span class="line" id="L3074">    <span class="tok-kw">const</span> p = swizzle(q, .w, .y, .x, .z);</span>
<span class="line" id="L3075">    <span class="tok-kw">const</span> sign = -<span class="tok-number">1.0</span>;</span>
<span class="line" id="L3076"></span>
<span class="line" id="L3077">    <span class="tok-kw">const</span> singularity = p[<span class="tok-number">0</span>] * p[<span class="tok-number">2</span>] + sign * p[<span class="tok-number">1</span>] * p[<span class="tok-number">3</span>];</span>
<span class="line" id="L3078">    <span class="tok-kw">if</span> (singularity &gt; <span class="tok-number">0.499</span>) {</span>
<span class="line" id="L3079">        angles[<span class="tok-number">0</span>] = math.pi * <span class="tok-number">0.5</span>;</span>
<span class="line" id="L3080">        angles[<span class="tok-number">1</span>] = <span class="tok-number">2.0</span> * math.atan2(<span class="tok-type">f32</span>, p[<span class="tok-number">1</span>], p[<span class="tok-number">0</span>]);</span>
<span class="line" id="L3081">        angles[<span class="tok-number">2</span>] = <span class="tok-number">0.0</span>;</span>
<span class="line" id="L3082">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (singularity &lt; -<span class="tok-number">0.499</span>) {</span>
<span class="line" id="L3083">        angles[<span class="tok-number">0</span>] = -math.pi * <span class="tok-number">0.5</span>;</span>
<span class="line" id="L3084">        angles[<span class="tok-number">1</span>] = <span class="tok-number">2.0</span> * math.atan2(<span class="tok-type">f32</span>, p[<span class="tok-number">1</span>], p[<span class="tok-number">0</span>]);</span>
<span class="line" id="L3085">        angles[<span class="tok-number">2</span>] = <span class="tok-number">0.0</span>;</span>
<span class="line" id="L3086">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3087">        <span class="tok-kw">const</span> sq = p * p;</span>
<span class="line" id="L3088">        <span class="tok-kw">var</span> y = splat(F32x4, <span class="tok-number">2.0</span>) * f32x4(p[<span class="tok-number">0</span>] * p[<span class="tok-number">1</span>] - sign * p[<span class="tok-number">2</span>] * p[<span class="tok-number">3</span>], p[<span class="tok-number">0</span>] * p[<span class="tok-number">3</span>] - sign * p[<span class="tok-number">1</span>] * p[<span class="tok-number">2</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3089">        <span class="tok-kw">var</span> x = splat(F32x4, <span class="tok-number">1.0</span>) - (splat(F32x4, <span class="tok-number">2.0</span>) * f32x4(sq[<span class="tok-number">1</span>] + sq[<span class="tok-number">2</span>], sq[<span class="tok-number">2</span>] + sq[<span class="tok-number">3</span>], <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L3090">        <span class="tok-kw">var</span> res = atan2(y, x);</span>
<span class="line" id="L3091">        angles[<span class="tok-number">0</span>] = math.asin(<span class="tok-number">2.0</span> * singularity);</span>
<span class="line" id="L3092">        angles[<span class="tok-number">1</span>] = res[<span class="tok-number">0</span>];</span>
<span class="line" id="L3093">        angles[<span class="tok-number">2</span>] = res[<span class="tok-number">1</span>];</span>
<span class="line" id="L3094">    }</span>
<span class="line" id="L3095"></span>
<span class="line" id="L3096">    <span class="tok-kw">return</span> angles;</span>
<span class="line" id="L3097">}</span>
<span class="line" id="L3098"></span>
<span class="line" id="L3099"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quaternion.quatToRollPitchYaw&quot;</span> {</span>
<span class="line" id="L3100">    {</span>
<span class="line" id="L3101">        <span class="tok-kw">const</span> expected = f32x4(<span class="tok-number">0.1</span> * math.pi, <span class="tok-number">0.2</span> * math.pi, <span class="tok-number">0.3</span> * math.pi, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3102">        <span class="tok-kw">const</span> quat = quatFromRollPitchYaw(expected[<span class="tok-number">0</span>], expected[<span class="tok-number">1</span>], expected[<span class="tok-number">2</span>]);</span>
<span class="line" id="L3103">        <span class="tok-kw">const</span> result = quatToRollPitchYaw(quat);</span>
<span class="line" id="L3104">        <span class="tok-kw">try</span> expect(approxEqAbs(loadArr3(result), expected, <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3105">    }</span>
<span class="line" id="L3106"></span>
<span class="line" id="L3107">    {</span>
<span class="line" id="L3108">        <span class="tok-kw">const</span> expected = f32x4(<span class="tok-number">0.3</span> * math.pi, <span class="tok-number">0.1</span> * math.pi, <span class="tok-number">0.2</span> * math.pi, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3109">        <span class="tok-kw">const</span> quat = quatFromRollPitchYaw(expected[<span class="tok-number">0</span>], expected[<span class="tok-number">1</span>], expected[<span class="tok-number">2</span>]);</span>
<span class="line" id="L3110">        <span class="tok-kw">const</span> result = quatToRollPitchYaw(quat);</span>
<span class="line" id="L3111">        <span class="tok-kw">try</span> expect(approxEqAbs(loadArr3(result), expected, <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3112">    }</span>
<span class="line" id="L3113"></span>
<span class="line" id="L3114">    <span class="tok-comment">// North pole singularity</span>
</span>
<span class="line" id="L3115">    {</span>
<span class="line" id="L3116">        <span class="tok-kw">const</span> angle = f32x4(<span class="tok-number">0.5</span> * math.pi, <span class="tok-number">0.2</span> * math.pi, <span class="tok-number">0.3</span> * math.pi, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3117">        <span class="tok-kw">const</span> expected = f32x4(<span class="tok-number">0.5</span> * math.pi, -<span class="tok-number">0.1</span> * math.pi, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3118">        <span class="tok-kw">const</span> quat = quatFromRollPitchYaw(angle[<span class="tok-number">0</span>], angle[<span class="tok-number">1</span>], angle[<span class="tok-number">2</span>]);</span>
<span class="line" id="L3119">        <span class="tok-kw">const</span> result = quatToRollPitchYaw(quat);</span>
<span class="line" id="L3120">        <span class="tok-kw">try</span> expect(approxEqAbs(loadArr3(result), expected, <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3121">    }</span>
<span class="line" id="L3122"></span>
<span class="line" id="L3123">    <span class="tok-comment">// South pole singularity</span>
</span>
<span class="line" id="L3124">    {</span>
<span class="line" id="L3125">        <span class="tok-kw">const</span> angle = f32x4(-<span class="tok-number">0.5</span> * math.pi, <span class="tok-number">0.2</span> * math.pi, <span class="tok-number">0.3</span> * math.pi, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3126">        <span class="tok-kw">const</span> expected = f32x4(-<span class="tok-number">0.5</span> * math.pi, <span class="tok-number">0.5</span> * math.pi, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>);</span>
<span class="line" id="L3127">        <span class="tok-kw">const</span> quat = quatFromRollPitchYaw(angle[<span class="tok-number">0</span>], angle[<span class="tok-number">1</span>], angle[<span class="tok-number">2</span>]);</span>
<span class="line" id="L3128">        <span class="tok-kw">const</span> result = quatToRollPitchYaw(quat);</span>
<span class="line" id="L3129">        <span class="tok-kw">try</span> expect(approxEqAbs(loadArr3(result), expected, <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3130">    }</span>
<span class="line" id="L3131">}</span>
<span class="line" id="L3132"></span>
<span class="line" id="L3133"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">quatFromRollPitchYaw</span>(pitch: <span class="tok-type">f32</span>, yaw: <span class="tok-type">f32</span>, roll: <span class="tok-type">f32</span>) Quat {</span>
<span class="line" id="L3134">    <span class="tok-kw">return</span> quatFromRollPitchYawV(f32x4(pitch, yaw, roll, <span class="tok-number">0.0</span>));</span>
<span class="line" id="L3135">}</span>
<span class="line" id="L3136"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">quatFromRollPitchYawV</span>(angles: Vec) Quat { <span class="tok-comment">// | pitch | yaw | roll | 0 |</span>
</span>
<span class="line" id="L3137">    <span class="tok-kw">const</span> sc = sincos(splat(Vec, <span class="tok-number">0.5</span>) * angles);</span>
<span class="line" id="L3138">    <span class="tok-kw">const</span> p0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, sc[<span class="tok-number">1</span>], sc[<span class="tok-number">0</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> });</span>
<span class="line" id="L3139">    <span class="tok-kw">const</span> p1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, sc[<span class="tok-number">0</span>], sc[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> });</span>
<span class="line" id="L3140">    <span class="tok-kw">const</span> y0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, sc[<span class="tok-number">1</span>], sc[<span class="tok-number">0</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), <span class="tok-number">1</span>, <span class="tok-number">1</span> });</span>
<span class="line" id="L3141">    <span class="tok-kw">const</span> y1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, sc[<span class="tok-number">0</span>], sc[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), <span class="tok-number">1</span>, <span class="tok-number">1</span> });</span>
<span class="line" id="L3142">    <span class="tok-kw">const</span> r0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, sc[<span class="tok-number">1</span>], sc[<span class="tok-number">0</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), <span class="tok-number">2</span> });</span>
<span class="line" id="L3143">    <span class="tok-kw">const</span> r1 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, sc[<span class="tok-number">0</span>], sc[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), <span class="tok-number">2</span> });</span>
<span class="line" id="L3144">    <span class="tok-kw">const</span> q1 = p1 * f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>) * y1;</span>
<span class="line" id="L3145">    <span class="tok-kw">const</span> q0 = p0 * y0 * r0;</span>
<span class="line" id="L3146">    <span class="tok-kw">return</span> mulAdd(q1, r1, q0);</span>
<span class="line" id="L3147">}</span>
<span class="line" id="L3148"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.quaternion.quatFromRollPitchYawV&quot;</span> {</span>
<span class="line" id="L3149">    {</span>
<span class="line" id="L3150">        <span class="tok-kw">const</span> m0 = quatToMat(quatFromRollPitchYawV(f32x4(<span class="tok-number">0.25</span> * math.pi, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>)));</span>
<span class="line" id="L3151">        <span class="tok-kw">const</span> m1 = rotationX(<span class="tok-number">0.25</span> * math.pi);</span>
<span class="line" id="L3152">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">0</span>], m1[<span class="tok-number">0</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3153">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">1</span>], m1[<span class="tok-number">1</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3154">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">2</span>], m1[<span class="tok-number">2</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3155">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">3</span>], m1[<span class="tok-number">3</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3156">    }</span>
<span class="line" id="L3157">    {</span>
<span class="line" id="L3158">        <span class="tok-kw">const</span> m0 = quatToMat(quatFromRollPitchYaw(<span class="tok-number">0.1</span> * math.pi, <span class="tok-number">0.2</span> * math.pi, <span class="tok-number">0.3</span> * math.pi));</span>
<span class="line" id="L3159">        <span class="tok-kw">const</span> m1 = mul(</span>
<span class="line" id="L3160">            rotationZ(<span class="tok-number">0.3</span> * math.pi),</span>
<span class="line" id="L3161">            mul(rotationX(<span class="tok-number">0.1</span> * math.pi), rotationY(<span class="tok-number">0.2</span> * math.pi)),</span>
<span class="line" id="L3162">        );</span>
<span class="line" id="L3163">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">0</span>], m1[<span class="tok-number">0</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3164">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">1</span>], m1[<span class="tok-number">1</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3165">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">2</span>], m1[<span class="tok-number">2</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3166">        <span class="tok-kw">try</span> expect(approxEqAbs(m0[<span class="tok-number">3</span>], m1[<span class="tok-number">3</span>], <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3167">    }</span>
<span class="line" id="L3168">}</span>
<span class="line" id="L3169"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L3170"><span class="tok-comment">//</span>
</span>
<span class="line" id="L3171"><span class="tok-comment">// 6. Color functions</span>
</span>
<span class="line" id="L3172"><span class="tok-comment">//</span>
</span>
<span class="line" id="L3173"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L3174"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">adjustSaturation</span>(color: F32x4, saturation: <span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L3175">    <span class="tok-kw">const</span> luminance = dot3(f32x4(<span class="tok-number">0.2125</span>, <span class="tok-number">0.7154</span>, <span class="tok-number">0.0721</span>, <span class="tok-number">0.0</span>), color);</span>
<span class="line" id="L3176">    <span class="tok-kw">var</span> result = mulAdd(color - luminance, f32x4s(saturation), luminance);</span>
<span class="line" id="L3177">    result[<span class="tok-number">3</span>] = color[<span class="tok-number">3</span>];</span>
<span class="line" id="L3178">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L3179">}</span>
<span class="line" id="L3180"></span>
<span class="line" id="L3181"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">adjustContrast</span>(color: F32x4, contrast: <span class="tok-type">f32</span>) F32x4 {</span>
<span class="line" id="L3182">    <span class="tok-kw">var</span> result = mulAdd(color - f32x4s(<span class="tok-number">0.5</span>), f32x4s(contrast), f32x4s(<span class="tok-number">0.5</span>));</span>
<span class="line" id="L3183">    result[<span class="tok-number">3</span>] = color[<span class="tok-number">3</span>];</span>
<span class="line" id="L3184">    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L3185">}</span>
<span class="line" id="L3186"></span>
<span class="line" id="L3187"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rgbToHsl</span>(rgb: F32x4) F32x4 {</span>
<span class="line" id="L3188">    <span class="tok-kw">const</span> r = swizzle(rgb, .x, .x, .x, .x);</span>
<span class="line" id="L3189">    <span class="tok-kw">const</span> g = swizzle(rgb, .y, .y, .y, .y);</span>
<span class="line" id="L3190">    <span class="tok-kw">const</span> b = swizzle(rgb, .z, .z, .z, .z);</span>
<span class="line" id="L3191"></span>
<span class="line" id="L3192">    <span class="tok-kw">const</span> minv = min(r, min(g, b));</span>
<span class="line" id="L3193">    <span class="tok-kw">const</span> maxv = max(r, max(g, b));</span>
<span class="line" id="L3194"></span>
<span class="line" id="L3195">    <span class="tok-kw">const</span> l = (minv + maxv) * f32x4s(<span class="tok-number">0.5</span>);</span>
<span class="line" id="L3196">    <span class="tok-kw">const</span> d = maxv - minv;</span>
<span class="line" id="L3197">    <span class="tok-kw">const</span> la = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), l, rgb);</span>
<span class="line" id="L3198"></span>
<span class="line" id="L3199">    <span class="tok-kw">if</span> (all(d &lt; f32x4s(math.floatEps(<span class="tok-type">f32</span>)), <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3200">        <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), f32x4s(<span class="tok-number">0.0</span>), la);</span>
<span class="line" id="L3201">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3202">        <span class="tok-kw">var</span> s: F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3203">        <span class="tok-kw">var</span> h: F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3204"></span>
<span class="line" id="L3205">        <span class="tok-kw">const</span> d2 = minv + maxv;</span>
<span class="line" id="L3206"></span>
<span class="line" id="L3207">        <span class="tok-kw">if</span> (all(l &gt; f32x4s(<span class="tok-number">0.5</span>), <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3208">            s = d / (f32x4s(<span class="tok-number">2.0</span>) - d2);</span>
<span class="line" id="L3209">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3210">            s = d / d2;</span>
<span class="line" id="L3211">        }</span>
<span class="line" id="L3212"></span>
<span class="line" id="L3213">        <span class="tok-kw">if</span> (all(r == maxv, <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3214">            h = (g - b) / d;</span>
<span class="line" id="L3215">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (all(g == maxv, <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3216">            h = f32x4s(<span class="tok-number">2.0</span>) + (b - r) / d;</span>
<span class="line" id="L3217">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3218">            h = f32x4s(<span class="tok-number">4.0</span>) + (r - g) / d;</span>
<span class="line" id="L3219">        }</span>
<span class="line" id="L3220"></span>
<span class="line" id="L3221">        h /= f32x4s(<span class="tok-number">6.0</span>);</span>
<span class="line" id="L3222"></span>
<span class="line" id="L3223">        <span class="tok-kw">if</span> (all(h &lt; f32x4s(<span class="tok-number">0.0</span>), <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3224">            h += f32x4s(<span class="tok-number">1.0</span>);</span>
<span class="line" id="L3225">        }</span>
<span class="line" id="L3226"></span>
<span class="line" id="L3227">        <span class="tok-kw">const</span> lha = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), h, la);</span>
<span class="line" id="L3228">        <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>), lha, s);</span>
<span class="line" id="L3229">    }</span>
<span class="line" id="L3230">}</span>
<span class="line" id="L3231"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.color.rgbToHsl&quot;</span> {</span>
<span class="line" id="L3232">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsl(f32x4(<span class="tok-number">0.2</span>, <span class="tok-number">0.4</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.6111</span>, <span class="tok-number">0.6</span>, <span class="tok-number">0.5</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3233">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsl(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.5</span>)), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">0.5</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3234">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsl(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.25</span>)), f32x4(<span class="tok-number">0.3333</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">0.25</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3235">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsl(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.6666</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3236">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsl(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3237">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsl(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3238">}</span>
<span class="line" id="L3239"></span>
<span class="line" id="L3240"><span class="tok-kw">fn</span> <span class="tok-fn">hueToClr</span>(p: F32x4, q: F32x4, h: F32x4) F32x4 {</span>
<span class="line" id="L3241">    <span class="tok-kw">var</span> t = h;</span>
<span class="line" id="L3242"></span>
<span class="line" id="L3243">    <span class="tok-kw">if</span> (all(t &lt; f32x4s(<span class="tok-number">0.0</span>), <span class="tok-number">3</span>))</span>
<span class="line" id="L3244">        t += f32x4s(<span class="tok-number">1.0</span>);</span>
<span class="line" id="L3245"></span>
<span class="line" id="L3246">    <span class="tok-kw">if</span> (all(t &gt; f32x4s(<span class="tok-number">1.0</span>), <span class="tok-number">3</span>))</span>
<span class="line" id="L3247">        t -= f32x4s(<span class="tok-number">1.0</span>);</span>
<span class="line" id="L3248"></span>
<span class="line" id="L3249">    <span class="tok-kw">if</span> (all(t &lt; f32x4s(<span class="tok-number">1.0</span> / <span class="tok-number">6.0</span>), <span class="tok-number">3</span>))</span>
<span class="line" id="L3250">        <span class="tok-kw">return</span> mulAdd(q - p, f32x4s(<span class="tok-number">6.0</span>) * t, p);</span>
<span class="line" id="L3251"></span>
<span class="line" id="L3252">    <span class="tok-kw">if</span> (all(t &lt; f32x4s(<span class="tok-number">0.5</span>), <span class="tok-number">3</span>))</span>
<span class="line" id="L3253">        <span class="tok-kw">return</span> q;</span>
<span class="line" id="L3254"></span>
<span class="line" id="L3255">    <span class="tok-kw">if</span> (all(t &lt; f32x4s(<span class="tok-number">2.0</span> / <span class="tok-number">3.0</span>), <span class="tok-number">3</span>))</span>
<span class="line" id="L3256">        <span class="tok-kw">return</span> mulAdd(q - p, f32x4s(<span class="tok-number">6.0</span>) * (f32x4s(<span class="tok-number">2.0</span> / <span class="tok-number">3.0</span>) - t), p);</span>
<span class="line" id="L3257"></span>
<span class="line" id="L3258">    <span class="tok-kw">return</span> p;</span>
<span class="line" id="L3259">}</span>
<span class="line" id="L3260"></span>
<span class="line" id="L3261"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">hslToRgb</span>(hsl: F32x4) F32x4 {</span>
<span class="line" id="L3262">    <span class="tok-kw">const</span> s = swizzle(hsl, .y, .y, .y, .y);</span>
<span class="line" id="L3263">    <span class="tok-kw">const</span> l = swizzle(hsl, .z, .z, .z, .z);</span>
<span class="line" id="L3264"></span>
<span class="line" id="L3265">    <span class="tok-kw">if</span> (all(isNearEqual(s, f32x4s(<span class="tok-number">0.0</span>), f32x4s(math.floatEps(<span class="tok-type">f32</span>))), <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3266">        <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), l, hsl);</span>
<span class="line" id="L3267">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3268">        <span class="tok-kw">const</span> h = swizzle(hsl, .x, .x, .x, .x);</span>
<span class="line" id="L3269">        <span class="tok-kw">var</span> q: F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3270">        <span class="tok-kw">if</span> (all(l &lt; f32x4s(<span class="tok-number">0.5</span>), <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3271">            q = l * (f32x4s(<span class="tok-number">1.0</span>) + s);</span>
<span class="line" id="L3272">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3273">            q = (l + s) - (l * s);</span>
<span class="line" id="L3274">        }</span>
<span class="line" id="L3275"></span>
<span class="line" id="L3276">        <span class="tok-kw">const</span> p = f32x4s(<span class="tok-number">2.0</span>) * l - q;</span>
<span class="line" id="L3277"></span>
<span class="line" id="L3278">        <span class="tok-kw">const</span> r = hueToClr(p, q, h + f32x4s(<span class="tok-number">1.0</span> / <span class="tok-number">3.0</span>));</span>
<span class="line" id="L3279">        <span class="tok-kw">const</span> g = hueToClr(p, q, h);</span>
<span class="line" id="L3280">        <span class="tok-kw">const</span> b = hueToClr(p, q, h - f32x4s(<span class="tok-number">1.0</span> / <span class="tok-number">3.0</span>));</span>
<span class="line" id="L3281"></span>
<span class="line" id="L3282">        <span class="tok-kw">const</span> rg = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), r, g);</span>
<span class="line" id="L3283">        <span class="tok-kw">const</span> ba = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), b, hsl);</span>
<span class="line" id="L3284">        <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), rg, ba);</span>
<span class="line" id="L3285">    }</span>
<span class="line" id="L3286">}</span>
<span class="line" id="L3287"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.color.hslToRgb&quot;</span> {</span>
<span class="line" id="L3288">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.2</span>, <span class="tok-number">0.4</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>), hslToRgb(f32x4(<span class="tok-number">0.6111</span>, <span class="tok-number">0.6</span>, <span class="tok-number">0.5</span>, <span class="tok-number">1.0</span>)), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3289">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.5</span>), hslToRgb(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">0.5</span>)), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3290">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.25</span>), hslToRgb(f32x4(<span class="tok-number">0.3333</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">0.25</span>)), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L3291">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), hslToRgb(f32x4(<span class="tok-number">0.6666</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>, <span class="tok-number">1.0</span>)), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L3292">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>), hslToRgb(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>)), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3293">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), hslToRgb(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>)), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3294">    <span class="tok-kw">try</span> expect(approxEqAbs(hslToRgb(rgbToHsl(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>))), f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0005</span>));</span>
<span class="line" id="L3295">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3296">        hslToRgb(rgbToHsl(f32x4(<span class="tok-number">0.82198</span>, <span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3297">        f32x4(<span class="tok-number">0.82198</span>, <span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3298">        <span class="tok-number">0.0005</span>,</span>
<span class="line" id="L3299">    ));</span>
<span class="line" id="L3300">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3301">        rgbToHsl(hslToRgb(f32x4(<span class="tok-number">0.82198</span>, <span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3302">        f32x4(<span class="tok-number">0.82198</span>, <span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3303">        <span class="tok-number">0.0005</span>,</span>
<span class="line" id="L3304">    ));</span>
<span class="line" id="L3305">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3306">        rgbToHsl(hslToRgb(f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3307">        f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3308">        <span class="tok-number">0.0005</span>,</span>
<span class="line" id="L3309">    ));</span>
<span class="line" id="L3310">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3311">        hslToRgb(rgbToHsl(f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3312">        f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3313">        <span class="tok-number">0.0005</span>,</span>
<span class="line" id="L3314">    ));</span>
<span class="line" id="L3315">}</span>
<span class="line" id="L3316"></span>
<span class="line" id="L3317"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rgbToHsv</span>(rgb: F32x4) F32x4 {</span>
<span class="line" id="L3318">    <span class="tok-kw">const</span> r = swizzle(rgb, .x, .x, .x, .x);</span>
<span class="line" id="L3319">    <span class="tok-kw">const</span> g = swizzle(rgb, .y, .y, .y, .y);</span>
<span class="line" id="L3320">    <span class="tok-kw">const</span> b = swizzle(rgb, .z, .z, .z, .z);</span>
<span class="line" id="L3321"></span>
<span class="line" id="L3322">    <span class="tok-kw">const</span> minv = min(r, min(g, b));</span>
<span class="line" id="L3323">    <span class="tok-kw">const</span> v = max(r, max(g, b));</span>
<span class="line" id="L3324">    <span class="tok-kw">const</span> d = v - minv;</span>
<span class="line" id="L3325">    <span class="tok-kw">const</span> s = <span class="tok-kw">if</span> (all(isNearEqual(v, f32x4s(<span class="tok-number">0.0</span>), f32x4s(math.floatEps(<span class="tok-type">f32</span>))), <span class="tok-number">3</span>)) f32x4s(<span class="tok-number">0.0</span>) <span class="tok-kw">else</span> d / v;</span>
<span class="line" id="L3326"></span>
<span class="line" id="L3327">    <span class="tok-kw">if</span> (all(d &lt; f32x4s(math.floatEps(<span class="tok-type">f32</span>)), <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3328">        <span class="tok-kw">const</span> hv = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), f32x4s(<span class="tok-number">0.0</span>), v);</span>
<span class="line" id="L3329">        <span class="tok-kw">const</span> hva = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), hv, rgb);</span>
<span class="line" id="L3330">        <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>), hva, s);</span>
<span class="line" id="L3331">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3332">        <span class="tok-kw">var</span> h: F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3333">        <span class="tok-kw">if</span> (all(r == v, <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3334">            h = (g - b) / d;</span>
<span class="line" id="L3335">            <span class="tok-kw">if</span> (all(g &lt; b, <span class="tok-number">3</span>))</span>
<span class="line" id="L3336">                h += f32x4s(<span class="tok-number">6.0</span>);</span>
<span class="line" id="L3337">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (all(g == v, <span class="tok-number">3</span>)) {</span>
<span class="line" id="L3338">            h = f32x4s(<span class="tok-number">2.0</span>) + (b - r) / d;</span>
<span class="line" id="L3339">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3340">            h = f32x4s(<span class="tok-number">4.0</span>) + (r - g) / d;</span>
<span class="line" id="L3341">        }</span>
<span class="line" id="L3342"></span>
<span class="line" id="L3343">        h /= f32x4s(<span class="tok-number">6.0</span>);</span>
<span class="line" id="L3344">        <span class="tok-kw">const</span> hv = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), h, v);</span>
<span class="line" id="L3345">        <span class="tok-kw">const</span> hva = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), hv, rgb);</span>
<span class="line" id="L3346">        <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>), hva, s);</span>
<span class="line" id="L3347">    }</span>
<span class="line" id="L3348">}</span>
<span class="line" id="L3349"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.color.rgbToHsv&quot;</span> {</span>
<span class="line" id="L3350">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsv(f32x4(<span class="tok-number">0.2</span>, <span class="tok-number">0.4</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.6111</span>, <span class="tok-number">0.75</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3351">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsv(f32x4(<span class="tok-number">0.4</span>, <span class="tok-number">0.2</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.7222</span>, <span class="tok-number">0.75</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3352">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsv(f32x4(<span class="tok-number">0.4</span>, <span class="tok-number">0.8</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.2777</span>, <span class="tok-number">0.75</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3353">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsv(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.5</span>)), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3354">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsv(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.25</span>)), f32x4(<span class="tok-number">0.3333</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.25</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3355">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsv(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.6666</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3356">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsv(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3357">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToHsv(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), <span class="tok-number">0.0001</span>));</span>
<span class="line" id="L3358">}</span>
<span class="line" id="L3359"></span>
<span class="line" id="L3360"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">hsvToRgb</span>(hsv: F32x4) F32x4 {</span>
<span class="line" id="L3361">    <span class="tok-kw">const</span> h = swizzle(hsv, .x, .x, .x, .x);</span>
<span class="line" id="L3362">    <span class="tok-kw">const</span> s = swizzle(hsv, .y, .y, .y, .y);</span>
<span class="line" id="L3363">    <span class="tok-kw">const</span> v = swizzle(hsv, .z, .z, .z, .z);</span>
<span class="line" id="L3364"></span>
<span class="line" id="L3365">    <span class="tok-kw">const</span> h6 = h * f32x4s(<span class="tok-number">6.0</span>);</span>
<span class="line" id="L3366">    <span class="tok-kw">const</span> i = floor(h6);</span>
<span class="line" id="L3367">    <span class="tok-kw">const</span> f = h6 - i;</span>
<span class="line" id="L3368"></span>
<span class="line" id="L3369">    <span class="tok-kw">const</span> p = v * (f32x4s(<span class="tok-number">1.0</span>) - s);</span>
<span class="line" id="L3370">    <span class="tok-kw">const</span> q = v * (f32x4s(<span class="tok-number">1.0</span>) - f * s);</span>
<span class="line" id="L3371">    <span class="tok-kw">const</span> t = v * (f32x4s(<span class="tok-number">1.0</span>) - (f32x4s(<span class="tok-number">1.0</span>) - f) * s);</span>
<span class="line" id="L3372"></span>
<span class="line" id="L3373">    <span class="tok-kw">const</span> ii = <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intFromFloat</span>(mod(i, f32x4s(<span class="tok-number">6.0</span>))[<span class="tok-number">0</span>]));</span>
<span class="line" id="L3374">    <span class="tok-kw">const</span> rgb = <span class="tok-kw">switch</span> (ii) {</span>
<span class="line" id="L3375">        <span class="tok-number">0</span> =&gt; blk: {</span>
<span class="line" id="L3376">            <span class="tok-kw">const</span> vt = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), v, t);</span>
<span class="line" id="L3377">            <span class="tok-kw">break</span> :blk select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), vt, p);</span>
<span class="line" id="L3378">        },</span>
<span class="line" id="L3379">        <span class="tok-number">1</span> =&gt; blk: {</span>
<span class="line" id="L3380">            <span class="tok-kw">const</span> qv = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), q, v);</span>
<span class="line" id="L3381">            <span class="tok-kw">break</span> :blk select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), qv, p);</span>
<span class="line" id="L3382">        },</span>
<span class="line" id="L3383">        <span class="tok-number">2</span> =&gt; blk: {</span>
<span class="line" id="L3384">            <span class="tok-kw">const</span> pv = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), p, v);</span>
<span class="line" id="L3385">            <span class="tok-kw">break</span> :blk select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), pv, t);</span>
<span class="line" id="L3386">        },</span>
<span class="line" id="L3387">        <span class="tok-number">3</span> =&gt; blk: {</span>
<span class="line" id="L3388">            <span class="tok-kw">const</span> pq = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), p, q);</span>
<span class="line" id="L3389">            <span class="tok-kw">break</span> :blk select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), pq, v);</span>
<span class="line" id="L3390">        },</span>
<span class="line" id="L3391">        <span class="tok-number">4</span> =&gt; blk: {</span>
<span class="line" id="L3392">            <span class="tok-kw">const</span> tp = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), t, p);</span>
<span class="line" id="L3393">            <span class="tok-kw">break</span> :blk select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), tp, v);</span>
<span class="line" id="L3394">        },</span>
<span class="line" id="L3395">        <span class="tok-number">5</span> =&gt; blk: {</span>
<span class="line" id="L3396">            <span class="tok-kw">const</span> vp = select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), v, p);</span>
<span class="line" id="L3397">            <span class="tok-kw">break</span> :blk select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>), vp, q);</span>
<span class="line" id="L3398">        },</span>
<span class="line" id="L3399">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L3400">    };</span>
<span class="line" id="L3401">    <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), rgb, hsv);</span>
<span class="line" id="L3402">}</span>
<span class="line" id="L3403"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.color.hsvToRgb&quot;</span> {</span>
<span class="line" id="L3404">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0005</span>;</span>
<span class="line" id="L3405">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.2</span>, <span class="tok-number">0.4</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>), hsvToRgb(f32x4(<span class="tok-number">0.6111</span>, <span class="tok-number">0.75</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>)), epsilon));</span>
<span class="line" id="L3406">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.4</span>, <span class="tok-number">0.2</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>), hsvToRgb(f32x4(<span class="tok-number">0.7222</span>, <span class="tok-number">0.75</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>)), epsilon));</span>
<span class="line" id="L3407">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.4</span>, <span class="tok-number">0.8</span>, <span class="tok-number">0.2</span>, <span class="tok-number">1.0</span>), hsvToRgb(f32x4(<span class="tok-number">0.2777</span>, <span class="tok-number">0.75</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>)), epsilon));</span>
<span class="line" id="L3408">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.5</span>), hsvToRgb(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.5</span>)), epsilon));</span>
<span class="line" id="L3409">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.25</span>), hsvToRgb(f32x4(<span class="tok-number">0.3333</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.25</span>)), epsilon));</span>
<span class="line" id="L3410">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), hsvToRgb(f32x4(<span class="tok-number">0.6666</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>)), epsilon));</span>
<span class="line" id="L3411">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>), hsvToRgb(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>)), epsilon));</span>
<span class="line" id="L3412">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), hsvToRgb(f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>)), epsilon));</span>
<span class="line" id="L3413">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3414">        hsvToRgb(rgbToHsv(f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3415">        f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3416">        epsilon,</span>
<span class="line" id="L3417">    ));</span>
<span class="line" id="L3418">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3419">        hsvToRgb(rgbToHsv(f32x4(<span class="tok-number">0.82198</span>, <span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3420">        f32x4(<span class="tok-number">0.82198</span>, <span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3421">        epsilon,</span>
<span class="line" id="L3422">    ));</span>
<span class="line" id="L3423">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3424">        rgbToHsv(hsvToRgb(f32x4(<span class="tok-number">0.82198</span>, <span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3425">        f32x4(<span class="tok-number">0.82198</span>, <span class="tok-number">0.1839</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3426">        epsilon,</span>
<span class="line" id="L3427">    ));</span>
<span class="line" id="L3428">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3429">        rgbToHsv(hsvToRgb(f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3430">        f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3431">        epsilon,</span>
<span class="line" id="L3432">    ));</span>
<span class="line" id="L3433">}</span>
<span class="line" id="L3434"></span>
<span class="line" id="L3435"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rgbToSrgb</span>(rgb: F32x4) F32x4 {</span>
<span class="line" id="L3436">    <span class="tok-kw">const</span> static = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3437">        <span class="tok-kw">const</span> cutoff = f32x4(<span class="tok-number">0.0031308</span>, <span class="tok-number">0.0031308</span>, <span class="tok-number">0.0031308</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3438">        <span class="tok-kw">const</span> linear = f32x4(<span class="tok-number">12.92</span>, <span class="tok-number">12.92</span>, <span class="tok-number">12.92</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3439">        <span class="tok-kw">const</span> scale = f32x4(<span class="tok-number">1.055</span>, <span class="tok-number">1.055</span>, <span class="tok-number">1.055</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3440">        <span class="tok-kw">const</span> bias = f32x4(<span class="tok-number">0.055</span>, <span class="tok-number">0.055</span>, <span class="tok-number">0.055</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3441">        <span class="tok-kw">const</span> rgamma = <span class="tok-number">1.0</span> / <span class="tok-number">2.4</span>;</span>
<span class="line" id="L3442">    };</span>
<span class="line" id="L3443">    <span class="tok-kw">var</span> v = saturate(rgb);</span>
<span class="line" id="L3444">    <span class="tok-kw">const</span> v0 = v * static.linear;</span>
<span class="line" id="L3445">    <span class="tok-kw">const</span> v1 = static.scale * f32x4(</span>
<span class="line" id="L3446">        math.pow(<span class="tok-type">f32</span>, v[<span class="tok-number">0</span>], static.rgamma),</span>
<span class="line" id="L3447">        math.pow(<span class="tok-type">f32</span>, v[<span class="tok-number">1</span>], static.rgamma),</span>
<span class="line" id="L3448">        math.pow(<span class="tok-type">f32</span>, v[<span class="tok-number">2</span>], static.rgamma),</span>
<span class="line" id="L3449">        v[<span class="tok-number">3</span>],</span>
<span class="line" id="L3450">    ) - static.bias;</span>
<span class="line" id="L3451">    v = select(v &lt; static.cutoff, v0, v1);</span>
<span class="line" id="L3452">    <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), v, rgb);</span>
<span class="line" id="L3453">}</span>
<span class="line" id="L3454"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.color.rgbToSrgb&quot;</span> {</span>
<span class="line" id="L3455">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.001</span>;</span>
<span class="line" id="L3456">    <span class="tok-kw">try</span> expect(approxEqAbs(rgbToSrgb(f32x4(<span class="tok-number">0.2</span>, <span class="tok-number">0.4</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>)), f32x4(<span class="tok-number">0.484</span>, <span class="tok-number">0.665</span>, <span class="tok-number">0.906</span>, <span class="tok-number">1.0</span>), epsilon));</span>
<span class="line" id="L3457">}</span>
<span class="line" id="L3458"></span>
<span class="line" id="L3459"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">srgbToRgb</span>(srgb: F32x4) F32x4 {</span>
<span class="line" id="L3460">    <span class="tok-kw">const</span> static = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3461">        <span class="tok-kw">const</span> cutoff = f32x4(<span class="tok-number">0.04045</span>, <span class="tok-number">0.04045</span>, <span class="tok-number">0.04045</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3462">        <span class="tok-kw">const</span> rlinear = f32x4(<span class="tok-number">1.0</span> / <span class="tok-number">12.92</span>, <span class="tok-number">1.0</span> / <span class="tok-number">12.92</span>, <span class="tok-number">1.0</span> / <span class="tok-number">12.92</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3463">        <span class="tok-kw">const</span> scale = f32x4(<span class="tok-number">1.0</span> / <span class="tok-number">1.055</span>, <span class="tok-number">1.0</span> / <span class="tok-number">1.055</span>, <span class="tok-number">1.0</span> / <span class="tok-number">1.055</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3464">        <span class="tok-kw">const</span> bias = f32x4(<span class="tok-number">0.055</span>, <span class="tok-number">0.055</span>, <span class="tok-number">0.055</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3465">        <span class="tok-kw">const</span> gamma = <span class="tok-number">2.4</span>;</span>
<span class="line" id="L3466">    };</span>
<span class="line" id="L3467">    <span class="tok-kw">var</span> v = saturate(srgb);</span>
<span class="line" id="L3468">    <span class="tok-kw">const</span> v0 = v * static.rlinear;</span>
<span class="line" id="L3469">    <span class="tok-kw">var</span> v1 = static.scale * (v + static.bias);</span>
<span class="line" id="L3470">    v1 = f32x4(</span>
<span class="line" id="L3471">        math.pow(<span class="tok-type">f32</span>, v1[<span class="tok-number">0</span>], static.gamma),</span>
<span class="line" id="L3472">        math.pow(<span class="tok-type">f32</span>, v1[<span class="tok-number">1</span>], static.gamma),</span>
<span class="line" id="L3473">        math.pow(<span class="tok-type">f32</span>, v1[<span class="tok-number">2</span>], static.gamma),</span>
<span class="line" id="L3474">        v1[<span class="tok-number">3</span>],</span>
<span class="line" id="L3475">    );</span>
<span class="line" id="L3476">    v = select(v &gt; static.cutoff, v1, v0);</span>
<span class="line" id="L3477">    <span class="tok-kw">return</span> select(boolx4(<span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">true</span>, <span class="tok-null">false</span>), v, srgb);</span>
<span class="line" id="L3478">}</span>
<span class="line" id="L3479"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.color.srgbToRgb&quot;</span> {</span>
<span class="line" id="L3480">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0007</span>;</span>
<span class="line" id="L3481">    <span class="tok-kw">try</span> expect(approxEqAbs(f32x4(<span class="tok-number">0.2</span>, <span class="tok-number">0.4</span>, <span class="tok-number">0.8</span>, <span class="tok-number">1.0</span>), srgbToRgb(f32x4(<span class="tok-number">0.484</span>, <span class="tok-number">0.665</span>, <span class="tok-number">0.906</span>, <span class="tok-number">1.0</span>)), epsilon));</span>
<span class="line" id="L3482">    <span class="tok-kw">try</span> expect(approxEqAbs(</span>
<span class="line" id="L3483">        rgbToSrgb(srgbToRgb(f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>))),</span>
<span class="line" id="L3484">        f32x4(<span class="tok-number">0.1839</span>, <span class="tok-number">0.82198</span>, <span class="tok-number">0.632</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3485">        epsilon,</span>
<span class="line" id="L3486">    ));</span>
<span class="line" id="L3487">}</span>
<span class="line" id="L3488"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L3489"><span class="tok-comment">//</span>
</span>
<span class="line" id="L3490"><span class="tok-comment">// X. Misc functions</span>
</span>
<span class="line" id="L3491"><span class="tok-comment">//</span>
</span>
<span class="line" id="L3492"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L3493"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linePointDistance</span>(linept0: Vec, linept1: Vec, pt: Vec) F32x4 {</span>
<span class="line" id="L3494">    <span class="tok-kw">const</span> ptvec = pt - linept0;</span>
<span class="line" id="L3495">    <span class="tok-kw">const</span> linevec = linept1 - linept0;</span>
<span class="line" id="L3496">    <span class="tok-kw">const</span> scale = dot3(ptvec, linevec) / lengthSq3(linevec);</span>
<span class="line" id="L3497">    <span class="tok-kw">return</span> length3(ptvec - linevec * scale);</span>
<span class="line" id="L3498">}</span>
<span class="line" id="L3499"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.linePointDistance&quot;</span> {</span>
<span class="line" id="L3500">    {</span>
<span class="line" id="L3501">        <span class="tok-kw">const</span> linept0 = f32x4(-<span class="tok-number">1.0</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3502">        <span class="tok-kw">const</span> linept1 = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3503">        <span class="tok-kw">const</span> pt = f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3504">        <span class="tok-kw">var</span> v = linePointDistance(linept0, linept1, pt);</span>
<span class="line" id="L3505">        <span class="tok-kw">try</span> expect(approxEqAbs(v, splat(F32x4, <span class="tok-number">0.654</span>), <span class="tok-number">0.001</span>));</span>
<span class="line" id="L3506">    }</span>
<span class="line" id="L3507">}</span>
<span class="line" id="L3508"></span>
<span class="line" id="L3509"><span class="tok-kw">fn</span> <span class="tok-fn">sin32</span>(v: <span class="tok-type">f32</span>) <span class="tok-type">f32</span> {</span>
<span class="line" id="L3510">    <span class="tok-kw">var</span> y = v - math.tau * <span class="tok-builtin">@round</span>(v * <span class="tok-number">1.0</span> / math.tau);</span>
<span class="line" id="L3511"></span>
<span class="line" id="L3512">    <span class="tok-kw">if</span> (y &gt; <span class="tok-number">0.5</span> * math.pi) {</span>
<span class="line" id="L3513">        y = math.pi - y;</span>
<span class="line" id="L3514">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (y &lt; -math.pi * <span class="tok-number">0.5</span>) {</span>
<span class="line" id="L3515">        y = -math.pi - y;</span>
<span class="line" id="L3516">    }</span>
<span class="line" id="L3517">    <span class="tok-kw">const</span> y2 = y * y;</span>
<span class="line" id="L3518"></span>
<span class="line" id="L3519">    <span class="tok-comment">// 11-degree minimax approximation</span>
</span>
<span class="line" id="L3520">    <span class="tok-kw">var</span> sinv = mulAdd(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">2.3889859e-08</span>), y2, <span class="tok-number">2.7525562e-06</span>);</span>
<span class="line" id="L3521">    sinv = mulAdd(sinv, y2, -<span class="tok-number">0.00019840874</span>);</span>
<span class="line" id="L3522">    sinv = mulAdd(sinv, y2, <span class="tok-number">0.0083333310</span>);</span>
<span class="line" id="L3523">    sinv = mulAdd(sinv, y2, -<span class="tok-number">0.16666667</span>);</span>
<span class="line" id="L3524">    <span class="tok-kw">return</span> y * mulAdd(sinv, y2, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3525">}</span>
<span class="line" id="L3526"><span class="tok-kw">fn</span> <span class="tok-fn">cos32</span>(v: <span class="tok-type">f32</span>) <span class="tok-type">f32</span> {</span>
<span class="line" id="L3527">    <span class="tok-kw">var</span> y = v - math.tau * <span class="tok-builtin">@round</span>(v * <span class="tok-number">1.0</span> / math.tau);</span>
<span class="line" id="L3528"></span>
<span class="line" id="L3529">    <span class="tok-kw">const</span> sign = blk: {</span>
<span class="line" id="L3530">        <span class="tok-kw">if</span> (y &gt; <span class="tok-number">0.5</span> * math.pi) {</span>
<span class="line" id="L3531">            y = math.pi - y;</span>
<span class="line" id="L3532">            <span class="tok-kw">break</span> :blk <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">1.0</span>);</span>
<span class="line" id="L3533">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (y &lt; -math.pi * <span class="tok-number">0.5</span>) {</span>
<span class="line" id="L3534">            y = -math.pi - y;</span>
<span class="line" id="L3535">            <span class="tok-kw">break</span> :blk <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">1.0</span>);</span>
<span class="line" id="L3536">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3537">            <span class="tok-kw">break</span> :blk <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3538">        }</span>
<span class="line" id="L3539">    };</span>
<span class="line" id="L3540">    <span class="tok-kw">const</span> y2 = y * y;</span>
<span class="line" id="L3541"></span>
<span class="line" id="L3542">    <span class="tok-comment">// 10-degree minimax approximation</span>
</span>
<span class="line" id="L3543">    <span class="tok-kw">var</span> cosv = mulAdd(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">2.6051615e-07</span>), y2, <span class="tok-number">2.4760495e-05</span>);</span>
<span class="line" id="L3544">    cosv = mulAdd(cosv, y2, -<span class="tok-number">0.0013888378</span>);</span>
<span class="line" id="L3545">    cosv = mulAdd(cosv, y2, <span class="tok-number">0.041666638</span>);</span>
<span class="line" id="L3546">    cosv = mulAdd(cosv, y2, -<span class="tok-number">0.5</span>);</span>
<span class="line" id="L3547">    <span class="tok-kw">return</span> sign * mulAdd(cosv, y2, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3548">}</span>
<span class="line" id="L3549"><span class="tok-kw">fn</span> <span class="tok-fn">sincos32</span>(v: <span class="tok-type">f32</span>) [<span class="tok-number">2</span>]<span class="tok-type">f32</span> {</span>
<span class="line" id="L3550">    <span class="tok-kw">var</span> y = v - math.tau * <span class="tok-builtin">@round</span>(v * <span class="tok-number">1.0</span> / math.tau);</span>
<span class="line" id="L3551"></span>
<span class="line" id="L3552">    <span class="tok-kw">const</span> sign = blk: {</span>
<span class="line" id="L3553">        <span class="tok-kw">if</span> (y &gt; <span class="tok-number">0.5</span> * math.pi) {</span>
<span class="line" id="L3554">            y = math.pi - y;</span>
<span class="line" id="L3555">            <span class="tok-kw">break</span> :blk <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">1.0</span>);</span>
<span class="line" id="L3556">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (y &lt; -math.pi * <span class="tok-number">0.5</span>) {</span>
<span class="line" id="L3557">            y = -math.pi - y;</span>
<span class="line" id="L3558">            <span class="tok-kw">break</span> :blk <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">1.0</span>);</span>
<span class="line" id="L3559">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L3560">            <span class="tok-kw">break</span> :blk <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3561">        }</span>
<span class="line" id="L3562">    };</span>
<span class="line" id="L3563">    <span class="tok-kw">const</span> y2 = y * y;</span>
<span class="line" id="L3564"></span>
<span class="line" id="L3565">    <span class="tok-comment">// 11-degree minimax approximation</span>
</span>
<span class="line" id="L3566">    <span class="tok-kw">var</span> sinv = mulAdd(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">2.3889859e-08</span>), y2, <span class="tok-number">2.7525562e-06</span>);</span>
<span class="line" id="L3567">    sinv = mulAdd(sinv, y2, -<span class="tok-number">0.00019840874</span>);</span>
<span class="line" id="L3568">    sinv = mulAdd(sinv, y2, <span class="tok-number">0.0083333310</span>);</span>
<span class="line" id="L3569">    sinv = mulAdd(sinv, y2, -<span class="tok-number">0.16666667</span>);</span>
<span class="line" id="L3570">    sinv = y * mulAdd(sinv, y2, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3571"></span>
<span class="line" id="L3572">    <span class="tok-comment">// 10-degree minimax approximation</span>
</span>
<span class="line" id="L3573">    <span class="tok-kw">var</span> cosv = mulAdd(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">2.6051615e-07</span>), y2, <span class="tok-number">2.4760495e-05</span>);</span>
<span class="line" id="L3574">    cosv = mulAdd(cosv, y2, -<span class="tok-number">0.0013888378</span>);</span>
<span class="line" id="L3575">    cosv = mulAdd(cosv, y2, <span class="tok-number">0.041666638</span>);</span>
<span class="line" id="L3576">    cosv = mulAdd(cosv, y2, -<span class="tok-number">0.5</span>);</span>
<span class="line" id="L3577">    cosv = sign * mulAdd(cosv, y2, <span class="tok-number">1.0</span>);</span>
<span class="line" id="L3578"></span>
<span class="line" id="L3579">    <span class="tok-kw">return</span> .{ sinv, cosv };</span>
<span class="line" id="L3580">}</span>
<span class="line" id="L3581"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.sincos32&quot;</span> {</span>
<span class="line" id="L3582">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L3583"></span>
<span class="line" id="L3584">    <span class="tok-kw">try</span> expect(math.isNan(sincos32(math.inf(<span class="tok-type">f32</span>))[<span class="tok-number">0</span>]));</span>
<span class="line" id="L3585">    <span class="tok-kw">try</span> expect(math.isNan(sincos32(math.inf(<span class="tok-type">f32</span>))[<span class="tok-number">1</span>]));</span>
<span class="line" id="L3586">    <span class="tok-kw">try</span> expect(math.isNan(sincos32(-math.inf(<span class="tok-type">f32</span>))[<span class="tok-number">0</span>]));</span>
<span class="line" id="L3587">    <span class="tok-kw">try</span> expect(math.isNan(sincos32(-math.inf(<span class="tok-type">f32</span>))[<span class="tok-number">1</span>]));</span>
<span class="line" id="L3588">    <span class="tok-kw">try</span> expect(math.isNan(sincos32(math.nan_f32)[<span class="tok-number">0</span>]));</span>
<span class="line" id="L3589">    <span class="tok-kw">try</span> expect(math.isNan(sincos32(-math.nan_f32)[<span class="tok-number">1</span>]));</span>
<span class="line" id="L3590"></span>
<span class="line" id="L3591">    <span class="tok-kw">try</span> expect(math.isNan(sin32(math.inf(<span class="tok-type">f32</span>))));</span>
<span class="line" id="L3592">    <span class="tok-kw">try</span> expect(math.isNan(cos32(math.inf(<span class="tok-type">f32</span>))));</span>
<span class="line" id="L3593">    <span class="tok-kw">try</span> expect(math.isNan(sin32(-math.inf(<span class="tok-type">f32</span>))));</span>
<span class="line" id="L3594">    <span class="tok-kw">try</span> expect(math.isNan(cos32(-math.inf(<span class="tok-type">f32</span>))));</span>
<span class="line" id="L3595">    <span class="tok-kw">try</span> expect(math.isNan(sin32(math.nan_f32)));</span>
<span class="line" id="L3596">    <span class="tok-kw">try</span> expect(math.isNan(cos32(-math.nan_f32)));</span>
<span class="line" id="L3597"></span>
<span class="line" id="L3598">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">100.0</span>;</span>
<span class="line" id="L3599">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L3600">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">100</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L3601">        <span class="tok-kw">const</span> sc = sincos32(f);</span>
<span class="line" id="L3602">        <span class="tok-kw">const</span> s0 = sin32(f);</span>
<span class="line" id="L3603">        <span class="tok-kw">const</span> c0 = cos32(f);</span>
<span class="line" id="L3604">        <span class="tok-kw">const</span> s = <span class="tok-builtin">@sin</span>(f);</span>
<span class="line" id="L3605">        <span class="tok-kw">const</span> c = <span class="tok-builtin">@cos</span>(f);</span>
<span class="line" id="L3606">        <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, sc[<span class="tok-number">0</span>], s, epsilon));</span>
<span class="line" id="L3607">        <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, sc[<span class="tok-number">1</span>], c, epsilon));</span>
<span class="line" id="L3608">        <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, s0, s, epsilon));</span>
<span class="line" id="L3609">        <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, c0, c, epsilon));</span>
<span class="line" id="L3610">        f += <span class="tok-number">0.12345</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L3611">    }</span>
<span class="line" id="L3612">}</span>
<span class="line" id="L3613"></span>
<span class="line" id="L3614"><span class="tok-kw">fn</span> <span class="tok-fn">asin32</span>(v: <span class="tok-type">f32</span>) <span class="tok-type">f32</span> {</span>
<span class="line" id="L3615">    <span class="tok-kw">const</span> x = <span class="tok-builtin">@fabs</span>(v);</span>
<span class="line" id="L3616">    <span class="tok-kw">var</span> omx = <span class="tok-number">1.0</span> - x;</span>
<span class="line" id="L3617">    <span class="tok-kw">if</span> (omx &lt; <span class="tok-number">0.0</span>) {</span>
<span class="line" id="L3618">        omx = <span class="tok-number">0.0</span>;</span>
<span class="line" id="L3619">    }</span>
<span class="line" id="L3620">    <span class="tok-kw">const</span> root = <span class="tok-builtin">@sqrt</span>(omx);</span>
<span class="line" id="L3621"></span>
<span class="line" id="L3622">    <span class="tok-comment">// 7-degree minimax approximation</span>
</span>
<span class="line" id="L3623">    <span class="tok-kw">var</span> result = mulAdd(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">0.0012624911</span>), x, <span class="tok-number">0.0066700901</span>);</span>
<span class="line" id="L3624">    result = mulAdd(result, x, -<span class="tok-number">0.0170881256</span>);</span>
<span class="line" id="L3625">    result = mulAdd(result, x, <span class="tok-number">0.0308918810</span>);</span>
<span class="line" id="L3626">    result = mulAdd(result, x, -<span class="tok-number">0.0501743046</span>);</span>
<span class="line" id="L3627">    result = mulAdd(result, x, <span class="tok-number">0.0889789874</span>);</span>
<span class="line" id="L3628">    result = mulAdd(result, x, -<span class="tok-number">0.2145988016</span>);</span>
<span class="line" id="L3629">    result = root * mulAdd(result, x, <span class="tok-number">1.5707963050</span>);</span>
<span class="line" id="L3630"></span>
<span class="line" id="L3631">    <span class="tok-kw">return</span> <span class="tok-kw">if</span> (v &gt;= <span class="tok-number">0.0</span>) <span class="tok-number">0.5</span> * math.pi - result <span class="tok-kw">else</span> result - <span class="tok-number">0.5</span> * math.pi;</span>
<span class="line" id="L3632">}</span>
<span class="line" id="L3633"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.asin32&quot;</span> {</span>
<span class="line" id="L3634">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L3635"></span>
<span class="line" id="L3636">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, asin(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">1.1</span>)), -<span class="tok-number">0.5</span> * math.pi, epsilon));</span>
<span class="line" id="L3637">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, asin(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">1.1</span>)), <span class="tok-number">0.5</span> * math.pi, epsilon));</span>
<span class="line" id="L3638">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, asin(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">1000.1</span>)), -<span class="tok-number">0.5</span> * math.pi, epsilon));</span>
<span class="line" id="L3639">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, asin(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">100000.1</span>)), <span class="tok-number">0.5</span> * math.pi, epsilon));</span>
<span class="line" id="L3640">    <span class="tok-kw">try</span> expect(math.isNan(asin(math.inf(<span class="tok-type">f32</span>))));</span>
<span class="line" id="L3641">    <span class="tok-kw">try</span> expect(math.isNan(asin(-math.inf(<span class="tok-type">f32</span>))));</span>
<span class="line" id="L3642">    <span class="tok-kw">try</span> expect(math.isNan(asin(math.nan_f32)));</span>
<span class="line" id="L3643">    <span class="tok-kw">try</span> expect(math.isNan(asin(-math.nan_f32)));</span>
<span class="line" id="L3644"></span>
<span class="line" id="L3645">    <span class="tok-kw">try</span> expect(approxEqAbs(asin(splat(F32x8, -<span class="tok-number">100.0</span>)), splat(F32x8, -<span class="tok-number">0.5</span> * math.pi), epsilon));</span>
<span class="line" id="L3646">    <span class="tok-kw">try</span> expect(approxEqAbs(asin(splat(F32x16, <span class="tok-number">100.0</span>)), splat(F32x16, <span class="tok-number">0.5</span> * math.pi), epsilon));</span>
<span class="line" id="L3647">    <span class="tok-kw">try</span> expect(all(isNan(asin(splat(F32x4, math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L3648">    <span class="tok-kw">try</span> expect(all(isNan(asin(splat(F32x4, -math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L3649">    <span class="tok-kw">try</span> expect(all(isNan(asin(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L3650">    <span class="tok-kw">try</span> expect(all(isNan(asin(splat(F32x4, math.qnan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L3651"></span>
<span class="line" id="L3652">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">1.0</span>;</span>
<span class="line" id="L3653">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L3654">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">8</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L3655">        <span class="tok-kw">const</span> r0 = asin32(f);</span>
<span class="line" id="L3656">        <span class="tok-kw">const</span> r1 = math.asin(f);</span>
<span class="line" id="L3657">        <span class="tok-kw">const</span> r4 = asin(splat(F32x4, f));</span>
<span class="line" id="L3658">        <span class="tok-kw">const</span> r8 = asin(splat(F32x8, f));</span>
<span class="line" id="L3659">        <span class="tok-kw">const</span> r16 = asin(splat(F32x16, f));</span>
<span class="line" id="L3660">        <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, r0, r1, epsilon));</span>
<span class="line" id="L3661">        <span class="tok-kw">try</span> expect(approxEqAbs(r4, splat(F32x4, r1), epsilon));</span>
<span class="line" id="L3662">        <span class="tok-kw">try</span> expect(approxEqAbs(r8, splat(F32x8, r1), epsilon));</span>
<span class="line" id="L3663">        <span class="tok-kw">try</span> expect(approxEqAbs(r16, splat(F32x16, r1), epsilon));</span>
<span class="line" id="L3664">        f += <span class="tok-number">0.09</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L3665">    }</span>
<span class="line" id="L3666">}</span>
<span class="line" id="L3667"></span>
<span class="line" id="L3668"><span class="tok-kw">fn</span> <span class="tok-fn">acos32</span>(v: <span class="tok-type">f32</span>) <span class="tok-type">f32</span> {</span>
<span class="line" id="L3669">    <span class="tok-kw">const</span> x = <span class="tok-builtin">@fabs</span>(v);</span>
<span class="line" id="L3670">    <span class="tok-kw">var</span> omx = <span class="tok-number">1.0</span> - x;</span>
<span class="line" id="L3671">    <span class="tok-kw">if</span> (omx &lt; <span class="tok-number">0.0</span>) {</span>
<span class="line" id="L3672">        omx = <span class="tok-number">0.0</span>;</span>
<span class="line" id="L3673">    }</span>
<span class="line" id="L3674">    <span class="tok-kw">const</span> root = <span class="tok-builtin">@sqrt</span>(omx);</span>
<span class="line" id="L3675"></span>
<span class="line" id="L3676">    <span class="tok-comment">// 7-degree minimax approximation</span>
</span>
<span class="line" id="L3677">    <span class="tok-kw">var</span> result = mulAdd(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">0.0012624911</span>), x, <span class="tok-number">0.0066700901</span>);</span>
<span class="line" id="L3678">    result = mulAdd(result, x, -<span class="tok-number">0.0170881256</span>);</span>
<span class="line" id="L3679">    result = mulAdd(result, x, <span class="tok-number">0.0308918810</span>);</span>
<span class="line" id="L3680">    result = mulAdd(result, x, -<span class="tok-number">0.0501743046</span>);</span>
<span class="line" id="L3681">    result = mulAdd(result, x, <span class="tok-number">0.0889789874</span>);</span>
<span class="line" id="L3682">    result = mulAdd(result, x, -<span class="tok-number">0.2145988016</span>);</span>
<span class="line" id="L3683">    result = root * mulAdd(result, x, <span class="tok-number">1.5707963050</span>);</span>
<span class="line" id="L3684"></span>
<span class="line" id="L3685">    <span class="tok-kw">return</span> <span class="tok-kw">if</span> (v &gt;= <span class="tok-number">0.0</span>) result <span class="tok-kw">else</span> math.pi - result;</span>
<span class="line" id="L3686">}</span>
<span class="line" id="L3687"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.acos32&quot;</span> {</span>
<span class="line" id="L3688">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.1</span>;</span>
<span class="line" id="L3689"></span>
<span class="line" id="L3690">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, acos(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">1.1</span>)), math.pi, epsilon));</span>
<span class="line" id="L3691">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, acos(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, -<span class="tok-number">10000.1</span>)), math.pi, epsilon));</span>
<span class="line" id="L3692">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, acos(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">1.1</span>)), <span class="tok-number">0.0</span>, epsilon));</span>
<span class="line" id="L3693">    <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, acos(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">1000.1</span>)), <span class="tok-number">0.0</span>, epsilon));</span>
<span class="line" id="L3694">    <span class="tok-kw">try</span> expect(math.isNan(acos(math.inf(<span class="tok-type">f32</span>))));</span>
<span class="line" id="L3695">    <span class="tok-kw">try</span> expect(math.isNan(acos(-math.inf(<span class="tok-type">f32</span>))));</span>
<span class="line" id="L3696">    <span class="tok-kw">try</span> expect(math.isNan(acos(math.nan_f32)));</span>
<span class="line" id="L3697">    <span class="tok-kw">try</span> expect(math.isNan(acos(-math.nan_f32)));</span>
<span class="line" id="L3698"></span>
<span class="line" id="L3699">    <span class="tok-kw">try</span> expect(approxEqAbs(acos(splat(F32x8, -<span class="tok-number">100.0</span>)), splat(F32x8, math.pi), epsilon));</span>
<span class="line" id="L3700">    <span class="tok-kw">try</span> expect(approxEqAbs(acos(splat(F32x16, <span class="tok-number">100.0</span>)), splat(F32x16, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L3701">    <span class="tok-kw">try</span> expect(all(isNan(acos(splat(F32x4, math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L3702">    <span class="tok-kw">try</span> expect(all(isNan(acos(splat(F32x4, -math.inf(<span class="tok-type">f32</span>)))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L3703">    <span class="tok-kw">try</span> expect(all(isNan(acos(splat(F32x4, math.nan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L3704">    <span class="tok-kw">try</span> expect(all(isNan(acos(splat(F32x4, math.qnan_f32))), <span class="tok-number">0</span>) == <span class="tok-null">true</span>);</span>
<span class="line" id="L3705"></span>
<span class="line" id="L3706">    <span class="tok-kw">var</span> f: <span class="tok-type">f32</span> = -<span class="tok-number">1.0</span>;</span>
<span class="line" id="L3707">    <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L3708">    <span class="tok-kw">while</span> (i &lt; <span class="tok-number">8</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L3709">        <span class="tok-kw">const</span> r0 = acos32(f);</span>
<span class="line" id="L3710">        <span class="tok-kw">const</span> r1 = math.acos(f);</span>
<span class="line" id="L3711">        <span class="tok-kw">const</span> r4 = acos(splat(F32x4, f));</span>
<span class="line" id="L3712">        <span class="tok-kw">const</span> r8 = acos(splat(F32x8, f));</span>
<span class="line" id="L3713">        <span class="tok-kw">const</span> r16 = acos(splat(F32x16, f));</span>
<span class="line" id="L3714">        <span class="tok-kw">try</span> expect(math.approxEqAbs(<span class="tok-type">f32</span>, r0, r1, epsilon));</span>
<span class="line" id="L3715">        <span class="tok-kw">try</span> expect(approxEqAbs(r4, splat(F32x4, r1), epsilon));</span>
<span class="line" id="L3716">        <span class="tok-kw">try</span> expect(approxEqAbs(r8, splat(F32x8, r1), epsilon));</span>
<span class="line" id="L3717">        <span class="tok-kw">try</span> expect(approxEqAbs(r16, splat(F32x16, r1), epsilon));</span>
<span class="line" id="L3718">        f += <span class="tok-number">0.09</span> * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i));</span>
<span class="line" id="L3719">    }</span>
<span class="line" id="L3720">}</span>
<span class="line" id="L3721"></span>
<span class="line" id="L3722"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">modAngle32</span>(in_angle: <span class="tok-type">f32</span>) <span class="tok-type">f32</span> {</span>
<span class="line" id="L3723">    <span class="tok-kw">const</span> angle = in_angle + math.pi;</span>
<span class="line" id="L3724">    <span class="tok-kw">var</span> temp: <span class="tok-type">f32</span> = <span class="tok-builtin">@fabs</span>(angle);</span>
<span class="line" id="L3725">    temp = temp - (<span class="tok-number">2.0</span> * math.pi * <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intFromFloat</span>(temp / math.pi)))));</span>
<span class="line" id="L3726">    temp = temp - math.pi;</span>
<span class="line" id="L3727">    <span class="tok-kw">if</span> (angle &lt; <span class="tok-number">0.0</span>) {</span>
<span class="line" id="L3728">        temp = -temp;</span>
<span class="line" id="L3729">    }</span>
<span class="line" id="L3730">    <span class="tok-kw">return</span> temp;</span>
<span class="line" id="L3731">}</span>
<span class="line" id="L3732"></span>
<span class="line" id="L3733"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">cmulSoa</span>(re0: <span class="tok-kw">anytype</span>, im0: <span class="tok-kw">anytype</span>, re1: <span class="tok-kw">anytype</span>, im1: <span class="tok-kw">anytype</span>) [<span class="tok-number">2</span>]<span class="tok-builtin">@TypeOf</span>(re0, im0, re1, im1) {</span>
<span class="line" id="L3734">    <span class="tok-kw">const</span> re0_re1 = re0 * re1;</span>
<span class="line" id="L3735">    <span class="tok-kw">const</span> re0_im1 = re0 * im1;</span>
<span class="line" id="L3736">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L3737">        mulAdd(-im0, im1, re0_re1), <span class="tok-comment">// re</span>
</span>
<span class="line" id="L3738">        mulAdd(re1, im0, re0_im1), <span class="tok-comment">// im</span>
</span>
<span class="line" id="L3739">    };</span>
<span class="line" id="L3740">}</span>
<span class="line" id="L3741"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L3742"><span class="tok-comment">//</span>
</span>
<span class="line" id="L3743"><span class="tok-comment">// FFT (implementation based on xdsp.h from DirectXMath)</span>
</span>
<span class="line" id="L3744"><span class="tok-comment">//</span>
</span>
<span class="line" id="L3745"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L3746"><span class="tok-kw">fn</span> <span class="tok-fn">fftButterflyDit4_1</span>(re0: *F32x4, im0: *F32x4) <span class="tok-type">void</span> {</span>
<span class="line" id="L3747">    <span class="tok-kw">const</span> re0l = swizzle(re0.*, .x, .x, .y, .y);</span>
<span class="line" id="L3748">    <span class="tok-kw">const</span> re0h = swizzle(re0.*, .z, .z, .w, .w);</span>
<span class="line" id="L3749"></span>
<span class="line" id="L3750">    <span class="tok-kw">const</span> im0l = swizzle(im0.*, .x, .x, .y, .y);</span>
<span class="line" id="L3751">    <span class="tok-kw">const</span> im0h = swizzle(im0.*, .z, .z, .w, .w);</span>
<span class="line" id="L3752"></span>
<span class="line" id="L3753">    <span class="tok-kw">const</span> re_temp = mulAdd(re0h, f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>), re0l);</span>
<span class="line" id="L3754">    <span class="tok-kw">const</span> im_temp = mulAdd(im0h, f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>), im0l);</span>
<span class="line" id="L3755"></span>
<span class="line" id="L3756">    <span class="tok-kw">const</span> re_shuf0 = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, re_temp, im_temp, [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L3757">    <span class="tok-kw">const</span> re_shuf = swizzle(re_shuf0, .x, .w, .x, .w);</span>
<span class="line" id="L3758">    <span class="tok-kw">const</span> im_shuf = swizzle(re_shuf0, .z, .y, .z, .y);</span>
<span class="line" id="L3759"></span>
<span class="line" id="L3760">    <span class="tok-kw">const</span> re_templ = swizzle(re_temp, .x, .y, .x, .y);</span>
<span class="line" id="L3761">    <span class="tok-kw">const</span> im_templ = swizzle(im_temp, .x, .y, .x, .y);</span>
<span class="line" id="L3762"></span>
<span class="line" id="L3763">    re0.* = mulAdd(re_shuf, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>), re_templ);</span>
<span class="line" id="L3764">    im0.* = mulAdd(im_shuf, f32x4(<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>), im_templ);</span>
<span class="line" id="L3765">}</span>
<span class="line" id="L3766"></span>
<span class="line" id="L3767"><span class="tok-kw">fn</span> <span class="tok-fn">fftButterflyDit4_4</span>(</span>
<span class="line" id="L3768">    re0: *F32x4,</span>
<span class="line" id="L3769">    re1: *F32x4,</span>
<span class="line" id="L3770">    re2: *F32x4,</span>
<span class="line" id="L3771">    re3: *F32x4,</span>
<span class="line" id="L3772">    im0: *F32x4,</span>
<span class="line" id="L3773">    im1: *F32x4,</span>
<span class="line" id="L3774">    im2: *F32x4,</span>
<span class="line" id="L3775">    im3: *F32x4,</span>
<span class="line" id="L3776">    unity_table_re: []<span class="tok-kw">const</span> F32x4,</span>
<span class="line" id="L3777">    unity_table_im: []<span class="tok-kw">const</span> F32x4,</span>
<span class="line" id="L3778">    stride: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3779">    last: <span class="tok-type">bool</span>,</span>
<span class="line" id="L3780">) <span class="tok-type">void</span> {</span>
<span class="line" id="L3781">    <span class="tok-kw">const</span> re_temp0 = re0.* + re2.*;</span>
<span class="line" id="L3782">    <span class="tok-kw">const</span> im_temp0 = im0.* + im2.*;</span>
<span class="line" id="L3783"></span>
<span class="line" id="L3784">    <span class="tok-kw">const</span> re_temp2 = re1.* + re3.*;</span>
<span class="line" id="L3785">    <span class="tok-kw">const</span> im_temp2 = im1.* + im3.*;</span>
<span class="line" id="L3786"></span>
<span class="line" id="L3787">    <span class="tok-kw">const</span> re_temp1 = re0.* - re2.*;</span>
<span class="line" id="L3788">    <span class="tok-kw">const</span> im_temp1 = im0.* - im2.*;</span>
<span class="line" id="L3789"></span>
<span class="line" id="L3790">    <span class="tok-kw">const</span> re_temp3 = re1.* - re3.*;</span>
<span class="line" id="L3791">    <span class="tok-kw">const</span> im_temp3 = im1.* - im3.*;</span>
<span class="line" id="L3792"></span>
<span class="line" id="L3793">    <span class="tok-kw">var</span> re_temp4 = re_temp0 + re_temp2;</span>
<span class="line" id="L3794">    <span class="tok-kw">var</span> im_temp4 = im_temp0 + im_temp2;</span>
<span class="line" id="L3795"></span>
<span class="line" id="L3796">    <span class="tok-kw">var</span> re_temp5 = re_temp1 + im_temp3;</span>
<span class="line" id="L3797">    <span class="tok-kw">var</span> im_temp5 = im_temp1 - re_temp3;</span>
<span class="line" id="L3798"></span>
<span class="line" id="L3799">    <span class="tok-kw">var</span> re_temp6 = re_temp0 - re_temp2;</span>
<span class="line" id="L3800">    <span class="tok-kw">var</span> im_temp6 = im_temp0 - im_temp2;</span>
<span class="line" id="L3801"></span>
<span class="line" id="L3802">    <span class="tok-kw">var</span> re_temp7 = re_temp1 - im_temp3;</span>
<span class="line" id="L3803">    <span class="tok-kw">var</span> im_temp7 = im_temp1 + re_temp3;</span>
<span class="line" id="L3804"></span>
<span class="line" id="L3805">    {</span>
<span class="line" id="L3806">        <span class="tok-kw">const</span> re_im = cmulSoa(re_temp5, im_temp5, unity_table_re[stride], unity_table_im[stride]);</span>
<span class="line" id="L3807">        re_temp5 = re_im[<span class="tok-number">0</span>];</span>
<span class="line" id="L3808">        im_temp5 = re_im[<span class="tok-number">1</span>];</span>
<span class="line" id="L3809">    }</span>
<span class="line" id="L3810">    {</span>
<span class="line" id="L3811">        <span class="tok-kw">const</span> re_im = cmulSoa(re_temp6, im_temp6, unity_table_re[stride * <span class="tok-number">2</span>], unity_table_im[stride * <span class="tok-number">2</span>]);</span>
<span class="line" id="L3812">        re_temp6 = re_im[<span class="tok-number">0</span>];</span>
<span class="line" id="L3813">        im_temp6 = re_im[<span class="tok-number">1</span>];</span>
<span class="line" id="L3814">    }</span>
<span class="line" id="L3815">    {</span>
<span class="line" id="L3816">        <span class="tok-kw">const</span> re_im = cmulSoa(re_temp7, im_temp7, unity_table_re[stride * <span class="tok-number">3</span>], unity_table_im[stride * <span class="tok-number">3</span>]);</span>
<span class="line" id="L3817">        re_temp7 = re_im[<span class="tok-number">0</span>];</span>
<span class="line" id="L3818">        im_temp7 = re_im[<span class="tok-number">1</span>];</span>
<span class="line" id="L3819">    }</span>
<span class="line" id="L3820"></span>
<span class="line" id="L3821">    <span class="tok-kw">if</span> (last) {</span>
<span class="line" id="L3822">        fftButterflyDit4_1(&amp;re_temp4, &amp;im_temp4);</span>
<span class="line" id="L3823">        fftButterflyDit4_1(&amp;re_temp5, &amp;im_temp5);</span>
<span class="line" id="L3824">        fftButterflyDit4_1(&amp;re_temp6, &amp;im_temp6);</span>
<span class="line" id="L3825">        fftButterflyDit4_1(&amp;re_temp7, &amp;im_temp7);</span>
<span class="line" id="L3826">    }</span>
<span class="line" id="L3827"></span>
<span class="line" id="L3828">    re0.* = re_temp4;</span>
<span class="line" id="L3829">    im0.* = im_temp4;</span>
<span class="line" id="L3830"></span>
<span class="line" id="L3831">    re1.* = re_temp5;</span>
<span class="line" id="L3832">    im1.* = im_temp5;</span>
<span class="line" id="L3833"></span>
<span class="line" id="L3834">    re2.* = re_temp6;</span>
<span class="line" id="L3835">    im2.* = im_temp6;</span>
<span class="line" id="L3836"></span>
<span class="line" id="L3837">    re3.* = re_temp7;</span>
<span class="line" id="L3838">    im3.* = im_temp7;</span>
<span class="line" id="L3839">}</span>
<span class="line" id="L3840"></span>
<span class="line" id="L3841"><span class="tok-kw">fn</span> <span class="tok-fn">fft4</span>(re: []F32x4, im: []F32x4, count: <span class="tok-type">u32</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L3842">    assert(std.math.isPowerOfTwo(count));</span>
<span class="line" id="L3843">    assert(re.len &gt;= count);</span>
<span class="line" id="L3844">    assert(im.len &gt;= count);</span>
<span class="line" id="L3845"></span>
<span class="line" id="L3846">    <span class="tok-kw">var</span> index: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L3847">    <span class="tok-kw">while</span> (index &lt; count) : (index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L3848">        fftButterflyDit4_1(&amp;re[index], &amp;im[index]);</span>
<span class="line" id="L3849">    }</span>
<span class="line" id="L3850">}</span>
<span class="line" id="L3851"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.fft4&quot;</span> {</span>
<span class="line" id="L3852">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L3853">    <span class="tok-kw">var</span> re = [_]F32x4{f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>)};</span>
<span class="line" id="L3854">    <span class="tok-kw">var</span> im = [_]F32x4{f32x4s(<span class="tok-number">0.0</span>)};</span>
<span class="line" id="L3855">    fft4(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], <span class="tok-number">1</span>);</span>
<span class="line" id="L3856"></span>
<span class="line" id="L3857">    <span class="tok-kw">var</span> re_uns: [<span class="tok-number">1</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3858">    <span class="tok-kw">var</span> im_uns: [<span class="tok-number">1</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3859">    fftUnswizzle(re[<span class="tok-number">0</span>..], re_uns[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L3860">    fftUnswizzle(im[<span class="tok-number">0</span>..], im_uns[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L3861"></span>
<span class="line" id="L3862">    <span class="tok-kw">try</span> expect(approxEqAbs(re_uns[<span class="tok-number">0</span>], f32x4(<span class="tok-number">10.0</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">2.0</span>, -<span class="tok-number">2.0</span>), epsilon));</span>
<span class="line" id="L3863">    <span class="tok-kw">try</span> expect(approxEqAbs(im_uns[<span class="tok-number">0</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">2.0</span>), epsilon));</span>
<span class="line" id="L3864">}</span>
<span class="line" id="L3865"></span>
<span class="line" id="L3866"><span class="tok-kw">fn</span> <span class="tok-fn">fft8</span>(re: []F32x4, im: []F32x4, count: <span class="tok-type">u32</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L3867">    assert(std.math.isPowerOfTwo(count));</span>
<span class="line" id="L3868">    assert(re.len &gt;= <span class="tok-number">2</span> * count);</span>
<span class="line" id="L3869">    assert(im.len &gt;= <span class="tok-number">2</span> * count);</span>
<span class="line" id="L3870"></span>
<span class="line" id="L3871">    <span class="tok-kw">var</span> index: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L3872">    <span class="tok-kw">while</span> (index &lt; count) : (index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L3873">        <span class="tok-kw">var</span> pre = re[index * <span class="tok-number">2</span> ..];</span>
<span class="line" id="L3874">        <span class="tok-kw">var</span> pim = im[index * <span class="tok-number">2</span> ..];</span>
<span class="line" id="L3875"></span>
<span class="line" id="L3876">        <span class="tok-kw">var</span> odds_re = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, pre[<span class="tok-number">0</span>], pre[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L3877">        <span class="tok-kw">var</span> evens_re = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, pre[<span class="tok-number">0</span>], pre[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L3878">        <span class="tok-kw">var</span> odds_im = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, pim[<span class="tok-number">0</span>], pim[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">3</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">3</span>) });</span>
<span class="line" id="L3879">        <span class="tok-kw">var</span> evens_im = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">f32</span>, pim[<span class="tok-number">0</span>], pim[<span class="tok-number">1</span>], [<span class="tok-number">4</span>]<span class="tok-type">i32</span>{ <span class="tok-number">0</span>, <span class="tok-number">2</span>, ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), ~<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">2</span>) });</span>
<span class="line" id="L3880">        fftButterflyDit4_1(&amp;odds_re, &amp;odds_im);</span>
<span class="line" id="L3881">        fftButterflyDit4_1(&amp;evens_re, &amp;evens_im);</span>
<span class="line" id="L3882"></span>
<span class="line" id="L3883">        {</span>
<span class="line" id="L3884">            <span class="tok-kw">const</span> re_im = cmulSoa(</span>
<span class="line" id="L3885">                odds_re,</span>
<span class="line" id="L3886">                odds_im,</span>
<span class="line" id="L3887">                f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.70710677</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">0.70710677</span>),</span>
<span class="line" id="L3888">                f32x4(<span class="tok-number">0.0</span>, -<span class="tok-number">0.70710677</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">0.70710677</span>),</span>
<span class="line" id="L3889">            );</span>
<span class="line" id="L3890">            pre[<span class="tok-number">0</span>] = evens_re + re_im[<span class="tok-number">0</span>];</span>
<span class="line" id="L3891">            pim[<span class="tok-number">0</span>] = evens_im + re_im[<span class="tok-number">1</span>];</span>
<span class="line" id="L3892">        }</span>
<span class="line" id="L3893">        {</span>
<span class="line" id="L3894">            <span class="tok-kw">const</span> re_im = cmulSoa(</span>
<span class="line" id="L3895">                odds_re,</span>
<span class="line" id="L3896">                odds_im,</span>
<span class="line" id="L3897">                f32x4(-<span class="tok-number">1.0</span>, -<span class="tok-number">0.70710677</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.70710677</span>),</span>
<span class="line" id="L3898">                f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">0.70710677</span>, <span class="tok-number">1.0</span>, <span class="tok-number">0.70710677</span>),</span>
<span class="line" id="L3899">            );</span>
<span class="line" id="L3900">            pre[<span class="tok-number">1</span>] = evens_re + re_im[<span class="tok-number">0</span>];</span>
<span class="line" id="L3901">            pim[<span class="tok-number">1</span>] = evens_im + re_im[<span class="tok-number">1</span>];</span>
<span class="line" id="L3902">        }</span>
<span class="line" id="L3903">    }</span>
<span class="line" id="L3904">}</span>
<span class="line" id="L3905"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.fft8&quot;</span> {</span>
<span class="line" id="L3906">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L3907">    <span class="tok-kw">var</span> re = [_]F32x4{ f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>), f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>) };</span>
<span class="line" id="L3908">    <span class="tok-kw">var</span> im = [_]F32x4{ f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>) };</span>
<span class="line" id="L3909">    fft8(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], <span class="tok-number">1</span>);</span>
<span class="line" id="L3910"></span>
<span class="line" id="L3911">    <span class="tok-kw">var</span> re_uns: [<span class="tok-number">2</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3912">    <span class="tok-kw">var</span> im_uns: [<span class="tok-number">2</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3913">    fftUnswizzle(re[<span class="tok-number">0</span>..], re_uns[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L3914">    fftUnswizzle(im[<span class="tok-number">0</span>..], im_uns[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L3915"></span>
<span class="line" id="L3916">    <span class="tok-kw">try</span> expect(approxEqAbs(re_uns[<span class="tok-number">0</span>], f32x4(<span class="tok-number">36.0</span>, -<span class="tok-number">4.0</span>, -<span class="tok-number">4.0</span>, -<span class="tok-number">4.0</span>), epsilon));</span>
<span class="line" id="L3917">    <span class="tok-kw">try</span> expect(approxEqAbs(re_uns[<span class="tok-number">1</span>], f32x4(-<span class="tok-number">4.0</span>, -<span class="tok-number">4.0</span>, -<span class="tok-number">4.0</span>, -<span class="tok-number">4.0</span>), epsilon));</span>
<span class="line" id="L3918">    <span class="tok-kw">try</span> expect(approxEqAbs(im_uns[<span class="tok-number">0</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">9.656854</span>, <span class="tok-number">4.0</span>, <span class="tok-number">1.656854</span>), epsilon));</span>
<span class="line" id="L3919">    <span class="tok-kw">try</span> expect(approxEqAbs(im_uns[<span class="tok-number">1</span>], f32x4(<span class="tok-number">0.0</span>, -<span class="tok-number">1.656854</span>, -<span class="tok-number">4.0</span>, -<span class="tok-number">9.656854</span>), epsilon));</span>
<span class="line" id="L3920">}</span>
<span class="line" id="L3921"></span>
<span class="line" id="L3922"><span class="tok-kw">fn</span> <span class="tok-fn">fft16</span>(re: []F32x4, im: []F32x4, count: <span class="tok-type">u32</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L3923">    assert(std.math.isPowerOfTwo(count));</span>
<span class="line" id="L3924">    assert(re.len &gt;= <span class="tok-number">4</span> * count);</span>
<span class="line" id="L3925">    assert(im.len &gt;= <span class="tok-number">4</span> * count);</span>
<span class="line" id="L3926"></span>
<span class="line" id="L3927">    <span class="tok-kw">const</span> static = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L3928">        <span class="tok-kw">const</span> unity_table_re = [<span class="tok-number">4</span>]F32x4{</span>
<span class="line" id="L3929">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">1.0</span>),</span>
<span class="line" id="L3930">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.92387950</span>, <span class="tok-number">0.70710677</span>, <span class="tok-number">0.38268343</span>),</span>
<span class="line" id="L3931">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.70710677</span>, -<span class="tok-number">4.3711388e-008</span>, -<span class="tok-number">0.70710677</span>),</span>
<span class="line" id="L3932">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">0.38268343</span>, -<span class="tok-number">0.70710677</span>, -<span class="tok-number">0.92387950</span>),</span>
<span class="line" id="L3933">        };</span>
<span class="line" id="L3934">        <span class="tok-kw">const</span> unity_table_im = [<span class="tok-number">4</span>]F32x4{</span>
<span class="line" id="L3935">            f32x4(-<span class="tok-number">0.0</span>, -<span class="tok-number">0.0</span>, -<span class="tok-number">0.0</span>, -<span class="tok-number">0.0</span>),</span>
<span class="line" id="L3936">            f32x4(-<span class="tok-number">0.0</span>, -<span class="tok-number">0.38268343</span>, -<span class="tok-number">0.70710677</span>, -<span class="tok-number">0.92387950</span>),</span>
<span class="line" id="L3937">            f32x4(-<span class="tok-number">0.0</span>, -<span class="tok-number">0.70710677</span>, -<span class="tok-number">1.0</span>, -<span class="tok-number">0.70710677</span>),</span>
<span class="line" id="L3938">            f32x4(-<span class="tok-number">0.0</span>, -<span class="tok-number">0.92387950</span>, -<span class="tok-number">0.70710677</span>, <span class="tok-number">0.38268343</span>),</span>
<span class="line" id="L3939">        };</span>
<span class="line" id="L3940">    };</span>
<span class="line" id="L3941"></span>
<span class="line" id="L3942">    <span class="tok-kw">var</span> index: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L3943">    <span class="tok-kw">while</span> (index &lt; count) : (index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L3944">        fftButterflyDit4_4(</span>
<span class="line" id="L3945">            &amp;re[index * <span class="tok-number">4</span>],</span>
<span class="line" id="L3946">            &amp;re[index * <span class="tok-number">4</span> + <span class="tok-number">1</span>],</span>
<span class="line" id="L3947">            &amp;re[index * <span class="tok-number">4</span> + <span class="tok-number">2</span>],</span>
<span class="line" id="L3948">            &amp;re[index * <span class="tok-number">4</span> + <span class="tok-number">3</span>],</span>
<span class="line" id="L3949">            &amp;im[index * <span class="tok-number">4</span>],</span>
<span class="line" id="L3950">            &amp;im[index * <span class="tok-number">4</span> + <span class="tok-number">1</span>],</span>
<span class="line" id="L3951">            &amp;im[index * <span class="tok-number">4</span> + <span class="tok-number">2</span>],</span>
<span class="line" id="L3952">            &amp;im[index * <span class="tok-number">4</span> + <span class="tok-number">3</span>],</span>
<span class="line" id="L3953">            static.unity_table_re[<span class="tok-number">0</span>..],</span>
<span class="line" id="L3954">            static.unity_table_im[<span class="tok-number">0</span>..],</span>
<span class="line" id="L3955">            <span class="tok-number">1</span>,</span>
<span class="line" id="L3956">            <span class="tok-null">true</span>,</span>
<span class="line" id="L3957">        );</span>
<span class="line" id="L3958">    }</span>
<span class="line" id="L3959">}</span>
<span class="line" id="L3960"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.fft16&quot;</span> {</span>
<span class="line" id="L3961">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L3962">    <span class="tok-kw">var</span> re = [_]F32x4{</span>
<span class="line" id="L3963">        f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),</span>
<span class="line" id="L3964">        f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L3965">        f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),</span>
<span class="line" id="L3966">        f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L3967">    };</span>
<span class="line" id="L3968">    <span class="tok-kw">var</span> im = [_]F32x4{ f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>) };</span>
<span class="line" id="L3969">    fft16(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], <span class="tok-number">1</span>);</span>
<span class="line" id="L3970"></span>
<span class="line" id="L3971">    <span class="tok-kw">var</span> re_uns: [<span class="tok-number">4</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3972">    <span class="tok-kw">var</span> im_uns: [<span class="tok-number">4</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L3973">    fftUnswizzle(re[<span class="tok-number">0</span>..], re_uns[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L3974">    fftUnswizzle(im[<span class="tok-number">0</span>..], im_uns[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L3975"></span>
<span class="line" id="L3976">    <span class="tok-kw">try</span> expect(approxEqAbs(re_uns[<span class="tok-number">0</span>], f32x4(<span class="tok-number">136.0</span>, -<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>), epsilon));</span>
<span class="line" id="L3977">    <span class="tok-kw">try</span> expect(approxEqAbs(re_uns[<span class="tok-number">1</span>], f32x4(-<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>), epsilon));</span>
<span class="line" id="L3978">    <span class="tok-kw">try</span> expect(approxEqAbs(re_uns[<span class="tok-number">2</span>], f32x4(-<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>), epsilon));</span>
<span class="line" id="L3979">    <span class="tok-kw">try</span> expect(approxEqAbs(re_uns[<span class="tok-number">3</span>], f32x4(-<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>, -<span class="tok-number">8.0</span>), epsilon));</span>
<span class="line" id="L3980">    <span class="tok-kw">try</span> expect(approxEqAbs(im_uns[<span class="tok-number">0</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">40.218716</span>, <span class="tok-number">19.313708</span>, <span class="tok-number">11.972846</span>), epsilon));</span>
<span class="line" id="L3981">    <span class="tok-kw">try</span> expect(approxEqAbs(im_uns[<span class="tok-number">1</span>], f32x4(<span class="tok-number">8.0</span>, <span class="tok-number">5.345429</span>, <span class="tok-number">3.313708</span>, <span class="tok-number">1.591299</span>), epsilon));</span>
<span class="line" id="L3982">    <span class="tok-kw">try</span> expect(approxEqAbs(im_uns[<span class="tok-number">2</span>], f32x4(<span class="tok-number">0.0</span>, -<span class="tok-number">1.591299</span>, -<span class="tok-number">3.313708</span>, -<span class="tok-number">5.345429</span>), epsilon));</span>
<span class="line" id="L3983">    <span class="tok-kw">try</span> expect(approxEqAbs(im_uns[<span class="tok-number">3</span>], f32x4(-<span class="tok-number">8.0</span>, -<span class="tok-number">11.972846</span>, -<span class="tok-number">19.313708</span>, -<span class="tok-number">40.218716</span>), epsilon));</span>
<span class="line" id="L3984">}</span>
<span class="line" id="L3985"></span>
<span class="line" id="L3986"><span class="tok-kw">fn</span> <span class="tok-fn">fftN</span>(re: []F32x4, im: []F32x4, unity_table: []<span class="tok-kw">const</span> F32x4, length: <span class="tok-type">u32</span>, count: <span class="tok-type">u32</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L3987">    assert(length &gt; <span class="tok-number">16</span>);</span>
<span class="line" id="L3988">    assert(std.math.isPowerOfTwo(length));</span>
<span class="line" id="L3989">    assert(std.math.isPowerOfTwo(count));</span>
<span class="line" id="L3990">    assert(re.len &gt;= length * count / <span class="tok-number">4</span>);</span>
<span class="line" id="L3991">    assert(re.len == im.len);</span>
<span class="line" id="L3992"></span>
<span class="line" id="L3993">    <span class="tok-kw">const</span> total = count * length;</span>
<span class="line" id="L3994">    <span class="tok-kw">const</span> total_vectors = total / <span class="tok-number">4</span>;</span>
<span class="line" id="L3995">    <span class="tok-kw">const</span> stage_vectors = length / <span class="tok-number">4</span>;</span>
<span class="line" id="L3996">    <span class="tok-kw">const</span> stage_vectors_mask = stage_vectors - <span class="tok-number">1</span>;</span>
<span class="line" id="L3997">    <span class="tok-kw">const</span> stride = length / <span class="tok-number">16</span>;</span>
<span class="line" id="L3998">    <span class="tok-kw">const</span> stride_mask = stride - <span class="tok-number">1</span>;</span>
<span class="line" id="L3999">    <span class="tok-kw">const</span> stride_inv_mask = ~stride_mask;</span>
<span class="line" id="L4000"></span>
<span class="line" id="L4001">    <span class="tok-kw">var</span> unity_table_re = unity_table;</span>
<span class="line" id="L4002">    <span class="tok-kw">var</span> unity_table_im = unity_table[length / <span class="tok-number">4</span> ..];</span>
<span class="line" id="L4003"></span>
<span class="line" id="L4004">    <span class="tok-kw">var</span> index: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L4005">    <span class="tok-kw">while</span> (index &lt; total_vectors / <span class="tok-number">4</span>) : (index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4006">        <span class="tok-kw">const</span> n = (index &amp; stride_inv_mask) * <span class="tok-number">4</span> + (index &amp; stride_mask);</span>
<span class="line" id="L4007">        fftButterflyDit4_4(</span>
<span class="line" id="L4008">            &amp;re[n],</span>
<span class="line" id="L4009">            &amp;re[n + stride],</span>
<span class="line" id="L4010">            &amp;re[n + stride * <span class="tok-number">2</span>],</span>
<span class="line" id="L4011">            &amp;re[n + stride * <span class="tok-number">3</span>],</span>
<span class="line" id="L4012">            &amp;im[n],</span>
<span class="line" id="L4013">            &amp;im[n + stride],</span>
<span class="line" id="L4014">            &amp;im[n + stride * <span class="tok-number">2</span>],</span>
<span class="line" id="L4015">            &amp;im[n + stride * <span class="tok-number">3</span>],</span>
<span class="line" id="L4016">            unity_table_re[(n &amp; stage_vectors_mask)..],</span>
<span class="line" id="L4017">            unity_table_im[(n &amp; stage_vectors_mask)..],</span>
<span class="line" id="L4018">            stride,</span>
<span class="line" id="L4019">            <span class="tok-null">false</span>,</span>
<span class="line" id="L4020">        );</span>
<span class="line" id="L4021">    }</span>
<span class="line" id="L4022"></span>
<span class="line" id="L4023">    <span class="tok-kw">if</span> (length &gt; <span class="tok-number">16</span> * <span class="tok-number">4</span>) {</span>
<span class="line" id="L4024">        fftN(re, im, unity_table[(length / <span class="tok-number">2</span>)..], length / <span class="tok-number">4</span>, count * <span class="tok-number">4</span>);</span>
<span class="line" id="L4025">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">16</span> * <span class="tok-number">4</span>) {</span>
<span class="line" id="L4026">        fft16(re, im, count * <span class="tok-number">4</span>);</span>
<span class="line" id="L4027">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">8</span> * <span class="tok-number">4</span>) {</span>
<span class="line" id="L4028">        fft8(re, im, count * <span class="tok-number">4</span>);</span>
<span class="line" id="L4029">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">4</span> * <span class="tok-number">4</span>) {</span>
<span class="line" id="L4030">        fft4(re, im, count * <span class="tok-number">4</span>);</span>
<span class="line" id="L4031">    }</span>
<span class="line" id="L4032">}</span>
<span class="line" id="L4033"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.fftN&quot;</span> {</span>
<span class="line" id="L4034">    <span class="tok-kw">var</span> unity_table: [<span class="tok-number">128</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4035">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L4036"></span>
<span class="line" id="L4037">    <span class="tok-comment">// 32 samples</span>
</span>
<span class="line" id="L4038">    {</span>
<span class="line" id="L4039">        <span class="tok-kw">var</span> re = [_]F32x4{</span>
<span class="line" id="L4040">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4041">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4042">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4043">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4044">        };</span>
<span class="line" id="L4045">        <span class="tok-kw">var</span> im = [_]F32x4{</span>
<span class="line" id="L4046">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4047">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4048">        };</span>
<span class="line" id="L4049"></span>
<span class="line" id="L4050">        fftInitUnityTable(unity_table[<span class="tok-number">0</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L4051">        fft(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], unity_table[<span class="tok-number">0</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L4052"></span>
<span class="line" id="L4053">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">0</span>], f32x4(<span class="tok-number">528.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4054">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">1</span>], f32x4(-<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4055">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">2</span>], f32x4(-<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4056">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">3</span>], f32x4(-<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4057">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">4</span>], f32x4(-<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4058">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">5</span>], f32x4(-<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4059">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">6</span>], f32x4(-<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4060">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">7</span>], f32x4(-<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>, -<span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4061">        <span class="tok-kw">try</span> expect(approxEqAbs(im[<span class="tok-number">0</span>], f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">162.450726</span>, <span class="tok-number">80.437432</span>, <span class="tok-number">52.744931</span>), epsilon));</span>
<span class="line" id="L4062">        <span class="tok-kw">try</span> expect(approxEqAbs(im[<span class="tok-number">1</span>], f32x4(<span class="tok-number">38.627417</span>, <span class="tok-number">29.933895</span>, <span class="tok-number">23.945692</span>, <span class="tok-number">19.496056</span>), epsilon));</span>
<span class="line" id="L4063">        <span class="tok-kw">try</span> expect(approxEqAbs(im[<span class="tok-number">2</span>], f32x4(<span class="tok-number">16.0</span>, <span class="tok-number">13.130861</span>, <span class="tok-number">10.690858</span>, <span class="tok-number">8.552178</span>), epsilon));</span>
<span class="line" id="L4064">        <span class="tok-kw">try</span> expect(approxEqAbs(im[<span class="tok-number">3</span>], f32x4(<span class="tok-number">6.627417</span>, <span class="tok-number">4.853547</span>, <span class="tok-number">3.182598</span>, <span class="tok-number">1.575862</span>), epsilon));</span>
<span class="line" id="L4065">        <span class="tok-kw">try</span> expect(approxEqAbs(im[<span class="tok-number">4</span>], f32x4(<span class="tok-number">0.0</span>, -<span class="tok-number">1.575862</span>, -<span class="tok-number">3.182598</span>, -<span class="tok-number">4.853547</span>), epsilon));</span>
<span class="line" id="L4066">        <span class="tok-kw">try</span> expect(approxEqAbs(im[<span class="tok-number">5</span>], f32x4(-<span class="tok-number">6.627417</span>, -<span class="tok-number">8.552178</span>, -<span class="tok-number">10.690858</span>, -<span class="tok-number">13.130861</span>), epsilon));</span>
<span class="line" id="L4067">        <span class="tok-kw">try</span> expect(approxEqAbs(im[<span class="tok-number">6</span>], f32x4(-<span class="tok-number">16.0</span>, -<span class="tok-number">19.496056</span>, -<span class="tok-number">23.945692</span>, -<span class="tok-number">29.933895</span>), epsilon));</span>
<span class="line" id="L4068">        <span class="tok-kw">try</span> expect(approxEqAbs(im[<span class="tok-number">7</span>], f32x4(-<span class="tok-number">38.627417</span>, -<span class="tok-number">52.744931</span>, -<span class="tok-number">80.437432</span>, -<span class="tok-number">162.450726</span>), epsilon));</span>
<span class="line" id="L4069">    }</span>
<span class="line" id="L4070"></span>
<span class="line" id="L4071">    <span class="tok-comment">// 64 samples</span>
</span>
<span class="line" id="L4072">    {</span>
<span class="line" id="L4073">        <span class="tok-kw">var</span> re = [_]F32x4{</span>
<span class="line" id="L4074">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4075">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4076">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4077">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4078">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4079">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4080">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4081">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4082">        };</span>
<span class="line" id="L4083">        <span class="tok-kw">var</span> im = [_]F32x4{</span>
<span class="line" id="L4084">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4085">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4086">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4087">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4088">        };</span>
<span class="line" id="L4089"></span>
<span class="line" id="L4090">        fftInitUnityTable(unity_table[<span class="tok-number">0</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L4091">        fft(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], unity_table[<span class="tok-number">0</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L4092"></span>
<span class="line" id="L4093">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">0</span>], f32x4(<span class="tok-number">1056.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">32.0</span>, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L4094">        <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">1</span>;</span>
<span class="line" id="L4095">        <span class="tok-kw">while</span> (i &lt; <span class="tok-number">16</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4096">            <span class="tok-kw">try</span> expect(approxEqAbs(re[i], f32x4(-<span class="tok-number">32.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">32.0</span>, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L4097">        }</span>
<span class="line" id="L4098"></span>
<span class="line" id="L4099">        <span class="tok-kw">const</span> expected = [_]<span class="tok-type">f32</span>{</span>
<span class="line" id="L4100">            <span class="tok-number">0.0</span>,        <span class="tok-number">0.0</span>,      <span class="tok-number">324.901452</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">160.874864</span>,  <span class="tok-number">0.0</span>,      <span class="tok-number">105.489863</span>,  <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4101">            <span class="tok-number">77.254834</span>,  <span class="tok-number">0.0</span>,      <span class="tok-number">59.867789</span>,   <span class="tok-number">0.0</span>,      <span class="tok-number">47.891384</span>,   <span class="tok-number">0.0</span>,      <span class="tok-number">38.992113</span>,   <span class="tok-number">0.0</span>,</span>
<span class="line" id="L4102">            <span class="tok-number">32.000000</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">26.261721</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">21.381716</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">17.104356</span>,   <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4103">            <span class="tok-number">13.254834</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">9.707094</span>,    <span class="tok-number">0.000000</span>, <span class="tok-number">6.365196</span>,    <span class="tok-number">0.000000</span>, <span class="tok-number">3.151725</span>,    <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4104">            <span class="tok-number">0.000000</span>,   <span class="tok-number">0.000000</span>, -<span class="tok-number">3.151725</span>,   <span class="tok-number">0.000000</span>, -<span class="tok-number">6.365196</span>,   <span class="tok-number">0.000000</span>, -<span class="tok-number">9.707094</span>,   <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4105">            -<span class="tok-number">13.254834</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">17.104356</span>,  <span class="tok-number">0.000000</span>, -<span class="tok-number">21.381716</span>,  <span class="tok-number">0.000000</span>, -<span class="tok-number">26.261721</span>,  <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4106">            -<span class="tok-number">32.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">38.992113</span>,  <span class="tok-number">0.000000</span>, -<span class="tok-number">47.891384</span>,  <span class="tok-number">0.000000</span>, -<span class="tok-number">59.867789</span>,  <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4107">            -<span class="tok-number">77.254834</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">105.489863</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">160.874864</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">324.901452</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4108">        };</span>
<span class="line" id="L4109">        <span class="tok-kw">for</span> (expected, <span class="tok-number">0</span>..) |e, ie| {</span>
<span class="line" id="L4110">            <span class="tok-kw">try</span> expect(std.math.approxEqAbs(<span class="tok-type">f32</span>, e, im[(ie / <span class="tok-number">4</span>)][ie % <span class="tok-number">4</span>], epsilon));</span>
<span class="line" id="L4111">        }</span>
<span class="line" id="L4112">    }</span>
<span class="line" id="L4113"></span>
<span class="line" id="L4114">    <span class="tok-comment">// 128 samples</span>
</span>
<span class="line" id="L4115">    {</span>
<span class="line" id="L4116">        <span class="tok-kw">var</span> re = [_]F32x4{</span>
<span class="line" id="L4117">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4118">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4119">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4120">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4121">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4122">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4123">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4124">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4125">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4126">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4127">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4128">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4129">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4130">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4131">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4132">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4133">        };</span>
<span class="line" id="L4134">        <span class="tok-kw">var</span> im = [_]F32x4{</span>
<span class="line" id="L4135">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4136">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4137">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4138">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4139">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4140">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4141">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4142">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4143">        };</span>
<span class="line" id="L4144"></span>
<span class="line" id="L4145">        fftInitUnityTable(unity_table[<span class="tok-number">0</span>..<span class="tok-number">128</span>]);</span>
<span class="line" id="L4146">        fft(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], unity_table[<span class="tok-number">0</span>..<span class="tok-number">128</span>]);</span>
<span class="line" id="L4147"></span>
<span class="line" id="L4148">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">0</span>], f32x4(<span class="tok-number">2112.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L4149">        <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">1</span>;</span>
<span class="line" id="L4150">        <span class="tok-kw">while</span> (i &lt; <span class="tok-number">32</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4151">            <span class="tok-kw">try</span> expect(approxEqAbs(re[i], f32x4(-<span class="tok-number">64.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L4152">        }</span>
<span class="line" id="L4153"></span>
<span class="line" id="L4154">        <span class="tok-kw">const</span> expected = [_]<span class="tok-type">f32</span>{</span>
<span class="line" id="L4155">            <span class="tok-number">0.000000</span>,    <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">649.802905</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4156">            <span class="tok-number">321.749727</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">210.979725</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4157">            <span class="tok-number">154.509668</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">119.735578</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4158">            <span class="tok-number">95.782769</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">77.984226</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4159">            <span class="tok-number">64.000000</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">52.523443</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4160">            <span class="tok-number">42.763433</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">34.208713</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4161">            <span class="tok-number">26.509668</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">19.414188</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4162">            <span class="tok-number">12.730392</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">6.303450</span>,    <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4163">            <span class="tok-number">0.000000</span>,    <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">6.303450</span>,   <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4164">            -<span class="tok-number">12.730392</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">19.414188</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4165">            -<span class="tok-number">26.509668</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">34.208713</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4166">            -<span class="tok-number">42.763433</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">52.523443</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4167">            -<span class="tok-number">64.000000</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">77.984226</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4168">            -<span class="tok-number">95.782769</span>,  <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">119.735578</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4169">            -<span class="tok-number">154.509668</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">210.979725</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4170">            -<span class="tok-number">321.749727</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, -<span class="tok-number">649.802905</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>, <span class="tok-number">0.000000</span>,</span>
<span class="line" id="L4171">        };</span>
<span class="line" id="L4172">        <span class="tok-kw">for</span> (expected, <span class="tok-number">0</span>..) |e, ie| {</span>
<span class="line" id="L4173">            <span class="tok-kw">try</span> expect(std.math.approxEqAbs(<span class="tok-type">f32</span>, e, im[(ie / <span class="tok-number">4</span>)][ie % <span class="tok-number">4</span>], epsilon));</span>
<span class="line" id="L4174">        }</span>
<span class="line" id="L4175">    }</span>
<span class="line" id="L4176">}</span>
<span class="line" id="L4177"></span>
<span class="line" id="L4178"><span class="tok-kw">fn</span> <span class="tok-fn">fftUnswizzle</span>(input: []<span class="tok-kw">const</span> F32x4, output: []F32x4) <span class="tok-type">void</span> {</span>
<span class="line" id="L4179">    assert(std.math.isPowerOfTwo(input.len));</span>
<span class="line" id="L4180">    assert(input.len == output.len);</span>
<span class="line" id="L4181">    assert(input.ptr != output.ptr);</span>
<span class="line" id="L4182"></span>
<span class="line" id="L4183">    <span class="tok-kw">const</span> log2_length = std.math.log2_int(<span class="tok-type">usize</span>, input.len * <span class="tok-number">4</span>);</span>
<span class="line" id="L4184">    assert(log2_length &gt;= <span class="tok-number">2</span>);</span>
<span class="line" id="L4185"></span>
<span class="line" id="L4186">    <span class="tok-kw">const</span> length = input.len;</span>
<span class="line" id="L4187"></span>
<span class="line" id="L4188">    <span class="tok-kw">const</span> f32_output = <span class="tok-builtin">@as</span>([*]<span class="tok-type">f32</span>, <span class="tok-builtin">@ptrCast</span>(output.ptr))[<span class="tok-number">0</span> .. output.len * <span class="tok-number">4</span>];</span>
<span class="line" id="L4189"></span>
<span class="line" id="L4190">    <span class="tok-kw">const</span> static = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L4191">        <span class="tok-kw">const</span> swizzle_table = [<span class="tok-number">256</span>]<span class="tok-type">u8</span>{</span>
<span class="line" id="L4192">            <span class="tok-number">0x00</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0x80</span>, <span class="tok-number">0xC0</span>, <span class="tok-number">0x10</span>, <span class="tok-number">0x50</span>, <span class="tok-number">0x90</span>, <span class="tok-number">0xD0</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0xA0</span>, <span class="tok-number">0xE0</span>, <span class="tok-number">0x30</span>, <span class="tok-number">0x70</span>, <span class="tok-number">0xB0</span>, <span class="tok-number">0xF0</span>,</span>
<span class="line" id="L4193">            <span class="tok-number">0x04</span>, <span class="tok-number">0x44</span>, <span class="tok-number">0x84</span>, <span class="tok-number">0xC4</span>, <span class="tok-number">0x14</span>, <span class="tok-number">0x54</span>, <span class="tok-number">0x94</span>, <span class="tok-number">0xD4</span>, <span class="tok-number">0x24</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0xA4</span>, <span class="tok-number">0xE4</span>, <span class="tok-number">0x34</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0xB4</span>, <span class="tok-number">0xF4</span>,</span>
<span class="line" id="L4194">            <span class="tok-number">0x08</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0xC8</span>, <span class="tok-number">0x18</span>, <span class="tok-number">0x58</span>, <span class="tok-number">0x98</span>, <span class="tok-number">0xD8</span>, <span class="tok-number">0x28</span>, <span class="tok-number">0x68</span>, <span class="tok-number">0xA8</span>, <span class="tok-number">0xE8</span>, <span class="tok-number">0x38</span>, <span class="tok-number">0x78</span>, <span class="tok-number">0xB8</span>, <span class="tok-number">0xF8</span>,</span>
<span class="line" id="L4195">            <span class="tok-number">0x0C</span>, <span class="tok-number">0x4C</span>, <span class="tok-number">0x8C</span>, <span class="tok-number">0xCC</span>, <span class="tok-number">0x1C</span>, <span class="tok-number">0x5C</span>, <span class="tok-number">0x9C</span>, <span class="tok-number">0xDC</span>, <span class="tok-number">0x2C</span>, <span class="tok-number">0x6C</span>, <span class="tok-number">0xAC</span>, <span class="tok-number">0xEC</span>, <span class="tok-number">0x3C</span>, <span class="tok-number">0x7C</span>, <span class="tok-number">0xBC</span>, <span class="tok-number">0xFC</span>,</span>
<span class="line" id="L4196">            <span class="tok-number">0x01</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0x81</span>, <span class="tok-number">0xC1</span>, <span class="tok-number">0x11</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x91</span>, <span class="tok-number">0xD1</span>, <span class="tok-number">0x21</span>, <span class="tok-number">0x61</span>, <span class="tok-number">0xA1</span>, <span class="tok-number">0xE1</span>, <span class="tok-number">0x31</span>, <span class="tok-number">0x71</span>, <span class="tok-number">0xB1</span>, <span class="tok-number">0xF1</span>,</span>
<span class="line" id="L4197">            <span class="tok-number">0x05</span>, <span class="tok-number">0x45</span>, <span class="tok-number">0x85</span>, <span class="tok-number">0xC5</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x55</span>, <span class="tok-number">0x95</span>, <span class="tok-number">0xD5</span>, <span class="tok-number">0x25</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0xA5</span>, <span class="tok-number">0xE5</span>, <span class="tok-number">0x35</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0xB5</span>, <span class="tok-number">0xF5</span>,</span>
<span class="line" id="L4198">            <span class="tok-number">0x09</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x89</span>, <span class="tok-number">0xC9</span>, <span class="tok-number">0x19</span>, <span class="tok-number">0x59</span>, <span class="tok-number">0x99</span>, <span class="tok-number">0xD9</span>, <span class="tok-number">0x29</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0xA9</span>, <span class="tok-number">0xE9</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0x79</span>, <span class="tok-number">0xB9</span>, <span class="tok-number">0xF9</span>,</span>
<span class="line" id="L4199">            <span class="tok-number">0x0D</span>, <span class="tok-number">0x4D</span>, <span class="tok-number">0x8D</span>, <span class="tok-number">0xCD</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x5D</span>, <span class="tok-number">0x9D</span>, <span class="tok-number">0xDD</span>, <span class="tok-number">0x2D</span>, <span class="tok-number">0x6D</span>, <span class="tok-number">0xAD</span>, <span class="tok-number">0xED</span>, <span class="tok-number">0x3D</span>, <span class="tok-number">0x7D</span>, <span class="tok-number">0xBD</span>, <span class="tok-number">0xFD</span>,</span>
<span class="line" id="L4200">            <span class="tok-number">0x02</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0xC2</span>, <span class="tok-number">0x12</span>, <span class="tok-number">0x52</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0xD2</span>, <span class="tok-number">0x22</span>, <span class="tok-number">0x62</span>, <span class="tok-number">0xA2</span>, <span class="tok-number">0xE2</span>, <span class="tok-number">0x32</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0xB2</span>, <span class="tok-number">0xF2</span>,</span>
<span class="line" id="L4201">            <span class="tok-number">0x06</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xC6</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x56</span>, <span class="tok-number">0x96</span>, <span class="tok-number">0xD6</span>, <span class="tok-number">0x26</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0xA6</span>, <span class="tok-number">0xE6</span>, <span class="tok-number">0x36</span>, <span class="tok-number">0x76</span>, <span class="tok-number">0xB6</span>, <span class="tok-number">0xF6</span>,</span>
<span class="line" id="L4202">            <span class="tok-number">0x0A</span>, <span class="tok-number">0x4A</span>, <span class="tok-number">0x8A</span>, <span class="tok-number">0xCA</span>, <span class="tok-number">0x1A</span>, <span class="tok-number">0x5A</span>, <span class="tok-number">0x9A</span>, <span class="tok-number">0xDA</span>, <span class="tok-number">0x2A</span>, <span class="tok-number">0x6A</span>, <span class="tok-number">0xAA</span>, <span class="tok-number">0xEA</span>, <span class="tok-number">0x3A</span>, <span class="tok-number">0x7A</span>, <span class="tok-number">0xBA</span>, <span class="tok-number">0xFA</span>,</span>
<span class="line" id="L4203">            <span class="tok-number">0x0E</span>, <span class="tok-number">0x4E</span>, <span class="tok-number">0x8E</span>, <span class="tok-number">0xCE</span>, <span class="tok-number">0x1E</span>, <span class="tok-number">0x5E</span>, <span class="tok-number">0x9E</span>, <span class="tok-number">0xDE</span>, <span class="tok-number">0x2E</span>, <span class="tok-number">0x6E</span>, <span class="tok-number">0xAE</span>, <span class="tok-number">0xEE</span>, <span class="tok-number">0x3E</span>, <span class="tok-number">0x7E</span>, <span class="tok-number">0xBE</span>, <span class="tok-number">0xFE</span>,</span>
<span class="line" id="L4204">            <span class="tok-number">0x03</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x83</span>, <span class="tok-number">0xC3</span>, <span class="tok-number">0x13</span>, <span class="tok-number">0x53</span>, <span class="tok-number">0x93</span>, <span class="tok-number">0xD3</span>, <span class="tok-number">0x23</span>, <span class="tok-number">0x63</span>, <span class="tok-number">0xA3</span>, <span class="tok-number">0xE3</span>, <span class="tok-number">0x33</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0xB3</span>, <span class="tok-number">0xF3</span>,</span>
<span class="line" id="L4205">            <span class="tok-number">0x07</span>, <span class="tok-number">0x47</span>, <span class="tok-number">0x87</span>, <span class="tok-number">0xC7</span>, <span class="tok-number">0x17</span>, <span class="tok-number">0x57</span>, <span class="tok-number">0x97</span>, <span class="tok-number">0xD7</span>, <span class="tok-number">0x27</span>, <span class="tok-number">0x67</span>, <span class="tok-number">0xA7</span>, <span class="tok-number">0xE7</span>, <span class="tok-number">0x37</span>, <span class="tok-number">0x77</span>, <span class="tok-number">0xB7</span>, <span class="tok-number">0xF7</span>,</span>
<span class="line" id="L4206">            <span class="tok-number">0x0B</span>, <span class="tok-number">0x4B</span>, <span class="tok-number">0x8B</span>, <span class="tok-number">0xCB</span>, <span class="tok-number">0x1B</span>, <span class="tok-number">0x5B</span>, <span class="tok-number">0x9B</span>, <span class="tok-number">0xDB</span>, <span class="tok-number">0x2B</span>, <span class="tok-number">0x6B</span>, <span class="tok-number">0xAB</span>, <span class="tok-number">0xEB</span>, <span class="tok-number">0x3B</span>, <span class="tok-number">0x7B</span>, <span class="tok-number">0xBB</span>, <span class="tok-number">0xFB</span>,</span>
<span class="line" id="L4207">            <span class="tok-number">0x0F</span>, <span class="tok-number">0x4F</span>, <span class="tok-number">0x8F</span>, <span class="tok-number">0xCF</span>, <span class="tok-number">0x1F</span>, <span class="tok-number">0x5F</span>, <span class="tok-number">0x9F</span>, <span class="tok-number">0xDF</span>, <span class="tok-number">0x2F</span>, <span class="tok-number">0x6F</span>, <span class="tok-number">0xAF</span>, <span class="tok-number">0xEF</span>, <span class="tok-number">0x3F</span>, <span class="tok-number">0x7F</span>, <span class="tok-number">0xBF</span>, <span class="tok-number">0xFF</span>,</span>
<span class="line" id="L4208">        };</span>
<span class="line" id="L4209">    };</span>
<span class="line" id="L4210"></span>
<span class="line" id="L4211">    <span class="tok-kw">if</span> ((log2_length &amp; <span class="tok-number">1</span>) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L4212">        <span class="tok-kw">const</span> rev32 = <span class="tok-builtin">@as</span>(<span class="tok-type">u6</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-number">32</span> - log2_length));</span>
<span class="line" id="L4213">        <span class="tok-kw">var</span> index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L4214">        <span class="tok-kw">while</span> (index &lt; length) : (index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4215">            <span class="tok-kw">const</span> n = index * <span class="tok-number">4</span>;</span>
<span class="line" id="L4216">            <span class="tok-kw">const</span> addr =</span>
<span class="line" id="L4217">                (<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(static.swizzle_table[n &amp; <span class="tok-number">0xff</span>])) &lt;&lt; <span class="tok-number">24</span>) |</span>
<span class="line" id="L4218">                (<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(static.swizzle_table[(n &gt;&gt; <span class="tok-number">8</span>) &amp; <span class="tok-number">0xff</span>])) &lt;&lt; <span class="tok-number">16</span>) |</span>
<span class="line" id="L4219">                (<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(static.swizzle_table[(n &gt;&gt; <span class="tok-number">16</span>) &amp; <span class="tok-number">0xff</span>])) &lt;&lt; <span class="tok-number">8</span>) |</span>
<span class="line" id="L4220">                <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(static.swizzle_table[(n &gt;&gt; <span class="tok-number">24</span>) &amp; <span class="tok-number">0xff</span>]));</span>
<span class="line" id="L4221">            f32_output[addr &gt;&gt; rev32] = input[index][<span class="tok-number">0</span>];</span>
<span class="line" id="L4222">            f32_output[(<span class="tok-number">0x40000000</span> | addr) &gt;&gt; rev32] = input[index][<span class="tok-number">1</span>];</span>
<span class="line" id="L4223">            f32_output[(<span class="tok-number">0x80000000</span> | addr) &gt;&gt; rev32] = input[index][<span class="tok-number">2</span>];</span>
<span class="line" id="L4224">            f32_output[(<span class="tok-number">0xC0000000</span> | addr) &gt;&gt; rev32] = input[index][<span class="tok-number">3</span>];</span>
<span class="line" id="L4225">        }</span>
<span class="line" id="L4226">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L4227">        <span class="tok-kw">const</span> rev7 = <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">1</span>) &lt;&lt; <span class="tok-builtin">@as</span>(<span class="tok-type">u6</span>, <span class="tok-builtin">@intCast</span>(log2_length - <span class="tok-number">3</span>));</span>
<span class="line" id="L4228">        <span class="tok-kw">const</span> rev32 = <span class="tok-builtin">@as</span>(<span class="tok-type">u6</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-number">32</span> - (log2_length - <span class="tok-number">3</span>)));</span>
<span class="line" id="L4229">        <span class="tok-kw">var</span> index: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L4230">        <span class="tok-kw">while</span> (index &lt; length) : (index += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4231">            <span class="tok-kw">const</span> n = index / <span class="tok-number">2</span>;</span>
<span class="line" id="L4232">            <span class="tok-kw">var</span> addr =</span>
<span class="line" id="L4233">                (((<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(static.swizzle_table[n &amp; <span class="tok-number">0xff</span>])) &lt;&lt; <span class="tok-number">24</span>) |</span>
<span class="line" id="L4234">                (<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(static.swizzle_table[(n &gt;&gt; <span class="tok-number">8</span>) &amp; <span class="tok-number">0xff</span>])) &lt;&lt; <span class="tok-number">16</span>) |</span>
<span class="line" id="L4235">                (<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(static.swizzle_table[(n &gt;&gt; <span class="tok-number">16</span>) &amp; <span class="tok-number">0xff</span>])) &lt;&lt; <span class="tok-number">8</span>) |</span>
<span class="line" id="L4236">                (<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(static.swizzle_table[(n &gt;&gt; <span class="tok-number">24</span>) &amp; <span class="tok-number">0xff</span>])))) &gt;&gt; rev32) |</span>
<span class="line" id="L4237">                ((index &amp; <span class="tok-number">1</span>) * rev7 * <span class="tok-number">4</span>);</span>
<span class="line" id="L4238">            f32_output[addr] = input[index][<span class="tok-number">0</span>];</span>
<span class="line" id="L4239">            addr += rev7;</span>
<span class="line" id="L4240">            f32_output[addr] = input[index][<span class="tok-number">1</span>];</span>
<span class="line" id="L4241">            addr += rev7;</span>
<span class="line" id="L4242">            f32_output[addr] = input[index][<span class="tok-number">2</span>];</span>
<span class="line" id="L4243">            addr += rev7;</span>
<span class="line" id="L4244">            f32_output[addr] = input[index][<span class="tok-number">3</span>];</span>
<span class="line" id="L4245">        }</span>
<span class="line" id="L4246">    }</span>
<span class="line" id="L4247">}</span>
<span class="line" id="L4248"></span>
<span class="line" id="L4249"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fftInitUnityTable</span>(out_unity_table: []F32x4) <span class="tok-type">void</span> {</span>
<span class="line" id="L4250">    assert(std.math.isPowerOfTwo(out_unity_table.len));</span>
<span class="line" id="L4251">    assert(out_unity_table.len &gt;= <span class="tok-number">32</span> <span class="tok-kw">and</span> out_unity_table.len &lt;= <span class="tok-number">512</span>);</span>
<span class="line" id="L4252"></span>
<span class="line" id="L4253">    <span class="tok-kw">var</span> unity_table = out_unity_table;</span>
<span class="line" id="L4254"></span>
<span class="line" id="L4255">    <span class="tok-kw">const</span> v0123 = f32x4(<span class="tok-number">0.0</span>, <span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>);</span>
<span class="line" id="L4256">    <span class="tok-kw">var</span> length = out_unity_table.len / <span class="tok-number">4</span>;</span>
<span class="line" id="L4257">    <span class="tok-kw">var</span> vlstep = f32x4s(<span class="tok-number">0.5</span> * math.pi / <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(length)));</span>
<span class="line" id="L4258"></span>
<span class="line" id="L4259">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L4260">        length /= <span class="tok-number">4</span>;</span>
<span class="line" id="L4261">        <span class="tok-kw">var</span> vjp = v0123;</span>
<span class="line" id="L4262"></span>
<span class="line" id="L4263">        <span class="tok-kw">var</span> j: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L4264">        <span class="tok-kw">while</span> (j &lt; length) : (j += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4265">            unity_table[j] = f32x4s(<span class="tok-number">1.0</span>);</span>
<span class="line" id="L4266">            unity_table[j + length * <span class="tok-number">4</span>] = f32x4s(<span class="tok-number">0.0</span>);</span>
<span class="line" id="L4267"></span>
<span class="line" id="L4268">            <span class="tok-kw">var</span> vls = vjp * vlstep;</span>
<span class="line" id="L4269">            <span class="tok-kw">var</span> sin_cos = sincos(vls);</span>
<span class="line" id="L4270">            unity_table[j + length] = sin_cos[<span class="tok-number">1</span>];</span>
<span class="line" id="L4271">            unity_table[j + length * <span class="tok-number">5</span>] = sin_cos[<span class="tok-number">0</span>] * f32x4s(-<span class="tok-number">1.0</span>);</span>
<span class="line" id="L4272"></span>
<span class="line" id="L4273">            <span class="tok-kw">var</span> vijp = vjp + vjp;</span>
<span class="line" id="L4274">            vls = vijp * vlstep;</span>
<span class="line" id="L4275">            sin_cos = sincos(vls);</span>
<span class="line" id="L4276">            unity_table[j + length * <span class="tok-number">2</span>] = sin_cos[<span class="tok-number">1</span>];</span>
<span class="line" id="L4277">            unity_table[j + length * <span class="tok-number">6</span>] = sin_cos[<span class="tok-number">0</span>] * f32x4s(-<span class="tok-number">1.0</span>);</span>
<span class="line" id="L4278"></span>
<span class="line" id="L4279">            vijp = vijp + vjp;</span>
<span class="line" id="L4280">            vls = vijp * vlstep;</span>
<span class="line" id="L4281">            sin_cos = sincos(vls);</span>
<span class="line" id="L4282">            unity_table[j + length * <span class="tok-number">3</span>] = sin_cos[<span class="tok-number">1</span>];</span>
<span class="line" id="L4283">            unity_table[j + length * <span class="tok-number">7</span>] = sin_cos[<span class="tok-number">0</span>] * f32x4s(-<span class="tok-number">1.0</span>);</span>
<span class="line" id="L4284"></span>
<span class="line" id="L4285">            vjp += f32x4s(<span class="tok-number">4.0</span>);</span>
<span class="line" id="L4286">        }</span>
<span class="line" id="L4287">        vlstep *= f32x4s(<span class="tok-number">4.0</span>);</span>
<span class="line" id="L4288">        unity_table = unity_table[<span class="tok-number">8</span> * length ..];</span>
<span class="line" id="L4289"></span>
<span class="line" id="L4290">        <span class="tok-kw">if</span> (length &lt;= <span class="tok-number">4</span>)</span>
<span class="line" id="L4291">            <span class="tok-kw">break</span>;</span>
<span class="line" id="L4292">    }</span>
<span class="line" id="L4293">}</span>
<span class="line" id="L4294"></span>
<span class="line" id="L4295"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fft</span>(re: []F32x4, im: []F32x4, unity_table: []<span class="tok-kw">const</span> F32x4) <span class="tok-type">void</span> {</span>
<span class="line" id="L4296">    <span class="tok-kw">const</span> length = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@intCast</span>(re.len * <span class="tok-number">4</span>));</span>
<span class="line" id="L4297">    assert(std.math.isPowerOfTwo(length));</span>
<span class="line" id="L4298">    assert(length &gt;= <span class="tok-number">4</span> <span class="tok-kw">and</span> length &lt;= <span class="tok-number">512</span>);</span>
<span class="line" id="L4299">    assert(re.len == im.len);</span>
<span class="line" id="L4300"></span>
<span class="line" id="L4301">    <span class="tok-kw">var</span> re_temp_storage: [<span class="tok-number">128</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4302">    <span class="tok-kw">var</span> im_temp_storage: [<span class="tok-number">128</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4303">    <span class="tok-kw">var</span> re_temp = re_temp_storage[<span class="tok-number">0</span>..re.len];</span>
<span class="line" id="L4304">    <span class="tok-kw">var</span> im_temp = im_temp_storage[<span class="tok-number">0</span>..im.len];</span>
<span class="line" id="L4305"></span>
<span class="line" id="L4306">    std.mem.copy(F32x4, re_temp, re);</span>
<span class="line" id="L4307">    std.mem.copy(F32x4, im_temp, im);</span>
<span class="line" id="L4308"></span>
<span class="line" id="L4309">    <span class="tok-kw">if</span> (length &gt; <span class="tok-number">16</span>) {</span>
<span class="line" id="L4310">        assert(unity_table.len == length);</span>
<span class="line" id="L4311">        fftN(re_temp, im_temp, unity_table, length, <span class="tok-number">1</span>);</span>
<span class="line" id="L4312">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">16</span>) {</span>
<span class="line" id="L4313">        fft16(re_temp, im_temp, <span class="tok-number">1</span>);</span>
<span class="line" id="L4314">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">8</span>) {</span>
<span class="line" id="L4315">        fft8(re_temp, im_temp, <span class="tok-number">1</span>);</span>
<span class="line" id="L4316">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">4</span>) {</span>
<span class="line" id="L4317">        fft4(re_temp, im_temp, <span class="tok-number">1</span>);</span>
<span class="line" id="L4318">    }</span>
<span class="line" id="L4319"></span>
<span class="line" id="L4320">    fftUnswizzle(re_temp, re);</span>
<span class="line" id="L4321">    fftUnswizzle(im_temp, im);</span>
<span class="line" id="L4322">}</span>
<span class="line" id="L4323"></span>
<span class="line" id="L4324"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ifft</span>(re: []F32x4, im: []<span class="tok-kw">const</span> F32x4, unity_table: []<span class="tok-kw">const</span> F32x4) <span class="tok-type">void</span> {</span>
<span class="line" id="L4325">    <span class="tok-kw">const</span> length = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@intCast</span>(re.len * <span class="tok-number">4</span>));</span>
<span class="line" id="L4326">    assert(std.math.isPowerOfTwo(length));</span>
<span class="line" id="L4327">    assert(length &gt;= <span class="tok-number">4</span> <span class="tok-kw">and</span> length &lt;= <span class="tok-number">512</span>);</span>
<span class="line" id="L4328">    assert(re.len == im.len);</span>
<span class="line" id="L4329"></span>
<span class="line" id="L4330">    <span class="tok-kw">var</span> re_temp_storage: [<span class="tok-number">128</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4331">    <span class="tok-kw">var</span> im_temp_storage: [<span class="tok-number">128</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4332">    <span class="tok-kw">var</span> re_temp = re_temp_storage[<span class="tok-number">0</span>..re.len];</span>
<span class="line" id="L4333">    <span class="tok-kw">var</span> im_temp = im_temp_storage[<span class="tok-number">0</span>..im.len];</span>
<span class="line" id="L4334"></span>
<span class="line" id="L4335">    <span class="tok-kw">const</span> rnp = f32x4s(<span class="tok-number">1.0</span> / <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(length)));</span>
<span class="line" id="L4336">    <span class="tok-kw">const</span> rnm = f32x4s(-<span class="tok-number">1.0</span> / <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(length)));</span>
<span class="line" id="L4337"></span>
<span class="line" id="L4338">    <span class="tok-kw">for</span> (re, <span class="tok-number">0</span>..) |_, i| {</span>
<span class="line" id="L4339">        re_temp[i] = re[i] * rnp;</span>
<span class="line" id="L4340">        im_temp[i] = im[i] * rnm;</span>
<span class="line" id="L4341">    }</span>
<span class="line" id="L4342"></span>
<span class="line" id="L4343">    <span class="tok-kw">if</span> (length &gt; <span class="tok-number">16</span>) {</span>
<span class="line" id="L4344">        assert(unity_table.len == length);</span>
<span class="line" id="L4345">        fftN(re_temp, im_temp, unity_table, length, <span class="tok-number">1</span>);</span>
<span class="line" id="L4346">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">16</span>) {</span>
<span class="line" id="L4347">        fft16(re_temp, im_temp, <span class="tok-number">1</span>);</span>
<span class="line" id="L4348">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">8</span>) {</span>
<span class="line" id="L4349">        fft8(re_temp, im_temp, <span class="tok-number">1</span>);</span>
<span class="line" id="L4350">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (length == <span class="tok-number">4</span>) {</span>
<span class="line" id="L4351">        fft4(re_temp, im_temp, <span class="tok-number">1</span>);</span>
<span class="line" id="L4352">    }</span>
<span class="line" id="L4353"></span>
<span class="line" id="L4354">    fftUnswizzle(re_temp, re);</span>
<span class="line" id="L4355">}</span>
<span class="line" id="L4356"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.ifft&quot;</span> {</span>
<span class="line" id="L4357">    <span class="tok-kw">var</span> unity_table: [<span class="tok-number">512</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4358">    <span class="tok-kw">const</span> epsilon = <span class="tok-number">0.0001</span>;</span>
<span class="line" id="L4359"></span>
<span class="line" id="L4360">    <span class="tok-comment">// 64 samples</span>
</span>
<span class="line" id="L4361">    {</span>
<span class="line" id="L4362">        <span class="tok-kw">var</span> re = [_]F32x4{</span>
<span class="line" id="L4363">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4364">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4365">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4366">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4367">            f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>),     f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>),</span>
<span class="line" id="L4368">            f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>),  f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>),</span>
<span class="line" id="L4369">            f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>),</span>
<span class="line" id="L4370">            f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>),</span>
<span class="line" id="L4371">        };</span>
<span class="line" id="L4372">        <span class="tok-kw">var</span> im = [_]F32x4{</span>
<span class="line" id="L4373">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4374">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4375">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4376">            f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>), f32x4s(<span class="tok-number">0.0</span>),</span>
<span class="line" id="L4377">        };</span>
<span class="line" id="L4378"></span>
<span class="line" id="L4379">        fftInitUnityTable(unity_table[<span class="tok-number">0</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L4380">        fft(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], unity_table[<span class="tok-number">0</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L4381"></span>
<span class="line" id="L4382">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">0</span>], f32x4(<span class="tok-number">1056.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">32.0</span>, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L4383">        <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">1</span>;</span>
<span class="line" id="L4384">        <span class="tok-kw">while</span> (i &lt; <span class="tok-number">16</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4385">            <span class="tok-kw">try</span> expect(approxEqAbs(re[i], f32x4(-<span class="tok-number">32.0</span>, <span class="tok-number">0.0</span>, -<span class="tok-number">32.0</span>, <span class="tok-number">0.0</span>), epsilon));</span>
<span class="line" id="L4386">        }</span>
<span class="line" id="L4387"></span>
<span class="line" id="L4388">        ifft(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], unity_table[<span class="tok-number">0</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L4389"></span>
<span class="line" id="L4390">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">0</span>], f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, <span class="tok-number">4.0</span>), epsilon));</span>
<span class="line" id="L4391">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">1</span>], f32x4(<span class="tok-number">5.0</span>, <span class="tok-number">6.0</span>, <span class="tok-number">7.0</span>, <span class="tok-number">8.0</span>), epsilon));</span>
<span class="line" id="L4392">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">2</span>], f32x4(<span class="tok-number">9.0</span>, <span class="tok-number">10.0</span>, <span class="tok-number">11.0</span>, <span class="tok-number">12.0</span>), epsilon));</span>
<span class="line" id="L4393">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">3</span>], f32x4(<span class="tok-number">13.0</span>, <span class="tok-number">14.0</span>, <span class="tok-number">15.0</span>, <span class="tok-number">16.0</span>), epsilon));</span>
<span class="line" id="L4394">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">4</span>], f32x4(<span class="tok-number">17.0</span>, <span class="tok-number">18.0</span>, <span class="tok-number">19.0</span>, <span class="tok-number">20.0</span>), epsilon));</span>
<span class="line" id="L4395">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">5</span>], f32x4(<span class="tok-number">21.0</span>, <span class="tok-number">22.0</span>, <span class="tok-number">23.0</span>, <span class="tok-number">24.0</span>), epsilon));</span>
<span class="line" id="L4396">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">6</span>], f32x4(<span class="tok-number">25.0</span>, <span class="tok-number">26.0</span>, <span class="tok-number">27.0</span>, <span class="tok-number">28.0</span>), epsilon));</span>
<span class="line" id="L4397">        <span class="tok-kw">try</span> expect(approxEqAbs(re[<span class="tok-number">7</span>], f32x4(<span class="tok-number">29.0</span>, <span class="tok-number">30.0</span>, <span class="tok-number">31.0</span>, <span class="tok-number">32.0</span>), epsilon));</span>
<span class="line" id="L4398">    }</span>
<span class="line" id="L4399"></span>
<span class="line" id="L4400">    <span class="tok-comment">// 512 samples</span>
</span>
<span class="line" id="L4401">    {</span>
<span class="line" id="L4402">        <span class="tok-kw">var</span> re: [<span class="tok-number">128</span>]F32x4 = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4403">        <span class="tok-kw">var</span> im = [_]F32x4{f32x4s(<span class="tok-number">0.0</span>)} ** <span class="tok-number">128</span>;</span>
<span class="line" id="L4404"></span>
<span class="line" id="L4405">        <span class="tok-kw">for</span> (&amp;re, <span class="tok-number">0</span>..) |*v, i| {</span>
<span class="line" id="L4406">            <span class="tok-kw">const</span> f = <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i * <span class="tok-number">4</span>));</span>
<span class="line" id="L4407">            v.* = f32x4(f + <span class="tok-number">1.0</span>, f + <span class="tok-number">2.0</span>, f + <span class="tok-number">3.0</span>, f + <span class="tok-number">4.0</span>);</span>
<span class="line" id="L4408">        }</span>
<span class="line" id="L4409"></span>
<span class="line" id="L4410">        fftInitUnityTable(unity_table[<span class="tok-number">0</span>..<span class="tok-number">512</span>]);</span>
<span class="line" id="L4411">        fft(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], unity_table[<span class="tok-number">0</span>..<span class="tok-number">512</span>]);</span>
<span class="line" id="L4412"></span>
<span class="line" id="L4413">        <span class="tok-kw">for</span> (re, <span class="tok-number">0</span>..) |v, i| {</span>
<span class="line" id="L4414">            <span class="tok-kw">const</span> f = <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i * <span class="tok-number">4</span>));</span>
<span class="line" id="L4415">            <span class="tok-kw">try</span> expect(!approxEqAbs(v, f32x4(f + <span class="tok-number">1.0</span>, f + <span class="tok-number">2.0</span>, f + <span class="tok-number">3.0</span>, f + <span class="tok-number">4.0</span>), epsilon));</span>
<span class="line" id="L4416">        }</span>
<span class="line" id="L4417"></span>
<span class="line" id="L4418">        ifft(re[<span class="tok-number">0</span>..], im[<span class="tok-number">0</span>..], unity_table[<span class="tok-number">0</span>..<span class="tok-number">512</span>]);</span>
<span class="line" id="L4419"></span>
<span class="line" id="L4420">        <span class="tok-kw">for</span> (re, <span class="tok-number">0</span>..) |v, i| {</span>
<span class="line" id="L4421">            <span class="tok-kw">const</span> f = <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(i * <span class="tok-number">4</span>));</span>
<span class="line" id="L4422">            <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(f + <span class="tok-number">1.0</span>, f + <span class="tok-number">2.0</span>, f + <span class="tok-number">3.0</span>, f + <span class="tok-number">4.0</span>), epsilon));</span>
<span class="line" id="L4423">        }</span>
<span class="line" id="L4424">    }</span>
<span class="line" id="L4425">}</span>
<span class="line" id="L4426"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L4427"><span class="tok-comment">//</span>
</span>
<span class="line" id="L4428"><span class="tok-comment">// Private functions and constants</span>
</span>
<span class="line" id="L4429"><span class="tok-comment">//</span>
</span>
<span class="line" id="L4430"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L4431"><span class="tok-kw">const</span> f32x4_sign_mask1: F32x4 = F32x4{ <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0x8000_0000</span>))), <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> };</span>
<span class="line" id="L4432"><span class="tok-kw">const</span> f32x4_mask2: F32x4 = F32x4{</span>
<span class="line" id="L4433">    <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0xffff_ffff</span>))),</span>
<span class="line" id="L4434">    <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0xffff_ffff</span>))),</span>
<span class="line" id="L4435">    <span class="tok-number">0</span>,</span>
<span class="line" id="L4436">    <span class="tok-number">0</span>,</span>
<span class="line" id="L4437">};</span>
<span class="line" id="L4438"><span class="tok-kw">const</span> f32x4_mask3: F32x4 = F32x4{</span>
<span class="line" id="L4439">    <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0xffff_ffff</span>))),</span>
<span class="line" id="L4440">    <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0xffff_ffff</span>))),</span>
<span class="line" id="L4441">    <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0xffff_ffff</span>))),</span>
<span class="line" id="L4442">    <span class="tok-number">0</span>,</span>
<span class="line" id="L4443">};</span>
<span class="line" id="L4444"></span>
<span class="line" id="L4445"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">splatNegativeZero</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) T {</span>
<span class="line" id="L4446">    <span class="tok-kw">return</span> <span class="tok-builtin">@splat</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0x8000_0000</span>))));</span>
<span class="line" id="L4447">}</span>
<span class="line" id="L4448"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">splatNoFraction</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) T {</span>
<span class="line" id="L4449">    <span class="tok-kw">return</span> <span class="tok-builtin">@splat</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">8_388_608.0</span>));</span>
<span class="line" id="L4450">}</span>
<span class="line" id="L4451"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">splatAbsMask</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) T {</span>
<span class="line" id="L4452">    <span class="tok-kw">return</span> <span class="tok-builtin">@splat</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0x7fff_ffff</span>))));</span>
<span class="line" id="L4453">}</span>
<span class="line" id="L4454"></span>
<span class="line" id="L4455"><span class="tok-kw">fn</span> <span class="tok-fn">floatToIntAndBack</span>(v: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(v) {</span>
<span class="line" id="L4456">    <span class="tok-comment">// This routine won't handle nan, inf and numbers greater than 8_388_608.0 (will generate undefined values).</span>
</span>
<span class="line" id="L4457">    <span class="tok-builtin">@setRuntimeSafety</span>(<span class="tok-null">false</span>);</span>
<span class="line" id="L4458"></span>
<span class="line" id="L4459">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v);</span>
<span class="line" id="L4460">    <span class="tok-kw">const</span> len = veclen(T);</span>
<span class="line" id="L4461"></span>
<span class="line" id="L4462">    <span class="tok-kw">var</span> vi32: [len]<span class="tok-type">i32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4463">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L4464">    <span class="tok-comment">// vcvttps2dq</span>
</span>
<span class="line" id="L4465">    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; len) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4466">        vi32[i] = <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intFromFloat</span>(v[i]));</span>
<span class="line" id="L4467">    }</span>
<span class="line" id="L4468"></span>
<span class="line" id="L4469">    <span class="tok-kw">var</span> vf32: [len]<span class="tok-type">f32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L4470">    i = <span class="tok-number">0</span>;</span>
<span class="line" id="L4471">    <span class="tok-comment">// vcvtdq2ps</span>
</span>
<span class="line" id="L4472">    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; len) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4473">        vf32[i] = <span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-builtin">@floatFromInt</span>(vi32[i]));</span>
<span class="line" id="L4474">    }</span>
<span class="line" id="L4475"></span>
<span class="line" id="L4476">    <span class="tok-kw">return</span> vf32;</span>
<span class="line" id="L4477">}</span>
<span class="line" id="L4478"><span class="tok-kw">test</span> <span class="tok-str">&quot;zmath.floatToIntAndBack&quot;</span> {</span>
<span class="line" id="L4479">    {</span>
<span class="line" id="L4480">        <span class="tok-kw">const</span> v = floatToIntAndBack(f32x4(<span class="tok-number">1.1</span>, <span class="tok-number">2.9</span>, <span class="tok-number">3.0</span>, -<span class="tok-number">4.5</span>));</span>
<span class="line" id="L4481">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x4(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, -<span class="tok-number">4.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L4482">    }</span>
<span class="line" id="L4483">    {</span>
<span class="line" id="L4484">        <span class="tok-kw">const</span> v = floatToIntAndBack(f32x8(<span class="tok-number">1.1</span>, <span class="tok-number">2.9</span>, <span class="tok-number">3.0</span>, -<span class="tok-number">4.5</span>, <span class="tok-number">2.5</span>, -<span class="tok-number">2.5</span>, <span class="tok-number">1.1</span>, -<span class="tok-number">100.2</span>));</span>
<span class="line" id="L4485">        <span class="tok-kw">try</span> expect(approxEqAbs(v, f32x8(<span class="tok-number">1.0</span>, <span class="tok-number">2.0</span>, <span class="tok-number">3.0</span>, -<span class="tok-number">4.0</span>, <span class="tok-number">2.0</span>, -<span class="tok-number">2.0</span>, <span class="tok-number">1.0</span>, -<span class="tok-number">100.0</span>), <span class="tok-number">0.0</span>));</span>
<span class="line" id="L4486">    }</span>
<span class="line" id="L4487">    {</span>
<span class="line" id="L4488">        <span class="tok-kw">const</span> v = floatToIntAndBack(f32x4(math.inf(<span class="tok-type">f32</span>), <span class="tok-number">2.9</span>, math.nan_f32, math.qnan_f32));</span>
<span class="line" id="L4489">        <span class="tok-kw">try</span> expect(v[<span class="tok-number">1</span>] == <span class="tok-number">2.0</span>);</span>
<span class="line" id="L4490">    }</span>
<span class="line" id="L4491">}</span>
<span class="line" id="L4492"></span>
<span class="line" id="L4493"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">approxEqAbs</span>(v0: <span class="tok-kw">anytype</span>, v1: <span class="tok-kw">anytype</span>, eps: <span class="tok-type">f32</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L4494">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(v0, v1);</span>
<span class="line" id="L4495">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">comptime_int</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L4496">    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; veclen(T)) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L4497">        <span class="tok-kw">if</span> (!math.approxEqAbs(<span class="tok-type">f32</span>, v0[i], v1[i], eps)) {</span>
<span class="line" id="L4498">            <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L4499">        }</span>
<span class="line" id="L4500">    }</span>
<span class="line" id="L4501">    <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L4502">}</span>
<span class="line" id="L4503"></span>
<span class="line" id="L4504"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L4505"><span class="tok-comment">// This software is available under 2 licenses -- choose whichever you prefer.</span>
</span>
<span class="line" id="L4506"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L4507"><span class="tok-comment">// ALTERNATIVE A - MIT License</span>
</span>
<span class="line" id="L4508"><span class="tok-comment">// Copyright (c) 2022 Michal Ziulek and Contributors</span>
</span>
<span class="line" id="L4509"><span class="tok-comment">// Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
</span>
<span class="line" id="L4510"><span class="tok-comment">// this software and associated documentation files (the &quot;Software&quot;), to deal in</span>
</span>
<span class="line" id="L4511"><span class="tok-comment">// the Software without restriction, including without limitation the rights to</span>
</span>
<span class="line" id="L4512"><span class="tok-comment">// use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</span>
</span>
<span class="line" id="L4513"><span class="tok-comment">// of the Software, and to permit persons to whom the Software is furnished to do</span>
</span>
<span class="line" id="L4514"><span class="tok-comment">// so, subject to the following conditions:</span>
</span>
<span class="line" id="L4515"><span class="tok-comment">// The above copyright notice and this permission notice shall be included in all</span>
</span>
<span class="line" id="L4516"><span class="tok-comment">// copies or substantial portions of the Software.</span>
</span>
<span class="line" id="L4517"><span class="tok-comment">// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
</span>
<span class="line" id="L4518"><span class="tok-comment">// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
</span>
<span class="line" id="L4519"><span class="tok-comment">// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
</span>
<span class="line" id="L4520"><span class="tok-comment">// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
</span>
<span class="line" id="L4521"><span class="tok-comment">// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
</span>
<span class="line" id="L4522"><span class="tok-comment">// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
</span>
<span class="line" id="L4523"><span class="tok-comment">// SOFTWARE.</span>
</span>
<span class="line" id="L4524"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L4525"><span class="tok-comment">// ALTERNATIVE B - Public Domain (www.unlicense.org)</span>
</span>
<span class="line" id="L4526"><span class="tok-comment">// This is free and unencumbered software released into the public domain.</span>
</span>
<span class="line" id="L4527"><span class="tok-comment">// Anyone is free to copy, modify, publish, use, compile, sell, or distribute this</span>
</span>
<span class="line" id="L4528"><span class="tok-comment">// software, either in source code form or as a compiled binary, for any purpose,</span>
</span>
<span class="line" id="L4529"><span class="tok-comment">// commercial or non-commercial, and by any means.</span>
</span>
<span class="line" id="L4530"><span class="tok-comment">// In jurisdictions that recognize copyright laws, the author or authors of this</span>
</span>
<span class="line" id="L4531"><span class="tok-comment">// software dedicate any and all copyright interest in the software to the public</span>
</span>
<span class="line" id="L4532"><span class="tok-comment">// domain. We make this dedication for the benefit of the public at large and to</span>
</span>
<span class="line" id="L4533"><span class="tok-comment">// the detriment of our heirs and successors. We intend this dedication to be an</span>
</span>
<span class="line" id="L4534"><span class="tok-comment">// overt act of relinquishment in perpetuity of all present and future rights to</span>
</span>
<span class="line" id="L4535"><span class="tok-comment">// this software under copyright law.</span>
</span>
<span class="line" id="L4536"><span class="tok-comment">// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
</span>
<span class="line" id="L4537"><span class="tok-comment">// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
</span>
<span class="line" id="L4538"><span class="tok-comment">// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
</span>
<span class="line" id="L4539"><span class="tok-comment">// AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
</span>
<span class="line" id="L4540"><span class="tok-comment">// ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION</span>
</span>
<span class="line" id="L4541"><span class="tok-comment">// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
</span>
<span class="line" id="L4542"><span class="tok-comment">// ------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L4543"></span>
</code></pre></body>
</html>